-- =========================================================
-- ğŸ›’ PICKLE Project: Updated ERD Schema (Payment & Ledger Focused)
-- Last Updated: 2026-02-04
-- =========================================================

-- 1. ê²°ì œ ìˆ˜ë‹¨ í…Œì´ë¸” (Payment Method)
-- ì‚¬ìš©ìì˜ ë“±ë¡ëœ ì¹´ë“œ ë˜ëŠ” ë¹Œë§í‚¤ ì •ë³´ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
CREATE TABLE IF NOT EXISTS payment_method (
  method_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  method_type payment_method_type NOT NULL,  
  billing_key VARCHAR(255),               -- ì¹´ì¹´ì˜¤í˜ì´ SID (ìë™ê²°ì œìš©)
  card_brand VARCHAR(30),                 -- ì¹´ë“œì‚¬ (ì˜ˆ: ì‹ í•œ, êµ­ë¯¼)
  card_last4 CHAR(4),                     -- ì¹´ë“œ ë’·ë²ˆí˜¸ 4ìë¦¬
  is_default BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT fk_method_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id) ON DELETE CASCADE
);

-- ê²°ì œ ìˆ˜ë‹¨ ì¤‘ë³µ ë“±ë¡ ë°©ì§€ (ì‚¬ìš©ìë‹¹ ë™ì¼ ë¹Œë§í‚¤ ì¤‘ë³µ ê¸ˆì§€)
CREATE UNIQUE INDEX IF NOT EXISTS uq_payment_method_user_billing_key
  ON payment_method (user_id, billing_key)
  WHERE billing_key IS NOT NULL;


-- 2. ê²°ì œ í…Œì´ë¸” (Payment)
-- ëª¨ë“  ê²°ì œ ì‹œë„ì™€ ê²°ê³¼ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
CREATE TABLE IF NOT EXISTS payment (
  payment_id BIGSERIAL PRIMARY KEY,
  cart_session_id BIGINT UNIQUE,          -- ì—°ë™ëœ ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ (1:1)
  user_id BIGINT NOT NULL,
  method_id BIGINT,                       -- ì‚¬ìš©ëœ ê²°ì œ ìˆ˜ë‹¨

  pg_provider pg_provider_type NOT NULL,  -- KAKAO_PAY, CARD_PG
  pg_tid VARCHAR(255) UNIQUE,             -- ì¹´ì¹´ì˜¤í˜ì´ ê±°ë˜ ê³ ìœ  ë²ˆí˜¸ (TID)

  status payment_status NOT NULL DEFAULT 'PENDING', -- PENDING, APPROVED, FAILED, CANCELLED
  total_amount INTEGER NOT NULL,
  
  approved_at TIMESTAMPTZ,                -- ì‹¤ì œ ìŠ¹ì¸ ì™„ë£Œ ì‹œê°
  created_at TIMESTAMPTZ DEFAULT now(),   -- ê²°ì œ ì‹œë„(Ready) ì‹œê°

  CONSTRAINT fk_payment_session
    FOREIGN KEY (cart_session_id) REFERENCES cart_session (cart_session_id),
  CONSTRAINT fk_payment_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id),
  CONSTRAINT fk_payment_method
    FOREIGN KEY (method_id) REFERENCES payment_method (method_id)
);

-- ê²°ì œ ì¡°íšŒ ìµœì í™”ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_payment_pg_tid ON payment (pg_tid);
CREATE INDEX IF NOT EXISTS idx_payment_status ON payment (status);


-- 3. ê°€ê³„ë¶€ í…Œì´ë¸” (Ledger Entry)
-- ìŠ¹ì¸ëœ ê²°ì œ ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ ì§€ì¶œ ë‚´ì—­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
CREATE TABLE IF NOT EXISTS ledger_entry (
  ledger_entry_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  payment_id BIGINT,                      -- ì—°ë™ëœ ê²°ì œ ì •ë³´ (SET NULLë¡œ ìœ ì§€)

  spend_date DATE NOT NULL,               -- ì§€ì¶œ ì¼ì
  category ledger_category NOT NULL DEFAULT 'ETC', -- GROCERY, SNACK ë“±
  amount INTEGER NOT NULL,                -- ì§€ì¶œ ê¸ˆì•¡
  memo TEXT,                              -- ì‚¬ìš©ì ë©”ëª¨ (API ëª…ì„¸ ëŒ€ì‘)
  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT fk_ledger_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id) ON DELETE CASCADE,
  CONSTRAINT fk_ledger_payment
    FOREIGN KEY (payment_id) REFERENCES payment (payment_id) ON DELETE SET NULL
);

-- ê°€ê³„ë¶€ í†µê³„ë¥¼ ìœ„í•œ ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_ledger_user_date ON ledger_entry (user_id, spend_date);
CREATE INDEX IF NOT EXISTS idx_ledger_category ON ledger_entry (category);


-- 4. ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ í…Œì´ë¸” (Cart Session - ë³´ì™„)
-- ê²°ì œ ìƒíƒœ(status)ì™€ ë™ê¸°í™”ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
-- (ê¸°ì¡´ í…Œì´ë¸”ì´ ì¡´ì¬í•œë‹¤ë©´ status íƒ€ì… í™•ì¸ í•„ìš”: ACTIVE, PAID, CANCELLED ë“±)
-- ALTER TABLE cart_session ADD COLUMN IF NOT EXISTS measured_total_g INTEGER DEFAULT 0;
-- ALTER TABLE cart_session ADD COLUMN IF NOT EXISTS expected_total_g INTEGER DEFAULT 0;
