stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_BACKEND: "$DOCKER_USERNAME/smart-cart-backend:latest"
  IMAGE_AI: "$DOCKER_USERNAME/smart-cart-ai:latest"
  IMAGE_AIRFLOW: "$DOCKER_USERNAME/smart-cart-airflow:latest"
  DOCKER_BUILDKIT: 1

# services: docker:dind 제거 (Host Docker Socket 사용)

# =========================================================
# 1. Backend Build Job
# =========================================================
build-backend:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Backend using Host Cache..."
    # DooD는 호스트의 이미지를 그대로 보므로 --cache-from 명시 안 해도 캐시가 있으면 씀
    # 확실히 하기 위해 기존 로직 유지하되, pull은 필요 없음 (호스트에 있으면 됨)
    - >
      docker build 
      --build-arg BUILDKIT_INLINE_CACHE=1 
      -t $IMAGE_BACKEND ./backend
    - docker push $IMAGE_BACKEND
  rules:
    - changes:
        - backend/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 2. AI (Inference) Build Job
# =========================================================
build-ai:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building AI using Host Cache..."
    - >
      docker build 
      --build-arg BUILDKIT_INLINE_CACHE=1 
      -t $IMAGE_AI ./ai
    - docker push $IMAGE_AI
  rules:
    - changes:
        - ai/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 3. MLOps (Airflow) Build Job
# =========================================================
build-airflow:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Airflow using Host Cache..."
    - >
      docker build 
      --build-arg BUILDKIT_INLINE_CACHE=1 
      -f mlops/airflow/Dockerfile 
      -t $IMAGE_AIRFLOW ./mlops
    - docker push $IMAGE_AIRFLOW
  rules:
    - changes:
        - mlops/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 4. Deploy (EC2)
# =========================================================
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - echo "Creating full directory structure on EC2..."
    - >
      ssh $EC2_USER@$EC2_HOST "mkdir -p ~/workspaces/S14P11A202/backend 
      ~/workspaces/S14P11A202/ai 
      ~/workspaces/S14P11A202/mlops/airflow"
    
    - echo "Uploading docker-compose.yml..."
    - scp docker-compose.yml $EC2_USER@$EC2_HOST:~/workspaces/S14P11A202/

    - echo "Generating .env file on EC2..."
    - |
      ssh $EC2_USER@$EC2_HOST "cat <<EOF > ~/workspaces/S14P11A202/.env
      DOCKER_USERNAME=$DOCKER_USERNAME
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      MINIO_ROOT_USER=$MINIO_ROOT_USER
      MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
      MINIO_BUCKET_NAME=$MINIO_BUCKET_NAME
      KAKAO_ADMIN_KEY=$KAKAO_ADMIN_KEY
      EOF"
    
    - echo "Executing Remote Deployment Commands..."
    - >
      ssh $EC2_USER@$EC2_HOST "
        cd ~/workspaces/S14P11A202 && 
        echo '$DOCKER_PASSWORD' | docker login -u '$DOCKER_USERNAME' --password-stdin &&
        docker compose pull && 
        docker compose up -d --remove-orphans &&
        docker image prune -f
      "
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
