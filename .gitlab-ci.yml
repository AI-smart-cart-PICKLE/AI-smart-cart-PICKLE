# 1. íŒŒì´í”„ë¼ì¸ ì „ì²´ ìŠ¤í…Œì´ì§€ ì •ì˜
stages:
  - test          # ì½”ë“œ ë¬¸ë²• ê²€ì‚¬ ë° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  - build-package # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

# ì „ì—­ ë³€ìˆ˜ ì„¤ì •
variables:
  # ë„ì»¤ ì†ë„ í–¥ìƒì„ ìœ„í•œ ë“œë¼ì´ë²„ ì„¤ì •
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # ì´ë¯¸ì§€ íƒœê·¸: master ë¸Œëœì¹˜ëŠ” 'latest', ë‚˜ë¨¸ì§€ëŠ” 'ë¸Œëœì¹˜ëª…'ìœ¼ë¡œ íƒœê¹…
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  LATEST_TAG: $CI_REGISTRY_IMAGE:latest

# ë¹Œë“œìš© DinD í™œì„±í™”
services:
  - name: docker:24.0.5-dind
    command: ["--tls=false"]

# =========================================================
# Stage 1: TEST (í’ˆì§ˆ ê´€ë¦¬)
# =========================================================
test_python:
  image: python:3.11-slim
  stage: test
  script:
    - pip install -r requirements.txt
    - pip install flake8
    # 1. ë¬¸ë²• ê²€ì‚¬ (ë„ˆë¬´ ì—„ê²©í•˜ë©´ íŒ€ì›ë“¤ ìš°ë‹ˆê¹Œ E501(ì¤„ê¸¸ì´) ì •ë„ëŠ” ë¬´ì‹œ)
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

# =========================================================
# Stage 2: BUILD & PUSH
# =========================================================
build_arm64:
  image: docker:24.0.5
  stage: build-package
  before_script:
    # ê¹ƒë© ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    # ARM64 ì—ë®¬ë ˆì´í„° ì„¤ì¹˜ (QEMU)
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    # Buildx ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    - docker buildx create --use
  script:
      - echo "ğŸ—ï¸ Building Docker Image for ARM64..."
      # ê¸°ë³¸ ì´ë¯¸ì§€ íƒœê·¸ëŠ” í•­ìƒ ë¶™ì´ê³ , master(ë˜ëŠ” main)ì¼ ë•Œë§Œ latest íƒœê·¸ë¥¼ ë™ì ìœ¼ë¡œ ì¶”ê°€
      - docker buildx build --platform linux/arm64 \
          -t $IMAGE_TAG \
          $( [ "$CI_COMMIT_BRANCH" = "master" ] || [ "$CI_COMMIT_BRANCH" = "main" ] && echo "-t $LATEST_TAG" ) \
          --push .
      - echo "âœ… Build & Push Complete!"
    
  # master ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§Œ ì‹¤í–‰
  only:
    - master