stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # 각 모듈별 이미지 태그 정의
  IMAGE_BACKEND: $CI_REGISTRY_IMAGE/backend:latest
  IMAGE_AI: $CI_REGISTRY_IMAGE/ai:latest
  IMAGE_AIRFLOW: $CI_REGISTRY_IMAGE/airflow:latest

services:
  - name: docker:24.0.5-dind
    command: ["--tls=false"]

# =========================================================
# 1. Backend Build Job
# =========================================================
build-backend:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building Backend..."
    - docker build -t $IMAGE_BACKEND ./backend
    - docker push $IMAGE_BACKEND
  rules:
    # backend 폴더나 Dockerfile, Compose 파일이 바뀌면 실행
    - changes:
        - backend/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 2. AI (Inference) Build Job
# =========================================================
build-ai:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building AI Inference Server..."
    - docker build -t $IMAGE_AI ./ai
    - docker push $IMAGE_AI
  rules:
    - changes:
        - ai/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 3. MLOps (Airflow) Build Job
# =========================================================
build-airflow:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - echo "Building Airflow..."
    # 빌드 컨텍스트는 mlops 디렉토리
    - docker build -t $IMAGE_AIRFLOW -f mlops/airflow/Dockerfile ./mlops
    - docker push $IMAGE_AIRFLOW
  rules:
    - changes:
        - mlops/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 4. Deploy (EC2)
# =========================================================
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - 'which ssh-agent || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    # SSH_PRIVATE_KEY 변수에 EC2 키 파일 내용이 등록되어 있어야 함
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # 호스트 키 검증 비활성화 (보안상 known_hosts 권장하나 편의상 적용)
    - echo -e "Host *
	StrictHostKeyChecking no

" > ~/.ssh/config
  script:
    - echo "Deploying to EC2..."
    # 1. 최신 docker-compose.yml 서버로 전송
    - scp docker-compose.yml $EC2_USER@$EC2_HOST:~/workspaces/S14P11A202/
    # 2. 서버에서 Pull 및 Up (변경된 컨테이너만 재시작됨)
    - ssh $EC2_USER@$EC2_HOST "cd ~/workspaces/S14P11A202 && docker compose pull && docker compose up -d"
  rules:
    # 빌드 작업 중 하나라도 성공하거나, 마스터 브랜치 푸시 시 실행
    - if: $CI_COMMIT_BRANCH == "master"
