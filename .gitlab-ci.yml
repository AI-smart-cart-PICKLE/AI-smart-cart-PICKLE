stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_BACKEND: "$DOCKER_USERNAME/smart-cart-backend:latest"
  IMAGE_AI: "$DOCKER_USERNAME/smart-cart-ai:latest"
  IMAGE_AIRFLOW: "$DOCKER_USERNAME/smart-cart-airflow:latest"
  DOCKER_BUILDKIT: 1
  DOCKER_HOST: "unix:///var/run/docker.sock"

# =========================================================
# 1. Backend Build Job
# =========================================================
build-backend:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Backend using Host Cache..."
    - >
      docker build
      --build-arg BUILDKIT_INLINE_CACHE=1
      -t $IMAGE_BACKEND ./backend
    - docker push $IMAGE_BACKEND
  rules:
    - changes:
        - backend/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 2. AI Build Job
# =========================================================
build-ai:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building AI using Host Cache..."
    - >
      docker build
      --build-arg BUILDKIT_INLINE_CACHE=1
      -t $IMAGE_AI ./ai
    - docker push $IMAGE_AI
  rules:
    - changes:
        - ai/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 3. Frontend Build Job
# =========================================================
build-frontend:
  stage: build
  image: node:20-alpine
  script:
    - echo "Building Frontend (Vue.js)..."
    - cd frontend/cart
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/cart/dist/
    expire_in: 1 hour
  rules:
    - changes:
        - frontend/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 4. MLOps (Airflow) Build Job
# =========================================================
build-airflow:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Airflow using Host Cache..."
    - >
      docker build
      --build-arg BUILDKIT_INLINE_CACHE=1
      -f mlops/airflow/Dockerfile
      -t $IMAGE_AIRFLOW ./mlops
    - docker push $IMAGE_AIRFLOW
  rules:
    - changes:
        - mlops/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 5. Deploy (EC2)
# =========================================================
deploy:
  stage: deploy
  image: alpine:latest
  needs:
    - job: build-backend
      optional: true
    - job: build-ai
      optional: true
    - job: build-frontend
      artifacts: true
      optional: true
    - job: build-airflow
      optional: true
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - echo "Creating directory structure on EC2..."
    - ssh $EC2_USER@$EC2_HOST "mkdir -p ~/workspaces/S14P11A202/frontend/dist"

    - echo "Uploading deployment files..."
    - scp docker-compose.yml init-db.sh nginx-ssl-prod.conf $EC2_USER@$EC2_HOST:~/workspaces/S14P11A202/

    - echo "Uploading frontend build files..."
    - |
      if [ -d "frontend/cart/dist" ]; then
        rsync -avz --delete -e "ssh" frontend/cart/dist/ $EC2_USER@$EC2_HOST:~/workspaces/S14P11A202/frontend/dist/
      fi

    - echo "Generating .env file..."
    - |
      ssh $EC2_USER@$EC2_HOST "cat <<EOF > ~/workspaces/S14P11A202/.env
      DOCKER_USERNAME=$DOCKER_USERNAME
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      DB_NAME=$DB_NAME
      MINIO_ROOT_USER=$MINIO_ROOT_USER
      MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
      MINIO_BUCKET_NAME=$MINIO_BUCKET_NAME
      SECRET_KEY=$SECRET_KEY
      KAKAO_ADMIN_KEY=$KAKAO_ADMIN_KEY
      KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY
      KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI
      GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
      GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
      GOOGLE_REDIRECT_URI=$GOOGLE_REDIRECT_URI
      SMTP_HOST=$SMTP_HOST
      SMTP_PORT=$SMTP_PORT
      SMTP_USER=$SMTP_USER
      SMTP_PASSWORD=$SMTP_PASSWORD
      FRONTEND_URL=$FRONTEND_URL
      AIRFLOW_BASE_URL=$AIRFLOW_BASE_URL
      SSL_CERT_PATH=$SSL_CERT_PATH
      EOF"

    - echo "Executing Remote Deployment..."
    - |
      ssh $EC2_USER@$EC2_HOST << 'REMOTECMD'
        cd ~/workspaces/S14P11A202

        # frontend/dist가 비어있으면 web-kiosk/dist에서 복사 (fallback)
        if [ ! -f "frontend/dist/index.html" ] && [ -d "frontend/web-kiosk/dist" ]; then
          echo "frontend/dist is empty, copying from web-kiosk/dist..."
          cp -r frontend/web-kiosk/dist/* frontend/dist/
        fi

        # 기존 컨테이너 정리 (데이터는 유지)
        docker compose down

        # Docker 로그인 및 이미지 pull
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        docker compose pull

        # 서비스 실행
        docker compose --profile cpu up -d --remove-orphans

        # DB 준비 대기
        sleep 10

        # alembic_version 테이블 초기화 (마이그레이션 히스토리만 삭제)
        docker compose exec -T db psql -U $DB_USER -d app_db -c "DELETE FROM alembic_version;" || true

        # 기존 마이그레이션 파일 삭제
        rm -rf backend/alembic/versions/*.py

        # 현재 models.py 기준으로 새 마이그레이션 생성
        docker compose exec -T backend alembic revision --autogenerate -m "auto_baseline_$(date +%Y%m%d_%H%M%S)"

        # DB 변경 없이 "적용됨"으로 표시 (데이터 보존)
        docker compose exec -T backend alembic stamp head

        # 이미지 정리
        docker image prune -f
      REMOTECMD
  rules:
    - if: $CI_COMMIT_BRANCH == "master"