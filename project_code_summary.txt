
==================================================
FILE PATH: .\.gitlab-ci.yml
==================================================
stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  IMAGE_BACKEND: "$DOCKER_USERNAME/smart-cart-backend:latest"
  IMAGE_AI: "$DOCKER_USERNAME/smart-cart-ai:latest"
  IMAGE_AIRFLOW: "$DOCKER_USERNAME/smart-cart-airflow:latest"
  DOCKER_BUILDKIT: 1
  DOCKER_HOST: "unix:///var/run/docker.sock"

# services: docker:dind ì œê±° (Host Docker Socket ì‚¬ìš© - DOOD)

# =========================================================
# 1. Backend Build Job
# =========================================================
build-backend:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Backend using Host Cache..."
    - >
      docker build 
      --build-arg BUILDKIT_INLINE_CACHE=1 
      -t $IMAGE_BACKEND ./backend
    - docker push $IMAGE_BACKEND
  rules:
    - changes:
        - backend/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 2. AI (Inference) Build Job
# =========================================================
build-ai:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building AI using Host Cache..."
    - >
      docker build 
      --build-arg BUILDKIT_INLINE_CACHE=1 
      -t $IMAGE_AI ./ai
    - docker push $IMAGE_AI
  rules:
    - changes:
        - ai/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 3. Frontend Build Job
# =========================================================
build-frontend:
  stage: build
  image: node:20-alpine
  script:
    - echo "Building Frontend (Vue.js)..."
    - cd frontend/cart
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/web-kiosk/dist/
    expire_in: 1 hour
  rules:
    - changes:
        - frontend/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 4. MLOps (Airflow) Build Job
# =========================================================
build-airflow:
  stage: build
  image: docker:24.0.5
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  script:
    - echo "Building Airflow using Host Cache..."
    - >
      docker build 
      --build-arg BUILDKIT_INLINE_CACHE=1 
      -f mlops/airflow/Dockerfile 
      -t $IMAGE_AIRFLOW ./mlops
    - docker push $IMAGE_AIRFLOW
  rules:
    - changes:
        - mlops/**/*
        - docker-compose.yml
      when: always

# =========================================================
# 4. Deploy (EC2)
# =========================================================
deploy:
  stage: deploy
  image: alpine:latest
  needs:
    - job: build-frontend
      artifacts: true
      optional: true
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  script:
    - echo "Creating full directory structure on EC2..."
    - >
      ssh $EC2_USER@$EC2_HOST "mkdir -p ~/workspaces/S14P11A202/backend
      ~/workspaces/S14P11A202/ai
      ~/workspaces/S14P11A202/mlops/airflow
      ~/workspaces/S14P11A202/frontend/web-kiosk/dist"

    - echo "Uploading deployment files..."
    # feat ë¸Œëœì¹˜ì˜ ìˆ˜ì •ì‚¬í•­: init-db.sh, nginx ì„¤ì • í¬í•¨ ì—…ë¡œë“œ
    - scp docker-compose.yml init-db.sh nginx-ssl-prod.conf $EC2_USER@$EC2_HOST:~/workspaces/S14P11A202/

    - echo "Uploading frontend build files (if available)..."
    - |
      if [ -d "frontend/web-kiosk/dist" ]; then
        echo "Cleaning old frontend files..."
        ssh $EC2_USER@$EC2_HOST "rm -rf ~/workspaces/S14P11A202/frontend/web-kiosk/dist && mkdir -p ~/workspaces/S14P11A202/frontend/web-kiosk/dist"
        rsync -avz --delete -e "ssh" frontend/web-kiosk/dist/ $EC2_USER@$EC2_HOST:~/workspaces/S14P11A202/frontend/web-kiosk/dist/
        echo "Frontend files uploaded successfully"
      else
        echo "No frontend build artifacts found - skipping frontend upload"
      fi

    - echo "Generating .env file on EC2..."
    - |
      ssh $EC2_USER@$EC2_HOST "cat <<EOF > ~/workspaces/S14P11A202/.env
      DOCKER_USERNAME=$DOCKER_USERNAME
      DB_USER=$DB_USER
      DB_PASSWORD=$DB_PASSWORD
      DB_NAME=$DB_NAME
      MINIO_ROOT_USER=$MINIO_ROOT_USER
      MINIO_ROOT_PASSWORD=$MINIO_ROOT_PASSWORD
      MINIO_BUCKET_NAME=$MINIO_BUCKET_NAME
      KAKAO_ADMIN_KEY=$KAKAO_ADMIN_KEY
      KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY
      KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI
      GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
      GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
      GOOGLE_REDIRECT_URI=$GOOGLE_REDIRECT_URI
      SMTP_HOST=$SMTP_HOST
      SMTP_PORT=$SMTP_PORT
      SMTP_USER=$SMTP_USER
      SMTP_PASSWORD=$SMTP_PASSWORD
      FRONTEND_URL=$FRONTEND_URL
      AIRFLOW_BASE_URL=$AIRFLOW_BASE_URL
      SSL_CERT_PATH=$SSL_CERT_PATH
      EOF"
    
    - echo "Executing Remote Deployment Commands..."
    - >
      ssh $EC2_USER@$EC2_HOST "
        cd ~/workspaces/S14P11A202 &&
        echo '$DOCKER_PASSWORD' | docker login -u '$DOCKER_USERNAME' --password-stdin &&
        docker compose pull &&
        docker compose --profile cpu up -d --remove-orphans &&
        docker compose restart nginx &&
        docker image prune -f
      "
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

==================================================
FILE PATH: .\docker-compose.yml
==================================================
name: smart-cart-project

services:
  # --- [Storage Layer] ---
  db:
    image: pgvector/pgvector:pg16
    container_name: postgres_db
    restart: always
    env_file: .env
    environment:
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password123}
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-admin} -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio
    container_name: minio_storage
    restart: always
    env_file: .env
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./data/minio:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  # MinIO Bucket Initialization (Idempotent)
  minio-init:
    image: minio/mc
    container_name: minio_init
    env_file: .env
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      until (mc alias set minio http://minio:9000 ${MINIO_ROOT_USER:-admin} ${MINIO_ROOT_PASSWORD:-password123}); do echo '...waiting for minio...' && sleep 1; done;
      mc mb --ignore-existing minio/mlflow;
      mc mb --ignore-existing minio/data;
      exit 0;
      "

  # --- [MLOps Layer] ---
  mlflow:
    image: ghcr.io/mlflow/mlflow:v3.8.1
    container_name: mlflow_server
    restart: always
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
      airflow:
        condition: service_healthy
    environment:
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER:-admin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-password123}
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
    entrypoint: >
      /bin/sh -c "
      pip install psycopg2-binary &&
      mlflow server 
      --backend-store-uri postgresql://${DB_USER:-admin}:${DB_PASSWORD:-password123}@db:5432/mlflow 
      --default-artifact-root s3://mlflow/ 
      --host 0.0.0.0
      --port 5000
      --allowed-hosts '*'"
    ports:
      - "5001:5000"
    volumes:
      - ./data:/data

  airflow:
    image: ${DOCKER_USERNAME:-local}/smart-cart-airflow:latest
    build:
      context: ./mlops
      dockerfile: airflow/Dockerfile
    container_name: airflow_standalone
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
    environment:
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://${DB_USER:-admin}:${DB_PASSWORD:-password123}@db:5432/airflow
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__WEBSERVER__BASE_URL=${AIRFLOW_BASE_URL:-https://bapsim.site/airflow}
      - AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX=True
    volumes:
      - ./mlops/airflow/dags:/opt/airflow/dags
      - ./mlops/airflow/logs:/opt/airflow/logs
    healthcheck:
      test: ["CMD-SHELL", "airflow jobs check --job-type SchedulerJob --hostname $(hostname) || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    command: standalone
    ports:
      - "8081:8080"

  # --- [Application Layer] ---
  backend:
    image: ${DOCKER_USERNAME:-local}/smart-cart-backend:latest
    build: 
      context: ./backend
      dockerfile: Dockerfile
    container_name: fastapi_backend
    restart: always
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      - DATABASE_URL=postgresql://${DB_USER:-admin}:${DB_PASSWORD:-password123}@db:5432/app_db
      - MINIO_ENDPOINT=http://minio:9000
      - AI_INFERENCE_URL=${AI_INFERENCE_URL:-http://ai_inference:8000}
    ports:
      - "8000:8000"
    volumes:
      - ./data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 6gb
          cpus: '2.0'

  # AI Inference Server (CPU Mode)
  ai-inference:
    profiles: ["cpu", "prod"]
    image: ${DOCKER_USERNAME:-local}/smart-cart-ai:latest
    build:
      context: ./ai
      dockerfile: Dockerfile
    container_name: ai_inference
    restart: always
    env_file: .env
    shm_size: 2gb
    environment:
      - MINIO_ENDPOINT=http://minio:9000
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER:-admin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-password123}
    ports:
      - "8001:8000"
    volumes:
      - ./data:/data
    depends_on:
      minio-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          memory: 4gb
          cpus: '2.0'

  # [GPU Mode] AI Inference Server
  ai-inference-gpu:
    profiles: ["dev", "gpu"]
    image: ${DOCKER_USERNAME:-local}/smart-cart-ai:latest
    build:
      context: ./ai
      dockerfile: Dockerfile
    container_name: ai_inference_gpu
    restart: always
    env_file: .env
    shm_size: 2gb
    environment:
      - MINIO_ENDPOINT=http://minio:9000
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER:-admin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-password123}
    ports:
      - "8001:8000" # í¬íŠ¸ í†µì¼
    volumes:
      - ./data:/data
    depends_on:
      minio-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          memory: 8gb
          cpus: '4.0'
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # --- [Gateway Layer] ---
  nginx:
    image: nginx:alpine
    container_name: nginx_gateway
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-ssl-prod.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend/web-kiosk/dist:/usr/share/nginx/html:ro
      - ${SSL_CERT_PATH:-./certs}:/etc/letsencrypt:ro
      - /var/www/certbot:/var/www/certbot:ro
    depends_on:
      - backend
      - mlflow
      - airflow

==================================================
FILE PATH: .\GEMINI.md
==================================================
ë„ˆê°€ í•˜ëŠ” ë§ë“¤ í•œê¸€ë¡œ ë²ˆì—­í•´ì„œ ë³´ì—¬ì¤˜.
ë¡œê·¸,ë¶„ì„ê²°ê³¼ ì´ëŸ°ê²ƒë“¤ í•œêµ­ì–´ë¡œ ë§í•´.

ì•„ë˜ì˜ api ëª…ì„¸ì„œ .csv íŒŒì¼ì„ ë°˜ë“œì‹œ ë³´ê³  ì‘ì„±í•œë‹¤.
ë³€ìˆ˜ëª…ì€ snake caseë¡œ í•œë‹¤.
ì½”ë“œëŠ” ê°ì²´ ì§€í–¥ì ìœ¼ë¡œ ìœ ì§€, ë³´ìˆ˜, ì¬ì‚¬ìš©ì„±ì´ ì‰½ë„ë¡ ì‘ì„±í•œë‹¤.
backend ë””ë ‰í† ë¦¬ì— ìˆëŠ” app í´ë” ì•ˆì— dbì™€ mobile_app ë””ë ‰í† ë¦¬ ì•ˆì— UIë¥¼ ë³´ê³  UIì™€ DBê°€ ì—°ë™ì´ ì˜ ëëŠ”ì§€ ê²€ì¦í•œë‹¤.
ë‚´ë¶€ í†µì‹  ê·œê±±ì€ httpì´ê³ , ì™¸ë¶€ í†µì‹  ê·œê²©ì€ httpsì´ë‹¤.

1. ë„ˆê°€ í•˜ëŠ” ë§ë“¤ í•œê¸€ë¡œ ë²ˆì—­í•´ì„œ ë³´ì—¬ì¤˜.
2. ë¶„ì„ê²°ê³¼/ERD ë“± ê¸°ìˆ ì  ë‚´ìš©ì€ ë°˜ë“œì‹œ í•œê¸€ë¡œ ì„¤ëª…í•´.
3. ì•„ë˜ì˜ api ëª…ì„¸ì„œ .csv íŒŒì¼ì„ ë°˜ë“œì‹œ ì°¸ê³ í•˜ì—¬ ê°œë°œí•´.
4. ë³€ìˆ˜ëª…ì€ snake caseë¥¼ ì‚¬ìš©í•´.
5. ì½”ë“œëŠ” ê°ì²´ ì§€í–¥ì ì´ê³  ìœ ì§€ë³´ìˆ˜ê°€ ìš©ì´í•˜ë„ë¡ ì‘ì„±í•´.
6. backend/app/db êµ¬ì¡°ì™€ mobile_app UI ì—°ë™ ìƒíƒœë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ê²€ì¦í•´.
7. ë‚´ë¶€ í†µì‹ ì€ http, ì™¸ë¶€ í†µì‹ ì€ https ê·œê²©ì„ ì¤€ìˆ˜í•´.

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
CREATE EXTENSION IF NOT EXISTS vector;


CREATE TYPE user_provider AS ENUM ('LOCAL', 'GOOGLE');
CREATE TYPE cart_session_status AS ENUM ('ACTIVE', 'CHECKOUT_REQUESTED', 'PAID', 'CANCELLED');
CREATE TYPE detection_action_type AS ENUM ('ADD', 'REMOVE');
CREATE TYPE payment_method_type AS ENUM ('CARD', 'KAKAO_PAY');
CREATE TYPE pg_provider_type AS ENUM ('KAKAO_PAY', 'CARD_PG');
CREATE TYPE payment_status AS ENUM ('PENDING', 'APPROVED', 'FAILED', 'CANCELLED');
CREATE TYPE ledger_category AS ENUM ('GROCERY', 'MEAT', 'DAIRY', 'BEVERAGE', 'SNACK', 'HOUSEHOLD', 'ETC');



CREATE TABLE app_user (
  user_id BIGSERIAL PRIMARY KEY,
  email VARCHAR(255) NOT NULL UNIQUE,
  provider user_provider NOT NULL DEFAULT 'LOCAL',
  nickname VARCHAR(40) NOT NULL,
  password_hash VARCHAR(255),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);


CREATE TABLE product_category (
  category_id BIGSERIAL PRIMARY KEY,
  name VARCHAR(60) NOT NULL UNIQUE,
  zone_code VARCHAR(30)
);


CREATE TABLE product (
  product_id BIGSERIAL PRIMARY KEY,
  category_id BIGINT,
  barcode VARCHAR(64) UNIQUE, 
  name VARCHAR(255) NOT NULL,
  price INTEGER NOT NULL,
  unit_weight_g INTEGER NOT NULL,
  stock_quantity INTEGER DEFAULT 0,
  image_url TEXT,
  product_info JSONB,

  embedding vector(1536),   
  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT fk_product_category
    FOREIGN KEY (category_id) REFERENCES product_category (category_id)
);


CREATE INDEX idx_product_name_trgm
  ON product USING gin (name gin_trgm_ops);

CREATE INDEX idx_product_embedding
  ON product USING ivfflat (embedding vector_cosine_ops);


CREATE TABLE recipe (
  recipe_id BIGSERIAL PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  instructions TEXT,
  image_url TEXT,

  embedding vector(1536),   

  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_recipe_embedding
  ON recipe USING ivfflat (embedding vector_cosine_ops);


CREATE TABLE recipe_ingredient (
  recipe_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  quantity_info VARCHAR(50),
  importance_score INTEGER DEFAULT 1,

  PRIMARY KEY (recipe_id, product_id),

  CONSTRAINT fk_recipe
    FOREIGN KEY (recipe_id) REFERENCES recipe (recipe_id) ON DELETE CASCADE,

  CONSTRAINT fk_ingredient
    FOREIGN KEY (product_id) REFERENCES product (product_id)
);


CREATE TABLE saved_recipe (
  user_id BIGINT NOT NULL,
  recipe_id BIGINT NOT NULL,
  saved_at TIMESTAMPTZ DEFAULT now(),

  PRIMARY KEY (user_id, recipe_id),

  CONSTRAINT fk_saved_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id) ON DELETE CASCADE,

  CONSTRAINT fk_saved_recipe
    FOREIGN KEY (recipe_id) REFERENCES recipe (recipe_id) ON DELETE CASCADE
);


CREATE TABLE cart_device (
  cart_device_id BIGSERIAL PRIMARY KEY,
  device_code VARCHAR(64) NOT NULL UNIQUE  
);


CREATE TABLE cart_session (
  cart_session_id BIGSERIAL PRIMARY KEY,
  cart_device_id BIGINT NOT NULL,
  user_id BIGINT,

  status cart_session_status NOT NULL DEFAULT 'ACTIVE',
  budget_limit INTEGER DEFAULT 0,

  expected_total_g INTEGER DEFAULT 0,
  measured_total_g INTEGER DEFAULT 0,

  started_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  ended_at TIMESTAMPTZ,

  CONSTRAINT fk_cart_device
    FOREIGN KEY (cart_device_id) REFERENCES cart_device (cart_device_id),

  CONSTRAINT fk_cart_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id)
);


CREATE TABLE cart_item (
  cart_item_id BIGSERIAL PRIMARY KEY,
  cart_session_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,

  quantity  INTEGER NOT NULL DEFAULT 1,
  unit_price INTEGER NOT NULL,
  added_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT uq_cart_item_session_product UNIQUE (cart_session_id, product_id), 

  CONSTRAINT fk_cart_session
    FOREIGN KEY (cart_session_id) REFERENCES cart_session (cart_session_id) ON DELETE CASCADE,

  CONSTRAINT fk_cart_product
    FOREIGN KEY (product_id) REFERENCES product (product_id)
);




CREATE TABLE cart_detection_log (
  log_id BIGSERIAL PRIMARY KEY,
  cart_session_id BIGINT NOT NULL,
  cart_device_id BIGINT NOT NULL,
  product_id BIGINT,       
  action_type detection_action_type NOT NULL, 
  confidence_score NUMERIC(5,2),  
  detected_weight_g INTEGER, 
  is_applied BOOLEAN DEFAULT FALSE,
  detected_at TIMESTAMPTZ DEFAULT now(), 
  created_at TIMESTAMPTZ DEFAULT now(),  

  CONSTRAINT fk_log_session
    FOREIGN KEY (cart_session_id) REFERENCES cart_session (cart_session_id) ON DELETE CASCADE,

  CONSTRAINT fk_log_device
    FOREIGN KEY (cart_device_id) REFERENCES cart_device (cart_device_id),

  CONSTRAINT fk_log_product
    FOREIGN KEY (product_id) REFERENCES product (product_id)
);


CREATE TABLE payment_method (
  method_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,

  method_type payment_method_type NOT NULL,  

  billing_key VARCHAR(255),

  card_brand VARCHAR(30),       
  card_last4 CHAR(4),            


  is_default BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT fk_method_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX uq_payment_method_user_billing_key
  ON payment_method (user_id, billing_key)
  WHERE billing_key IS NOT NULL;


CREATE TABLE payment (
  payment_id BIGSERIAL PRIMARY KEY,
  cart_session_id BIGINT UNIQUE,
  user_id BIGINT NOT NULL,

  method_id BIGINT,

  pg_provider pg_provider_type NOT NULL,  
  pg_tid VARCHAR(255),                    

  status payment_status NOT NULL DEFAULT 'PENDING',
  total_amount INTEGER NOT NULL,
  approved_at TIMESTAMPTZ,

  CONSTRAINT fk_payment_session
    FOREIGN KEY (cart_session_id) REFERENCES cart_session (cart_session_id),

  CONSTRAINT fk_payment_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id),

  CONSTRAINT fk_payment_method
    FOREIGN KEY (method_id) REFERENCES payment_method (method_id)
);


CREATE TABLE ledger_entry (
  ledger_entry_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL,
  payment_id BIGINT,

  spend_date DATE NOT NULL,
  category ledger_category NOT NULL DEFAULT 'ETC',
  amount INTEGER NOT NULL,

  CONSTRAINT fk_ledger_user
    FOREIGN KEY (user_id) REFERENCES app_user (user_id) ON DELETE CASCADE,

  CONSTRAINT fk_ledger_payment
    FOREIGN KEY (payment_id) REFERENCES payment (payment_id) ON DELETE SET NULL
);

```

```api ëª…ì„¸ csvíŒŒì¼

ID,ë°± êµ¬í˜„,êµ¬ë¶„,method,URI,API,ì„¤ëª…
íšŒì›,Yes,íšŒì› ì •ë³´ ì¡°íšŒ(User Router),,/api/users/me
íšŒì›,Yes,ë‹‰ë„¤ì„ ë³€ê²½(User Router),,/api/users/me/nickname
íšŒì›,Yes,ë¹„ë°€ë²ˆí˜¸ ë³€ê²½(User Router),,/api/users/me/password
ì¸ì¦,Yes,í† í° ê°±ì‹ (Auth Router),,/api/auth/refresh
ì¸ì¦,Yes,êµ¬ê¸€ ë¡œê·¸ì¸(Auth Router),,/api/auth/google
ì¸ì¦,Yes,êµ¬ê¸€ ì½œë°±(Auth Router),,/api/auth/google/callback
ì¸ì¦,Yes,ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸(Auth Router),,/api/auth/kakao
ì¸ì¦,Yes,ì¹´ì¹´ì˜¤ ì½œë°±(Auth Router),,/api/auth/kakao/callback
ìƒí’ˆ,Yes,ìƒí’ˆ ëª©ë¡ ì¡°íšŒ,/api/products/
ìƒí’ˆ,Yes,ìƒí’ˆ ê²€ìƒ‰,/api/products/search
ìƒí’ˆ,Yes,ìƒí’ˆ ìƒì„¸,/api/products/{product_id}
ìƒí’ˆ,Yes,ìƒí’ˆ ìœ„ì¹˜,/api/products/{product_id}/location
ì¹´íŠ¸,Yes,ì¹´íŠ¸ QR ë¡œê·¸ì¸,/api/carts/pair/qr
ì¹´íŠ¸,Yes,ì¹´íŠ¸ ì„¸ì…˜ ìƒì„±,/api/carts/
ì¹´íŠ¸,Yes,ì¹´íŠ¸ ì„¸ì…˜ ì¡°íšŒ,/api/carts/{session_id}
ì¹´íŠ¸,Yes,ìƒí’ˆ ì¶”ê°€,/api/carts/{session_id}/items
ì¹´íŠ¸,Yes,ìƒí’ˆ ì œê±°,/api/carts/items/{cart_item_id}
ì¹´íŠ¸,Yes,ìƒí’ˆ ìˆ˜ëŸ‰ ë³€ê²½,/api/carts/items/{cart_item_id}
ì¹´íŠ¸,Yes,ìš”ë¦¬ ì„ íƒ,/api/carts/{session_id}/select-recipe
ì¹´íŠ¸,Yes,ë¬´ê²Œ ê²€ì¦,/api/carts/weight/validate
ì¹´íŠ¸,Yes,ì¹´íŠ¸ ì„¸ì…˜ ì·¨ì†Œ,/api/carts/{session_id}/cancel
ì¹´íŠ¸,Yes,ì¹´ë©”ë¼ ë·° ì¼œê¸°,/api/carts/{cart_session_id}/camera/view/on
ì¹´íŠ¸,Yes,ì¹´ë©”ë¼ ë·° ë„ê¸°,/api/carts/{cart_session_id}/camera/view/off
ì¶”ì²œ,Yes,ì¬ë£Œ ê¸°ë°˜ ë ˆì‹œí”¼ ì¶”ì²œ,/api/recommendations/by-product/{product_id}
ê²°ì œ,Yes,ê²°ì œ ìš”ì²­,/api/payments/request
ê²°ì œ,Yes,ìë™ê²°ì œ ë“±ë¡ ì¤€ë¹„,/api/payments/subscription/register/ready
ê²°ì œ,Yes,ìë™ê²°ì œ ë“±ë¡ ìŠ¹ì¸,/api/payments/subscription/register/approve
ê²°ì œ,Yes,ìë™ê²°ì œ ì‹¤í–‰,/api/payments/subscription/pay
ê²°ì œ,Yes,ê²°ì œ ì¤€ë¹„,/api/payments/ready
ê²°ì œ,Yes,ê²°ì œ ìŠ¹ì¸,/api/payments/approve
ê²°ì œ,Yes,ê²°ì œ ìƒì„¸ ì¡°íšŒ,/api/payments/{payment_id}
ê²°ì œ,Yes,ê²°ì œ ìˆ˜ë‹¨ ëª©ë¡,/api/payments/methods
ê²°ì œ,Yes,ê²°ì œ ìˆ˜ë‹¨ ë“±ë¡,/api/payments/methods
ê²°ì œ,Yes,ê²°ì œ ìˆ˜ë‹¨ ì‚­ì œ,/api/payments/methods/{method_id}
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ë‚´ì—­ ì¡°íšŒ,/api/ledger
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ìº˜ë¦°ë”,/api/ledger/calendar
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ì›”ë³„ ìš”ì•½,/api/ledger/summary/monthly
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ìƒìœ„ ì¹´í…Œê³ ë¦¬,/api/ledger/top-categories
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ìƒìœ„ ìƒí’ˆ,/api/ledger/top-items
ê°€ê³„ë¶€,Yes,ìµœê·¼ ì§€ì¶œ ë‚´ì—­,/api/ledger/recent
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ë‹¨ê±´ ìƒì„¸,/api/ledger/{ledger_entry_id}
ê°€ê³„ë¶€,Yes,ê°€ê³„ë¶€ ì •ë³´ ìˆ˜ì •,/api/ledger/{ledger_entry_id}

```

```commit ì»¨ë²¤ì…˜
# **Commit Convention Specification**

## **1. ëª©ì  (Purpose)**

ë³¸ ë¬¸ì„œëŠ” íŒ€ ë‚´ Git ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™(Commit Convention)ì„ ì •ì˜í•˜ì—¬, ì¼ê´€ëœ ë³€ê²½ ì´ë ¥ ê´€ë¦¬ì™€ ëª…í™•í•œ ë³€ê²½ ì˜ë„ ì „ë‹¬ì„ ëª©í‘œë¡œ í•œë‹¤.

## **2. ê¸°ë³¸ êµ¬ì¡° (Structure)**

ëª¨ë“  ì»¤ë°‹ ë©”ì‹œì§€ëŠ” ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¥¸ë‹¤.

```
type: subject
```

- **type**: ì»¤ë°‹ì˜ ì„±ê²© (í•„ìˆ˜)
- **subject**: ë³€ê²½ ìš”ì•½ (í•„ìˆ˜, 50ì ì´ë‚´)

## **3. Type ê·œì¹™**

| **Type** | **Description** |
| --- | --- |
| âœ¨ feat | ì‹ ê·œ ê¸°ëŠ¥ ì¶”ê°€ |
| ğŸ› fix | ë²„ê·¸ ìˆ˜ì • |
| ğŸ“ docs | ë¬¸ì„œ ê´€ë ¨ ë³€ê²½ |
| â™»ï¸ refactor | ê¸°ëŠ¥ ë³€ê²½ ì—†ëŠ” ì½”ë“œ êµ¬ì¡° ê°œì„  |
| ğŸš€ deploy | CI/CD ì„¤ì • ë³€ê²½ |
| ğŸ”§ chore | ê¸°ëŠ¥ ì™¸ ìì˜í•œ ìˆ˜ì • (ì˜ˆ: ì„¤ì •, í™˜ê²½ íŒŒì¼ ë“±) |
| ğŸ—‘ï¸ remove | ë¶ˆí•„ìš”í•œ íŒŒì¼ ë˜ëŠ” ì½”ë“œ ì‚­ì œ |
|  |  |

## **4. Subject ê·œì¹™**

- ë©”ì‹œì§€ëŠ” ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ì‘ì„±í•œë‹¤. (50ì ì´ë‚´)
- ë³€ê²½ ë‚´ìš©ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆê²Œ ì‘ì„±í•œë‹¤.
- í•„ìš” ì‹œ ì—¬ëŸ¬ ë¬¸ë‹¨ìœ¼ë¡œ êµ¬ë¶„ ê°€ëŠ¥

ì˜ˆì‹œ:

```
refactor(user): ìœ íš¨ì„± ê²€ì‚¬ ë¡œì§ ë¶„ë¦¬
- ê¸°ì¡´ ì¤‘ë³µëœ validation ë¡œì§ì„ common/utilsë¡œ ì´ë™í•˜ì—¬ ì¬ì‚¬ìš©ì„± í™•ë³´
- ì´ë¡œ ì¸í•´ ì¤‘ë³µ ì½”ë“œ ê°ì†Œ ë° ìœ ì§€ë³´ìˆ˜ íš¨ìœ¨ì„± í–¥ìƒ
```

## **5. ì‘ì„± ê·œì¹™ ìš”ì•½**

- ì»¤ë°‹ì€ **ì˜ë¯¸ ìˆëŠ” ìµœì†Œ ë‹¨ìœ„**ë¡œ ë¶„ë¦¬í•œë‹¤.
- **í•˜ë‚˜ì˜ ì»¤ë°‹ì—ëŠ” í•˜ë‚˜ì˜ ëª©ì **ë§Œ í¬í•¨í•œë‹¤.
- PR ë¦¬ë·° ì‹œ `type`ê³¼ `scope`ë¥¼ í†µí•´ ë³€ê²½ ëª©ì ì„ ëª…í™•íˆ í•œë‹¤.
- íŒ€ ì „ì²´ê°€ ë™ì¼í•œ í˜•ì‹ì„ ì¤€ìˆ˜í•˜ë©°, í•„ìš” ì‹œ **commitlint**ë¡œ ìë™ ê²€ì¦í•œë‹¤.

## **6. ì˜ˆì‹œ ëª©ë¡**

```
feat: íšŒì›ê°€ì… ì‹œ ì´ë©”ì¼ ì¤‘ë³µ ê²€ì‚¬ ê¸°ëŠ¥ ì¶”ê°€
fix(auth): í† í° ë§Œë£Œ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
docs: README ì„¤ì¹˜ ê°€ì´ë“œ ë³´ì™„
refactor: userService ë¡œì§ ë¶„ë¦¬ ë° í•¨ìˆ˜ëª… ìˆ˜ì •
deploy: GitHub Actions í…ŒìŠ¤íŠ¸ ë‹¨ê³„ ì¶”ê°€
chore: ESLint ì„¤ì • íŒŒì¼ ì—…ë°ì´íŠ¸
remove: ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” mock ë°ì´í„° ì‚­ì œ
```


==================================================
FILE PATH: .\HWdocs.md
==================================================
# ğŸ“ AIoT Smart Cart â€“ Hardware Specification

ë³¸ ë¬¸ì„œëŠ” AIoT ìŠ¤ë§ˆíŠ¸ ì‡¼í•‘ì¹´íŠ¸ í”„ë¡œì íŠ¸ì˜ í•˜ë“œì›¨ì–´ ì„¤ê³„ ê¸°ì¤€ ë° ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ì¹˜ìˆ˜ë¥¼ ì •ì˜í•œë‹¤.  
3D í”„ë¦°íŒ… ê¸°ë°˜ í•˜ìš°ì§• ì„¤ê³„ë¥¼ ëª©ì ìœ¼ë¡œ í•˜ë©°, ëª¨ë“  ì¹˜ìˆ˜ëŠ” ì‹¤ì œ ì œì‘ ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•˜ì—¬ ê³µì°¨ë¥¼ í¬í•¨í•œë‹¤.

---

## ğŸ–¨ 1. 3D Printer

### Printer Model
- **Bambu Lab HS2**

### Global Tolerance Policy
- ëª¨ë“  ë¼ì›Œë§ì¶¤ êµ¬ì¡°ë¬¼ì€ **Â±0.3 mm ê³µì°¨**ë¥¼ ê¸°ë³¸ ì ìš©í•œë‹¤.

> ë³¸ í”„ë¡œì íŠ¸ì˜ ëª¨ë“  ê²°í•© êµ¬ì¡°ëŠ” *press-fit ê¸°ì¤€*ì´ë©°, í›„ê°€ê³µ ì—†ì´ ì¡°ë¦½ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„í•œë‹¤.

---

## ğŸ“º 2. LCD Display

### External Dimensions
| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width | 190.5 mm |
| Height | 114.6 mm |
| Depth | 16.7 mm |

### Active Display Area
| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width (Display Only) | 154.28 mm |
| Height (Display Only) | 86.12 mm |

### Design Notes
- ë² ì ¤ ê³ ì •ì„ ê³ ë ¤í•˜ì—¬ ì „ë©´ í™€ ê°€ê³µ ì‹œ +0.3 mm ì—¬ìœ  ì ìš©
- Display only ì˜ì—­ì€ í™”ë©´ ë…¸ì¶œ ì˜ì—­ìœ¼ë¡œ ë³„ë„ ì»·íŒ… í•„ìš”

---

## ğŸ§  3. Jetson Orin Nano

| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width | 103.5 mm |
| Height | 91 mm |
| Depth | 38 mm |

### Design Notes
- ë°©ì—´ ê³µê°„ í™•ë³´ í•„ìš” (ìƒë¶€ ìµœì†Œ 5 mm ê¶Œì¥)
- ë§ˆìš´íŠ¸ í™€ ìœ„ì¹˜ëŠ” ì‹¤ì œ PCB ê¸°ì¤€ìœ¼ë¡œ ì¬í™•ì¸ ì˜ˆì •

---

## ğŸ”‹ 4. Battery Housing

- âŒ í˜„ì¬ ë¯¸ì ìš©
- ì¶”í›„ ì „ì› ì„¤ê³„ í™•ì¥(power bank ì‚¬ìš©) ì‹œ ì¶”ê°€ ì˜ˆì •

---

## ğŸ›’ 5. Cart Knob Support

| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width | 30 mm |
| Height | 50 mm |
| Depth | 36.3 mm |

### Notes
- ì†ì¡ì´ ì²´ê²°ë¶€ ê¸°ì¤€ ì„¤ê³„
- ë‚´ë¶€ ì‚½ì… êµ¬ì¡° ì‹œ 0.3 mm ê³µì°¨ ì ìš©

---

## ğŸ“· 6. Camera Module

| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width | 36 mm |
| Height | 43 mm |
| Depth | 14 mm |

### Design Notes
- ì „ë©´ ë Œì¦ˆ í™€ì€ +0.5 mm ì—¬ìœ  ê¶Œì¥
- ì§„ë™ ë°©ì§€ë¥¼ ìœ„í•œ ê³ ë¬´ íŒ¨í‚¹ êµ¬ì¡° ê³ ë ¤

---

## ğŸ”§ 7. Cart Mount Assembly

### 7.1 Support Block

| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width | 30 mm |
| Height | 50 mm |
| Depth | 36 mm |
| Fillet Radius | 15 mm |

#### Port Clearance (Left Side Only)

Jetson Orin Nanoì˜ HDMI / USB í¬íŠ¸ë¥¼ ê³ ë ¤í•˜ì—¬ **Support Block ì¢Œì¸¡ë©´ì—ë§Œ** í¬íŠ¸ìš© ê´€í†µ í™€ì„ ì„¤ê³„í•œë‹¤.  
ìš°ì¸¡ë©´ì—ëŠ” í¬íŠ¸ í™€ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.

| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Width | 20 mm |
| Height | 13 mm |
| Depth | Through All |

##### Design Notes
- í¬íŠ¸ í™€ ìœ„ì¹˜ ê¸°ì¤€ì€ Jetson PCB ì‹¤ì¸¡ ê¸°ì¤€ìœ¼ë¡œ ìµœì¢… ë³´ì •
- ì¼€ì´ë¸” íƒˆì°© ì—¬ìœ  í™•ë³´ë¥¼ ìœ„í•´ ì£¼ë³€ +0.3 mm ê³µì°¨ ì ìš©
- í•´ë‹¹ í™€ì€ HDMI + USB ê³µìš© ì ‘ê·¼ìš©ì´ë©° ì§ì‚¬ê°í˜• ì»· í˜•íƒœ
- ì¢Œì¸¡ ë°©í–¥ ê¸°ì¤€: **Jetson ì¥ì°© ê¸°ì¤€ í¬íŠ¸ê°€ ìœ„ì¹˜í•œ ë©´**

### 7.2 Ring Clamp

| í•­ëª© | ì¹˜ìˆ˜ |
|------|------|
| Radius | 13 mm |

### Design Notes
- ì¹´íŠ¸ íŒŒì´í”„ ê¸°ì¤€ ì›í˜• í´ë¨í”„ êµ¬ì¡°
- Ring íŒŒíŠ¸ëŠ” íƒ„ì„± ì²´ê²° ë°©ì‹
- Support â†” Ring ì²´ê²°ë¶€ëŠ” ë¶„ë¦¬í˜• êµ¬ì¡° ê¶Œì¥

---

## âš– 8. Load Cell Housing

- í˜„ì¬ ë¯¸ì •

---

## ğŸ“Œ General Mechanical Guidelines

- ëª¨ë“  ì‚½ì… êµ¬ì¡°:
  - ê¸°ë³¸ ê³µì°¨: +0.3 mm
- ë‚˜ì‚¬ ì²´ê²°ë¶€:
  - M3 ê¸°ì¤€ Hole Diameter: 3.2 mm
- í”„ë¦°íŒ… ë°©í–¥:
  - ì²´ê²° í•˜ì¤‘ ë°©í–¥ ê¸°ì¤€ Layer ì •ë ¬
- Edge:
  - ì™¸ë¶€ ëª¨ì„œë¦¬ Fillet â‰¥ 2 mm ê¶Œì¥

---

## ğŸ“ Revision

| Version | Date | Description |
|--------|------|-------------|
| v1.0 | 2026-01 | Initial hardware specification |

---

End of Document


==================================================
FILE PATH: .\init_mlflow_db.py
==================================================
import mlflow.store.db.utils
from sqlalchemy import create_engine
engine = create_engine('postgresql://admin:password123@db:5432/mlflow')
mlflow.store.db.utils._initialize_tables(engine)
print("MLflow database initialized successfully.")

==================================================
FILE PATH: .\README.md
==================================================


==================================================
FILE PATH: .\ai\environment.yaml
==================================================
name: pickle_ai
channels:
  - pytorch
  - conda-forge
  - defaults
dependencies:
  - python=3.10.19
  # PyTorch 2.3.1 (CUDA ë²„ì „ì€ í™˜ê²½ì— ë§ê²Œ ìë™ ì„ íƒë˜ë„ë¡ ì¼ë°˜ì ìœ¼ë¡œ ëª…ì‹œí•˜ì§€ ì•Šìœ¼ë‚˜, í•„ìš”ì‹œ ìˆ˜ì • ê°€ëŠ¥)
  - pytorch=2.3.1
  - torchvision
  - torchaudio
  - numpy=1.26.4
  - pip
  - pip:
    - fastapi==0.128.0
    - uvicorn[standard]
    - ultralytics==8.4.2
    - opencv-python-headless>=4.8
    - albumentations==1.4.10
    - pillow==12.1.0
    - scikit-learn==1.5.2
    - pandas==2.2.2
    - requests
    - jupyterlab
    - matplotlib
    - python-multipart

==================================================
FILE PATH: .\ai\README.md
==================================================
# AI & Edge (Jetson Orin Nano)

ì´ ë””ë ‰í† ë¦¬ëŠ” **Jetson Orin Nano (Edge Device)** ë° ëª¨ë¸ í•™ìŠµ/ì „ì²˜ë¦¬ë¥¼ ìœ„í•œ AI ëª¨ë“ˆì„ ê´€ë¦¬í•©ë‹ˆë‹¤.



## 1. ë””ë ‰í† ë¦¬ êµ¬ì¡°

- **`inference/`**: YOLO ê¸°ë°˜ ê°ì²´ íƒì§€ ì¶”ë¡  ì„œë²„ (FastAPI)
  - Jetson ë° ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œ ì‹¤í–‰ (`main.py`)
  - ì¶”ë¡  ì „ resizing ë“± ì „ì²˜ë¦¬ ë¡œì§ í¬í•¨
- **`preprocessing/`**: ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ë° ì¦ê°•(Augmentation) ë¡œì§
  - ë¡œì»¬ ê°œë°œí™˜ê²½ì—ì„œ ë°ì´í„°ì…‹ ì¤€ë¹„ ì‹œ ì‚¬ìš©
- **`training/`**: ëª¨ë¸ í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸
  - GPU ì„œë²„ ë˜ëŠ” ë¡œì»¬ì—ì„œ í•™ìŠµ ì‹œ ì‚¬ìš©
- **`Dockerfile`**: í†µí•© Dockerfile (ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë° Jetson ë°°í¬ ê²¸ìš©)
- **`environment.yaml`**: Conda í™˜ê²½ ì„¤ì • íŒŒì¼ (ì•ˆì •ì„± ìœ„ì£¼ ì„¤ì •)



## 2. ê°œë°œ í™˜ê²½

- **Python**: 3.10.19
- **Framework**
  - PyTorch 2.3.1
  - Ultralytics 8.4.2 (YOLOv8/v11)
- **Key Libraries**
  - numpy 1.26.4 (ë²„ì „ ê³ ì •)
  - opencv-python-headless 4.8
  - albumentations 1.4.10



## 3. ì‹¤í–‰ ê°€ì´ë“œ (Local Development)

- `docker-compose`ë¥¼ í†µí•´ ì‹¤í–‰
- ë‹¨, AI ì¶”ë¡  ì„œë²„ëŠ” EC2 ë°°í¬ ì‹œ ì œì™¸ë˜ë„ë¡ ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë¡œì»¬ ê°œë°œ ì‹œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ë•ŒëŠ” **`--profile dev`** ì˜µì…˜ì´ í•„ìš”



### 3.1. AI ì„œë²„ í¬í•¨ ì „ì²´ ì‹¤í–‰

ë¡œì»¬ì—ì„œ AI ì¶”ë¡  ì„œë²„(`localhost:8001`)ê¹Œì§€ í¬í•¨í•˜ì—¬ ì „ì²´ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©

```bash
# ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰
docker compose --profile dev up --build -d
```

- ì‹¤í–‰ í›„ ì ‘ì†: `http://localhost:8001/` (AI Inference Server)
- Swagger Docs: `http://localhost:8001/docs`

### 3.2. AI ì„œë²„ ì œì™¸ ì‹¤í–‰ (ê¸°ë³¸)
AI ì„œë²„ ì—†ì´ ë°±ì—”ë“œ ë° ì¸í”„ë¼ë§Œ ì‹¤í–‰í•˜ë ¤ë©´ ê¸°ë³¸ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©(EC2 ë°°í¬ ì‹œ ë™ì‘ ë°©ì‹)

```bash
docker compose up -d
```



## 4. Jetson ë°°í¬ ì°¸ê³ 

Jetson Orin Nano í™˜ê²½ì—ì„œëŠ” `Dockerfile`ì˜ ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¥¼ `dustynv/l4t-pytorch` ë“±ìœ¼ë¡œ ë³€ê²½í•˜ê±°ë‚˜, í•´ë‹¹ í™˜ê²½ì— ë§ëŠ” `runtime: nvidia` ì„¤ì •ì„ ì¶”ê°€í•˜ì—¬ ë‹¨ë…ìœ¼ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.



==================================================
FILE PATH: .\ai\edge\cart_agent.py
==================================================
import time
import requests
import cv2
import os
from collections import Counter, deque
from ultralytics import YOLO

BACKEND_URL = os.getenv("BACKEND_URL", "https://bapsim.site") 
DEVICE_CODE = os.getenv("DEVICE_CODE", "CART-DEVICE-001")
MODEL_PATH = os.getenv("MODEL_PATH", "best.pt")
CONF_THRESHOLD = 0.5
CAMERA_INDEX = 0
WINDOW_SIZE = 30 
STABILIZATION_THRESHOLD = 0.9

def get_global_stabilized_state(buffer):
    state_history = []
    for frame_data in buffer:
        items_tuple = tuple(sorted(frame_data.items()))
        state_history.append(items_tuple)
    
    most_common_state, count = Counter(state_history).most_common(1)[0]
    stability_score = count / len(buffer)
    
    if stability_score >= STABILIZATION_THRESHOLD:
        inventory = [{"product_name": k, "quantity": v} for k, v in most_common_state]
        return inventory
    
    return None

def run_inference():
    try:
        model = YOLO(MODEL_PATH)
    except:
        model = YOLO("yolov8n.pt")
    
    cap = cv2.VideoCapture(CAMERA_INDEX)
    if not cap.isOpened():
        return

    detection_buffer = deque(maxlen=WINDOW_SIZE)
    last_sync_inventory = None 
    last_sync_time = 0

    try:
        while True:
            ret, frame = cap.read()
            if not ret: 
                time.sleep(0.1)
                continue

            results = model(frame, conf=CONF_THRESHOLD, verbose=False)
            
            current_frame_counts = Counter()
            for r in results:
                for box in r.boxes:
                    class_name = model.names[int(box.cls[0])]
                    current_frame_counts[class_name] += 1
            
            detection_buffer.append(dict(current_frame_counts))
            
            if len(detection_buffer) == WINDOW_SIZE:
                stabilized_inventory = get_global_stabilized_state(detection_buffer)
                
                if stabilized_inventory is not None:
                    current_time = time.time()
                    
                    if (stabilized_inventory != last_sync_inventory) or (current_time - last_sync_time > 15):
                        try:
                            resp = requests.post(
                                f"{BACKEND_URL}/api/carts/sync-by-device",
                                json={
                                    "device_code": DEVICE_CODE,
                                    "items": stabilized_inventory
                                },
                                timeout=2
                            )
                            if resp.status_code == 200:
                                last_sync_inventory = stabilized_inventory
                                last_sync_time = current_time
                                
                        except Exception:
                            pass

            time.sleep(0.05)

    except KeyboardInterrupt:
        pass
    finally:
        cap.release()

if __name__ == "__main__":
    run_inference()

==================================================
FILE PATH: .\ai\inference\main.py
==================================================
from fastapi import FastAPI, UploadFile, File, BackgroundTasks, Body, HTTPException
import os
import io
import sys
import mlflow
import asyncio
from contextlib import asynccontextmanager
from ultralytics import YOLO
from PIL import Image

# ==============================
# Path ì„¤ì •
# ==============================
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
try:
    from training.train import train as run_training
except ImportError:
    from ai.training.train import train as run_training

# ==============================
# Global State
# ==============================
model = None
is_training = False

MODEL_LOCAL_DIR = "models"
MODEL_FILENAME = "best.pt"
MODEL_PATH = os.path.join(MODEL_LOCAL_DIR, MODEL_FILENAME)

# í—ˆìš© ëª¨ë¸ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
ALLOWED_MODELS = {
    "yolov8n.pt",
    "yolov8s.pt",
    "yolov8m.pt",
    "yolo11n.pt",
    "yolo11s.pt"
}

# ==============================
# Background Training Wrapper
# ==============================
async def background_train_wrapper(
    epochs: int,
    experiment_name: str,
    model_name: str
):
    global is_training
    try:
        is_training = True
        print(f"[TRAIN] start | model={model_name}, epochs={epochs}, exp={experiment_name}")

        await asyncio.to_thread(
            run_training,
            epochs=epochs,
            experiment_name=experiment_name,
            model_name=model_name
        )

        print("[TRAIN] finished")
    except Exception as e:
        print(f"[TRAIN] failed: {e}")
    finally:
        is_training = False

# ==============================
# Lifespan (Startup / Shutdown)
# ==============================
@asynccontextmanager
async def lifespan(app: FastAPI):
    global model

    print("AI Inference Server Initializing...")

    os.makedirs(MODEL_LOCAL_DIR, exist_ok=True)

    # MLflow ì„¤ì •
    mlflow_uri = os.getenv("MLFLOW_TRACKING_URI", "http://mlflow:5000")
    mlflow.set_tracking_uri(mlflow_uri)

    # ==============================
    # MLflow run_id ê¸°ë°˜ ëª¨ë¸ ë‹¤ìš´ë¡œë“œ
    # ==============================
    run_id = os.getenv("MODEL_RUN_ID")
    if run_id:
        try:
            print(f"[MODEL] Downloading from MLflow run_id={run_id}")
            mlflow.artifacts.download_artifacts(
                run_id=run_id,
                artifact_path=f"weights/{MODEL_FILENAME}",
                dst_path=MODEL_LOCAL_DIR
            )
        except Exception as e:
            print(f"[MODEL] MLflow download failed: {e}")

    # ==============================
    # ëª¨ë¸ ë¡œë“œ
    # ==============================
    try:
        if os.path.exists(MODEL_PATH):
            print(f"[MODEL] Loading {MODEL_PATH}")
            model = YOLO(MODEL_PATH)
        else:
            print("[MODEL] best.pt not found â†’ loading yolov8n.pt")
            model = YOLO("yolov8n.pt")
    except Exception as e:
        print(f"[MODEL] load failed: {e}")
        model = YOLO("yolov8n.pt")

    yield
    print("AI Inference Server Shutting Down...")

# ==============================
# FastAPI App
# ==============================
app = FastAPI(
    title="Smart Cart AI Inference Server",
    lifespan=lifespan
)

# ==============================
# Health
# ==============================
@app.get("/health")
def health():
    return {
        "status": "ok",
        "model_loaded": model is not None,
        "is_training": is_training
    }

# ==============================
# Available Models
# ==============================
@app.get("/models")
def get_available_models():
    return {
        "allowed_base_models": sorted(list(ALLOWED_MODELS)),
        "local_models": [
            f for f in os.listdir(MODEL_LOCAL_DIR)
            if f.endswith(".pt")
        ]
    }

# ==============================
# Train API
# ==============================
@app.post("/train")
async def train_model(
    background_tasks: BackgroundTasks,
    epochs: int = Body(10, embed=True),
    experiment_name: str = Body("manual_trigger", embed=True),
    model_name: str = Body("yolov8s.pt", embed=True)
):
    global is_training

    if is_training:
        raise HTTPException(status_code=409, detail="Training already in progress")

    if model_name not in ALLOWED_MODELS:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid model_name. Allowed: {sorted(ALLOWED_MODELS)}"
        )

    background_tasks.add_task(
        background_train_wrapper,
        epochs=epochs,
        experiment_name=experiment_name,
        model_name=model_name
    )

    return {
        "message": "Training started",
        "epochs": epochs,
        "experiment": experiment_name,
        "model_name": model_name
    }

# ==============================
# Switch Serving Model (run_id)
# ==============================
@app.post("/model/switch")
def switch_model(run_id: str = Body(..., embed=True)):
    global model

    try:
        print(f"[MODEL] Switching to run_id={run_id}")
        mlflow.artifacts.download_artifacts(
            run_id=run_id,
            artifact_path=f"weights/{MODEL_FILENAME}",
            dst_path=MODEL_LOCAL_DIR
        )

        model = YOLO(MODEL_PATH)

        return {
            "message": "Model switched successfully",
            "run_id": run_id
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# ==============================
# Predict
# ==============================
@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    if not model:
        raise HTTPException(status_code=500, detail="Model not loaded")

    try:
        contents = await file.read()
        image = Image.open(io.BytesIO(contents))

        results = model.predict(image, imgsz=640)

        detections = []
        for r in results:
            for box in r.boxes:
                cls = int(box.cls)
                detections.append({
                    "class": cls,
                    "name": model.names[cls],
                    "confidence": float(box.conf),
                    "bbox": box.xyxy.tolist()[0]
                })

        return {
            "count": len(detections),
            "detections": detections
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# ==============================
# Run (local only)
# ==============================
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)


==================================================
FILE PATH: .\ai\inference\tests\run_once.py
==================================================
"""
ì˜ì¡´ì„± ë° í™˜ê²½ ì •ìƒ ë™ì‘ í™•ì¸ì„ ìœ„í•œ ë‹¨ë°œì„± ì¶”ë¡  í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
- ëª¨ë¸ ë¡œë”©
- ì´ë¯¸ì§€ ì…ë ¥
- ì¶”ë¡  íŒŒì´í”„ë¼ì¸ ê²€ì¦ìš©
"""


from ultralytics import YOLO

model = YOLO("models/best.pt")
results = model("test.jpg", save=True)

for r in results:
    print("boxes (xyxy):", r.boxes.xyxy)
    print("classes:", r.boxes.cls)
    print("conf:", r.boxes.conf)


==================================================
FILE PATH: .\ai\preprocessing\preprocess.py
==================================================
# ai/preprocessing/preprocess.py
import os

DATASET_PATH = "C:/Users/SSAFY/Desktop/smart-cart-detection.v1i.yolov8"


def validate_dataset():
    """
    YOLOv8 ë°ì´í„°ì…‹ ìµœì†Œ ì „ì²˜ë¦¬(ê²€ì¦)
    - train/images â†” train/labels 1:1
    - íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
    """

    img_dir = os.path.join(DATASET_PATH, "train/images")
    lbl_dir = os.path.join(DATASET_PATH, "train/labels")

    if not os.path.isdir(img_dir):
        raise FileNotFoundError("train/images not found")

    if not os.path.isdir(lbl_dir):
        raise FileNotFoundError("train/labels not found")

    imgs = {os.path.splitext(f)[0] for f in os.listdir(img_dir)}
    lbls = {os.path.splitext(f)[0] for f in os.listdir(lbl_dir)}

    diff = imgs ^ lbls
    if diff:
        raise ValueError(f"Image/Label mismatch: {len(diff)} files")

    print("[PREPROCESS] Dataset validation passed")


if __name__ == "__main__":
    validate_dataset()


==================================================
FILE PATH: .\ai\training\train.py
==================================================
# ==============================
# YOLOv8 Training Script (with MLflow)
# ==============================

import os
import mlflow
from ultralytics import YOLO

# --- [í•„ìˆ˜] Windows OpenMP ì¶©ëŒ ë°©ì§€ ---
os.environ["KMP_DUPLICATE_LIB_OK"] = "TRUE"

# ==============================
# Path / Env
# ==============================
DEFAULT_DATASET_PATH = "/data/dataset"
DATASET_PATH = os.getenv("DATASET_PATH", DEFAULT_DATASET_PATH)
DATA_YAML = os.path.join(DATASET_PATH, "data.yaml")

MLFLOW_TRACKING_URI = os.getenv("MLFLOW_TRACKING_URI", "http://mlflow:5000")
DEFAULT_EXPERIMENT_NAME = os.getenv(
    "MLFLOW_EXPERIMENT_NAME",
    "smart-cart-training"
)

# ==============================
# Train Function
# ==============================
def train(
    *,
    epochs: int = 50,
    imgsz: int = 640,
    batch: int = 16,
    device: object = 0,
    data_yaml: str = DATA_YAML,
    project: str = "/data/runs/train",
    name: str = "mlflow_run",
    experiment_name: str = DEFAULT_EXPERIMENT_NAME,
    model_name: str = "yolov8s.pt",
    **kwargs  # ğŸ”¥ [NEW] ëª¨ë“  ì¶”ê°€ íŒŒë¼ë¯¸í„°ë¥¼ ë°›ìŒ
):
    """
    YOLOv8 í•™ìŠµ + MLflow ë¡œê¹…

    Args:
        model_name: ì‚¬ì „í•™ìŠµ ëª¨ë¸ (.pt)
        experiment_name: MLflow experiment name
        **kwargs: model.train()ì— ì „ë‹¬í•  ëª¨ë“  ì¶”ê°€ íŒŒë¼ë¯¸í„° (mosaic, mixup, lr0, lrf ë“±)
    """

    # ==============================
    # MLflow Init
    # ==============================
    mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)
    mlflow.set_experiment(experiment_name)

    print(f"[MLflow] URI        : {MLFLOW_TRACKING_URI}")
    print(f"[MLflow] Experiment : {experiment_name}")
    print(f"[Training] Model    : {model_name}")

    # ==============================
    # Load Model
    # ==============================
    model = YOLO(model_name)

    # ==============================
    # MLflow Run
    # ==============================
    mlflow.end_run()  # í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” run ì •ë¦¬
    with mlflow.start_run() as run:
        run_id = run.info.run_id
        print(f"[MLflow] Run ID: {run_id}")

        # ==============================
        # Device Check
        # ==============================
        import torch
        if device == 0 and not torch.cuda.is_available():
            print("[Warning] CUDA not available â†’ CPU fallback")
            device = "cpu"

        # ==============================
        # Set Default Hyperparams
        # ==============================
        # ì‚¬ìš©ìê°€ kwargsë¡œ ë„˜ê¸°ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ ê¸°ë³¸ê°’ ì ìš©
        train_args = {
            "data": data_yaml,
            "imgsz": imgsz,
            "epochs": epochs,
            "batch": batch,
            "device": device,
            "workers": 0,  # Windows/Linux í˜¸í™˜ì„± ì•ˆì „ê°’
            
            # --- Augmentation Defaults ---
            "mosaic": 1.0,
            "mixup": 0.2,
            "fliplr": 0.5,
            "hsv_h": 0.015,
            "hsv_s": 0.7,
            "hsv_v": 0.4,
            
            # --- Stability Defaults ---
            "amp": True,
            "deterministic": True,
            "seed": 0,
            
            "project": project,
            "name": name,
            "exist_ok": True,
        }
        
        # kwargsë¡œ ë“¤ì–´ì˜¨ ê°’ì´ ìˆë‹¤ë©´ ë®ì–´ì“°ê¸° (Override)
        train_args.update(kwargs)

        # ==============================
        # Log Params
        # ==============================
        # ë¡œê¹…ì„ ìœ„í•´ model_nameë„ í¬í•¨
        log_params = train_args.copy()
        log_params["model_name"] = model_name
        mlflow.log_params(log_params)

        print("[Training] Start with params:", train_args)

        # ==============================
        # Train
        # ==============================
        results = model.train(**train_args)

        # ==============================
        # Metrics
        # ==============================
        metrics = {
            "mAP50": float(results.box.map50),
            "mAP50_95": float(results.box.map),
            "fitness": float(results.fitness)
        }
        mlflow.log_metrics(metrics)

        print(f"[MLflow] Metrics: {metrics}")

        # ==============================
        # Artifacts
        # ==============================
        best_model_path = os.path.join(
            results.save_dir,
            "weights",
            "best.pt"
        )

        if not os.path.exists(best_model_path):
            raise FileNotFoundError(
                f"best.pt not found at {best_model_path}"
            )

        # ğŸ”‘ AI ì„œë²„ì™€ ì•½ì†ëœ ê²½ë¡œ
        mlflow.log_artifact(
            best_model_path,
            artifact_path="weights"
        )

        # Optional: confusion matrix
        confusion_matrix = os.path.join(
            results.save_dir,
            "confusion_matrix.png"
        )
        if os.path.exists(confusion_matrix):
            mlflow.log_artifact(
                confusion_matrix,
                artifact_path="plots"
            )

        print("[MLflow] Artifacts uploaded")

        return run_id


# ==============================
# Local Run
# ==============================
if __name__ == "__main__":
    train()


==================================================
FILE PATH: .\backend\environment.yaml
==================================================
name: pickle_backend
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.12.9
  - pip
  - pip:
    - fastapi==0.128.0
    - uvicorn[standard]
    - sqlalchemy
    - psycopg2-binary
    - python-multipart
    - boto3
    - mlflow>=3.0.0
    - pytest
    - black
    - isort
    - httpx==0.28.1
    - python-dotenv==1.2.1
    - numpy==2.4.1


==================================================
FILE PATH: .\backend\export_project.py
==================================================
import os
import sys

# 1. ë‚´ìš©ì„ ì¶”ì¶œí•˜ê³  ì‹¶ì€ íŒŒì¼ í™•ì¥ìë“¤
TARGET_EXTENSIONS = {'.py', '.sql', '.md', '.txt', '.env'} 

# 2. ë¬´ì‹œí•  í´ë” ë° íŒŒì¼
IGNORE_DIRS = {'.git', '__pycache__', 'venv', '.venv', '.idea', '.vscode', 'migrations'}
IGNORE_FILES = {'export_project.py', 'poetry.lock', 'package-lock.json', 'project_context.txt'}

# ìœˆë„ìš° ì¸ì½”ë”© ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ì¶œë ¥ ê°•ì œ ì„¤ì •
sys.stdout.reconfigure(encoding='utf-8')

def print_tree(startpath):
    print(f"\n[Project Structure]: {startpath}")
    print("=" * 40)
    for root, dirs, files in os.walk(startpath):
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        level = root.replace(startpath, '').count(os.sep)
        indent = ' ' * 4 * (level)
        print(f'{indent}{os.path.basename(root)}/')
        subindent = ' ' * 4 * (level + 1)
        for f in files:
            if f not in IGNORE_FILES:
                print(f'{subindent}{f}')
    print("=" * 40 + "\n")

def export_files(startpath):
    print("[File Contents]")
    print("=" * 40)
    for root, dirs, files in os.walk(startpath):
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]

        for file in files:
            if file in IGNORE_FILES:
                continue
            
            _, ext = os.path.splitext(file)
            if ext not in TARGET_EXTENSIONS:
                continue

            file_path = os.path.join(root, file)
            relative_path = os.path.relpath(file_path, startpath)

            print(f"\nStart of file: {relative_path}")
            print("-" * 40)
            try:
                # íŒŒì¼ì„ ì½ì„ ë•Œ ì—ëŸ¬ê°€ ë‚˜ë©´ ê±´ë„ˆëœ€
                with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                    print(f.read())
            except Exception as e:
                print(f"Error reading file: {e}")
            print("-" * 40)
            print(f"End of file: {relative_path}\n")

if __name__ == "__main__":
    current_dir = os.getcwd()
    # í•„ìš”í•˜ë©´ íŠ¹ì • í´ë”(app)ë§Œ ì§€ì • ê°€ëŠ¥:
    # current_dir = os.path.join(os.getcwd(), 'app')
    
    print_tree(current_dir)
    export_files(current_dir)

==================================================
FILE PATH: .\backend\README.md
==================================================
# Backend (Main API Server)

ì´ ë””ë ‰í† ë¦¬ëŠ” ì„œë¹„ìŠ¤ì˜ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë‹´ë‹¹í•˜ëŠ” **Main API Server**ì…ë‹ˆë‹¤.



## 1. ë””ë ‰í† ë¦¬ êµ¬ì¡°

- **`app/`**: FastAPI ì†ŒìŠ¤ ì½”ë“œ ë©”ì¸ íŒ¨í‚¤ì§€
  - **`main.py`**: ì•± ì§„ì…ì  ë° FastAPI ì„¤ì •
  - **`routers/`**: API ì—”ë“œí¬ì¸íŠ¸ ëª¨ìŒ
  - **`models.py`**: SQLAlchemy DB ëª¨ë¸ ì •ì˜
  - **`schemas.py`**: Pydantic DTO ì •ì˜
  - **`database.py`**: DB ì—°ê²° ì„¸ì…˜ ê´€ë¦¬
- **`Dockerfile`**: ë°±ì—”ë“œ ì„œë²„ ì»¨í…Œì´ë„ˆ ë¹Œë“œ íŒŒì¼
- **`requirements.txt`**: ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ëª©ë¡



## 2. ê°œë°œ í™˜ê²½

- **Language**: Python 3.12.9
- **Framework**: FastAPI 0.128.0
- **Database**: PostgreSQL 16.x (w/ pgvector)
- **Storage**: MinIO (S3 Compatible) 7.2.20



## 3. ì‹¤í–‰ ê°€ì´ë“œ



==================================================
FILE PATH: .\backend\alembic\env.py
==================================================
from logging.config import fileConfig

from sqlalchemy import engine_from_config
from sqlalchemy import pool

from alembic import context
import sys
from pathlib import Path

sys.path.append(str(Path(__file__).resolve().parents[1]))

from app.database import Base
from app.models import *

import os
from dotenv import load_dotenv

load_dotenv()

DATABASE_URL = os.getenv("DATABASE_URL")

if not DATABASE_URL:
    raise RuntimeError("DATABASE_URL is not set")


target_metadata = Base.metadata

# this is the Alembic Config object, which provides
# access to the values within the .ini file in use.
config = context.config
config.set_main_option("sqlalchemy.url", DATABASE_URL)

# Interpret the config file for Python logging.
# This line sets up loggers basically.
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata

# other values from the config, defined by the needs of env.py,
# can be acquired:
# my_important_option = config.get_main_option("my_important_option")
# ... etc.


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode.

    This configures the context with just a URL
    and not an Engine, though an Engine is acceptable
    here as well.  By skipping the Engine creation
    we don't even need a DBAPI to be available.

    Calls to context.execute() here emit the given string to the
    script output.

    """
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode.

    In this scenario we need to create an Engine
    and associate a connection with the context.

    """
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection, target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()


==================================================
FILE PATH: .\backend\alembic\versions\2b87114328d5_add_cart_session_pairing_token.py
==================================================
"""add cart session pairing token

Revision ID: 2b87114328d5
Revises: 82d52c882a35
Create Date: 2026-01-30 14:39:02.455285

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '2b87114328d5'
down_revision: Union[str, Sequence[str], None] = '82d52c882a35'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('cart_session', sa.Column('pairing_token', sa.String(length=64), nullable=True))
    op.add_column('cart_session', sa.Column('paired_at', sa.DateTime(timezone=True), nullable=True))
    op.create_unique_constraint(None, 'cart_session', ['pairing_token'])
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'cart_session', type_='unique')
    op.drop_column('cart_session', 'paired_at')
    op.drop_column('cart_session', 'pairing_token')
    # ### end Alembic commands ###


==================================================
FILE PATH: .\backend\alembic\versions\3fd7de1c788e_add_camera_on_to_cart_session.py
==================================================
"""add camera_on to cart_session

Revision ID: 3fd7de1c788e
Revises: 4e8c53bbb5bf
Create Date: 2026-01-30 09:57:10.020006

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '3fd7de1c788e'
down_revision: Union[str, Sequence[str], None] = '4e8c53bbb5bf'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('cart_session', sa.Column('camera_on', sa.Boolean(), nullable=True))
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('cart_session', 'camera_on')
    # ### end Alembic commands ###

==================================================
FILE PATH: .\backend\alembic\versions\4977b62bd2e4_remove_cart_session_pairing_fields.py
==================================================
"""remove cart session pairing fields

Revision ID: 4977b62bd2e4
Revises: 2b87114328d5
Create Date: 2026-01-30 14:50:33.934586

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '4977b62bd2e4'
down_revision: Union[str, Sequence[str], None] = '2b87114328d5'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(op.f('cart_session_pairing_token_key'), 'cart_session', type_='unique')
    op.drop_column('cart_session', 'paired_at')
    op.drop_column('cart_session', 'pairing_token')
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('cart_session', sa.Column('pairing_token', sa.VARCHAR(length=64), autoincrement=False, nullable=True))
    op.add_column('cart_session', sa.Column('paired_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=True))
    op.create_unique_constraint(op.f('cart_session_pairing_token_key'), 'cart_session', ['pairing_token'], postgresql_nulls_not_distinct=False)
    # ### end Alembic commands ###


==================================================
FILE PATH: .\backend\alembic\versions\4e8c53bbb5bf_initial_migration.py
==================================================
"""initial_migration

Revision ID: 4e8c53bbb5bf
Revises: 
Create Date: 2026-01-30 14:28:40.290367

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
import pgvector

# revision identifiers, used by Alembic.
revision: str = '4e8c53bbb5bf'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('app_user',
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('email', sa.String(length=255), nullable=False),
    sa.Column('provider', sa.Enum('LOCAL', 'GOOGLE', 'KAKAO', name='userprovider'), nullable=False),
    sa.Column('nickname', sa.String(length=40), nullable=False),
    sa.Column('password_hash', sa.String(length=255), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('user_id'),
    sa.UniqueConstraint('email')
    )
    op.create_index(op.f('ix_app_user_user_id'), 'app_user', ['user_id'], unique=False)
    op.create_table('cart_device',
    sa.Column('cart_device_id', sa.Integer(), nullable=False),
    sa.Column('device_code', sa.String(length=64), nullable=False),
    sa.PrimaryKeyConstraint('cart_device_id'),
    sa.UniqueConstraint('device_code')
    )
    op.create_index(op.f('ix_cart_device_cart_device_id'), 'cart_device', ['cart_device_id'], unique=False)
    op.create_table('product_category',
    sa.Column('category_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=60), nullable=False),
    sa.Column('zone_code', sa.String(length=30), nullable=True),
    sa.PrimaryKeyConstraint('category_id'),
    sa.UniqueConstraint('name')
    )
    op.create_index(op.f('ix_product_category_category_id'), 'product_category', ['category_id'], unique=False)
    op.create_table('recipe',
    sa.Column('recipe_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('instructions', sa.Text(), nullable=True),
    sa.Column('image_url', sa.Text(), nullable=True),
    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('recipe_id')
    )
    op.create_index(op.f('ix_recipe_recipe_id'), 'recipe', ['recipe_id'], unique=False)
    op.create_table('cart_session',
    sa.Column('cart_session_id', sa.Integer(), nullable=False),
    sa.Column('cart_device_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.Enum('ACTIVE', 'CHECKOUT_REQUESTED', 'PAID', 'CANCELLED', name='cartsessionstatus'), nullable=False),
    sa.Column('budget_limit', sa.Integer(), nullable=True),
    sa.Column('expected_total_g', sa.Integer(), nullable=True),
    sa.Column('measured_total_g', sa.Integer(), nullable=True),
    sa.Column('started_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('ended_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['cart_device_id'], ['cart_device.cart_device_id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['app_user.user_id'], ),
    sa.PrimaryKeyConstraint('cart_session_id')
    )
    op.create_index(op.f('ix_cart_session_cart_session_id'), 'cart_session', ['cart_session_id'], unique=False)
    op.create_table('password_reset_token',
    sa.Column('token', sa.String(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('expires_at', sa.TIMESTAMP(), nullable=False),
    sa.Column('used', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['app_user.user_id'], ),
    sa.PrimaryKeyConstraint('token')
    )
    op.create_table('payment_method',
    sa.Column('method_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('method_type', sa.Enum('CARD', 'KAKAO_PAY', name='paymentmethodtype'), nullable=False),
    sa.Column('billing_key', sa.String(length=255), nullable=True),
    sa.Column('card_brand', sa.String(length=30), nullable=True),
    sa.Column('card_last4', sa.String(length=4), nullable=True),
    sa.Column('is_default', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['app_user.user_id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('method_id')
    )
    op.create_index(op.f('ix_payment_method_method_id'), 'payment_method', ['method_id'], unique=False)
    op.create_table('product',
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('category_id', sa.Integer(), nullable=True),
    sa.Column('barcode', sa.String(length=64), nullable=True),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('price', sa.Integer(), nullable=False),
    sa.Column('unit_weight_g', sa.Integer(), nullable=False),
    sa.Column('stock_quantity', sa.Integer(), nullable=True),
    sa.Column('image_url', sa.Text(), nullable=True),
    sa.Column('product_info', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['category_id'], ['product_category.category_id'], ),
    sa.PrimaryKeyConstraint('product_id'),
    sa.UniqueConstraint('barcode')
    )
    op.create_index(op.f('ix_product_product_id'), 'product', ['product_id'], unique=False)
    op.create_table('saved_recipe',
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('recipe_id', sa.Integer(), nullable=False),
    sa.Column('saved_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['recipe_id'], ['recipe.recipe_id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['app_user.user_id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id', 'recipe_id')
    )
    op.create_table('cart_detection_log',
    sa.Column('log_id', sa.Integer(), nullable=False),
    sa.Column('cart_session_id', sa.Integer(), nullable=False),
    sa.Column('cart_device_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=True),
    sa.Column('action_type', sa.Enum('ADD', 'REMOVE', name='detectionactiontype'), nullable=False),
    sa.Column('confidence_score', sa.Numeric(precision=5, scale=2), nullable=True),
    sa.Column('detected_weight_g', sa.Integer(), nullable=True),
    sa.Column('is_applied', sa.Boolean(), nullable=True),
    sa.Column('detected_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['cart_device_id'], ['cart_device.cart_device_id'], ),
    sa.ForeignKeyConstraint(['cart_session_id'], ['cart_session.cart_session_id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['product_id'], ['product.product_id'], ),
    sa.PrimaryKeyConstraint('log_id')
    )
    op.create_index(op.f('ix_cart_detection_log_log_id'), 'cart_detection_log', ['log_id'], unique=False)
    op.create_table('cart_item',
    sa.Column('cart_item_id', sa.Integer(), nullable=False),
    sa.Column('cart_session_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('quantity', sa.Integer(), nullable=False),
    sa.Column('unit_price', sa.Integer(), nullable=False),
    sa.Column('added_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['cart_session_id'], ['cart_session.cart_session_id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['product_id'], ['product.product_id'], ),
    sa.PrimaryKeyConstraint('cart_item_id')
    )
    op.create_index(op.f('ix_cart_item_cart_item_id'), 'cart_item', ['cart_item_id'], unique=False)
    op.create_table('payment',
    sa.Column('payment_id', sa.Integer(), nullable=False),
    sa.Column('cart_session_id', sa.Integer(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('method_id', sa.Integer(), nullable=True),
    sa.Column('pg_provider', sa.Enum('KAKAO_PAY', 'CARD_PG', name='pgprovidertype'), nullable=False),
    sa.Column('pg_tid', sa.String(length=255), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'APPROVED', 'FAILED', 'CANCELLED', name='paymentstatus'), nullable=False),
    sa.Column('total_amount', sa.Integer(), nullable=False),
    sa.Column('approved_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['cart_session_id'], ['cart_session.cart_session_id'], ),
    sa.ForeignKeyConstraint(['method_id'], ['payment_method.method_id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['app_user.user_id'], ),
    sa.PrimaryKeyConstraint('payment_id'),
    sa.UniqueConstraint('cart_session_id')
    )
    op.create_index(op.f('ix_payment_payment_id'), 'payment', ['payment_id'], unique=False)
    op.create_table('recipe_ingredient',
    sa.Column('recipe_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('quantity_info', sa.String(length=50), nullable=True),
    sa.Column('importance_score', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['product.product_id'], ),
    sa.ForeignKeyConstraint(['recipe_id'], ['recipe.recipe_id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('recipe_id', 'product_id')
    )
    op.create_table('ledger_entry',
    sa.Column('ledger_entry_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('payment_id', sa.Integer(), nullable=True),
    sa.Column('spend_date', sa.Date(), nullable=False),
    sa.Column('category', sa.Enum('GROCERY', 'MEAT', 'DAIRY', 'BEVERAGE', 'SNACK', 'HOUSEHOLD', 'ETC', name='ledgercategory'), nullable=False),
    sa.Column('amount', sa.Integer(), nullable=False),
    sa.Column('memo', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['payment_id'], ['payment.payment_id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['app_user.user_id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('ledger_entry_id')
    )
    op.create_index(op.f('ix_ledger_entry_ledger_entry_id'), 'ledger_entry', ['ledger_entry_id'], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_ledger_entry_ledger_entry_id'), table_name='ledger_entry')
    op.drop_table('ledger_entry')
    op.drop_table('recipe_ingredient')
    op.drop_index(op.f('ix_payment_payment_id'), table_name='payment')
    op.drop_table('payment')
    op.drop_index(op.f('ix_cart_item_cart_item_id'), table_name='cart_item')
    op.drop_table('cart_item')
    op.drop_index(op.f('ix_cart_detection_log_log_id'), table_name='cart_detection_log')
    op.drop_table('cart_detection_log')
    op.drop_table('saved_recipe')
    op.drop_index(op.f('ix_product_product_id'), table_name='product')
    op.drop_table('product')
    op.drop_index(op.f('ix_payment_method_method_id'), table_name='payment_method')
    op.drop_table('payment_method')
    op.drop_table('password_reset_token')
    op.drop_index(op.f('ix_cart_session_cart_session_id'), table_name='cart_session')
    op.drop_table('cart_session')
    op.drop_index(op.f('ix_recipe_recipe_id'), table_name='recipe')
    op.drop_table('recipe')
    op.drop_index(op.f('ix_product_category_category_id'), table_name='product_category')
    op.drop_table('product_category')
    op.drop_index(op.f('ix_cart_device_cart_device_id'), table_name='cart_device')
    op.drop_table('cart_device')
    op.drop_index(op.f('ix_app_user_user_id'), table_name='app_user')
    op.drop_table('app_user')
    # ### end Alembic commands ###


==================================================
FILE PATH: .\backend\alembic\versions\82d52c882a35_make_zone_code_and_category_id_not_null.py
==================================================
"""make zone_code and category_id not null

Revision ID: 82d52c882a35
Revises: 5e709302d134
Create Date: 2026-01-30 14:09:57.462673

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '82d52c882a35'
down_revision: Union[str, Sequence[str], None] = '5e709302d134'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('cart_session', 'camera_on')
    op.alter_column('product', 'category_id',
               existing_type=sa.INTEGER(),
               nullable=False)
    op.alter_column('product_category', 'zone_code',
               existing_type=sa.VARCHAR(length=30),
               nullable=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.alter_column('product_category', 'zone_code',
               existing_type=sa.VARCHAR(length=30),
               nullable=True)
    op.alter_column('product', 'category_id',
               existing_type=sa.INTEGER(),
               nullable=True)
    op.add_column('cart_session', sa.Column('camera_on', sa.BOOLEAN(), autoincrement=False, nullable=True))
    # ### end Alembic commands ###


==================================================
FILE PATH: .\backend\alembic\versions\e0e8a64d1b86_rename_camera_on_to_camera_view_on.py
==================================================
"""rename camera_on to camera_view_on

Revision ID: e0e8a64d1b86
Revises: 3fd7de1c788e
Create Date: 2026-01-30 10:43:43.631679

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'e0e8a64d1b86'
down_revision: Union[str, Sequence[str], None] = '3fd7de1c788e'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade():
    op.add_column(
        "cart_session",
        sa.Column("camera_view_on", sa.Boolean(), server_default="false", nullable=False)
    )
    op.drop_column("cart_session", "camera_on")


def downgrade():
    op.add_column(
        "cart_session",
        sa.Column("camera_on", sa.Boolean(), server_default="false", nullable=False)
    )
    op.drop_column("cart_session", "camera_view_on")

==================================================
FILE PATH: .\backend\app\check_data.py
==================================================
# backend/check_data.py
from sqlalchemy import text
from app.database import SessionLocal
from app import models

def check_db():
    db = SessionLocal()
    try:
        print("====== ğŸ” DB ë°ì´í„° ì ê²€ ======")
        
        # 1. ìƒí’ˆ(Product) í™•ì¸
        products = db.query(models.Product).all()
        print(f"\nğŸ§… [ìƒí’ˆ] ì´ {len(products)}ê°œ")
        for p in products:
            print(f" - ID: {p.product_id}, ì´ë¦„: {p.name}")

        # 2. ë ˆì‹œí”¼(Recipe) í™•ì¸
        recipes = db.query(models.Recipe).all()
        print(f"\nğŸ² [ë ˆì‹œí”¼] ì´ {len(recipes)}ê°œ")
        for r in recipes:
            print(f" - ID: {r.recipe_id}, ì´ë¦„: {r.title}")

        # 3. ì—°ê²°ê³ ë¦¬(RecipeIngredient) í™•ì¸ (ì—¬ê¸°ê°€ í•µì‹¬!)
        links = db.query(models.RecipeIngredient).all()
        print(f"\nğŸ”— [ì—°ê²°] ì´ {len(links)}ê°œ")
        for l in links:
            print(f" - ë ˆì‹œí”¼({l.recipe_id}) <-> ì¬ë£Œ({l.product_id}) | ì ìˆ˜: {l.importance_score}")

        if not links:
            print("\nâŒ ë¬¸ì œ ë°œê²¬: ìƒí’ˆê³¼ ë ˆì‹œí”¼ëŠ” ìˆëŠ”ë° 'ì—°ê²°' ë°ì´í„°ê°€ ì—†ë„¤ìš”!")
            print("   -> seed_data.pyë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.")
        else:
            print("\nâœ… ë°ì´í„°ëŠ” ì •ìƒì…ë‹ˆë‹¤. product_idë¥¼ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”.")

    except Exception as e:
        print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    check_db()

==================================================
FILE PATH: .\backend\app\database.py
==================================================
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.db.base import Base   

SQLALCHEMY_DATABASE_URL = os.getenv(
    "DATABASE_URL",
    "postgresql+psycopg2://admin:password123@localhost:5432/postgres"
)


connect_args = {}
if "sqlite" in SQLALCHEMY_DATABASE_URL:
    connect_args = {"check_same_thread": False}

engine = create_engine(
    SQLALCHEMY_DATABASE_URL, 
    connect_args=connect_args
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


==================================================
FILE PATH: .\backend\app\dependencies.py
==================================================
# app/dependencies.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.orm import Session

from app.database import get_db
from app.models import AppUser
from app.utils.jwt import decode_token

security = HTTPBearer()

def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: Session = Depends(get_db),
) -> AppUser:
    token = credentials.credentials  

    payload = decode_token(token)
    if payload is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token",
        )

    user_id = payload.get("sub")
    if user_id is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token",
        )

    user = db.get(AppUser, int(user_id))
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found",
        )

    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Inactive user",
        )

    return user



==================================================
FILE PATH: .\backend\app\init_db.py
==================================================
# init_db.py
from sqlalchemy import text
from app.database import SessionLocal

def init_db():
    db = SessionLocal()
    try:
        # 1. ë²¡í„° í™•ì¥ê¸°ëŠ¥ ì¼œê¸°
        print("DBì— ë²¡í„° ê¸°ëŠ¥ì„ ì¼œëŠ” ì¤‘...")
        db.execute(text("CREATE EXTENSION IF NOT EXISTS vector;"))
        db.commit()
        print("âœ… ì„±ê³µ! pgvector ê¸°ëŠ¥ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")

    except Exception as e:
        print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        print("í˜¹ì‹œ DBê°€ ì¼œì ¸ ìˆëŠ”ì§€, .env ì„¤ì •ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    finally:
        db.close()

if __name__ == "__main__":
    init_db()

==================================================
FILE PATH: .\backend\app\main.py
==================================================
from dotenv import load_dotenv
load_dotenv() # .env íŒŒì¼ì„ ì°¾ì•„ì„œ í™˜ê²½ë³€ìˆ˜ë¡œ ë¡œë“œí•¨
# ì•± ì‹¤í–‰ ì§„ì…ì 
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from .database import engine, Base
from . import models  # ìš°ë¦¬ê°€ ë§Œë“  models.pyë¥¼ ê°€ì ¸ì™€ì•¼ í…Œì´ë¸”ì„ ì¸ì‹í•©ë‹ˆë‹¤!
from .routers import cart, payment, user, auth, product, ledger, recommendation, recipe, admin # ë¼ìš°í„° íŒŒì¼ë“¤ ì„í¬íŠ¸

# â˜… í•µì‹¬: ì„œë²„ ì‹œì‘í•  ë•Œ DBì— ì—†ëŠ” í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ìƒì„±í•¨
# models.pyì— ì •ì˜ëœ í´ë˜ìŠ¤ë“¤ì„ ë³´ê³  ë§¤í•‘í•©ë‹ˆë‹¤.
# Base.metadata.create_all(bind=engine)

app = FastAPI(
    title="Pickle Project API",
    description="ìŠ¤ë§ˆíŠ¸ ì¹´íŠ¸ ë° ì¶”ì²œ/ê²°ì œ ì„œë¹„ìŠ¤ API",
    version="1.0.0"
)

import os

# CORS
frontend_url = os.getenv("FRONTEND_URL", "http://localhost:3000")
origins = [
    frontend_url,
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "http://localhost:8000",
    "http://127.0.0.1:8000",
    "https://bapsim.site",
    "http://bapsim.site",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ëª¨ë“  ê³³ì—ì„œ ì ‘ì† í—ˆìš© (ë³´ì•ˆìƒ ê°œë°œë•Œë§Œ ì‚¬ìš©)
    allow_credentials=True,
    allow_methods=["*"],  # ëª¨ë“  HTTP Method í—ˆìš© (GET, POST ë“±)
    allow_headers=["*"],  # ëª¨ë“  í—¤ë” í—ˆìš©
)

# ë¼ìš°í„° ë“±ë¡ (ë§Œë“¤ì–´ë‘” API ì—°ê²°)
# user.pyì˜ 2ê°œ ë¼ìš°í„°
app.include_router(user.auth_router)  # /auth/signup, /auth/login, /auth/logout
app.include_router(user.user_router)  # /users/me, /users/me/nickname, etc.

# ë‚˜ë¨¸ì§€ ë¼ìš°í„°
app.include_router(auth.router)       # /auth/refresh, /auth/google, /auth/kakao
app.include_router(product.router)
app.include_router(cart.router)
app.include_router(payment.router)
app.include_router(admin.router)
app.include_router(ledger.router)
app.include_router(recommendation.router)
app.include_router(recipe.router)

@app.get("/")
def read_root():
    return {"message": "Hello, Pickle! ì„œë²„ê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤."}

@app.get("/health")
def health():
    return {"status": "ok"}

==================================================
FILE PATH: .\backend\app\models.py
==================================================
from sqlalchemy import (
    Column, Integer, String, TIMESTAMP, ForeignKey, DateTime, Boolean, Text, Numeric, Date, Enum as SAEnum
)
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func
from sqlalchemy.dialects.postgresql import JSONB
from pgvector.sqlalchemy import Vector
import enum
from app.db.base import Base


# --- Enums (DB Enum Types) ---

class UserProvider(enum.Enum):
    LOCAL = "LOCAL"
    GOOGLE = "GOOGLE"
    KAKAO = "KAKAO"

class CartSessionStatus(enum.Enum):
    ACTIVE = "ACTIVE"
    CHECKOUT_REQUESTED = "CHECKOUT_REQUESTED"
    PAID = "PAID"
    CANCELLED = "CANCELLED"

class DetectionActionType(enum.Enum):
    ADD = "ADD"
    REMOVE = "REMOVE"

class PaymentMethodType(enum.Enum):
    CARD = "CARD"
    KAKAO_PAY = "KAKAO_PAY"

class PgProviderType(enum.Enum):
    KAKAO_PAY = "KAKAO_PAY"
    CARD_PG = "CARD_PG"

class PaymentStatus(enum.Enum):
    PENDING = "PENDING"
    APPROVED = "APPROVED"
    FAILED = "FAILED"
    CANCELLED = "CANCELLED"

class LedgerCategory(enum.Enum):
    GROCERY = "GROCERY"
    MEAT = "MEAT"
    DAIRY = "DAIRY"
    BEVERAGE = "BEVERAGE"
    SNACK = "SNACK"
    HOUSEHOLD = "HOUSEHOLD"
    ETC = "ETC"

# --- Models ---

class AppUser(Base):
    __tablename__ = "app_user"

    user_id = Column(Integer, primary_key=True, index=True)
    email = Column(String(255), unique=True, nullable=False)
    provider = Column(SAEnum(UserProvider), nullable=False, default=UserProvider.LOCAL)
    nickname = Column(String(40), nullable=False)
    password_hash = Column(String(255))
    created_at = Column(DateTime(timezone=True), nullable=False, default=func.now())
    updated_at = Column(DateTime(timezone=True), default=func.now(), onupdate=func.now())
    is_active = Column(Boolean, nullable=False, default=True)
    deleted_at = Column(DateTime(timezone=True), nullable=True)

    # Relationships
    saved_recipes = relationship("SavedRecipe", back_populates="user", cascade="all, delete-orphan")
    cart_sessions = relationship("CartSession", back_populates="user")
    payment_methods = relationship("PaymentMethod", back_populates="user", cascade="all, delete-orphan")
    payments = relationship("Payment", back_populates="user")
    ledger_entries = relationship("LedgerEntry", back_populates="user", cascade="all, delete-orphan")


class PasswordResetToken(Base):
    __tablename__ = "password_reset_token"

    token = Column(String, primary_key=True)
    user_id = Column( Integer, ForeignKey("app_user.user_id"), nullable=False)

    expires_at = Column(TIMESTAMP, nullable=False)
    used = Column(Boolean, default=False)

    created_at = Column(TIMESTAMP, server_default=func.now())


class ProductCategory(Base):
    __tablename__ = "product_category"

    category_id = Column(Integer, primary_key=True, index=True)
    name = Column(String(60), unique=True, nullable=False)
    zone_code = Column(String(30), nullable=False)

    # Relationships
    products = relationship("Product", back_populates="category")


class Product(Base):
    __tablename__ = "product"

    product_id = Column(Integer, primary_key=True, index=True)
    category_id = Column(Integer, ForeignKey("product_category.category_id"), nullable=False)
    barcode = Column(String(64), unique=True)
    name = Column(String(255), nullable=False)
    price = Column(Integer, nullable=False)
    unit_weight_g = Column(Integer, nullable=False)
    stock_quantity = Column(Integer, default=0)
    image_url = Column(Text)
    product_info = Column(JSONB)
    embedding = Column(Vector(1536))
    created_at = Column(DateTime(timezone=True), default=func.now())

    # Relationships
    category = relationship("ProductCategory", back_populates="products")
    cart_items = relationship("CartItem", back_populates="product")
    detection_logs = relationship("CartDetectionLog", back_populates="product")
    recipe_ingredients = relationship("RecipeIngredient", back_populates="product")


class Recipe(Base):
    __tablename__ = "recipe"

    recipe_id = Column(Integer, primary_key=True, index=True)
    title = Column(String(255), nullable=False)
    description = Column(Text)
    instructions = Column(Text)
    image_url = Column(Text)

    embedding = Column(Vector(1536))
    created_at = Column(DateTime(timezone=True), default=func.now())

    # Relationships
    ingredients = relationship("RecipeIngredient", back_populates="recipe", cascade="all, delete-orphan")
    saved_by_users = relationship("SavedRecipe", back_populates="recipe", cascade="all, delete-orphan")


class RecipeIngredient(Base):
    __tablename__ = "recipe_ingredient"

    recipe_id = Column(Integer, ForeignKey("recipe.recipe_id", ondelete="CASCADE"), primary_key=True)
    product_id = Column(Integer, ForeignKey("product.product_id"), primary_key=True)
    quantity_info = Column(String(50))
    importance_score = Column(Integer, default=1)

    # Relationships
    recipe = relationship("Recipe", back_populates="ingredients")
    product = relationship("Product", back_populates="recipe_ingredients")


class SavedRecipe(Base):
    __tablename__ = "saved_recipe"

    user_id = Column(Integer, ForeignKey("app_user.user_id", ondelete="CASCADE"), primary_key=True)
    recipe_id = Column(Integer, ForeignKey("recipe.recipe_id", ondelete="CASCADE"), primary_key=True)
    saved_at = Column(DateTime(timezone=True), default=func.now())

    # Relationships
    user = relationship("AppUser", back_populates="saved_recipes")
    recipe = relationship("Recipe", back_populates="saved_by_users")


class CartDevice(Base):
    __tablename__ = "cart_device"

    cart_device_id = Column(Integer, primary_key=True, index=True)
    device_code = Column(String(64), unique=True, nullable=False)

    # Relationships
    sessions = relationship("CartSession", back_populates="device")
    logs = relationship("CartDetectionLog", back_populates="device")


class CartSession(Base):
    __tablename__ = "cart_session"

    cart_session_id = Column(Integer, primary_key=True, index=True)
    cart_device_id = Column(Integer, ForeignKey("cart_device.cart_device_id"), nullable=False)
    user_id = Column(Integer, ForeignKey("app_user.user_id"))
    status = Column(SAEnum(CartSessionStatus), nullable=False, default=CartSessionStatus.ACTIVE)
    budget_limit = Column(Integer, default=0)
    expected_total_g = Column(Integer, default=0)
    measured_total_g = Column(Integer, default=0)
    started_at = Column(DateTime(timezone=True), nullable=False, default=func.now())
    ended_at = Column(DateTime(timezone=True))
    camera_view_on = Column(Boolean, default=False, nullable=False)

    # Relationships
    device = relationship("CartDevice", back_populates="sessions")
    user = relationship("AppUser", back_populates="cart_sessions")
    items = relationship("CartItem", back_populates="session", cascade="all, delete-orphan")
    logs = relationship("CartDetectionLog", back_populates="session", cascade="all, delete-orphan")
    payment = relationship("Payment", uselist=False, back_populates="session")


class CartItem(Base):
    __tablename__ = "cart_item"

    cart_item_id = Column(Integer, primary_key=True, index=True)
    cart_session_id = Column(Integer, ForeignKey("cart_session.cart_session_id", ondelete="CASCADE"), nullable=False)
    product_id = Column(Integer, ForeignKey("product.product_id"), nullable=False)
    quantity = Column(Integer, nullable=False, default=1)
    unit_price = Column(Integer, nullable=False)
    added_at = Column(DateTime(timezone=True), default=func.now())

    # Relationships
    session = relationship("CartSession", back_populates="items")
    product = relationship("Product", back_populates="cart_items")


class CartDetectionLog(Base):
    __tablename__ = "cart_detection_log"

    log_id = Column(Integer, primary_key=True, index=True)
    cart_session_id = Column(Integer, ForeignKey("cart_session.cart_session_id", ondelete="CASCADE"), nullable=False)
    cart_device_id = Column(Integer, ForeignKey("cart_device.cart_device_id"), nullable=False)
    product_id = Column(Integer, ForeignKey("product.product_id"))
    action_type = Column(SAEnum(DetectionActionType), nullable=False)
    confidence_score = Column(Numeric(5, 2))
    detected_weight_g = Column(Integer)
    is_applied = Column(Boolean, default=False)
    detected_at = Column(DateTime(timezone=True), default=func.now())
    created_at = Column(DateTime(timezone=True), default=func.now())

    # Relationships
    session = relationship("CartSession", back_populates="logs")
    device = relationship("CartDevice", back_populates="logs")
    product = relationship("Product", back_populates="detection_logs")


class PaymentMethod(Base):
    __tablename__ = "payment_method"

    method_id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("app_user.user_id", ondelete="CASCADE"), nullable=False)
    method_type = Column(SAEnum(PaymentMethodType), nullable=False)
    billing_key = Column(String(255))
    card_brand = Column(String(30))
    card_last4 = Column(String(4))
    is_default = Column(Boolean, nullable=False, default=False)
    created_at = Column(DateTime(timezone=True), default=func.now())

    # Relationships
    user = relationship("AppUser", back_populates="payment_methods")
    payments = relationship("Payment", back_populates="method")


class Payment(Base):
    __tablename__ = "payment"

    payment_id = Column(Integer, primary_key=True, index=True)
    cart_session_id = Column(Integer, ForeignKey("cart_session.cart_session_id"), unique=True)
    user_id = Column(Integer, ForeignKey("app_user.user_id"), nullable=False)
    method_id = Column(Integer, ForeignKey("payment_method.method_id"))
    pg_provider = Column(SAEnum(PgProviderType), nullable=False)
    pg_tid = Column(String(255))
    status = Column(SAEnum(PaymentStatus), nullable=False, default=PaymentStatus.PENDING)
    total_amount = Column(Integer, nullable=False)
    approved_at = Column(DateTime(timezone=True))

    # Relationships
    session = relationship("CartSession", back_populates="payment")
    user = relationship("AppUser", back_populates="payments")
    method = relationship("PaymentMethod", back_populates="payments")
    ledger_entries = relationship("LedgerEntry", back_populates="payment")


class LedgerEntry(Base):
    __tablename__ = "ledger_entry"

    ledger_entry_id = Column(Integer, primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("app_user.user_id", ondelete="CASCADE"), nullable=False)
    payment_id = Column(Integer, ForeignKey("payment.payment_id", ondelete="SET NULL"))
    spend_date = Column(Date, nullable=False)
    category = Column(SAEnum(LedgerCategory), nullable=False, default=LedgerCategory.ETC)
    amount = Column(Integer, nullable=False)
    memo = Column(Text)

    # Relationships
    user = relationship("AppUser", back_populates="ledger_entries")
    payment = relationship("Payment", back_populates="ledger_entries")


==================================================
FILE PATH: .\backend\app\schemas.py
==================================================
from pydantic import BaseModel, Field, EmailStr, field_validator, ConfigDict
from typing import Optional, List, Dict, Any
from datetime import datetime, date
from .models import PaymentMethodType, PgProviderType, PaymentStatus, LedgerCategory, DetectionActionType, UserProvider
import re


# =========================================================
# ğŸ’³ Payment Method Schemas (ê²°ì œ ìˆ˜ë‹¨)
# =========================================================

class PaymentMethodBase(BaseModel):
    method_type: PaymentMethodType
    billing_key: Optional[str] = None
    card_brand: Optional[str] = None
    card_last4: Optional[str] = Field(None, min_length=4, max_length=4)
    is_default: bool = False

class PaymentMethodCreate(PaymentMethodBase):
    pass

class PaymentMethodResponse(PaymentMethodBase):
    method_id: int
    user_id: int
    created_at: datetime

    class Config:
        from_attributes = True


# =========================================================
# ğŸ’° Payment Schemas (ê²°ì œ)
# =========================================================

# 1. ê²°ì œ ì¤€ë¹„ (Ready)
class PaymentReadyRequest(BaseModel):
    cart_session_id: int
    total_amount: int = Field(..., gt=0, description="ê²°ì œ ê¸ˆì•¡ì€ 0ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.") 
    method_id: Optional[int] = None

    model_config = ConfigDict(json_schema_extra={
        "example": {
            "cart_session_id": 12,
            "total_amount": 15000,
            "method_id": None
        }
    })

class PaymentReadyResponse(BaseModel):
    tid: str
    next_redirect_app_url: Optional[str] = None
    next_redirect_mobile_url: Optional[str] = None
    next_redirect_pc_url: Optional[str] = None
    created_at: datetime = Field(default_factory=datetime.now)
    partner_order_id: Optional[str] = None

# 2. ê²°ì œ ìŠ¹ì¸ (Approve)
class PaymentApproveRequest(BaseModel):
    tid: str
    pg_token: str
    partner_order_id: str
    partner_user_id: str

# 3. ê²°ì œ ë‚´ì—­ ì‘ë‹µ
class PaymentResponse(BaseModel):
    payment_id: int
    cart_session_id: Optional[int]
    user_id: int
    method_id: Optional[int]
    pg_provider: PgProviderType
    pg_tid: Optional[str]
    status: PaymentStatus
    total_amount: int
    approved_at: Optional[datetime]

    class Config:
        from_attributes = True

# 4. ê²°ì œ ì·¨ì†Œ
class PaymentCancelRequest(BaseModel):
    reason: str = "ì‚¬ìš©ì ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ"

class PaymentDetailResponse(PaymentResponse):
    items: List["CartItemResponse"] = []

# --- âœ¨ [NEW] ê²°ì œ ìš”ì²­ ë° ë¬´ê²Œ ê²€ì¦ (Checkout) ---

class PaymentRequest(BaseModel):
    """ì›¹ì—ì„œ ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì „ì†¡í•˜ëŠ” ë°ì´í„°"""
    cart_session_id: int
    amount: int
    measured_weight_g: int = Field(..., description="Jetson/ì„¼ì„œë¡œë¶€í„° ì¸¡ì •í•œ í˜„ì¬ ë¬´ê²Œ")
    use_subscription: bool = True  # ê¸°ë³¸ì ìœ¼ë¡œ ìë™ê²°ì œ ì‚¬ìš©

    model_config = ConfigDict(json_schema_extra={
        "example": {
            "cart_session_id": 5,
            "amount": 25000,
            "measured_weight_g": 1500,
            "use_subscription": True
        }
    })

class PaymentWarningResponse(BaseModel):
    """ë¬´ê²Œ ë¶ˆì¼ì¹˜ ì‹œ ë°˜í™˜í•˜ëŠ” ê²½ê³  ë°ì´í„° (409 Conflict)"""
    status: str = "WARNING"
    message: str
    difference: int
    expected_weight: int
    measured_weight: int
    action_required: str = "CHECK_CART_ITEMS"  # í”„ë¡ íŠ¸ì—”ë“œ ì‹ë³„ìš©


# =========================================================
# ğŸ”‘ Billing Key Schemas (ì¹´ë“œ ë“±ë¡)
# =========================================================

class CardRegisterResponse(BaseModel):
    next_redirect_mobile_url: str
    next_redirect_pc_url: str
    tid: str
    created_at: datetime

class CardRegisterResult(BaseModel):
    method_id: int
    card_name: str
    billing_key: str
    message: str = "ì¹´ë“œ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."


# =========================================================
# ğŸ“’ Ledger Schemas (ê°€ê³„ë¶€)
# =========================================================

class LedgerEntryResponse(BaseModel):
    ledger_entry_id: int
    user_id: int
    payment_id: Optional[int]
    spend_date: date
    category: LedgerCategory
    amount: int
    memo: Optional[str]

    class Config:
        from_attributes = True

class LedgerUpdateRequest(BaseModel):
    category: Optional[LedgerCategory] = None
    memo: Optional[str] = None

    model_config = ConfigDict(json_schema_extra={
        "example": {
            "category": "SNACK",
            "memo": "í¸ì˜ì  ê°„ì‹ êµ¬ë§¤"
        }
    })


# =========================================================
# ğŸ‘¤ User Schemas (íšŒì›)
# =========================================================

NICKNAME_REGEX = re.compile(r"^[A-Za-zê°€-í£]{2,20}$")

class UserBase(BaseModel):
    email: EmailStr
    nickname: str = Field(min_length=2, max_length=20)

class UserCreate(BaseModel):
    email: EmailStr
    password: str
    nickname: str

    @field_validator("password")
    @classmethod
    def validate_password(cls, value: str) -> str:
        if len(value) < 8:
            raise ValueError("Password must be at least 8 characters long")
        if not re.search(r"[A-Za-z]", value) or not re.search(r"\d", value):
            raise ValueError("Password must contain both letters and numbers")
        return value

    @field_validator("nickname")
    @classmethod
    def validate_nickname(cls, value: str) -> str:
        if not NICKNAME_REGEX.fullmatch(value):
            raise ValueError("Nickname must be 2â€“20 characters long and contain only Korean or English letters")
        return value
    
    model_config = ConfigDict(json_schema_extra={
        "example": {
            "email": "user@example.com",
            "password": "Password123!",
            "nickname": "í–‰ë³µí•œì‡¼í•‘"
        }
    })

class UserLogin(BaseModel):
    email: EmailStr
    password: str

    model_config = ConfigDict(json_schema_extra={
        "example": {
            "email": "user@example.com",
            "password": "Password123!"
        }
    })

class UserMeResponse(BaseModel):
    model_config = ConfigDict(from_attributes=True)
    user_id: int
    email: EmailStr
    provider: UserProvider
    nickname: str
    created_at: datetime
    updated_at: Optional[datetime]

class UserNicknameUpdate(BaseModel):
    nickname: str = Field(min_length=2, max_length=20)

class UserPasswordUpdate(BaseModel):
    current_password: str
    new_password: str

class UserPasswordResetRequest(BaseModel):
    email: EmailStr

class UserPasswordReset(BaseModel):
    token: str
    new_password: str = Field(min_length=8)

class TokenResponse(BaseModel):
    access_token: str
    refresh_token: Optional[str] = None
    token_type: str = "bearer"

class EmailCheckResponse(BaseModel):
    is_available: bool

class UserWithdraw(BaseModel):
    password: Optional[str] = None

class GoogleOAuthRequest(BaseModel):
    code: str


# =========================================================
# ğŸ›’ Cart Schemas (ì¥ë°”êµ¬ë‹ˆ)
# =========================================================

# ê¸°ê¸° ê¸°ë°˜ ìƒí’ˆ ë™ê¸°í™” (AI ì¶”ë¡  ì„œë²„ìš©)
class CartSyncItem(BaseModel):
    product_name: str
    quantity: int

class CartSyncRequest(BaseModel):
    device_code: str
    items: List[CartSyncItem]

class CartItemCreate(BaseModel):
    product_id: int
    quantity: int = Field(default=1, ge=1)

    model_config = ConfigDict(json_schema_extra={
        "example": {
            "product_id": 101,
            "quantity": 2
        }
    })

class ProductSimpleResponse(BaseModel):
    product_id: int
    name: str
    price: int
    image_url: Optional[str] = None
    
    class Config:
        from_attributes = True

class CartItemResponse(BaseModel):
    cart_item_id: int
    product: ProductSimpleResponse
    quantity: int
    unit_price: int
    total_price: int
    
    class Config:
        from_attributes = True

class CartSessionResponse(BaseModel):
    cart_session_id: int
    status: str
    total_amount: int
    total_items: int = 0
    expected_total_g: int = 0
    items: List[CartItemResponse] = Field(default_factory=list)
    
    class Config:
        from_attributes = True

class CartItemUpdate(BaseModel):
    quantity: int = Field(..., ge=1)

# --- Cart Weight Validation ---
class CartWeightValidateRequest(BaseModel):
    cart_session_id: int
    measured_weight_g: int = Field(..., gt=0)

    model_config = ConfigDict(json_schema_extra={
        "example": {
            "cart_session_id": 5,
            "measured_weight_g": 520
        }
    })

class CartWeightValidateResponse(BaseModel):
    is_valid: bool
    status: str  # MATCH | OVER_WEIGHT | UNDER_WEIGHT
    expected_weight: int
    measured_weight: int
    difference: int
    tolerance: int
    message: str


# =========================================================
# ğŸ³ Recipe & Product Schemas (ì¶”ì²œ ë° ìƒí’ˆ)
# =========================================================

class IngredientSimpleResponse(BaseModel):
    product_id: int
    name: str
    is_owned: bool
    
    class Config:
        from_attributes = True

class RecipeRecommendResponse(BaseModel):
    recipe_id: int
    title: str
    description: Optional[str] = None
    image_url: Optional[str] = None
    
    # AI ì¶”ì²œ ì ìˆ˜
    similarity_score: Optional[float] = None
    
    # ì „ì²´ ì¬ë£Œ
    ingredients: List[IngredientSimpleResponse] = [] 
    
    # ë¶€ì¡±í•œ ì¬ë£Œ
    missing_ingredients: List[IngredientSimpleResponse] = []
    
    class Config:
        from_attributes = True

# --- Product Schemas ---



class ProductResponse(BaseModel):

    product_id: int

    category_id: Optional[int]

    barcode: Optional[str]

    name: str

    price: int

    unit_weight_g: int

    stock_quantity: int

    image_url: Optional[str]

    product_info: Optional[dict] = None  # JSONB

    

    # ì¶”ê°€ í•„ë“œ (ìœ„ì¹˜ ì •ë³´ ë“±)

    zone_code: Optional[str] = None # Category ì¡°ì¸ ê²°ê³¼

    category_name: Optional[str] = None



    class Config:

        from_attributes = True



class ProductLocationResponse(BaseModel):

    product_id: int

    name: str

    zone_code: Optional[str]

    map_image_url: Optional[str] = None # ë§¤ì¥ ì§€ë„ ì´ë¯¸ì§€ URL ë“±



class RecipeIngredientResponse(BaseModel):

    product_id: int

    name: str

    quantity_info: Optional[str] = None

    image_url: Optional[str] = None

    

    class Config:

        from_attributes = True



class RecipeDetailResponse(BaseModel):
    recipe_id: int
    title: str
    description: Optional[str] = None
    instructions: Optional[str] = None
    image_url: Optional[str] = None
    prep_time_min: int = 30
    difficulty_label: str = "ë³´í†µ"
    calories: int = 500
    
    # ì¡°ë¦¬ ì¬ë£Œ
    ingredients: List[RecipeIngredientResponse] = []
    
    class Config:
        from_attributes = True




==================================================
FILE PATH: .\backend\app\seed_data.py
==================================================
import datetime
import sys
import os
from dotenv import load_dotenv

# Add parent directory to path to allow importing 'app'
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Load environment variables
load_dotenv(os.path.join(os.path.dirname(__file__), '../.env'))

from sqlalchemy import text  # â˜… ì´ ì¤„ ê¼­ ì¶”ê°€í•˜ì„¸ìš”!
from app.database import SessionLocal, engine
from app import models

def init_data():
    # â˜… [í•µì‹¬] DBì— ë²¡í„° ê¸°ëŠ¥ì„ ê°•ì œë¡œ ì¼­ë‹ˆë‹¤.
    try:
        with engine.connect() as conn:
            conn.execute(text("CREATE EXTENSION IF NOT EXISTS vector"))
            conn.commit()
            print("âœ… pgvector ê¸°ëŠ¥ í™œì„±í™” ì™„ë£Œ!")
    except Exception as e:
        print(f"âš ï¸ ë²¡í„° ê¸°ëŠ¥ í™œì„±í™” ê²½ê³ : {e}")

    # 1. í…Œì´ë¸” ìƒì„±
    models.Base.metadata.create_all(bind=engine)
    
    db = SessionLocal()
    try:
        print("ğŸŒ± ë°ì´í„° ì‹¬ëŠ” ì¤‘...")

        # 2. í…ŒìŠ¤íŠ¸ ìœ ì € ìƒì„±
        user = models.AppUser(user_id=1, email="test@test.com", nickname="í…ŒìŠ¤íŠ¸ìœ ì €", provider="LOCAL")
        db.merge(user)

        # 3. ìƒí’ˆ ìƒì„± (ì–‘íŒŒ)
        onion = models.Product(product_id=100, name="ì–‘íŒŒ", price=500, unit_weight_g=200)
        db.merge(onion)

        # 4. ë ˆì‹œí”¼ ìƒì„± (ì–‘íŒŒìˆ˜í”„)
        soup = models.Recipe(recipe_id=501, title="í”„ë Œì¹˜ ì–´ë‹ˆì–¸ ìˆ˜í”„", description="ì–‘íŒŒê°€ ë“¬ë¿ ë“¤ì–´ê°„ ìˆ˜í”„")
        db.merge(soup)

        # 5. ìƒí’ˆ-ë ˆì‹œí”¼ ì—°ê²° (ê°€ì¤‘ì¹˜ 5ì !)
        link = models.RecipeIngredient(recipe_id=501, product_id=100, importance_score=5, quantity_info="2ê°œ")
        db.merge(link)
        
        # 6. ì¹´íŠ¸ ê¸°ê¸° & ì„¸ì…˜ ìƒì„±
        device = models.CartDevice(cart_device_id=99, device_code="CART_001")
        db.merge(device)
        
        session = models.CartSession(
            cart_session_id=1, 
            cart_device_id=99, 
            user_id=1, 
            status=models.CartSessionStatus.ACTIVE
        )
        db.merge(session)

        db.commit()
        print("âœ… ê¸°ì´ˆ ë°ì´í„° ìƒì„± ì™„ë£Œ! (User:1, Product:100, Session:1)")

    except Exception as e:
        print(f"âŒ ì—ëŸ¬ ë°œìƒ: {e}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    init_data()

==================================================
FILE PATH: .\backend\app\__init__.py
==================================================


==================================================
FILE PATH: .\backend\app\core\config.py
==================================================
import os
from dotenv import load_dotenv
from pathlib import Path

# í”„ë¡œì íŠ¸ ë£¨íŠ¸(S14P11A202/) í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ .env íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤.
# app/core/config.py -> parent(1): app/core -> parent(2): app -> parent(3): backend -> parent(4): í”„ë¡œì íŠ¸ ë£¨íŠ¸
BASE_DIR = Path(__file__).resolve().parent.parent.parent.parent
load_dotenv(BASE_DIR / ".env")


class Settings:
    DATABASE_URL = os.getenv("DATABASE_URL")
    GOOGLE_CLIENT_ID = os.getenv("GOOGLE_CLIENT_ID")
    GOOGLE_CLIENT_SECRET = os.getenv("GOOGLE_CLIENT_SECRET")
    GOOGLE_REDIRECT_URI = os.getenv("GOOGLE_REDIRECT_URI")
    KAKAO_REST_API_KEY = os.getenv("KAKAO_REST_API_KEY")
    KAKAO_REDIRECT_URI = os.getenv("KAKAO_REDIRECT_URI") 
    KAKAO_ADMIN_KEY = os.getenv("KAKAO_ADMIN_KEY")
    JETSON_BASE_URL = os.getenv("JETSON_BASE_URL")
    JETSON_STREAM_URL = os.getenv("JETSON_STREAM_URL")

    BASE_URL = os.getenv("BASE_URL", "http://localhost:8000")

settings = Settings()





==================================================
FILE PATH: .\backend\app\db\base.py
==================================================
from sqlalchemy.orm import declarative_base

Base = declarative_base()


==================================================
FILE PATH: .\backend\app\routers\admin.py
==================================================
from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel, ConfigDict
import requests
import os

# í•„ìš”í•˜ë‹¤ë©´ ê´€ë¦¬ì ì¸ì¦ ì˜ì¡´ì„±(Depends) ì¶”ê°€ ê°€ëŠ¥
router = APIRouter(
    prefix="/admin",
    tags=["admin"],
    responses={404: {"description": "Not found"}},
)

# AI ì„œë²„ ì£¼ì†Œ (í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬)
AI_SERVER_URL = os.getenv("AI_INFERENCE_URL", "http://ai_inference:8000")

class TrainRequest(BaseModel):
    epochs: int = 10
    experiment_name: str = "manual_trigger"
    model_name: str = "yolo11s.pt"  # yolov8n.pt, yolov8s.pt, yolov8m.pt, yolo11n.pt ë“±
    
    # ì¶”ê°€ íŒŒë¼ë¯¸í„° í—ˆìš© (mosaic, lr0 ë“±)
    model_config = ConfigDict(extra="allow")

@router.post("/train")
def trigger_training(req: TrainRequest):
    """
    [Admin] ëª¨ë¸ ì¬í•™ìŠµ ìš”ì²­ì„ AI ì„œë²„(CPU)ë¡œ ì¤‘ê³„í•©ë‹ˆë‹¤.
    """
    url = f"{AI_SERVER_URL}/train"
    payload = req.model_dump() # Pydantic v2 ê¶Œì¥
    
    print(f"[Admin] Forwarding training request to {url} with {payload}")
    
    try:
        # AI ì„œë²„ í˜¸ì¶œ
        resp = requests.post(url, json=payload, timeout=5)
        
        if resp.status_code == 200:
            return resp.json()
        else:
            raise HTTPException(status_code=resp.status_code, detail=f"AI Server Error: {resp.text}")
            
    except requests.exceptions.ConnectionError:
        raise HTTPException(status_code=503, detail="AI Inference Server is unreachable.")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


==================================================
FILE PATH: .\backend\app\routers\auth.py
==================================================
# app/routers/auth.py
from fastapi import APIRouter, Cookie, HTTPException, Depends, status
from app.utils.jwt import decode_token, create_access_token, create_refresh_token
from sqlalchemy.orm import Session

from app.schemas import UserPasswordResetRequest, UserPasswordReset
from app.database import get_db
from app.models import AppUser, PasswordResetToken, UserProvider
from app.utils.security import hash_password

import uuid
from datetime import datetime, timedelta
from app.utils.email import send_reset_password_email
from os import getenv

import requests
from app import models, schemas
from app.core.config import settings   # settingsì—ì„œ env ì½ëŠ” êµ¬ì¡°ì¼ ë•Œ

from fastapi import Query
from fastapi.responses import JSONResponse, RedirectResponse

router = APIRouter(prefix="/auth", tags=["auth"])


@router.post("/refresh")
def refresh_access_token(refresh_token: str = Cookie(None)):
    if not refresh_token:
        raise HTTPException(status_code=401, detail="Refresh token missing")

    payload = decode_token(refresh_token)

    if payload.get("type") != "refresh":
        raise HTTPException(status_code=401, detail="Invalid token type")

    new_access_token = create_access_token(payload["sub"])

    return {
        "access_token": new_access_token,
        "token_type": "bearer",
    }


# TODO: SMTP blocked in SSAFY network
# TODO: Replace with SendGrid (HTTP API)

# ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ API
@router.post("/password/reset-request")
def request_password_reset(
    request: UserPasswordResetRequest,
    db: Session = Depends(get_db)
):
    user = db.query(AppUser).filter(AppUser.email == request.email).first()

    if not user:
        raise HTTPException(
            status_code=404,
            detail="í•´ë‹¹ ì´ë©”ì¼ë¡œ ê°€ì…ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤."
        )

    reset_token = str(uuid.uuid4())
    expires_at = datetime.utcnow() + timedelta(minutes=30)

    token_row = PasswordResetToken(
        token=reset_token,
        user_id=user.user_id,
        expires_at=expires_at,
        used=False
    )

    db.add(token_row)
    db.commit()

    reset_link = f"{getenv('FRONTEND_URL')}/reset-password?token={reset_token}"
    send_reset_password_email(user.email, reset_link)

    return {"message": "ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤."}


# ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì‹¤í–‰ API
@router.post("/password/reset")
def reset_password(
    request: UserPasswordReset,
    db: Session = Depends(get_db)
):
    token_row = (
        db.query(PasswordResetToken)
        .filter(PasswordResetToken.token == request.token)
        .first()
    )

    if not token_row:
        raise HTTPException(status_code=400, detail="ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.")

    if token_row.used:
        raise HTTPException(status_code=400, detail="ì´ë¯¸ ì‚¬ìš©ëœ í† í°ì…ë‹ˆë‹¤.")

    if token_row.expires_at < datetime.utcnow():
        raise HTTPException(status_code=400, detail="í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")

    user = (
        db.query(AppUser)
        .filter(AppUser.user_id == token_row.user_id)
        .first()
    )

    user.password_hash = hash_password(request.new_password)
    token_row.used = True

    db.commit()

    return {"message": "ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."}


# êµ¬ê¸€ ë¡œê·¸ì¸
@router.post(
    "/google",
    response_model=schemas.TokenResponse,
)
def google_login(
    request: schemas.GoogleOAuthRequest,
    db: Session = Depends(get_db),
):
    # 1. code â†’ access token
    token_res = requests.post(
        "https://oauth2.googleapis.com/token",
        data={
            "client_id": settings.GOOGLE_CLIENT_ID,
            "client_secret": settings.GOOGLE_CLIENT_SECRET,
            "code": request.code,
            "grant_type": "authorization_code",
            "redirect_uri": settings.GOOGLE_REDIRECT_URI,
        },
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )

    if token_res.status_code != 200:
        raise HTTPException(
            status_code=400,
            detail="Google token exchange failed",
        )

    google_access_token = token_res.json().get("access_token")

    # 2. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    user_res = requests.get(
        "https://www.googleapis.com/oauth2/v2/userinfo",
        headers={
            "Authorization": f"Bearer {google_access_token}"
        },
    )

    user_info = user_res.json()

    email = user_info.get("email")
    nickname = user_info.get("name")

    if not email:
        raise HTTPException(
            status_code=400,
            detail="Google user info invalid",
        )

    # 3. ì‚¬ìš©ì ì¡°íšŒ
    user = (
        db.query(models.AppUser)
        .filter(
            models.AppUser.email == email,
            models.AppUser.provider == "GOOGLE",
        )
        .first()
    )

    # 4. ì—†ìœ¼ë©´ íšŒì›ê°€ì…
    if not user:
        user = models.AppUser(
            email=email,
            nickname=nickname,
            provider="GOOGLE",
            password_hash=None,
        )
        db.add(user)
        db.commit()
        db.refresh(user)

    # 5. JWT ë°œê¸‰
    access_token = create_access_token(str(user.user_id))
    refresh_token = create_refresh_token(str(user.user_id))

    return {
        "access_token": access_token,
        "refresh_token": refresh_token,
        "token_type": "bearer",
    }


@router.get("/google/callback")
def google_callback(
    code: str = Query(...),
    db: Session = Depends(get_db),
):
    """
    Google OAuth redirect endpoint (í”„ë¡ íŠ¸ ë¯¸êµ¬í˜„ìš©)
    """
    # ê¸°ì¡´ POST /auth/google ë¡œì§ì„ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©
    oauth_request = schemas.GoogleOAuthRequest(code=code)
    return google_login(oauth_request, db)


# ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
@router.get("/kakao/login")
def kakao_login():
    kakao_auth_url = (
        "https://kauth.kakao.com/oauth/authorize"
        f"?client_id={settings.KAKAO_REST_API_KEY}"
        f"&redirect_uri={settings.KAKAO_REDIRECT_URI}"
        "&response_type=code"
    )
    return RedirectResponse(kakao_auth_url)


@router.get("/kakao/callback")
def kakao_callback(
    code: str,
    db: Session = Depends(get_db),
):
    # 1. í† í° ìš”ì²­
    token_res = requests.post(
        "https://kauth.kakao.com/oauth/token",
        data={
            "grant_type": "authorization_code",
            "client_id": settings.KAKAO_REST_API_KEY,
            "redirect_uri": settings.KAKAO_REDIRECT_URI,
            "code": code,
        },
        headers={"Content-Type": "application/x-www-form-urlencoded"},
    )

    if token_res.status_code != 200:
        print("Kakao token error:", token_res.text)
        raise HTTPException(status_code=400, detail=token_res.text)

    access_token = token_res.json()["access_token"]

    # 2. ì‚¬ìš©ì ì •ë³´
    user_res = requests.get(
        "https://kapi.kakao.com/v2/user/me",
        headers={"Authorization": f"Bearer {access_token}"},
    )

    kakao_user = user_res.json()

    kakao_id = kakao_user["id"]
    nickname = kakao_user["properties"]["nickname"]

    email = None
    if "kakao_account" in kakao_user:
        email = kakao_user["kakao_account"].get("email")

    # 3. DB ì¡°íšŒ
    user = (
        db.query(AppUser)
        .filter(
            AppUser.provider == UserProvider.KAKAO,
            AppUser.email == (email or f"kakao_{kakao_id}@kakao.com"),
        )
        .first()
    )

    # 4. ì—†ìœ¼ë©´ íšŒì›ê°€ì…
    if not user:
        user = AppUser(
            email=email or f"kakao_{kakao_id}@kakao.com",
            nickname=nickname,
            provider=UserProvider.KAKAO,
            password_hash=None,
        )
        db.add(user)
        db.commit()
        db.refresh(user)

    # 5. JWT ë°œê¸‰
    access_token = create_access_token(str(user.user_id))
    refresh_token = create_refresh_token(str(user.user_id))

    return {
        "access_token": access_token,
        "refresh_token": refresh_token,
        "token_type": "bearer",
    }



==================================================
FILE PATH: .\backend\app\routers\cart.py
==================================================
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from .. import models, schemas, database
from ..dependencies import get_current_user 
from sqlalchemy.sql import func 
import requests
from app.core.config import settings
from datetime import datetime
import uuid

from app.schemas import (
    CartWeightValidateRequest,
    CartWeightValidateResponse
)
from app.utils.check_data import validate_cart_weight

router = APIRouter(
    prefix="/carts",
    tags=["carts"],
    responses={404: {"description": "Not found"}},
)

# QR pair
@router.post("/pair/qr")
def pair_cart_by_qr(
    device_code: str,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    # 1. ë””ë°”ì´ìŠ¤ ì¡°íšŒ (QR ê¸°ë°˜)
    device = (
        db.query(models.CartDevice)
        .filter(models.CartDevice.device_code == device_code)
        .first()
    )

    if not device:
        raise HTTPException(status_code=404, detail="ì¹´íŠ¸ ë””ë°”ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # 2. í•´ë‹¹ ë””ë°”ì´ìŠ¤ì˜ ACTIVE ì„¸ì…˜ ì¡°íšŒ
    session = (
        db.query(models.CartSession)
        .filter(
            models.CartSession.cart_device_id == device.cart_device_id,
            models.CartSession.status == models.CartSessionStatus.ACTIVE,
        )
        .order_by(models.CartSession.started_at.desc())
        .first()
    )

    # 3. ì—†ìœ¼ë©´ ìƒˆ ì„¸ì…˜ ìƒì„±
    if not session:
        session = models.CartSession(
            cart_device_id=device.cart_device_id,
            user_id=current_user.user_id,
            status=models.CartSessionStatus.ACTIVE,
        )
        db.add(session)
        db.commit()
        db.refresh(session)
    else:
        # 4. ìˆìœ¼ë©´ ì‚¬ìš©ìë§Œ ì—°ê²°
        session.user_id = current_user.user_id
        db.commit()

    return {
        "cart_session_id": session.cart_session_id,
        "cart_device_id": device.cart_device_id,
        "message": "ì¹´íŠ¸ê°€ ì•±ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.",
    }


# --- 1. ì¥ë°”êµ¬ë‹ˆ ìƒì„± (ì‡¼í•‘ ì‹œì‘) ---
@router.post("/", response_model=schemas.CartSessionResponse)
def create_cart_session(
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    """
    ìƒˆë¡œìš´ ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.
    """
    new_session = models.CartSession(
        user_id=current_user.user_id,
        status=models.CartSessionStatus.ACTIVE,
        cart_device_id=1  # í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ ë””ë°”ì´ìŠ¤ ID
    )
    db.add(new_session)
    db.commit()
    db.refresh(new_session)
    
    # ë¹ˆ ì¥ë°”êµ¬ë‹ˆ ë°˜í™˜
    return {
        "cart_session_id": new_session.cart_session_id,
        "status": new_session.status.value,
        "total_amount": 0,
        "total_items": 0,
        "items": [],
        "expected_total_g": 0
    }


# --- 2. ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ---
@router.get("/current", response_model=schemas.CartSessionResponse)
def get_current_cart_session(
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    """
    í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ í™œì„± ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì„ ì¡°íšŒí•©ë‹ˆë‹¤.
    ì—†ìœ¼ë©´ 404ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
    """
    session = db.query(models.CartSession).filter(
        models.CartSession.user_id == current_user.user_id,
        models.CartSession.status == models.CartSessionStatus.ACTIVE
    ).order_by(models.CartSession.cart_session_id.desc()).first()

    if not session:
        raise HTTPException(status_code=404, detail="í™œì„±í™”ëœ ì¥ë°”êµ¬ë‹ˆê°€ ì—†ìŠµë‹ˆë‹¤.")
    
    # ê¸°ì¡´ get_cart_session ë¡œì§ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ë¶„ë¦¬í•˜ë©´ ì¢‹ì§€ë§Œ 
    # ì¼ë‹¨ ì—¬ê¸°ì— êµ¬í˜„
    response_items = []
    total_amount = 0
    total_quantity = 0

    for item in session.items:
        item_total = item.unit_price * item.quantity
        total_amount += item_total
        total_quantity += item.quantity
        
        response_items.append({
            "cart_item_id": item.cart_item_id,
            "product": item.product, 
            "quantity": item.quantity,
            "unit_price": item.unit_price,
            "total_price": item_total 
        })

    return {
        "cart_session_id": session.cart_session_id,
        "status": session.status.value, 
        "total_amount": total_amount,
        "total_items": total_quantity,
        "items": response_items,        
        "expected_total_g": session.expected_total_g
    }


# --- 2.1 íŠ¹ì • IDë¡œ ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ---
@router.get("/{session_id}", response_model=schemas.CartSessionResponse)
def get_cart_session(
    session_id: int, 
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    # ì„¸ì…˜ ë³¸ì¸ í™•ì¸
    session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == session_id,
        models.CartSession.user_id == current_user.user_id
    ).first()

    if not session:
        raise HTTPException(status_code=404, detail="ì¥ë°”êµ¬ë‹ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    # ìƒí’ˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    cart_items = db.query(models.CartItem).filter(
        models.CartItem.cart_session_id == session_id
    ).all()

    response_items = []
    total_amount = 0
    total_quantity = 0

    for item in cart_items:
        item_total = item.unit_price * item.quantity
        total_amount += item_total
        total_quantity += item.quantity
        
        response_items.append({
            "cart_item_id": item.cart_item_id,
            "product": item.product, 
            "quantity": item.quantity,
            "unit_price": item.unit_price,
            "total_price": item_total 
        })

    return {
        "cart_session_id": session.cart_session_id,
        "status": session.status.value, 
        "total_amount": total_amount,
        "total_items": total_quantity,
        "items": response_items,        
        "expected_total_g": session.expected_total_g
    }


# --- 3. ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ë‹´ê¸° ---
@router.post("/{session_id}/items")
def add_cart_item(
    session_id: int,
    item_req: schemas.CartItemCreate,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    # ì„¸ì…˜ ë³¸ì¸ í™•ì¸
    session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == session_id,
        models.CartSession.user_id == current_user.user_id
    ).first()
    if not session:
        raise HTTPException(status_code=404, detail="ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.")

    # ìƒí’ˆ ì¡´ì¬ í™•ì¸
    product = db.query(models.Product).filter(models.Product.product_id == item_req.product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="ìƒí’ˆì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

    # ì´ë¯¸ ë‹´ê¸´ ìƒí’ˆì¸ì§€ í™•ì¸
    existing_item = db.query(models.CartItem).filter(
        models.CartItem.cart_session_id == session_id,
        models.CartItem.product_id == item_req.product_id
    ).first()

    if existing_item:
        existing_item.quantity += item_req.quantity
    else:
        db.add(models.CartItem(
            cart_session_id=session_id,
            product_id=item_req.product_id,
            quantity=item_req.quantity,
            unit_price=product.price
        ))

    db.flush()                      
    recalc_expected_weight(session) 
    db.commit()
    
    return {"message": "ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ë‹´ì•˜ìŠµë‹ˆë‹¤."}


# --- AI ì¶”ë¡ ê¸° ì „ìš©: ì¹´íŠ¸ ìƒíƒœ ë™ê¸°í™” (Snapshot Sync) ---
@router.post("/sync-by-device")
def sync_cart_by_device(
    req: schemas.CartSyncRequest,
    db: Session = Depends(database.get_db)
):
    # 1. ê¸°ê¸° ë° ì„¸ì…˜ ì¡°íšŒ
    device = db.query(models.CartDevice).filter(models.CartDevice.device_code == req.device_code).first()
    if not device:
        raise HTTPException(status_code=404, detail="Unknown Device")

    session = db.query(models.CartSession).filter(
        models.CartSession.cart_device_id == device.cart_device_id,
        models.CartSession.status == models.CartSessionStatus.ACTIVE
    ).first()
    if not session:
        raise HTTPException(status_code=404, detail="No Active Session")

    # 2. ê¸°ì¡´ í’ˆëª© ì‹¹ ë¹„ìš°ê¸° (ë™ê¸°í™”ë¥¼ ìœ„í•´)
    db.query(models.CartItem).filter(models.CartItem.cart_session_id == session.cart_session_id).delete()

    # 3. ìƒˆë¡œìš´ Snapshotìœ¼ë¡œ ì±„ìš°ê¸°
    synced_count = 0
    for item in req.items:
        product = db.query(models.Product).filter(models.Product.name == item.product_name).first()
        if product:
            db.add(models.CartItem(
                cart_session_id=session.cart_session_id,
                product_id=product.product_id,
                quantity=item.quantity,
                unit_price=product.price
            ))
            synced_count += 1
    
    db.flush()
    recalc_expected_weight(session)
    db.commit()
    return {"status": "synced", "item_count": synced_count}


# --- ìš”ë¦¬ ì„ íƒ ---
@router.post("/{session_id}/select-recipe")
def select_recipe(session_id: int, recipe_id: int, db: Session = Depends(database.get_db)):
    session = db.query(models.CartSession).filter(models.CartSession.cart_session_id == session_id).first()
    if not session:
        raise HTTPException(status_code=404, detail="ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    
    # ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ì„¸ì…˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    return {"detail": f"ë ˆì‹œí”¼(ID:{recipe_id})ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤."}


# ì˜ˆìƒ ë¬´ê²Œ ê³„ì‚°
def recalc_expected_weight(session: models.CartSession):
    total_weight = 0
    for item in session.items:
        unit_weight = item.product.unit_weight_g or 0
        total_weight += unit_weight * item.quantity
    session.expected_total_g = total_weight


# ìƒí’ˆ ì‚­ì œ
@router.delete("/items/{cart_item_id}")
def delete_cart_item(
    cart_item_id: int,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    cart_item = (
        db.query(models.CartItem)
        .join(models.CartSession)
        .filter(
            models.CartItem.cart_item_id == cart_item_id,
            models.CartSession.user_id == current_user.user_id
        )
        .first()
    )

    if not cart_item:
        raise HTTPException(status_code=404, detail="ì¹´íŠ¸ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    session = cart_item.session

    if session.status != models.CartSessionStatus.ACTIVE:
        raise HTTPException(status_code=400, detail="ìˆ˜ì • ê°€ëŠ¥í•œ ì¹´íŠ¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.")

    db.delete(cart_item)
    db.flush()

    recalc_expected_weight(session)

    db.commit()

    return {
        "message": "ìƒí’ˆì´ ì¹´íŠ¸ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.",
        "expected_total_g": session.expected_total_g
    }


# ìƒí’ˆ ìˆ˜ëŸ‰ ë³€ê²½
@router.patch("/items/{cart_item_id}")
def update_cart_item_quantity(
    cart_item_id: int,
    req: schemas.CartItemUpdate,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    # 1. ì¹´íŠ¸ ìƒí’ˆ + ì‚¬ìš©ì ì†Œìœ  í™•ì¸
    cart_item = (
        db.query(models.CartItem)
        .join(models.CartSession)
        .filter(
            models.CartItem.cart_item_id == cart_item_id,
            models.CartSession.user_id == current_user.user_id
        )
        .first()
    )

    if not cart_item:
        raise HTTPException(status_code=404, detail="ì¹´íŠ¸ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    session = cart_item.session

    # 2. ì¹´íŠ¸ ìƒíƒœ í™•ì¸
    if session.status != models.CartSessionStatus.ACTIVE:
        raise HTTPException(status_code=400, detail="ìˆ˜ì • ê°€ëŠ¥í•œ ì¹´íŠ¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.")

    # 3. ìˆ˜ëŸ‰ ë³€ê²½
    cart_item.quantity = req.quantity

    db.flush()  # ë³€ê²½ì‚¬í•­ ë°˜ì˜

    # 4. ì˜ˆìƒ ë¬´ê²Œ ì¬ê³„ì‚°
    recalc_expected_weight(session)

    db.commit()
    db.refresh(cart_item)

    return {
        "message": "ìƒí’ˆ ìˆ˜ëŸ‰ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.",
        "cart_item_id": cart_item.cart_item_id,
        "quantity": cart_item.quantity,
        "expected_total_g": session.expected_total_g
    }


# ë¬´ê²Œ ê²€ì¦
@router.post("/weight/validate", response_model=CartWeightValidateResponse)
def validate_weight(
    request: CartWeightValidateRequest,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == request.cart_session_id,
        models.CartSession.user_id == current_user.user_id
    ).first()

    if not session:
        raise HTTPException(status_code=404, detail="ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    result = validate_cart_weight(
        db=db,
        cart_session_id=request.cart_session_id,
        measured_weight_g=request.measured_weight_g
    )

    db.commit()
    return result


# --- ì¹´íŠ¸ ì„¸ì…˜ ì·¨ì†Œ ---
@router.post("/{session_id}/cancel")
def cancel_cart_session(
    session_id: int,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == session_id,
        models.CartSession.user_id == current_user.user_id
    ).first()

    if not session:
        raise HTTPException(status_code=404, detail="ì¹´íŠ¸ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    if session.status != models.CartSessionStatus.ACTIVE:
        raise HTTPException(
            status_code=400,
            detail="ì·¨ì†Œ ê°€ëŠ¥í•œ ì¹´íŠ¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."
        )

    session.status = models.CartSessionStatus.CANCELLED
    session.ended_at = func.now()

    db.commit()

    return {
        "message": "ì¹´íŠ¸ ì„¸ì…˜ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
        "cart_session_id": session.cart_session_id,
        "status": session.status.value
    }


# ì¹´ë©”ë¼ ë·° on
@router.post("/{cart_session_id}/camera/view/on")
def camera_view_on(
    cart_session_id: int,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    cart = (
        db.query(models.CartSession)
        .filter(
            models.CartSession.cart_session_id == cart_session_id,
            models.CartSession.user_id == current_user.user_id,
            models.CartSession.status == models.CartSessionStatus.ACTIVE,
        )
        .first()
    )

    if not cart:
        raise HTTPException(status_code=404, detail="Active cart not found")

    cart.camera_view_on = True
    db.commit()

    return {
        "cart_session_id": cart_session_id,
        "camera_view_on": True,
        "stream_url": settings.JETSON_STREAM_URL
    }


# camera view close
@router.post("/{cart_session_id}/camera/view/off")
def camera_view_off(
    cart_session_id: int,
    db: Session = Depends(database.get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    cart = (
        db.query(models.CartSession)
        .filter(
            models.CartSession.cart_session_id == cart_session_id,
            models.CartSession.user_id == current_user.user_id,
            models.CartSession.status == models.CartSessionStatus.ACTIVE,
        )
        .first()
    )

    if not cart:
        raise HTTPException(status_code=404, detail="Active cart not found")

    cart.camera_view_on = False
    db.commit()

    return {
        "cart_session_id": cart_session_id,
        "camera_view_on": False
    }

==================================================
FILE PATH: .\backend\app\routers\ledger.py
==================================================
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from datetime import date
from typing import Optional

from app.database import get_db
from app import models
from app.dependencies import get_current_user
from app.schemas import LedgerUpdateRequest

from sqlalchemy import func
from calendar import monthrange





router = APIRouter(
    prefix="/ledger",
    tags=["ledger"],
)

# ======================================================
# 1ï¸âƒ£ ê²°ì œ â†’ ê°€ê³„ë¶€ ìƒì„± (payment ìŠ¹ì¸ ê¸°ë°˜)
# ======================================================
@router.post("/from-payment/{payment_id}")
def create_ledger_from_payment(
    payment_id: int,
    db: Session = Depends(get_db),
):
    # payment ì¡°íšŒ (CartSession, Itemsê¹Œì§€ í•¨ê»˜ ë¡œë”©í•˜ë ¤ë©´ join í•„ìš”í•  ìˆ˜ ìˆìŒ)
    payment = db.query(models.Payment).filter(
        models.Payment.payment_id == payment_id
    ).first()

    if not payment:
        raise HTTPException(status_code=404, detail="ê²°ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    if payment.status != models.PaymentStatus.APPROVED:
        raise HTTPException(
            status_code=400,
            detail="ìŠ¹ì¸ëœ ê²°ì œë§Œ ê°€ê³„ë¶€ë¡œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        )

    # ì´ë¯¸ ledger ìˆëŠ”ì§€ í™•ì¸
    existing = db.query(models.LedgerEntry).filter(
        models.LedgerEntry.payment_id == payment_id
    ).first()

    if existing:
        raise HTTPException(
            status_code=409,
            detail="ì´ë¯¸ ê°€ê³„ë¶€ì— ë“±ë¡ëœ ê²°ì œì…ë‹ˆë‹¤."
        )

    # --- ì¹´í…Œê³ ë¦¬ ìë™ ë§¤í•‘ ë¡œì§ ì‹œì‘ ---
    
    # 1. ê²°ì œì™€ ì—°ê²°ëœ ì¹´íŠ¸ ì„¸ì…˜ ì°¾ê¸°
    cart_session = payment.session
    if not cart_session:
        # ì„¸ì…˜ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
        main_category = models.LedgerCategory.GROCERY
        memo_text = "ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ (ì„¸ì…˜ ì •ë³´ ì—†ìŒ)"
    else:
        # 2. ì¹´íŠ¸ ì•„ì´í…œ ìˆœíšŒí•˜ë©° ì¹´í…Œê³ ë¦¬ë³„ ê¸ˆì•¡ ì§‘ê³„
        category_spending = {}
        
        # ìƒí’ˆëª… ìš”ì•½ìš©
        item_names = []

        for item in cart_session.items:
            # item.product.category.name (ì˜ˆ: "ì •ìœ¡", "ìœ ì œí’ˆ" ë“± DBì— ì €ì¥ëœ ë¬¸ìì—´)
            # ê´€ê³„ ë¡œë”©ì´ ì•ˆ ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ‘ê·¼ ì‹œ ì¿¼ë¦¬ ë°œìƒ ê°€ëŠ¥
            prod_cat_name = "ETC"
            if item.product and item.product.category:
                prod_cat_name = item.product.category.name
            
            # ê¸ˆì•¡ ê³„ì‚°
            amount = item.quantity * item.unit_price
            
            # ì§‘ê³„
            category_spending[prod_cat_name] = category_spending.get(prod_cat_name, 0) + amount
            
            if item.product:
                item_names.append(item.product.name)

        # 3. ê°€ì¥ ë§ì´ ì“´ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
        if category_spending:
            top_category_name = max(category_spending, key=category_spending.get)
        else:
            top_category_name = "GROCERY"

        # 4. ë¬¸ìì—´ -> LedgerCategory Enum ë§¤í•‘
        # DBì˜ product_category.name ê³¼ LedgerCategory Enum ê°„ì˜ ë§¤í•‘ í…Œì´ë¸”
        # (í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ë¡œ ë§¤í•‘)
        CATEGORY_MAP = {
            "ì •ìœ¡": models.LedgerCategory.MEAT,
            "ê³ ê¸°": models.LedgerCategory.MEAT,
            "ì¶•ì‚°": models.LedgerCategory.MEAT,
            "ìœ ì œí’ˆ": models.LedgerCategory.DAIRY,
            "ìš°ìœ ": models.LedgerCategory.DAIRY,
            "ì¹˜ì¦ˆ": models.LedgerCategory.DAIRY,
            "ìŒë£Œ": models.LedgerCategory.BEVERAGE,
            "ê³¼ì": models.LedgerCategory.SNACK,
            "ê°„ì‹": models.LedgerCategory.SNACK,
            "ìŠ¤ë‚µ": models.LedgerCategory.SNACK,
            "ìƒí™œ": models.LedgerCategory.HOUSEHOLD,
            "ì±„ì†Œ": models.LedgerCategory.GROCERY,
            "ì•¼ì±„": models.LedgerCategory.GROCERY,
            "ê³¼ì¼": models.LedgerCategory.GROCERY,
            "ìˆ˜ì‚°": models.LedgerCategory.GROCERY,
            "í•´ì‚°ë¬¼": models.LedgerCategory.GROCERY,
            "í†µì¡°ë¦¼": models.LedgerCategory.GROCERY, # ê°€ê³µì‹í’ˆì€ ë³´í†µ GROCERY
            "ì†ŒìŠ¤": models.LedgerCategory.GROCERY,
            "ì–‘ë…": models.LedgerCategory.GROCERY,
            "ë©´": models.LedgerCategory.GROCERY,
            "ì¦‰ì„": models.LedgerCategory.GROCERY,
        }
        
        main_category = models.LedgerCategory.GROCERY # ê¸°ë³¸ê°’
        
        # í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€ í™•ì¸ (ì˜ˆ: "ì •ìœ¡/ê³„ë€" -> "ì •ìœ¡" í¬í•¨ -> MEAT)
        for key, val in CATEGORY_MAP.items():
            if key in top_category_name:
                main_category = val
                break
        
        # ë©”ëª¨ ìƒì„± (ì˜ˆ: "ì‚¼ê²¹ì‚´ ì™¸ 3ê±´")
        if len(item_names) == 1:
            memo_text = item_names[0]
        elif len(item_names) > 1:
            memo_text = f"{item_names[0]} ì™¸ {len(item_names) - 1}ê±´"
        else:
            memo_text = "ìƒí’ˆ ì •ë³´ ì—†ìŒ"

    # --- ì¹´í…Œê³ ë¦¬ ìë™ ë§¤í•‘ ë¡œì§ ë ---

    # ledger ìƒì„±
    ledger = models.LedgerEntry(
        user_id=payment.user_id,
        payment_id=payment.payment_id,
        spend_date=date.today(),
        category=main_category,  
        amount=payment.total_amount,
        memo=memo_text,
    )

    db.add(ledger)
    db.commit()
    db.refresh(ledger)

    return ledger


# ======================================================
# 2ï¸âƒ£ ê°€ê³„ë¶€ ëª©ë¡ ì¡°íšŒ
# ======================================================
@router.get("")
def get_ledger_list(
    user_id: int = Query(..., description="ì‚¬ìš©ì ID"),
    start_date: Optional[date] = Query(None, description="ì¡°íšŒ ì‹œì‘ì¼"),
    end_date: Optional[date] = Query(None, description="ì¡°íšŒ ì¢…ë£Œì¼"),
    category: Optional[models.LedgerCategory] = Query(None, description="ì¹´í…Œê³ ë¦¬"),
    db: Session = Depends(get_db),
):
    query = db.query(models.LedgerEntry).filter(
        models.LedgerEntry.user_id == user_id
    )

    # ë‚ ì§œ í•„í„°
    if start_date:
        query = query.filter(models.LedgerEntry.spend_date >= start_date)

    if end_date:
        query = query.filter(models.LedgerEntry.spend_date <= end_date)

    # ì¹´í…Œê³ ë¦¬ í•„í„°
    if category:
        query = query.filter(models.LedgerEntry.category == category)

    ledgers = (
        query
        .order_by(models.LedgerEntry.spend_date.desc())
        .all()
    )

    return [
        {
            "ledger_entry_id": l.ledger_entry_id,
            "payment_id": l.payment_id,
            "spend_date": l.spend_date,
            "category": l.category,
            "amount": l.amount,
            "memo": l.memo,
        }
        for l in ledgers
    ]

# ======================================================
# 6ï¸âƒ£ ì›”ë³„ ê°€ê³„ë¶€ ìº˜ë¦°ë” ì¡°íšŒ (ë‚ ì§œë³„ ì§€ì¶œ í•©ê³„)
# ======================================================
@router.get("/calendar")
def get_ledger_calendar(
    year: int = Query(..., ge=2000, description="ì¡°íšŒ ì—°ë„"),
    month: int = Query(..., ge=1, le=12, description="ì¡°íšŒ ì›” (1~12)"),
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    # ì›” ì‹œì‘ / ì¢…ë£Œì¼ ê³„ì‚°
    start_date = date(year, month, 1)
    last_day = monthrange(year, month)[1]
    end_date = date(year, month, last_day)

    rows = (
        db.query(
            models.LedgerEntry.spend_date,
            func.sum(models.LedgerEntry.amount).label("total_amount"),
        )
        .filter(
            models.LedgerEntry.user_id == current_user.user_id,
            models.LedgerEntry.spend_date >= start_date,
            models.LedgerEntry.spend_date <= end_date,
        )
        .group_by(models.LedgerEntry.spend_date)
        .order_by(models.LedgerEntry.spend_date)
        .all()
    )

    daily_total = {}
    for spend_date, total_amount in rows:
        daily_total[str(spend_date)] = int(total_amount)

    return {
        "year": year,
        "month": month,
        "daily_total": daily_total,
    }

# ======================================================
# 5ï¸âƒ£ ì›”ë³„ ê°€ê³„ë¶€ ìš”ì•½ ì¡°íšŒ
# ======================================================
@router.get("/summary/monthly")
def get_monthly_summary(
    year: int = Query(..., ge=2000, description="ì¡°íšŒ ì—°ë„"),
    month: int = Query(..., ge=1, le=12, description="ì¡°íšŒ ì›” (1~12)"),
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    # ì›” ì‹œì‘ / ì¢…ë£Œì¼ ê³„ì‚°
    start_date = date(year, month, 1)
    last_day = monthrange(year, month)[1]
    end_date = date(year, month, last_day)

    # ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„ ì¡°íšŒ
    rows = (
        db.query(
            models.LedgerEntry.category,
            func.sum(models.LedgerEntry.amount).label("amount"),
        )
        .filter(
            models.LedgerEntry.user_id == current_user.user_id,
            models.LedgerEntry.spend_date >= start_date,
            models.LedgerEntry.spend_date <= end_date,
        )
        .group_by(models.LedgerEntry.category)
        .all()
    )

    by_category = [
        {
            "category": category,
            "amount": amount,
        }
        for category, amount in rows
    ]

    total_amount = sum(item["amount"] for item in by_category)

    # ğŸ”¹ ratio(%) ê³„ì‚°
    for item in by_category:
        item["ratio"] = round(item["amount"] / total_amount * 100) if total_amount > 0 else 0

    by_category.sort(key=lambda x: x["amount"], reverse=True)
    return {
        "year": year,
        "month": month,
        "total_amount": total_amount,
        "by_category": by_category,
    }

# ======================================================
# 7ï¸âƒ£ Top Categories ì¡°íšŒ (ì§€ì¶œ ê¸ˆì•¡ ê¸°ì¤€)
# ======================================================
@router.get("/top-categories")
def get_top_categories(
    year: int = Query(..., ge=2000, description="ì¡°íšŒ ì—°ë„"),
    month: int = Query(..., ge=1, le=12, description="ì¡°íšŒ ì›” (1~12)"),
    limit: int = Query(5, ge=1, le=10, description="ìƒìœ„ ì¹´í…Œê³ ë¦¬ ê°œìˆ˜"),
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    # ì›” ì‹œì‘ / ì¢…ë£Œì¼ ê³„ì‚°
    start_date = date(year, month, 1)
    last_day = monthrange(year, month)[1]
    end_date = date(year, month, last_day)

    rows = (
        db.query(
            models.LedgerEntry.category,
            func.sum(models.LedgerEntry.amount).label("amount"),
        )
        .filter(
            models.LedgerEntry.user_id == current_user.user_id,
            models.LedgerEntry.spend_date >= start_date,
            models.LedgerEntry.spend_date <= end_date,
        )
        .group_by(models.LedgerEntry.category)
        .order_by(func.sum(models.LedgerEntry.amount).desc())
        .limit(limit)
        .all()
    )

    categories = [
        {
            "category": category,
            "amount": amount,
        }
        for category, amount in rows
    ]

    total_amount = sum(item["amount"] for item in categories)

    for item in categories:
        item["ratio"] = round(item["amount"] / total_amount * 100) if total_amount > 0 else 0

    return {
        "year": year,
        "month": month,
        "categories": categories,
    }

# ======================================================
# 8ï¸âƒ£ Top Items ì¡°íšŒ (êµ¬ë§¤ íšŸìˆ˜ ê¸°ì¤€ - ì„ì‹œ: ì¹´í…Œê³ ë¦¬ ì‚¬ìš©)
# ======================================================
@router.get("/top-items")
def get_top_items(
    year: int = Query(..., ge=2000, description="ì¡°íšŒ ì—°ë„"),
    month: int = Query(..., ge=1, le=12, description="ì¡°íšŒ ì›” (1~12)"),
    limit: int = Query(5, ge=1, le=10, description="ìƒìœ„ ì•„ì´í…œ ê°œìˆ˜"),
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    start_date = date(year, month, 1)
    last_day = monthrange(year, month)[1]
    end_date = date(year, month, last_day)

    rows = (
        db.query(
            models.LedgerEntry.category.label("item_name"),
            func.count(models.LedgerEntry.ledger_entry_id).label("count"),
            func.sum(models.LedgerEntry.amount).label("total_amount"),
        )
        .filter(
            models.LedgerEntry.user_id == current_user.user_id,
            models.LedgerEntry.spend_date >= start_date,
            models.LedgerEntry.spend_date <= end_date,
        )
        .group_by(models.LedgerEntry.category)
        .order_by(
            func.count(models.LedgerEntry.ledger_entry_id).desc(),
            func.sum(models.LedgerEntry.amount).desc(),
        )
        .limit(limit)
        .all()
    )

    items = [
        {
            "item_name": item_name,
            "count": count,
            "total_amount": total_amount,
        }
        for item_name, count, total_amount in rows
    ]

    return {
        "year": year,
        "month": month,
        "items": items,
    }

# ======================================================
# 9ï¸âƒ£ ìµœê·¼ ì§€ì¶œ ë‚´ì—­ ì¡°íšŒ
# ======================================================
@router.get("/recent")
def get_recent_ledger(
    limit: int = Query(5, ge=1, le=20),
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    rows = (
        db.query(models.LedgerEntry, models.Payment)
        .join(
            models.Payment,
            models.LedgerEntry.payment_id == models.Payment.payment_id,
        )
        .filter(
            models.LedgerEntry.user_id == current_user.user_id,
            models.Payment.status == models.PaymentStatus.APPROVED,
        )
        .order_by(models.LedgerEntry.ledger_entry_id.desc())
        .limit(limit)
        .all()
    )

    items = []
    for ledger, payment in rows:
        items.append({
            "ledger_entry_id": ledger.ledger_entry_id,
            "payment_id": payment.payment_id,
            "spend_date": ledger.spend_date,
            "amount": ledger.amount,
            "category": ledger.category,
            "memo": ledger.memo,
        })

    return {"items": items}


# ======================================================
# 3ï¸âƒ£ ê°€ê³„ë¶€ ë‹¨ê±´ ì¡°íšŒ (JWT ì¸ì¦ + ë³¸ì¸ ë°ì´í„°ë§Œ)
# ======================================================
@router.get("/{ledger_entry_id}")
def get_ledger_detail(
    ledger_entry_id: int,
    db: Session = Depends(get_db),
    # í”„ë¡œì íŠ¸ì— ì´ë¯¸ ì“°ê³  ìˆëŠ” ì¸ì¦ ì˜ì¡´ì„± ì‚¬ìš©
    current_user: models.AppUser = Depends(get_current_user),
):
    ledger = db.query(models.LedgerEntry).filter(
        models.LedgerEntry.ledger_entry_id == ledger_entry_id
    ).first()

    if not ledger:
        raise HTTPException(status_code=404, detail="ê°€ê³„ë¶€ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # ë³¸ì¸ ê°€ê³„ë¶€ë§Œ ì¡°íšŒ ê°€ëŠ¥
    if ledger.user_id != current_user.user_id:
        raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")

    return {
        "ledger_entry_id": ledger.ledger_entry_id,
        "payment_id": ledger.payment_id,
        "spend_date": ledger.spend_date,
        "category": ledger.category,
        "amount": ledger.amount,
        "memo": ledger.memo,
    }

# ======================================================
# 4ï¸âƒ£ ê°€ê³„ë¶€ ìˆ˜ì • (ì¹´í…Œê³ ë¦¬ / ë©”ëª¨ë§Œ)
# ======================================================
@router.put("/{ledger_entry_id}")
def update_ledger(
    ledger_entry_id: int,
    data: LedgerUpdateRequest,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user),
):
    ledger = (
        db.query(models.LedgerEntry)
        .filter(models.LedgerEntry.ledger_entry_id == ledger_entry_id)
        .first()
    )

    if not ledger:
        raise HTTPException(status_code=404, detail="ê°€ê³„ë¶€ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # ğŸ” ë³¸ì¸ ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥
    if ledger.user_id != current_user.user_id:
        raise HTTPException(status_code=403, detail="ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")

    if data.category is not None:
        ledger.category = data.category

    if data.memo is not None:
        ledger.memo = data.memo

    db.commit()
    db.refresh(ledger)

    return {
        "ledger_entry_id": ledger.ledger_entry_id,
        "payment_id": ledger.payment_id,
        "spend_date": ledger.spend_date,
        "category": ledger.category,
        "amount": ledger.amount,
        "memo": ledger.memo,
    }

==================================================
FILE PATH: .\backend\app\routers\payment.py
==================================================
import httpx
from datetime import datetime
from fastapi import APIRouter, Depends, HTTPException, status
from fastapi.responses import HTMLResponse, JSONResponse
from sqlalchemy.orm import Session

# ë‚´ë¶€ ëª¨ë“ˆ ì„í¬íŠ¸
from .. import models, schemas, database
from ..dependencies import get_current_user, get_db
from app.utils.check_data import validate_cart_weight
from .ledger import create_ledger_from_payment
from app.core.config import settings

# í™˜ê²½ ë³€ìˆ˜ ë° í‚¤ ì„¤ì •
BASE_URL = settings.BASE_URL if hasattr(settings, "BASE_URL") else "http://localhost:8000"
KAKAO_ADMIN_KEY = settings.KAKAO_ADMIN_KEY

# ë¼ìš°í„° ì„¤ì •
router = APIRouter(
    prefix="/payments",
    tags=["payments"],
    responses={404: {"description": "Not found"}},
)

# --- ì¹´ì¹´ì˜¤í˜ì´ CID ì„¤ì • ---
CID_ONETIME = "TC0ONETIME"       # ì¼ë°˜ ê²°ì œ
CID_SUBSCRIPTION = "TCSUBSCRIP"  # ì •ê¸°/ìë™ ê²°ì œ


# =========================================================
# ğŸ› ï¸ í—¬í¼ í•¨ìˆ˜ (ì¤‘ë³µ ë¡œì§ ë¶„ë¦¬)
# =========================================================

def get_payment_or_404(payment_id: int, user_id: int, db: Session):
    """ê²°ì œ IDë¡œ ê²°ì œ ë‚´ì—­ ì¡°íšŒ"""
    payment = db.query(models.Payment).filter(
        models.Payment.payment_id == payment_id,
        models.Payment.user_id == user_id
    ).first()
    
    if not payment:
        raise HTTPException(status_code=404, detail="ê²°ì œ ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    return payment

async def process_subscription_payment(
    db: Session, 
    user: models.AppUser, 
    cart_session_id: int, 
    amount: int, 
    item_name: str
):
    """
    âœ… [ìˆ˜ì • 3] ê²°ì œ ì‹¤í–‰ ê³µí†µ ë¡œì§ í•¨ìˆ˜
    - request_paymentì™€ pay_subscriptionì—ì„œ ê³µí†µìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    """
    # 1. ë¹Œë§í‚¤ ì¡°íšŒ
    my_card = db.query(models.PaymentMethod).filter(
        models.PaymentMethod.user_id == user.user_id,
        models.PaymentMethod.billing_key.isnot(None)
    ).order_by(models.PaymentMethod.is_default.desc()).first()
    
    if not my_card:
        raise HTTPException(status_code=404, detail="ë“±ë¡ëœ ìë™ê²°ì œ ìˆ˜ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. ì¹´ë“œë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.")

    # 2. ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ìš”ì²­
    url = "https://kapi.kakao.com/v1/payment/subscription"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_ADMIN_KEY}",
        "Content-type": "application/x-www-form-urlencoded;charset=utf-8"
    }
    
    partner_order_id = f"sub_{cart_session_id}_{int(datetime.now().timestamp())}"

    pay_data = {
        "cid": CID_SUBSCRIPTION,
        "sid": my_card.billing_key,
        "partner_order_id": partner_order_id,
        "partner_user_id": str(user.user_id),
        "item_name": item_name,
        "quantity": 1,
        "total_amount": amount,
        "tax_free_amount": 0,
    }
    
    async with httpx.AsyncClient() as client:
        response = await client.post(url, headers=headers, data=pay_data)
        res_data = response.json()
        
    if "tid" not in res_data:
        raise HTTPException(status_code=400, detail=f"ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨: {res_data}")

    # 3. ê²°ì œ ë‚´ì—­ ì €ì¥ (Payment)
    new_payment = models.Payment(
        user_id=user.user_id,
        cart_session_id=cart_session_id,
        method_id=my_card.method_id,
        pg_provider=models.PgProviderType.KAKAO_PAY,
        pg_tid=res_data['tid'],
        status=models.PaymentStatus.APPROVED,
        total_amount=amount,
        approved_at=datetime.now()
    )
    db.add(new_payment)
    
    # 4. ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ ì—…ë°ì´íŠ¸ (ACTIVE -> PAID)
    # session ê°ì²´ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ ì—…ë°ì´íŠ¸ (ì•ˆì „ì„± í™•ë³´)
    cart_session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == cart_session_id
    ).first()
    
    if cart_session:
        cart_session.status = models.CartSessionStatus.PAID
        cart_session.ended_at = datetime.now()
    
    db.commit()
    db.refresh(new_payment)
    
    # 5. ê°€ê³„ë¶€ ìë™ ë“±ë¡
    try:
        create_ledger_from_payment(payment_id=new_payment.payment_id, db=db)
    except Exception as e:
        print(f"âš ï¸ ê°€ê³„ë¶€ ìë™ë“±ë¡ ì‹¤íŒ¨: {e}")

    return {
        "status": "SUCCESS",
        "message": "ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
        "amount": amount,
        "tid": res_data["tid"],
        "approved_at": res_data["approved_at"]
    }


# =========================================================
# ğŸ›ï¸ [Main] ê²°ì œ ìš”ì²­ ë° ê²€ì¦ (ì›¹ í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™)
# =========================================================

@router.post("/request")
async def request_payment(
    req: schemas.PaymentRequest,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    """
    [ê²°ì œ ìš”ì²­ API] ë¬´ê²Œ ê²€ì¦ í›„ ìë™ ê²°ì œë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
    """
    # 1. ì„¸ì…˜ ì¡°íšŒ
    cart_session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == req.cart_session_id,
        models.CartSession.user_id == current_user.user_id,
        models.CartSession.status == models.CartSessionStatus.ACTIVE
    ).first()

    if not cart_session:
        raise HTTPException(status_code=404, detail="ê²°ì œí•  í™œì„± ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # 2. ë¬´ê²Œ ì—…ë°ì´íŠ¸ ë° ê²€ì¦
    cart_session.measured_total_g = req.measured_weight_g
    db.commit() 

    weight_check = validate_cart_weight(
        db=db,
        cart_session_id=req.cart_session_id,
        measured_weight_g=req.measured_weight_g
    )

    if not weight_check["is_valid"]:
        return JSONResponse(
            status_code=409, 
            content={
                "status": "WARNING",
                "message": weight_check["message"],
                "difference": weight_check["difference"],
                "expected_weight": weight_check["expected_weight"],
                "measured_weight": weight_check["measured_weight"],
                "action_required": "CHECK_CART_ITEMS" 
            }
        )

    # 3. ê²°ì œ ì§„í–‰ (ìë™ê²°ì œ)
    if req.use_subscription:
        try:
            # â™»ï¸ ê³µí†µ í•¨ìˆ˜ í˜¸ì¶œë¡œ ì½”ë“œ ì¤‘ë³µ í•´ê²°!
            return await process_subscription_payment(
                db=db,
                user=current_user,
                cart_session_id=req.cart_session_id,
                amount=req.amount,
                item_name="ìŠ¤ë§ˆíŠ¸ ì¥ë°”êµ¬ë‹ˆ ê²°ì œ"
            )
        except HTTPException as e:
            raise e
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"ê²°ì œ ì˜¤ë¥˜: {str(e)}")
    else:
        return {"message": "ì¼ë°˜ ê²°ì œ(QR)ëŠ” /ready APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."}


# =========================================================
# ğŸ†• ì •ê¸°ê²°ì œ(Billing Key) ë“±ë¡ ë° í…ŒìŠ¤íŠ¸ ê²°ì œ
# =========================================================

@router.post("/subscription/register/ready", response_model=schemas.PaymentReadyResponse)
async def register_card_ready(
    current_user: models.AppUser = Depends(get_current_user)
):
    """[ì¹´ë“œ ë“±ë¡ 1ë‹¨ê³„] ì¸ì¦ ìš”ì²­"""
    url = "https://kapi.kakao.com/v1/payment/ready"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_ADMIN_KEY}",
        "Content-type": "application/x-www-form-urlencoded;charset=utf-8"
    }
    
    order_id = f"reg_{current_user.user_id}_{int(datetime.now().timestamp())}"
    
    data = {
        "cid": CID_SUBSCRIPTION,
        "partner_order_id": order_id,
        "partner_user_id": str(current_user.user_id),
        "item_name": "ì¹´ë“œ ìë™ê²°ì œ ë“±ë¡",
        "quantity": 1,
        "total_amount": 0,
        "tax_free_amount": 0,
        "approval_url": f"{BASE_URL}/api/payments/subscription/register/callback?status=success",
        "cancel_url": f"{BASE_URL}/api/payments/subscription/register/callback?status=cancel",
        "fail_url": f"{BASE_URL}/api/payments/subscription/register/callback?status=fail",
    }

    async with httpx.AsyncClient() as client:
        response = await client.post(url, headers=headers, data=data)
        res_data = response.json()

    if "tid" not in res_data:
        raise HTTPException(status_code=400, detail=f"KakaoPay Error: {res_data}")

    return schemas.PaymentReadyResponse(
        tid=res_data['tid'],
        next_redirect_app_url=res_data.get('next_redirect_app_url'),
        next_redirect_mobile_url=res_data.get('next_redirect_mobile_url'),
        next_redirect_pc_url=res_data.get('next_redirect_pc_url'),
        partner_order_id=order_id
    )


@router.get("/subscription/register/approve")
async def register_card_approve(
    tid: str,
    pg_token: str,
    partner_order_id: str,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    """[ì¹´ë“œ ë“±ë¡ 2ë‹¨ê³„] ë¹Œë§í‚¤ ë°œê¸‰"""
    url = "https://kapi.kakao.com/v1/payment/approve"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_ADMIN_KEY}",
        "Content-type": "application/x-www-form-urlencoded;charset=utf-8"
    }
    
    data = {
        "cid": CID_SUBSCRIPTION,
        "tid": tid,
        "partner_order_id": partner_order_id,
        "partner_user_id": str(current_user.user_id),
        "pg_token": pg_token
    }
    
    async with httpx.AsyncClient() as client:
        response = await client.post(url, headers=headers, data=data)
        res_data = response.json()

    if "sid" not in res_data:
        raise HTTPException(status_code=400, detail=f"ë“±ë¡ ì‹¤íŒ¨: {res_data}")

    sid = res_data["sid"]
    card_info = res_data.get("card_info", {})
    
    new_method = models.PaymentMethod(
        user_id=current_user.user_id,
        method_type=models.PaymentMethodType.KAKAO_PAY,
        billing_key=sid,
        card_brand=card_info.get("kakaopay_purchase_corp", "KAKAO"),
        card_last4=card_info.get("bin", "0000")[:4], 
        is_default=True 
    )
    
    db.add(new_method)
    db.commit()
    db.refresh(new_method)

    return {"message": "ì¹´ë“œ ë“±ë¡ ì™„ë£Œ", "billing_key": sid, "method_id": new_method.method_id}


@router.post("/subscription/pay")
async def pay_subscription(
    cart_session_id: int,
    amount: int,
    item_name: str = "ìŠ¤ë§ˆíŠ¸ ì¥ë°”êµ¬ë‹ˆ ìë™ê²°ì œ",
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    """
    [í…ŒìŠ¤íŠ¸ìš©/ì§ì ‘í˜¸ì¶œìš©] ë¬´ê²Œ ê²€ì¦ ì—†ì´ ì¦‰ì‹œ ê²°ì œ
    """
    # â™»ï¸ ê³µí†µ í•¨ìˆ˜ í˜¸ì¶œë¡œ ì½”ë“œ ì¤‘ë³µ í•´ê²°!
    return await process_subscription_payment(
        db=db,
        user=current_user,
        cart_session_id=cart_session_id,
        amount=amount,
        item_name=item_name
    )


@router.get("/subscription/register/callback", response_class=HTMLResponse)
async def register_callback(status: str, pg_token: str = None):
    if status == "success":
        return f"""
        <html>
            <head><title>ë“±ë¡ ì„±ê³µ</title></head>
            <body>
                <h1 style="color:blue;">ì¹´ë“œ ë“±ë¡ ì¸ì¦ ì™„ë£Œ!</h1>
                <p>ì•„ë˜ í† í°ì„ ë³µì‚¬í•´ì„œ <b>approve API</b>ì— ì…ë ¥í•˜ì„¸ìš”.</p>
                <div style="background:#eee; padding:10px; font-size:1.2em;">{pg_token}</div>
            </body>
        </html>
        """
    return "<h1>ë“±ë¡ ì·¨ì†Œ ë˜ëŠ” ì‹¤íŒ¨</h1>"


# =========================================================
# ğŸš€ [Legacy] ì¼ë°˜ 1íšŒì„± ê²°ì œ (QR/PC)
# =========================================================
# (ì´í•˜ 1íšŒì„± ê²°ì œ ì½”ë“œëŠ” ë³€ê²½ ì—†ìŒ, ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ ë©ë‹ˆë‹¤)
# ...
@router.post("/ready", response_model=schemas.PaymentReadyResponse)
async def payment_ready(
    request: schemas.PaymentReadyRequest,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    user_id = current_user.user_id
    cart_session = db.query(models.CartSession).filter(
        models.CartSession.cart_session_id == request.cart_session_id
    ).first()
    
    if not cart_session:
        raise HTTPException(status_code=404, detail="í•´ë‹¹ ì¹´íŠ¸ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    weight_check = validate_cart_weight(
        db=db,
        cart_session_id=cart_session.cart_session_id,
        measured_weight_g=cart_session.measured_total_g
    )

    if not weight_check["is_valid"]:
        raise HTTPException(status_code=400, detail=weight_check["message"])

    existing_payment = db.query(models.Payment).filter(
        models.Payment.cart_session_id == request.cart_session_id
    ).first()
    if existing_payment:
        db.delete(existing_payment)
        db.commit()

    url = "https://kapi.kakao.com/v1/payment/ready"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_ADMIN_KEY}",
        "Content-type": "application/x-www-form-urlencoded;charset=utf-8"
    }
    
    data = {
        "cid": CID_ONETIME,
        "partner_order_id": str(cart_session.cart_session_id),
        "partner_user_id": str(user_id),
        "item_name": "ìŠ¤ë§ˆíŠ¸ ì¥ë³´ê¸° ê²°ì œ",
        "quantity": 1,
        "total_amount": request.total_amount,
        "tax_free_amount": 0,
        "approval_url": f"{BASE_URL}/api/payments/success",
        "cancel_url": f"{BASE_URL}/api/payments/cancel",
        "fail_url": f"{BASE_URL}/api/payments/fail",
    }

    async with httpx.AsyncClient() as client:
        response = await client.post(url, headers=headers, data=data)
        res_data = response.json()

    if "tid" not in res_data:
        raise HTTPException(status_code=400, detail=f"KakaoPay Error: {res_data}")

    new_payment = models.Payment(
        cart_session_id=cart_session.cart_session_id,
        user_id=user_id,
        pg_provider=models.PgProviderType.KAKAO_PAY,
        pg_tid=res_data['tid'],
        status=models.PaymentStatus.PENDING,
        total_amount=request.total_amount,
        method_id=request.method_id
    )
    db.add(new_payment)
    db.commit()

    return schemas.PaymentReadyResponse(
        tid=res_data['tid'],
        next_redirect_app_url=res_data.get('next_redirect_app_url'),
        next_redirect_mobile_url=res_data.get('next_redirect_mobile_url'),
        next_redirect_pc_url=res_data.get('next_redirect_pc_url')
    )

@router.post("/approve", response_model=schemas.PaymentResponse)
async def payment_approve(
    request: schemas.PaymentApproveRequest,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    user_id = current_user.user_id
    payment = db.query(models.Payment).filter(
        models.Payment.pg_tid == request.tid,
        models.Payment.user_id == user_id,
        models.Payment.status == models.PaymentStatus.PENDING
    ).first()

    if not payment:
        raise HTTPException(status_code=404, detail="ëŒ€ê¸° ì¤‘ì¸ ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    url = "https://kapi.kakao.com/v1/payment/approve"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_ADMIN_KEY}",
        "Content-type": "application/x-www-form-urlencoded;charset=utf-8"
    }
    data = {
        "cid": CID_ONETIME,
        "tid": request.tid,
        "partner_order_id": str(payment.cart_session_id),
        "partner_user_id": str(user_id),
        "pg_token": request.pg_token
    }

    async with httpx.AsyncClient() as client:
        response = await client.post(url, headers=headers, data=data)
        res_data = response.json()

    if "aid" not in res_data:
        payment.status = models.PaymentStatus.FAILED
        db.commit()
        raise HTTPException(status_code=400, detail=f"Approval failed: {res_data}")

    payment.status = models.PaymentStatus.APPROVED
    payment.approved_at = datetime.now()
    
    if payment.cart_session_id:
        cart_session = db.query(models.CartSession).filter(
            models.CartSession.cart_session_id == payment.cart_session_id
        ).first()
        if cart_session:
            cart_session.status = models.CartSessionStatus.PAID
            cart_session.ended_at = datetime.now()

    db.commit()
    db.refresh(payment)

    try:
        create_ledger_from_payment(payment_id=payment.payment_id, db=db)
    except Exception as e:
        print(f"âš ï¸ ê°€ê³„ë¶€ ë“±ë¡ ì‹¤íŒ¨: {e}")

    return payment

@router.get("/success", response_class=HTMLResponse)
async def payment_success_callback(pg_token: str):
    return HTMLResponse(content=f"""
    <html>
        <head><title>ê²°ì œ ì„±ê³µ</title></head>
        <body style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;">
            <h1 style="color:green;">âœ… ê²°ì œ ìŠ¹ì¸ ëŒ€ê¸°ì¤‘</h1>
            <p>ì•±ìœ¼ë¡œ ëŒì•„ê°€ì„œ ê²°ì œ ì™„ë£Œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            <p>í† í°: <b>{pg_token}</b></p>
        </body>
    </html>
    """)

@router.get("/cancel")
async def payment_cancel_callback():
    return JSONResponse(content={"message": "ê²°ì œ ì·¨ì†Œ", "status": "CANCELLED"})

@router.get("/fail")
async def payment_fail_callback():
    return JSONResponse(content={"message": "ê²°ì œ ì‹¤íŒ¨", "status": "FAILED"}, status_code=400)

@router.get("/methods", response_model=list[schemas.PaymentMethodResponse])
async def get_payment_methods(
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    return db.query(models.PaymentMethod).filter(
        models.PaymentMethod.user_id == current_user.user_id
    ).all()

@router.post("/methods", response_model=schemas.PaymentMethodResponse)
async def register_payment_method(
    request: schemas.PaymentMethodCreate,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    user_id = current_user.user_id
    existing_count = db.query(models.PaymentMethod).filter(
        models.PaymentMethod.user_id == user_id
    ).count()
    is_default = (existing_count == 0)

    new_method = models.PaymentMethod(
        user_id=user_id,
        method_type=request.method_type,
        card_brand=request.card_brand,
        card_last4=request.card_last4,
        billing_key=request.billing_key,
        is_default=is_default or request.is_default
    )
    db.add(new_method)
    db.commit()
    db.refresh(new_method)
    return new_method

@router.delete("/methods/{method_id}")
async def delete_payment_method(
    method_id: int,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    method = db.query(models.PaymentMethod).filter(
        models.PaymentMethod.method_id == method_id,
        models.PaymentMethod.user_id == current_user.user_id
    ).first()

    if not method:
        raise HTTPException(status_code=404, detail="ê²°ì œ ìˆ˜ë‹¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    db.delete(method)
    db.commit()
    return {"message": "ê²°ì œ ìˆ˜ë‹¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."}

@router.get("/{payment_id}", response_model=schemas.PaymentDetailResponse)
async def get_payment_detail(
    payment_id: int,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    """
    ê²°ì œ ìƒì„¸ ë‚´ì—­ ì¡°íšŒ
    - ê²°ì œ ì •ë³´ ë° í•´ë‹¹ ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì˜ ì•„ì´í…œ ëª©ë¡ì„ í¬í•¨í•©ë‹ˆë‹¤.
    """
    # 1. ë³¸ì¸ ê²°ì œ ë‚´ì—­ì¸ì§€ í™•ì¸í•˜ë©° ì¡°íšŒ
    payment = get_payment_or_404(payment_id, current_user.user_id, db)
    
    # 2. ì‘ë‹µ ë°ì´í„° ìƒì„± (Pydantic ëª¨ë¸ ë³€í™˜)
    response = schemas.PaymentDetailResponse.model_validate(payment)
    
    # 3. ì¥ë°”êµ¬ë‹ˆ í’ˆëª© ëª©ë¡ ì¶”ê°€ (CartSession -> items)
    if payment.session and payment.session.items:
        items_list = []
        for item in payment.session.items:
            # item.productëŠ” lazy loading ë˜ë¯€ë¡œ ëª…ì‹œì ìœ¼ë¡œ ë³€í™˜
            product_simple = schemas.ProductSimpleResponse.model_validate(item.product)

            cart_item_res = schemas.CartItemResponse(
                cart_item_id=item.cart_item_id,
                product=product_simple,
                quantity=item.quantity,
                unit_price=item.unit_price,
                total_price=item.unit_price * item.quantity
            )
            items_list.append(cart_item_res)

        response.items = items_list

    return response


@router.post("/{payment_id}/cancel", response_model=schemas.PaymentResponse)
async def cancel_payment(
    payment_id: int,
    request: schemas.PaymentCancelRequest,
    db: Session = Depends(get_db),
    current_user: models.AppUser = Depends(get_current_user)
):
    payment = get_payment_or_404(payment_id, current_user.user_id, db)

    if payment.status != models.PaymentStatus.APPROVED:
        raise HTTPException(status_code=400, detail="ìŠ¹ì¸ ì™„ë£Œëœ ê²°ì œë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    url = "https://kapi.kakao.com/v1/payment/cancel"
    headers = {
        "Authorization": f"KakaoAK {KAKAO_ADMIN_KEY}",
        "Content-type": "application/x-www-form-urlencoded;charset=utf-8"
    }
    
    cid_to_use = CID_ONETIME if payment.method_id is None else CID_SUBSCRIPTION
    
    data = {
        "cid": cid_to_use, 
        "tid": payment.pg_tid,
        "cancel_amount": payment.total_amount,
        "cancel_tax_free_amount": 0,
    }

    async with httpx.AsyncClient() as client:
        response = await client.post(url, headers=headers, data=data)
        res_data = response.json()

    if "tid" not in res_data:
        raise HTTPException(status_code=400, detail=f"Cancel failed: {res_data}")

    payment.status = models.PaymentStatus.CANCELLED
    db.commit()
    db.refresh(payment)

    return payment

==================================================
FILE PATH: .\backend\app\routers\product.py
==================================================
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session, joinedload
from sqlalchemy import func, or_
from typing import List, Optional

from app.database import get_db
from app.models import Product, ProductCategory
from app.schemas import ProductResponse, ProductLocationResponse

router = APIRouter(
    prefix="/products",
    tags=["products"],
    responses={404: {"description": "Not found"}},
)

# ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
@router.get("/", response_model=List[ProductResponse])
def read_products(db: Session = Depends(get_db)):
    products = db.query(Product).all()
    return products

# ìƒí’ˆ ê²€ìƒ‰ (ì›¹ / pg_trgm ê¸°ë°˜) 
@router.get("/search", response_model=List[ProductResponse])
def search_products(
    q: str = Query(..., min_length=1, description="ê²€ìƒ‰ì–´"),
    db: Session = Depends(get_db),
):
    """
    ìƒí’ˆëª…ìœ¼ë¡œ ìƒí’ˆì„ ê²€ìƒ‰í•©ë‹ˆë‹¤. pg_trgmì„ í™œìš©í•œ ì˜¤íƒ€ í—ˆìš©(Fuzzy) ê²€ìƒ‰ì´ ì ìš©ë©ë‹ˆë‹¤.
    """
    products = (
        db.query(Product)
        .filter(func.similarity(Product.name, q) > 0.2)
        .order_by(func.similarity(Product.name, q).desc())
        .limit(20)
        .all()
    )
    return products

# ìƒí’ˆ ìƒì„¸ ì¡°íšŒ
@router.get("/{product_id}", response_model=ProductResponse)
async def read_product(product_id: int, db: Session = Depends(get_db)):
    """
    ìƒí’ˆ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
    """
    product = (
        db.query(Product)
        .options(joinedload(Product.category))
        .filter(Product.product_id == product_id)
        .first()
    )

    if not product:
        raise HTTPException(status_code=404, detail="Product not found")
    
    # ì¡°ì¸ëœ ì¹´í…Œê³ ë¦¬ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€ í•„ë“œ ì„¤ì • (ProductResponse ìŠ¤í‚¤ë§ˆ ëŒ€ì‘)
    if product.category:
        setattr(product, 'zone_code', product.category.zone_code)
        setattr(product, 'category_name', product.category.name)
        
    return product

# ìƒí’ˆ ìœ„ì¹˜ ì•ˆë‚´
@router.get("/{product_id}/location", response_model=ProductLocationResponse)
def get_product_location(
    product_id: int,
    db: Session = Depends(get_db),
):
    product = (
        db.query(Product)
        .options(joinedload(Product.category))
        .filter(Product.product_id == product_id)
        .first()
    )

    if not product:
        raise HTTPException(status_code=404, detail="Product not found")

    category = product.category
    zone_code = category.zone_code if category else "Unknown"

    return ProductLocationResponse(
        product_id=product.product_id,
        name=product.name,
        zone_code=zone_code,
        # TODO: ì‹¤ì œ ë§µ ì´ë¯¸ì§€ URL ë¡œì§ í•„ìš” ì‹œ ì¶”ê°€
        map_image_url=f"https://example.com/maps/{zone_code}.png" if zone_code else None
    )

# ë°”ì½”ë“œë¡œ ìƒí’ˆ ì¡°íšŒ
@router.get("/barcode/{barcode}", response_model=ProductResponse)
def get_product_by_barcode(
    barcode: str,
    db: Session = Depends(get_db)
):
    clean_barcode = barcode.strip()

    product = (
        db.query(Product)
        .filter(Product.barcode == clean_barcode)
        .first()
    )

    if not product:
        raise HTTPException(
            status_code=404,
            detail="ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        )

    return product



==================================================
FILE PATH: .\backend\app\routers\recipe.py
==================================================
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List

from .. import models, schemas, database

router = APIRouter(
    prefix="/recipes",
    tags=["recipes"],
)

@router.get("/{recipe_id}", response_model=schemas.RecipeDetailResponse)
def get_recipe_detail(
    recipe_id: int, 
    db: Session = Depends(database.get_db)
):
    """
    ë ˆì‹œí”¼ ìƒì„¸ ì¡°íšŒ
    - ë ˆì‹œí”¼ ê¸°ë³¸ ì •ë³´
    - í¬í•¨ëœ ì¬ë£Œ ëª©ë¡ (Product ì •ë³´ í¬í•¨)
    """
    recipe = db.query(models.Recipe).filter(models.Recipe.recipe_id == recipe_id).first()
    if not recipe:
        raise HTTPException(status_code=404, detail="ë ˆì‹œí”¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # ì¬ë£Œ ì •ë³´ ì¡°ë¦½
    ingredients_response = []
    for ri in recipe.ingredients:
        ingredients_response.append({
            "product_id": ri.product_id,
            "name": ri.product.name,
            "quantity_info": ri.quantity_info,
            "image_url": ri.product.image_url
        })

    return {
        "recipe_id": recipe.recipe_id,
        "title": recipe.title,
        "description": recipe.description,
        "instructions": recipe.instructions,
        "image_url": recipe.image_url,
        "prep_time_min": 30, # ì„ì‹œê°’
        "difficulty_label": "ë³´í†µ", # ì„ì‹œê°’
        "calories": 500, # ì„ì‹œê°’
        "ingredients": ingredients_response
    }


==================================================
FILE PATH: .\backend\app\routers\recommendation.py
==================================================
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from sqlalchemy import desc, asc
from typing import List

from .. import models, schemas, database
from ..dependencies import get_current_user

router = APIRouter(
    prefix="/recommendations",
    tags=["recommendations"],
    responses={404: {"description": "Not found"}},
)

@router.get("/by-product/{product_id}", response_model=List[schemas.RecipeRecommendResponse])
def recommend_recipes_ai(
    product_id: int, 
    cart_session_id: int = None, # ë‚´ ì¥ë°”êµ¬ë‹ˆë‘ ë¹„êµí•˜ë ¤ë©´ í•„ìš”
    db: Session = Depends(database.get_db)
):
    """
    [AI ì¶”ì²œ ë¡œì§]
    1. ì„ íƒí•œ ìƒí’ˆ(product_id)ì˜ ì„ë² ë”© ë²¡í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    2. pgvectorë¥¼ ì‚¬ìš©í•´ í•´ë‹¹ ìƒí’ˆê³¼ 'ì˜ë¯¸ì ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´' ë ˆì‹œí”¼ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    3. (ì˜µì…˜) í˜„ì¬ ì¥ë°”êµ¬ë‹ˆì— ì—†ëŠ” ë¶€ì¡±í•œ ì¬ë£Œë¥¼ ê³„ì‚°í•´ì„œ ì•Œë ¤ì¤ë‹ˆë‹¤.
    """
    
    # 1. ìƒí’ˆ ì¡°íšŒ (ë²¡í„° í¬í•¨)
    target_product = db.query(models.Product).filter(models.Product.product_id == product_id).first()
    if not target_product:
        raise HTTPException(status_code=404, detail="ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    # 2. AI ì¶”ì²œ ì¿¼ë¦¬ ì‘ì„±
    # embeddingì´ ìˆëŠ” ê²½ìš°: ì½”ì‚¬ì¸ ê±°ë¦¬(Cosine Distance)ë¡œ ìœ ì‚¬ë„ ì •ë ¬
    # embeddingì´ ì—†ëŠ” ê²½ìš°: ë‹¨ìˆœíˆ í•´ë‹¹ ì¬ë£Œë¥¼ í¬í•¨í•˜ëŠ” ë ˆì‹œí”¼ ê²€ìƒ‰ (Fallback)
    
    if target_product.embedding is not None:
        # ğŸ”¥ í•µì‹¬: pgvectorì˜ <=> ì—°ì‚°ì (Cosine Distance) ì‚¬ìš©
        # ìƒí’ˆì˜ ë²¡í„°ì™€ ë ˆì‹œí”¼ì˜ ë²¡í„° ê±°ë¦¬ê°€ ê°€ê¹Œìš¸ìˆ˜ë¡ ìƒìœ„ì— ë…¸ì¶œ
        recommendations = (
            db.query(models.Recipe)
            .order_by(models.Recipe.embedding.cosine_distance(target_product.embedding))
            .limit(5)
            .all()
        )
    else:
        # ë²¡í„°ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ì²˜ëŸ¼ 'ì¬ë£Œ í¬í•¨ ì—¬ë¶€'ë¡œ ê²€ìƒ‰ (Hard Rule)
        recommendations = (
            db.query(models.Recipe)
            .join(models.RecipeIngredient)
            .filter(models.RecipeIngredient.product_id == product_id)
            .limit(5)
            .all()
        )

    # 3. ì¥ë°”êµ¬ë‹ˆ ë¹„êµë¥¼ ìœ„í•œ ë‚´ ì•„ì´í…œ ì¡°íšŒ
    my_owned_product_ids = set()
    if cart_session_id:
        my_items = db.query(models.CartItem).filter(models.CartItem.cart_session_id == cart_session_id).all()
        my_owned_product_ids = {item.product_id for item in my_items}
        # ë°©ê¸ˆ ì°ì€ ìƒí’ˆë„ í¬í•¨
        my_owned_product_ids.add(product_id)

    # 4. ì‘ë‹µ ë°ì´í„° ì¡°ë¦½ (ë¶€ì¡±í•œ ì¬ë£Œ ê³„ì‚°)
    results = []
    for recipe in recommendations:
        # ì´ ë ˆì‹œí”¼ì˜ ëª¨ë“  ì¬ë£Œ ê°€ì ¸ì˜¤ê¸°
        recipe_ingredients = db.query(models.RecipeIngredient).filter(
            models.RecipeIngredient.recipe_id == recipe.recipe_id
        ).all()
        
        all_ingredients = []
        missing_list = []
        for ri in recipe_ingredients:
            # ì£¼ì¬ë£Œ(Product) ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            ing_product = ri.product 
            is_owned = ing_product.product_id in my_owned_product_ids
            
            # ì „ì²´ ì¬ë£Œ ë¦¬ìŠ¤íŠ¸
            all_ingredients.append({
                "product_id": ing_product.product_id,
                "name": ing_product.name,
                "is_owned": is_owned
            })
            
            if not is_owned:
                missing_list.append({
                    "product_id": ing_product.product_id,
                    "name": ing_product.name,
                    "is_owned": False
                })

        # ê²°ê³¼ ì¶”ê°€
        results.append({
            "recipe_id": recipe.recipe_id,
            "title": recipe.title,
            "description": recipe.description,
            "image_url": recipe.image_url,
            # AI ìœ ì‚¬ë„ ì ìˆ˜ê°€ ìˆìœ¼ë©´ ë„£ê³  ì•„ë‹ˆë©´ 0 (embeddingì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ)
            "similarity_score": 0.0, # ê³„ì‚°í•˜ë ¤ë©´ ì¿¼ë¦¬ì—ì„œ distance ì»¬ëŸ¼ì„ select í•´ì•¼ í•¨ (ë³µì¡ë„ ë•Œë¬¸ì— ìƒëµí•˜ê±°ë‚˜ ì¶”í›„ ê³ ë„í™”)
            "ingredients": all_ingredients,  
            "missing_ingredients": missing_list
        })

    return results

==================================================
FILE PATH: .\backend\app\routers\user.py
==================================================
# app/routers/user.py
from fastapi import APIRouter, Depends, HTTPException, status, Response
from sqlalchemy.orm import Session
from sqlalchemy.exc import IntegrityError

from app.database import get_db
from app import schemas
from app.models import AppUser, UserProvider
from app.utils.security import hash_password, verify_password
from app.utils.jwt import create_access_token, create_refresh_token
from app.dependencies import get_current_user
from app.schemas import UserNicknameUpdate, UserPasswordUpdate
from datetime import datetime


# Auth ê´€ë ¨ ë¼ìš°í„° (íšŒì›ê°€ì…, ë¡œê·¸ì¸, ë¡œê·¸ì•„ì›ƒ)
auth_router = APIRouter(prefix="/auth", tags=["Auth"])

# User ê´€ë ¨ ë¼ìš°í„° (ë‚´ ì •ë³´, í”„ë¡œí•„ ê´€ë¦¬)
user_router = APIRouter(prefix="/users", tags=["User"])


# íšŒì›ê°€ì…
@auth_router.post("/signup", response_model=schemas.UserMeResponse)
def signup(
    request: schemas.UserCreate,
    db: Session = Depends(get_db)
):
    try:
        user = AppUser(
            email=request.email,
            password_hash=hash_password(request.password),
            nickname=request.nickname,
            provider=UserProvider.LOCAL
        )
        db.add(user)
        db.commit()
        db.refresh(user)
        return user

    # ì´ë©”ì¼ ì¤‘ë³µ
    except IntegrityError:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Email already registered"
        )

    # í•´ì‹œ ê³¼ì •ì—ì„œ ë°œìƒí•˜ëŠ” ì˜ˆì™¸ë¥¼ 422ë¡œ ë³€í™˜ (ì„œë²„ 500 ë°©ì§€)
    except ValueError as e:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
            detail=str(e)
        )

# ë¡œê·¸ì¸
@auth_router.post("/login")
def login(
    request: schemas.UserLogin,
    response: Response,             
    db: Session = Depends(get_db)
):
    user = (
        db.query(AppUser)
        .filter(AppUser.email == request.email)
        .first()
    )

    if not user or not user.password_hash:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid email or password"
        )

    if not verify_password(request.password, user.password_hash):
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid email or password"
        )

    access_token = create_access_token(str(user.user_id))
    refresh_token = create_refresh_token(str(user.user_id))

    # Refresh Tokenì„ HttpOnly Cookieë¡œ ì„¤ì •
    response.set_cookie(
        key="refresh_token",
        value=refresh_token,
        httponly=True,
        samesite="lax",
        secure=False,   # HTTPSë©´ True
        path="/"
    )

    # dictë¡œ ë°˜í™˜ (FastAPIê°€ JSON Response ìë™ ìƒì„±)
    return {
        "access_token": access_token,
        "token_type": "bearer"
    }

# ë¡œê·¸ì•„ì›ƒ
@auth_router.post("/logout")
def logout(response: Response):
    response.delete_cookie(
        key="refresh_token",
        path="/",
    )
    return {"message": "Logged out successfully"}


# ë‚´ ì •ë³´ ì¡°íšŒ
@user_router.get("/me", response_model=schemas.UserMeResponse)
def read_me(
    current_user: AppUser = Depends(get_current_user)
):
    return current_user

# ë‹‰ë„¤ì„ ë³€ê²½
@user_router.patch("/me/nickname", response_model=schemas.UserMeResponse)
def update_nickname(
    req: schemas.UserNicknameUpdate,
    db: Session = Depends(get_db),
    current_user: AppUser = Depends(get_current_user),
):
    current_user.nickname = req.nickname
    db.commit()
    db.refresh(current_user)
    return current_user


# ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
@user_router.patch("/me/password")
def update_password(
    req: schemas.UserPasswordUpdate,
    db: Session = Depends(get_db),
    current_user: AppUser = Depends(get_current_user),
):
    # OAuth ìœ ì € ì°¨ë‹¨
    if current_user.provider != UserProvider.LOCAL:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="OAuth users cannot change password"
        )

    # í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ 
    if not verify_password(req.current_password, current_user.password_hash):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Current password is incorrect"
        )

    current_user.password_hash = hash_password(req.new_password)
    db.commit()

    return {"message": "Password updated successfully"}


# íšŒì›íƒˆí‡´
@user_router.delete("/me")
def withdraw_user(
    req: schemas.UserWithdraw,
    response: Response,
    db: Session = Depends(get_db),
    current_user: AppUser = Depends(get_current_user),
):
    # ì´ë¯¸ íƒˆí‡´í•œ ìœ ì € ë°©ì–´
    if not current_user.is_active:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="User already withdrawn"
        )

    # LOCAL ìœ ì € â†’ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
    if current_user.provider == UserProvider.LOCAL:
        if not req.password:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Password is required"
            )
        if not verify_password(req.password, current_user.password_hash):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="Password is incorrect"
            )

    # Soft delete ì²˜ë¦¬
    current_user.is_active = False
    current_user.deleted_at = datetime.utcnow()
    db.commit()

    # ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (refresh token ì œê±°)
    response.delete_cookie(
        key="refresh_token",
        path="/"
    )

    return {"message": "Account withdrawn successfully"}


==================================================
FILE PATH: .\backend\app\routers\__init__.py
==================================================
from .auth import router as auth_router
from .cart import router as cart_router
from .ledger import router as ledger_router
from .payment import router as payment_router
from .product import router as product_router
from .recommendation import router as recommendation_router
from .user import user_router, auth_router as user_auth_router
from .recipe import router as recipe_router
from .admin import router as admin_router

__all__ = [
    "auth_router",
    "cart_router",
    "ledger_router",
    "payment_router",
    "product_router",
    "recommendation_router",
    "user_router",
    "user_auth_router",
    "recipe_router",
    "admin_router",
]


==================================================
FILE PATH: .\backend\app\utils\check_data.py
==================================================
from sqlalchemy.orm import Session
from fastapi import HTTPException
from app.models import CartSession, CartItem, Product

# ì˜¤ì°¨ í—ˆìš© 
TOLERANCE_RATE = 0.05  # 5%

# ë¬´ê²Œ ê²€ì¦
def validate_cart_weight(
    db: Session,
    cart_session_id: int,
    measured_weight_g: int
) -> dict:
    cart = db.query(CartSession).filter(
        CartSession.cart_session_id == cart_session_id
    ).first()

    items = db.query(CartItem).join(Product).filter(
        CartItem.cart_session_id == cart_session_id
    ).all()

    expected_weight = sum(
        item.quantity * item.product.unit_weight_g
        for item in items
    )

    difference = measured_weight_g - expected_weight
    tolerance = int(expected_weight * TOLERANCE_RATE)

    if abs(difference) <= tolerance:
        status = "MATCH"
        message = "ë¬´ê²Œ ê²€ì¦ í†µê³¼. ê²°ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤."
    elif difference > 0:
        status = "OVER_WEIGHT"
        message = "ë¬´ê²Œê°€ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒí’ˆ ìˆ˜ëŸ‰ì„ ë³€ê²½í•˜ê±°ë‚˜ ìƒí’ˆì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”."
    else:
        status = "UNDER_WEIGHT"
        message = "ë¬´ê²Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ìƒí’ˆì„ ì‚­ì œí•˜ê±°ë‚˜ ìˆ˜ëŸ‰ì„ ë³€ê²½í•´ ì£¼ì„¸ìš”."

    cart.expected_total_g = expected_weight
    cart.measured_total_g = measured_weight_g

    return {
        "is_valid": status == "MATCH",
        "status": status,
        "expected_weight": expected_weight,
        "measured_weight": measured_weight_g,
        "difference": difference,
        "tolerance": tolerance,
        "message": message
    }


==================================================
FILE PATH: .\backend\app\utils\email.py
==================================================
# app/utils/email.py

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from os import getenv

SMTP_HOST = getenv("SMTP_HOST")
SMTP_PORT = int(getenv("SMTP_PORT"))
SMTP_USER = getenv("SMTP_USER")
SMTP_PASSWORD = getenv("SMTP_PASSWORD")


def send_reset_password_email(to_email: str, reset_link: str):
    msg = MIMEMultipart()
    msg["From"] = SMTP_USER
    msg["To"] = to_email
    msg["Subject"] = "[SmartCart] ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì•ˆë‚´"

    body = f"""
ì•ˆë…•í•˜ì„¸ìš”.

ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì •í•´ì£¼ì„¸ìš”.

{reset_link}

ë³¸ ë§í¬ëŠ” ì¼ì • ì‹œê°„ í›„ ë§Œë£Œë©ë‹ˆë‹¤.
"""
    msg.attach(MIMEText(body, "plain"))

    with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as server:
        server.starttls()
        server.login(SMTP_USER, SMTP_PASSWORD)
        server.send_message(msg)


==================================================
FILE PATH: .\backend\app\utils\jwt.py
==================================================
# app/utils/jwt.py
from datetime import datetime, timedelta
from jose import jwt, JWTError, ExpiredSignatureError
from typing import Optional
from fastapi import HTTPException, status

SECRET_KEY = "SECRET_KEY"
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30
REFRESH_TOKEN_EXPIRE_DAYS = 7


def create_access_token(subject: str, expires_delta: Optional[timedelta] = None) -> str:
    expire = datetime.utcnow() + (
        expires_delta or timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    )

    payload = {
        "sub": subject,
        "exp": expire,
        "type": "access",
    }

    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)


def create_refresh_token(subject: str, expires_delta: Optional[timedelta] = None) -> str:
    expire = datetime.utcnow() + (
        expires_delta or timedelta(days=REFRESH_TOKEN_EXPIRE_DAYS)
    )

    payload = {
        "sub": subject,
        "exp": expire,
        "type": "refresh",
    }

    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)


def decode_token(token: str) -> dict:
    try:
        return jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
    except ExpiredSignatureError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Token expired"
        )
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="Invalid token"
        )


==================================================
FILE PATH: .\backend\app\utils\security.py
==================================================
# app/utils/security.py
from passlib.context import CryptContext

pwd_context = CryptContext(
    schemes=["argon2"],
    deprecated="auto"
)

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)


==================================================
FILE PATH: .\backend\scripts\reset_db.py
==================================================
import os
import sys
from sqlalchemy import create_engine, text
from app.core.config import settings

def reset_database():
    print("ğŸ—‘ï¸ Database reset initiated...")
    
    # DB URL í™•ì¸
    db_url = settings.DATABASE_URL
    if not db_url:
        print("âŒ DATABASE_URL not found!")
        sys.exit(1)
        
    engine = create_engine(db_url)
    
    # Drop all tables and types logic
    # CASCADEë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜ì¡´ì„± ìˆëŠ” ê°ì²´ë“¤ë„ ëª¨ë‘ ì‚­ì œ
    drop_sql = text("""
    DO $$ DECLARE
        r RECORD;
    BEGIN
        -- 1. Drop all tables
        FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
            EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE';
        END LOOP;
        
        -- 2. Drop all enums/types
        FOR r IN (SELECT typname FROM pg_type t JOIN pg_namespace n ON t.typnamespace = n.oid WHERE n.nspname = 'public' AND t.typtype = 'e') LOOP
            EXECUTE 'DROP TYPE IF EXISTS ' || quote_ident(r.typname) || ' CASCADE';
        END LOOP;
        
        -- 3. Clear alembic_version table just in case
        EXECUTE 'DROP TABLE IF EXISTS alembic_version CASCADE';
    END $$;
    """)
    
    try:
        with engine.connect() as conn:
            conn.execute(drop_sql)
            conn.commit()
        print("âœ… Database successfully cleared (Tables & Types dropped).")
    except Exception as e:
        print(f"âŒ Failed to reset database: {e}")
        sys.exit(1)

if __name__ == "__main__":
    reset_database()


==================================================
FILE PATH: .\backend\scripts\run_sql.py
==================================================
import os
import sys
from sqlalchemy import create_engine, text
from app.core.config import settings

def run_seed_sql():
    print("ğŸŒ± Seeding database from SQL file...")
    
    db_url = settings.DATABASE_URL
    if not db_url:
        print("âŒ DATABASE_URL not found!")
        sys.exit(1)
        
    engine = create_engine(db_url)
    
    # SQL íŒŒì¼ ê²½ë¡œ
    sql_file_path = os.path.join(os.path.dirname(__file__), "seed_data.sql")
    
    try:
        with open(sql_file_path, "r", encoding="utf-8") as f:
            sql_content = f.read()
            
        with engine.connect() as conn:
            # SQL ë¬¸ì¥ì„ ì„¸ë¯¸ì½œë¡ (;) ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ì§€ ì•Šê³  í†µì§¸ë¡œ ì‹¤í–‰í•˜ë ¤ë©´ text() ì‚¬ìš©
            # í•˜ì§€ë§Œ ì—¬ëŸ¬ ë¬¸ì¥ì´ ì„ì—¬ ìˆìœ¼ë¯€ë¡œ, text()ê°€ ì´ë¥¼ ì§€ì›í•˜ëŠ”ì§€ DB ë“œë¼ì´ë²„ì— ë”°ë¼ ë‹¤ë¦„.
            # PostgreSQL(psycopg2)ì€ ì§€ì›í•¨.
            conn.execute(text(sql_content))
            conn.commit()
            
        print("âœ… Data seeded successfully!")
    except Exception as e:
        print(f"âŒ Failed to seed data: {e}")
        sys.exit(1)

if __name__ == "__main__":
    run_seed_sql()


==================================================
FILE PATH: .\backend\scripts\seed_data.sql
==================================================
-- [1. ì´ˆê¸°í™”] ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
TRUNCATE TABLE recipe_ingredient, recipe, cart_item, product, product_category CASCADE;

-- ========================================================
-- ğŸ·ï¸ 1. ì¹´í…Œê³ ë¦¬ (ê¸°ì¡´ + íŒ€ì› ë°ì´í„° í†µí•©)
-- ========================================================
-- [ê¸°ì¡´] 1~5ë²ˆ
INSERT INTO product_category (category_id, name, zone_code) VALUES 
(1, 'ì±„ì†Œ/ê³¼ì¼', 'A-01'),
(2, 'ì •ìœ¡/ê³„ë€', 'B-02'),
(3, 'ìˆ˜ì‚°/í•´ì‚°ë¬¼', 'C-03'),
(4, 'ê°€ê³µ/ìœ ì œí’ˆ', 'D-04'),
(5, 'ì–‘ë…/ì˜¤ì¼', 'E-05');

-- [íŒ€ì› - AI ì‹œì—°ìš©] 11~16ë²ˆ (ID ì¶©ëŒ ë°©ì§€ ìœ„í•´ ë²ˆí˜¸ ì´ë™)
INSERT INTO product_category (category_id, name, zone_code) VALUES
(11, 'í†µì¡°ë¦¼', 'A-10'),
(12, 'ì†ŒìŠ¤ë¥˜', 'A-20'),
(13, 'ë©´ë¥˜', 'A-30'),
(14, 'ì¦‰ì„ì‹í’ˆ', 'B-10'),
(15, 'ì¼/ìŠ¤í”„ë ˆë“œ', 'B-20'),
(16, 'ìŒë£Œ', 'C-10');


-- ========================================================
-- ğŸ¥« 2. ìƒí’ˆ ë°ì´í„°
-- ========================================================

-- [Team AI ì‹œì—° ë¬¼í’ˆ] (ID 1~8 ìœ ì§€ / ì¹´í…Œê³ ë¦¬ë§Œ 11ë²ˆëŒ€ë¡œ ë§¤í•‘)
INSERT INTO product (product_id, category_id, barcode, name, price, unit_weight_g, stock_quantity, image_url, product_info) VALUES
(1, 11, '8801000000001', 'ìŠ¤íŒ¸ 200g', 5200, 200, 30, 'https://example.com/spam.jpg', '{"code":"spam_200g","brand":"CJ"}'),
(2, 12, '8801000000002', 'í† ë§ˆí†  ì¼€ì°¹ 300g', 2800, 300, 40, 'https://example.com/ketchup.jpg', '{"code":"tomato_ketchup_300g"}'),
(3, 13, '8801000000003', 'ìŠ¤íŒŒê²Œí‹°ë©´ 500g', 3200, 500, 25, 'https://example.com/spaghetti.jpg', '{"code":"spaghetti_noodle_500g"}'),
(4, 11, '8801000000004', 'ì‚´ì½”ê¸°ì°¸ì¹˜ 90g', 2200, 90, 18, 'https://example.com/tuna.jpg', '{"code":"tuna_lean_90g"}'),
(5, 14, '8801000000005', '3ë¶„ì¹´ë ˆ ì•½ê°„ë§¤ìš´ë§›', 3500, 200, 20, 'https://example.com/curry.jpg', '{"code":"curry_3min_mildhot_200g","spicy":"mild"}'),
(6, 15, '8801000000006', 'ë”¸ê¸°ì¼ 570g', 4800, 570, 15, 'https://example.com/jam.jpg', '{"code":"strawberry_jam_570g"}'),
(7, 13, '8801000000007', 'ì‹ ë¼ë©´', 950, 120, 100, 'https://example.com/shinramen.jpg', '{"code":"shin_ramen","spicy":"hot"}'),
(8, 16, '8801000000008', 'í©ì‹œ ì œë¡œìŠˆê±° ë¼ì„', 2100, 500, 50, 'https://example.com/pepsi.jpg', '{"code":"pepsi_zero_lime_500ml","sugar":"zero"}');

-- [ê¸°ì¡´ ë”ë¯¸ ë¬¼í’ˆ] (ID 100ë²ˆëŒ€ - ì‹œì—° ë¬¼í’ˆê³¼ ì—°ê²°ë  ì¬ë£Œë“¤)
INSERT INTO product (product_id, category_id, name, price, unit_weight_g, barcode, image_url) VALUES 
(100, 1, 'í–‡ ì–‘íŒŒ', 3500, 1000, '8801000001001', 'https://example.com/onion.jpg'),
(101, 1, 'ëŒ€íŒŒ (í•œë‹¨)', 2800, 400, '8801000001002', 'https://example.com/greenonion.jpg'),
(102, 1, 'ë‹¤ì§„ ë§ˆëŠ˜', 4500, 200, '8801000001003', 'https://example.com/garlic.jpg'),
(103, 1, 'ì²­ì–‘ê³ ì¶”', 1500, 100, '8801000001004', 'https://example.com/chili.jpg'),
(104, 1, 'ì• í˜¸ë°•', 1200, 300, '8801000001005', 'https://example.com/zucchini.jpg'),
(105, 1, 'ê°ì (í™ê°ì)', 4000, 800, '8801000001006', 'https://example.com/potato.jpg'),
(106, 1, 'ë‹¹ê·¼', 2000, 300, '8801000001007', 'https://example.com/carrot.jpg'),
(200, 2, 'í•œëˆ ìƒì‚¼ê²¹ì‚´', 15900, 600, '8802000002001', 'https://example.com/porkbelly.jpg'),
(300, 4, 'ì°Œê°œìš© ë‘ë¶€', 1500, 300, '8803000003001', 'https://example.com/tofu.jpg'),
(301, 4, 'ì¢…ê°€ì§‘ ë§›ê¹€ì¹˜', 8900, 1000, '8803000003002', 'https://example.com/kimchi.jpg'),
(303, 3, 'ë¶€ì‚° ì‚¬ê°ì–´ë¬µ', 3000, 250, '8803000003004', 'https://example.com/fishcake.jpg'),
(400, 5, 'íƒœì–‘ì´ˆ ê³ ì¶”ì¥', 7500, 500, '8804000004001', 'https://example.com/gochujang.jpg'),
(401, 5, 'ì¬ë˜ì‹ ëœì¥', 6900, 500, '8804000004002', 'https://example.com/doenjang.jpg'),
(402, 5, 'ì§„ê°„ì¥', 5000, 900, '8804000004003', 'https://example.com/soysauce.jpg'),
(403, 5, 'ì°¸ê¸°ë¦„', 8000, 300, '8804000004004', 'https://example.com/sesameoil.jpg'),
(404, 5, 'ì„¤íƒ•', 3000, 1000, '8804000004005', 'https://example.com/sugar.jpg');


-- ========================================================
-- ğŸ³ 3. ë ˆì‹œí”¼ (ì‹œì—° ë¬¼í’ˆê³¼ ê¸°ì¡´ ì¬ë£Œë¥¼ ì—®ëŠ” ì—°ê²°ê³ ë¦¬!)
-- ========================================================

INSERT INTO recipe (recipe_id, title, description, instructions) VALUES 
-- [ê¸°ì¡´] 
(1, 'ë¼ì§€ê³ ê¸° ê¹€ì¹˜ì°Œê°œ', 'í•œêµ­ì¸ì˜ ì†Œìš¸í‘¸ë“œ! ì¹¼ì¹¼í•˜ê³  ê¹Šì€ ë§›ì˜ ê¹€ì¹˜ì°Œê°œ.', 'ì„¤ëª… ìƒëµ...'),
(2, 'ì°¨ëŒ ëœì¥ì°Œê°œ', 'êµ¬ìˆ˜í•¨ì˜ ëíŒì™• ëœì¥ì°Œê°œ.', 'ì„¤ëª… ìƒëµ...'),
(10, 'ì˜ì •ë¶€ì‹ ë¶€ëŒ€ì°Œê°œ', 'ìŠ¤íŒ¸ê³¼ ë¼ë©´ì‚¬ë¦¬ì˜ í™˜ìƒ ì¡°í•©! ì§‘ì—ì„œ ì¦ê¸°ëŠ” ì§„í•œ ë¶€ëŒ€ì°Œê°œì…ë‹ˆë‹¤.', 
'1. ëƒ„ë¹„ì— ê¹€ì¹˜, ìŠ¤íŒ¸, ì†Œì‹œì§€, ë‘ë¶€ë¥¼ ë‘˜ëŸ¬ ë‹´ìŠµë‹ˆë‹¤.\n2. ì–‘ë…ì¥(ê³ ì¶”ì¥, ë§ˆëŠ˜, ê°„ì¥)ì„ ì–¹ê³  ë¬¼ì„ ë¶“ìŠµë‹ˆë‹¤.\n3. ë“ì–´ì˜¤ë¥´ë©´ ë¼ë©´ì‚¬ë¦¬(ì‹ ë¼ë©´)ë¥¼ ë„£ìŠµë‹ˆë‹¤.\n4. ëŒ€íŒŒë¥¼ ë“¬ë¿ ë„£ê³  ë©´ì´ ìµì„ ë•Œê¹Œì§€ ë“ì´ë©´ ì™„ì„±!'),
(11, '3ë¶„ ì»· ì°¸ì¹˜ ê¹€ì¹˜ì°Œê°œ', 'ì‚´ì½”ê¸° ì°¸ì¹˜ì˜ ë‹´ë°±í•¨ì´ êµ­ë¬¼ì— ì™! ì´ˆê°„ë‹¨ ë°¥ë„ë‘‘.', 
'1. ëƒ„ë¹„ì— ì°¸ê¸°ë¦„ì„ ë‘ë¥´ê³  ê¹€ì¹˜ë¥¼ ë³¶ìŠµë‹ˆë‹¤.\n2. ë¬¼ì„ ë¶“ê³  ë“ìœ¼ë©´ ì°¸ì¹˜ ê¸°ë¦„ê¹Œì§€ í•¨ê»˜ ë„£ìŠµë‹ˆë‹¤.\n3. ì–‘íŒŒì™€ ëŒ€íŒŒë¥¼ ë„£ê³  í‘¹ ë“ì—¬ëƒ…ë‹ˆë‹¤.'),
(12, 'ì¶”ì–µì˜ ë‚˜í´ë¦¬íƒ„ ìŠ¤íŒŒê²Œí‹°', 'ì¼€ì°¹ìœ¼ë¡œ ë§Œë“œëŠ” ë‹¬ì½¤ìƒˆì½¤í•œ ë§›. ì•„ì´ë“¤ì´ ì •ë§ ì¢‹ì•„í•´ìš”.', 
'1. ë“ëŠ” ë¬¼ì— ìŠ¤íŒŒê²Œí‹° ë©´ì„ ì‚¶ìŠµë‹ˆë‹¤.\n2. íŒ¬ì— ê¸°ë¦„ì„ ë‘ë¥´ê³  í¸ë§ˆëŠ˜, ì–‘íŒŒ, ì†Œì„¸ì§€ë¥¼ ë³¶ìŠµë‹ˆë‹¤.\n3. ì‚¶ì€ ë©´ê³¼ ì¼€ì°¹ 4í°ìˆ ì„ ë„£ê³  ë³¶ìŠµë‹ˆë‹¤.\n4. ë©´ìˆ˜ë¥¼ ì•½ê°„ ë„£ì–´ ë†ë„ë¥¼ ë§ì¶”ë©´ ì™„ì„±!');


-- ========================================================
-- ğŸ”— 4. ë ˆì‹œí”¼-ì¬ë£Œ ì—°ê²° (ë§¤í•‘)
-- ========================================================

-- ê¸°ì¡´ ê¹€ì¹˜ì°Œê°œ (ë¼ì§€ê³ ê¸° ì‚¬ìš©)
INSERT INTO recipe_ingredient (recipe_id, product_id, quantity_info, importance_score) VALUES 
(1, 200, '300g', 5), (1, 301, '1/4í¬ê¸°', 5), (1, 300, 'ë°˜ ëª¨', 3), (1, 101, '1ëŒ€', 3);

-- ê¸°ì¡´ ëœì¥ì°Œê°œ
INSERT INTO recipe_ingredient (recipe_id, product_id, quantity_info, importance_score) VALUES 
(2, 401, '2í°ìˆ ', 5), (2, 300, 'ë°˜ ëª¨', 3), (2, 104, '1/3ê°œ', 3), (2, 105, '1ê°œ', 3);


-- âœ¨ [ì‹œì—°ìš© 1] ë¶€ëŒ€ì°Œê°œ (ìŠ¤íŒ¸, ë¼ë©´ -> ê¹€ì¹˜, ë‘ë¶€, ëŒ€íŒŒ ì¶”ì²œ)
INSERT INTO recipe_ingredient (recipe_id, product_id, quantity_info, importance_score) VALUES 
(10, 1, '1ìº”', 5),   -- ìŠ¤íŒ¸ (ì‹œì—° ë¬¼í’ˆ)
(10, 7, '1ê°œ', 5),   -- ì‹ ë¼ë©´ (ì‹œì—° ë¬¼í’ˆ)
(10, 301, 'ë°˜í¬ê¸°', 5), -- ê¹€ì¹˜ (ì¶”ê°€ êµ¬ë§¤ ìœ ë„!)
(10, 300, 'í•œëª¨', 3),   -- ë‘ë¶€ (ì¶”ê°€ êµ¬ë§¤ ìœ ë„!)
(10, 101, '2ëŒ€', 3),    -- ëŒ€íŒŒ (ì¶”ê°€ êµ¬ë§¤ ìœ ë„!)
(10, 400, '1í°ìˆ ', 1);  -- ê³ ì¶”ì¥

-- âœ¨ [ì‹œì—°ìš© 2] ì°¸ì¹˜ ê¹€ì¹˜ì°Œê°œ (ì°¸ì¹˜ -> ê¹€ì¹˜, ì–‘íŒŒ ì¶”ì²œ)
INSERT INTO recipe_ingredient (recipe_id, product_id, quantity_info, importance_score) VALUES 
(11, 4, '1ìº”', 5),   -- ì°¸ì¹˜ (ì‹œì—° ë¬¼í’ˆ)
(11, 301, 'ë°˜í¬ê¸°', 5), -- ê¹€ì¹˜ (ì¶”ê°€ êµ¬ë§¤ ìœ ë„!)
(11, 100, 'ë°˜ê°œ', 3),   -- ì–‘íŒŒ
(11, 103, '1ê°œ', 1);    -- ì²­ì–‘ê³ ì¶”

-- âœ¨ [ì‹œì—°ìš© 3] ë‚˜í´ë¦¬íƒ„ (ìŠ¤íŒŒê²Œí‹°, ì¼€ì°¹ -> ì–‘íŒŒ ì¶”ì²œ)
INSERT INTO recipe_ingredient (recipe_id, product_id, quantity_info, importance_score) VALUES 
(12, 3, '1ì¸ë¶„', 5),  -- ìŠ¤íŒŒê²Œí‹°ë©´ (ì‹œì—° ë¬¼í’ˆ)
(12, 2, '4í°ìˆ ', 5),  -- ì¼€ì°¹ (ì‹œì—° ë¬¼í’ˆ)
(12, 100, 'ë°˜ê°œ', 3),   -- ì–‘íŒŒ
(12, 102, '1í°ìˆ ', 1);  -- ë§ˆëŠ˜


-- ========================================================
-- ğŸ›’ 5. ì¹´íŠ¸ ë””ë°”ì´ìŠ¤ (í•„ìˆ˜)
-- ========================================================
INSERT INTO cart_device (cart_device_id, device_code) VALUES
(1, 'CART-DEVICE-001'),
(2, 'CART-DEVICE-002');


-- ========================================================
-- ğŸ”„ 6. ì‹œí€€ìŠ¤ ì¬ì„¤ì • (ID ì¶©ëŒ ë°©ì§€)
-- ========================================================
SELECT setval('product_category_category_id_seq', (SELECT MAX(category_id) FROM product_category));
SELECT setval('product_product_id_seq', (SELECT MAX(product_id) FROM product));
SELECT setval('recipe_recipe_id_seq', (SELECT MAX(recipe_id) FROM recipe));
SELECT setval('cart_device_cart_device_id_seq', (SELECT MAX(cart_device_id) FROM cart_device));



==================================================
FILE PATH: .\backend\tests\manual\check_db_data.py
==================================================
"""
[DB ë°ì´í„° ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸]
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” íŠ¹ì • ìœ ì €ì˜ ì´ë©”ì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ DB ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
SQLAlchemyë¥¼ ì‚¬ìš©í•˜ì—¬ DBì— ì§ì ‘ ì ‘ì†í•©ë‹ˆë‹¤.

ê²€ì¦ í•­ëª©:
1. ìœ ì € ì •ë³´ (User)
2. ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ ìƒíƒœ (CartSession) - PAID ì—¬ë¶€
3. ê²°ì œ ë‚´ì—­ (Payment) - APPROVED ì—¬ë¶€
4. ê°€ê³„ë¶€ ë‚´ì—­ (LedgerEntry) - ìƒì„± ì—¬ë¶€

ì‹¤í–‰ ë°©ë²•:
ìŠ¤í¬ë¦½íŠ¸ í•˜ë‹¨ì˜ verify_data("ì´ë©”ì¼") ë¶€ë¶„ì„ ìˆ˜ì •í•œ ë’¤ ì‹¤í–‰í•˜ì„¸ìš”.
$ python -m tests.manual.check_db_data
"""
import sys
import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app import models
from app.db.base import Base

# DB ì—°ê²° ì„¤ì •
SQLALCHEMY_DATABASE_URL = os.getenv("DATABASE_URL", "postgresql://admin:password123@localhost:5432/postgres")
if os.getenv("DB_PASSWORD"): # í™˜ê²½ë³€ìˆ˜ì— ë¹„ë²ˆì´ ë”°ë¡œ ìˆìœ¼ë©´ ì¡°í•© (ì¼ë°˜ì ì¸ ê²½ìš° .envì—ì„œ ë¡œë“œë¨)
    pass 

engine = create_engine(SQLALCHEMY_DATABASE_URL)
SessionLocal = sessionmaker(bind=engine)
db = SessionLocal()

def verify_data(email):
    print(f"ğŸ” '{email}' ìœ ì € ë°ì´í„° ì¡°íšŒ ì¤‘...\n")

    # 1. ìœ ì € ì°¾ê¸°
    user = db.query(models.AppUser).filter(models.AppUser.email == email).first()
    if not user:
        print("âŒ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return

    print(f"ğŸ‘¤ ìœ ì € ID: {user.user_id}, ë‹‰ë„¤ì„: {user.nickname}")

    # 2. ì¹´íŠ¸ ì„¸ì…˜ í™•ì¸
    cart = db.query(models.CartSession).filter(
        models.CartSession.user_id == user.user_id,
        models.CartSession.status == models.CartSessionStatus.PAID
    ).order_by(models.CartSession.cart_session_id.desc()).first()
    
    if cart:
        print(f"ğŸ›’ [ì™„ë£Œëœ ì¥ë°”êµ¬ë‹ˆ] ID: {cart.cart_session_id}, ìƒíƒœ: {cart.status.value}, ì¢…ë£Œì‹œê°„: {cart.ended_at}")
    else:
        print("âš ï¸ ì™„ë£Œëœ(PAID) ì¥ë°”êµ¬ë‹ˆ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.")

    # 3. ê²°ì œ ë‚´ì—­ í™•ì¸
    payment = db.query(models.Payment).filter(models.Payment.user_id == user.user_id).order_by(models.Payment.payment_id.desc()).first()
    if payment:
        print(f"ğŸ’³ [ê²°ì œ ë‚´ì—­] ID: {payment.payment_id}, TID: {payment.pg_tid}, ê¸ˆì•¡: {payment.total_amount}ì›, ìƒíƒœ: {payment.status.value}")
    else:
        print("âš ï¸ ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.")

    # 4. ê°€ê³„ë¶€ ë‚´ì—­ í™•ì¸ (ë©”ëª¨ ì»¬ëŸ¼ ì œì™¸í•˜ê³  ì¡°íšŒ)
    # models.LedgerEntry ì „ì²´ë¥¼ ì¡°íšŒí•˜ë©´ ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜ë¡œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë¯€ë¡œ í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒ
    ledger = db.query(
        models.LedgerEntry.ledger_entry_id,
        models.LedgerEntry.spend_date,
        models.LedgerEntry.amount,
        models.LedgerEntry.category
    ).filter(models.LedgerEntry.user_id == user.user_id).order_by(models.LedgerEntry.ledger_entry_id.desc()).first()

    if ledger:
        # íŠœí”Œë¡œ ë°˜í™˜ë˜ë¯€ë¡œ ì¸ë±ìŠ¤ë‚˜ ì´ë¦„ìœ¼ë¡œ ì ‘ê·¼ ë¶ˆê°€í•  ìˆ˜ ìˆì–´ ë‹¨ìˆœ ì¶œë ¥
        print(f"ğŸ“” [ê°€ê³„ë¶€] ID: {ledger.ledger_entry_id}, ë‚ ì§œ: {ledger.spend_date}, ê¸ˆì•¡: {ledger.amount}ì›, ì¹´í…Œê³ ë¦¬: {ledger.category.value}")
    else:
        print("âš ï¸ ê°€ê³„ë¶€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    verify_data("test_fy97rs9d@example.com")


==================================================
FILE PATH: .\backend\tests\manual\smoke_test_full.py
==================================================
import requests
import urllib3
import sys
import random
import string
import json

# SSL ê²½ê³  ë¬´ì‹œ
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

BASE_URL = "https://localhost/api"
HEADERS = {"Content-Type": "application/json"}
COOKIES = {}

# ìƒíƒœ ê³µìœ ìš© ì „ì—­ ë³€ìˆ˜
GLOBAL_STATE = {
    "user_email": "",
    "user_password": "",
    "access_token": None,
    "product_id": None,
    "recipe_id": None,
    "cart_session_id": None,
    "cart_item_id": None
}

def generate_random_email():
    return f"testuser_{''.join(random.choices(string.ascii_lowercase + string.digits, k=8))}@example.com"

def log(step, message, status="INFO"):
    icons = {"INFO": "â„¹ï¸", "PASS": "âœ…", "FAIL": "âŒ", "WARN": "âš ï¸"}
    print(f"{icons.get(status, '')} [{step}] {message}")

def req(method, endpoint, payload=None, auth=False, expected_status=[200, 201]):
    url = f"{BASE_URL}{endpoint}"
    headers = HEADERS.copy()
    
    if auth and GLOBAL_STATE["access_token"]:
        headers["Authorization"] = f"Bearer {GLOBAL_STATE['access_token']}"

    try:
        if method == "GET":
            response = requests.get(url, headers=headers, cookies=COOKIES, verify=False, timeout=5)
        elif method == "POST":
            response = requests.post(url, headers=headers, cookies=COOKIES, json=payload, verify=False, timeout=5)
        elif method == "PATCH":
            response = requests.patch(url, headers=headers, cookies=COOKIES, json=payload, verify=False, timeout=5)
        elif method == "DELETE":
            response = requests.delete(url, headers=headers, cookies=COOKIES, json=payload, verify=False, timeout=5)
        elif method == "PUT":
            response = requests.put(url, headers=headers, cookies=COOKIES, json=payload, verify=False, timeout=5)
        
        if response.status_code in expected_status:
            log(f"{method} {endpoint}", f"Status: {response.status_code}", "PASS")
            return response.json() if response.content else {}
        else:
            log(f"{method} {endpoint}", f"Expected {expected_status}, Got {response.status_code}", "FAIL")
            try:
                print(f"   Response: {json.dumps(response.json(), indent=2)}")
            except:
                print(f"   Response: {response.text[:200]}")
            return None

    except Exception as e:
        log(f"{method} {endpoint}", f"Exception: {str(e)}", "FAIL")
        return None

def main():
    print(f"ğŸš€ Full Smoke Test Started via {BASE_URL}\n")
    
    # 1. Health & Docs
    req("GET", "/health")
    
    # 2. Auth Flow
    print("\n--- [Auth Flow] ---")
    GLOBAL_STATE["user_email"] = generate_random_email()
    GLOBAL_STATE["user_password"] = "password123"
    
    # íšŒì›ê°€ì…
    res = req("POST", "/auth/signup", {
        "email": GLOBAL_STATE["user_email"],
        "password": GLOBAL_STATE["user_password"],
        "nickname": "Tester"
    })
    
    # ë¡œê·¸ì¸
    if res:
        login_res = requests.post(
            f"{BASE_URL}/auth/login",
            json={"email": GLOBAL_STATE["user_email"], "password": GLOBAL_STATE["user_password"]},
            verify=False
        )
        if login_res.status_code == 200:
            data = login_res.json()
            GLOBAL_STATE["access_token"] = data["access_token"]
            COOKIES.update(login_res.cookies) # Refresh Token ì¿ í‚¤ ì €ì¥
            log("POST /auth/login", "Login Successful", "PASS")
        else:
            log("POST /auth/login", f"Login Failed: {login_res.status_code}", "FAIL")
            sys.exit(1)

    # ë‚´ ì •ë³´ ì¡°íšŒ
    user_info = req("GET", "/users/me", auth=True)
    user_id = user_info["user_id"] if user_info else 1
    
    # ë‹‰ë„¤ì„ ë³€ê²½
    req("PATCH", "/users/me/nickname", {"nickname": "NewTester"}, auth=True)
    
    # 3. Product Flow
    print("\n--- [Product Flow] ---")
    products = req("GET", "/products/", auth=True) 
    
    if products and isinstance(products, list) and len(products) > 0:
        GLOBAL_STATE["product_id"] = products[0]["product_id"]
        log("Select Product", f"Picked Product ID: {GLOBAL_STATE['product_id']}", "INFO")
        
        # ìƒì„¸ ì¡°íšŒ
        req("GET", f"/products/{GLOBAL_STATE['product_id']}", auth=True)
        # ìœ„ì¹˜ ì¡°íšŒ
        req("GET", f"/products/{GLOBAL_STATE['product_id']}/location", auth=True)
        # AI ì¶”ì²œ (pgvector)
        req("GET", f"/recommendations/by-product/{GLOBAL_STATE['product_id']}", auth=True)
        # Barcode ì¡°íšŒ (ìŠ¤íŒ¸ ë°”ì½”ë“œ)
        req("GET", "/products/barcode/8801000000001", auth=True)
    else:
        log("Product Check", "No products found in DB. Skipping dependent tests.", "WARN")

    # 4. Cart Flow
    print("\n--- [Cart Flow] ---")
    # ì„¸ì…˜ ìƒì„± (ì£¼ì˜: DBì— CartDevice ë°ì´í„°ê°€ ìˆì–´ì•¼ ì„±ê³µí•¨)
    cart_res = req("POST", "/carts/", auth=True)
    
    if cart_res:
        GLOBAL_STATE["cart_session_id"] = cart_res["cart_session_id"]
        sid = GLOBAL_STATE["cart_session_id"]
        
        # ì¹´ë©”ë¼ ë·° ì œì–´
        req("POST", f"/carts/{sid}/camera/view/on", auth=True)
        req("POST", f"/carts/{sid}/camera/view/off", auth=True)

        # ìƒí’ˆì´ ìˆë‹¤ë©´ ë‹´ê¸° í…ŒìŠ¤íŠ¸
        if GLOBAL_STATE["product_id"]:
            # ì•„ì´í…œ ì¶”ê°€
            req("POST", f"/carts/{sid}/items", {
                "product_id": GLOBAL_STATE["product_id"],
                "quantity": 2
            }, auth=True)
            
            # ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ (ë‹´ê²¼ëŠ”ì§€ í™•ì¸)
            cart_detail = req("GET", f"/carts/{sid}", auth=True)
            if cart_detail and cart_detail.get("items"):
                GLOBAL_STATE["cart_item_id"] = cart_detail["items"][0]["cart_item_id"]
                
                # ìˆ˜ëŸ‰ ë³€ê²½
                req("PATCH", f"/carts/items/{GLOBAL_STATE['cart_item_id']}", {"quantity": 5}, auth=True)
                
                # ë¬´ê²Œ ê²€ì¦
                req("POST", "/carts/weight/validate", {
                    "cart_session_id": sid,
                    "measured_weight_g": 500
                }, auth=True)

                # ì•„ì´í…œ ì‚­ì œ (Cleanup)
                req("DELETE", f"/carts/items/{GLOBAL_STATE['cart_item_id']}", auth=True)

        # ì¹´íŠ¸ ì·¨ì†Œ
        req("POST", f"/carts/{sid}/cancel", auth=True)

    # 5. AI & Admin Flow (NEW)
    print("\n--- [AI & Admin Flow] ---")
    
    # 5-1. AI Training Trigger (Admin)
    # AI ì„œë²„ ì—°ê²° ì‹¤íŒ¨(503)ë„ ì„±ê³µìœ¼ë¡œ ê°„ì£¼ (Test ëª©ì : ë¼ìš°í„° ë„ë‹¬ ì—¬ë¶€)
    req("POST", "/admin/train", {
        "epochs": 1,
        "experiment_name": "smoke_test_augmented",
        "model_name": "yolo11n.pt",
        "mosaic": 0.5,
        "mixup": 0.1
    }, auth=True, expected_status=[200, 503, 500])

    # 5-2. AI Edge Sync (Cart)
    # ì‹¤ì œ ë””ë°”ì´ìŠ¤ê°€ ë³´ë‚´ëŠ” ìš”ì²­ ì‹œë®¬ë ˆì´ì…˜
    req("POST", "/carts/sync-by-device", {
        "device_code": "CART-DEVICE-001",
        "items": [
            {"product_name": "ì‹ ë¼ë©´", "quantity": 1},
            {"product_name": "ìŠ¤íŒ¸ 200g", "quantity": 2}
        ]
    }, expected_status=[200])


    # 6. Payment & Ledger Flow (Read-Only)
    print("\n--- [Payment & Ledger Flow] ---")
    req("GET", "/payments/methods", auth=True)
    
    # ê°€ê³„ë¶€ (ìˆ˜ì •: user_id ì¿¼ë¦¬ ì¶”ê°€)
    req("GET", f"/ledger?user_id={user_id}", auth=True)
    req("GET", "/ledger/calendar?year=2026&month=2", auth=True)
    req("GET", "/ledger/summary/monthly?year=2026&month=2", auth=True)
    req("GET", "/ledger/top-categories?year=2026&month=2", auth=True)

    # 7. Recipe Flow (Read-Only)
    print("\n--- [Recipe Flow] ---")
    # ë ˆì‹œí”¼ ID 1ë²ˆ ì¡°íšŒ ì‹œë„ (ì—†ìœ¼ë©´ 404)
    req("GET", "/recipes/1", auth=True, expected_status=[200, 404])

    # 8. Cleanup (Withdraw)
    print("\n--- [Cleanup] ---")
    req("DELETE", "/users/me", auth=True, payload={"password": GLOBAL_STATE["user_password"]})
    req("POST", "/auth/logout", auth=True)

    print("\nğŸ Smoke Test Completed.")

if __name__ == "__main__":
    main()

==================================================
FILE PATH: .\backend\tests\manual\test_payment_approve.py
==================================================
"""
[ê²°ì œ ì „ì²´ í”„ë¡œì„¸ìŠ¤ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ - Part 2]
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ìŠ¹ì¸(Approve) APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ê²°ì œë¥¼ ì™„ë£Œí•©ë‹ˆë‹¤.
ë¸Œë¼ìš°ì €ì—ì„œ ê²°ì œ ì™„ë£Œ í›„ ë°œê¸‰ë°›ì€ pg_tokenì´ í•„ìš”í•©ë‹ˆë‹¤.

ê¸°ëŠ¥:
1. ì‚¬ìš©ì ë¡œê·¸ì¸ (í† í° ë°œê¸‰)
2. ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ
3. ê²°ì œ ìƒíƒœ(APPROVED) ë° ê°€ê³„ë¶€ ìƒì„± í™•ì¸

ì‹¤í–‰ ë°©ë²•:
$ python -m tests.manual.test_payment_approve <ì´ë©”ì¼> <ë¹„ë°€ë²ˆí˜¸> <TID> <PG_TOKEN>
ì˜ˆ: python -m tests.manual.test_payment_approve test@example.com TestPass123! T123... pg_token...
"""
import requests
import sys

BASE_URL = "http://localhost:8000"
API_AUTH_LOGIN = f"{BASE_URL}/api/auth/login"
API_PAYMENT_APPROVE = f"{BASE_URL}/api/payments/approve"

def login(email, password):
    res = requests.post(API_AUTH_LOGIN, json={"email": email, "password": password})
    if res.status_code != 200:
        print("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨")
        sys.exit(1)
    return res.json()["access_token"]

def main():
    if len(sys.argv) < 5:
        print("ì‚¬ìš©ë²•: python test_payment_approve.py <email> <password> <tid> <pg_token>")
        return

    email = sys.argv[1]
    password = sys.argv[2]
    tid = sys.argv[3]
    pg_token = sys.argv[4]

    token = login(email, password)
    headers = {"Authorization": f"Bearer {token}"}

    print(f"ğŸ’³ ê²°ì œ ìŠ¹ì¸(Approve) ìš”ì²­ ì¤‘... (TID: {tid})")
    
    # schemas.PaymentApproveRequest í˜•ì‹ì— ë§ì¶¤
    payload = {
        "tid": tid,
        "pg_token": pg_token,
        "partner_order_id": "dummy", # ì„œë²„ ë¡œì§ì—ì„œ DB ê°’ìœ¼ë¡œ ëŒ€ì²´í•˜ë¯€ë¡œ dummy ì „ë‹¬ ê°€ëŠ¥
        "partner_user_id": "dummy"
    }

    res = requests.post(API_PAYMENT_APPROVE, headers=headers, json=payload)

    if res.status_code == 200:
        print("\n" + "="*50)
        print("âœ… ê²°ì œ ìµœì¢… ìŠ¹ì¸ ì„±ê³µ!!!")
        print(f"ê²°ì œ ID: {res.json().get('payment_id')}")
        print(f"ìƒíƒœ: {res.json().get('status')}")
        print(f"ìŠ¹ì¸ ì‹œê°: {res.json().get('approved_at')}")
        print("="*50)
        print("â„¹ï¸ ì´ì œ DBì˜ cart_session ìƒíƒœê°€ 'PAID'ë¡œ ë³€ê²½ë˜ì—ˆê³ , ê°€ê³„ë¶€(Ledger)ì— ë‚´ì—­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
    else:
        print(f"âŒ ìŠ¹ì¸ ì‹¤íŒ¨: {res.text}")

if __name__ == "__main__":
    main()


==================================================
FILE PATH: .\backend\tests\manual\test_payment_flow.py
==================================================
"""
[ê²°ì œ ë¡œì§ í†µí•© í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ - ìˆ˜ì •ë³¸]
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ìƒˆë¡œìš´ '/api/payments/request' ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ
ì¥ë°”êµ¬ë‹ˆ ë¬´ê²Œ ê²€ì¦ ë° ê²°ì œ ë¶„ê¸° ì²˜ë¦¬ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

ê¸°ëŠ¥:
1. ìœ ì € ìƒì„± ë° ë¡œê·¸ì¸
2. í…ŒìŠ¤íŠ¸ ìƒí’ˆ(ë¬´ê²Œ 100g) ìƒì„±
3. ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ë‹´ê¸° (2ê°œ -> ì˜ˆìƒ ë¬´ê²Œ 200g)
4. [í…ŒìŠ¤íŠ¸ 1] ë¬´ê²Œ ë¶ˆì¼ì¹˜ ì‹œë‚˜ë¦¬ì˜¤ (150g ì „ì†¡) -> 409 Conflict ì˜ˆìƒ
5. [í…ŒìŠ¤íŠ¸ 2] ë¬´ê²Œ ì¼ì¹˜ ì‹œë‚˜ë¦¬ì˜¤ (200g ì „ì†¡) -> 200 OK ì˜ˆìƒ

ì‹¤í–‰ ë°©ë²•:
$ cd backend
$ python -m tests.manual.test_payment_flow
"""
import requests
import random
import string
import sys
import os

# --- ì„¤ì • ---
BASE_URL = "http://localhost:8000"
API_AUTH_SIGNUP = f"{BASE_URL}/api/auth/signup"
API_AUTH_LOGIN = f"{BASE_URL}/api/auth/login"
API_PAYMENT_REQUEST = f"{BASE_URL}/api/payments/request"

# --- ìœ í‹¸ë¦¬í‹° ---
def random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

def create_random_user():
    email = f"test_{random_string()}@example.com"
    password = "TestPassword123!"
    nick_rand = ''.join(random.choices(string.ascii_lowercase, k=4))
    nickname = f"User{nick_rand}"
    
    print(f"ğŸ†• íšŒì›ê°€ì… ì‹œë„: {email}")
    requests.post(API_AUTH_SIGNUP, json={
        "email": email,
        "password": password,
        "nickname": nickname
    })
    return email, password

def login(email, password):
    res = requests.post(API_AUTH_LOGIN, json={"email": email, "password": password})
    if res.status_code != 200:
        print(f"âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: {res.text}")
        sys.exit(1)
    return res.json()["access_token"]

def ensure_test_product_exists():
    """í…ŒìŠ¤íŠ¸ìš© ìƒí’ˆ(100g, 1500ì›) ìƒì„±/ì¡°íšŒ"""
    sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))
    from app.database import SessionLocal
    from app import models
    
    db = SessionLocal()
    try:
        # í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ í™•ì¸
        category = db.query(models.ProductCategory).filter_by(name="í…ŒìŠ¤íŠ¸ì¹´í…Œê³ ë¦¬").first()
        if not category:
            category = models.ProductCategory(name="í…ŒìŠ¤íŠ¸ì¹´í…Œê³ ë¦¬", zone_code="T-1")
            db.add(category)
            db.commit()

        # í…ŒìŠ¤íŠ¸ ìƒí’ˆ í™•ì¸
        product_name = "í…ŒìŠ¤íŠ¸ìš© ê³¼ì(100g)"
        product = db.query(models.Product).filter_by(name=product_name).first()
        
        if not product:
            print("ğŸ“¦ í…ŒìŠ¤íŠ¸ ìƒí’ˆ ìƒì„± ì¤‘...")
            new_product = models.Product(
                category_id=category.category_id,
                name=product_name,
                price=1500,
                unit_weight_g=100,  # 100g
                barcode=f"TEST{random.randint(1000,9999)}"
            )
            db.add(new_product)
            db.commit()
            db.refresh(new_product)
            return new_product.product_id
        
        return product.product_id
    except Exception as e:
        print(f"âš ï¸ DB ì˜¤ë¥˜: {e}")
        sys.exit(1)
    finally:
        db.close()

def main():
    print("ğŸš€ [ê²°ì œ/ë¬´ê²Œ ê²€ì¦ í…ŒìŠ¤íŠ¸] ì‹œì‘í•©ë‹ˆë‹¤...")
    
    # 0. ì¤€ë¹„
    product_id = ensure_test_product_exists() 
    email, password = create_random_user()
    token = login(email, password)
    headers = {"Authorization": f"Bearer {token}"}

    # 1. ì¹´íŠ¸ ì„¸ì…˜ ì¤€ë¹„
    sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))
    from app.database import SessionLocal
    from app import models
    db = SessionLocal()
    
    device_code = "TEST_DEVICE_001"
    device = db.query(models.CartDevice).filter_by(device_code=device_code).first()
    if not device:
        device = models.CartDevice(device_code=device_code)
        db.add(device)
        db.commit()
        db.refresh(device)
    
    user_id = db.query(models.AppUser).filter_by(email=email).first().user_id
    
    # ê¸°ì¡´ í™œì„± ì„¸ì…˜ ì •ë¦¬
    db.query(models.CartSession).filter_by(user_id=user_id, status=models.CartSessionStatus.ACTIVE).update({"status": models.CartSessionStatus.CANCELLED})
    db.commit()
    
    new_session = models.CartSession(
        cart_device_id=device.cart_device_id,
        user_id=user_id,
        status=models.CartSessionStatus.ACTIVE
    )
    db.add(new_session)
    db.commit()
    db.refresh(new_session)
    cart_session_id = new_session.cart_session_id
    db.close()
    
    print(f"âœ… ì„¸ì…˜ ì¤€ë¹„ ì™„ë£Œ: ID {cart_session_id}")

    # 2. ìƒí’ˆ ë‹´ê¸° (100g * 2ê°œ = 200g, 3000ì›)
    # ìˆ˜ì •ëœ ê²½ë¡œ: /api/carts/{session_id}/items
    print(f"â• ìƒí’ˆ ë‹´ê¸° (ID: {product_id}, 2ê°œ)...")
    API_CART_ADD_ITEM = f"{BASE_URL}/api/carts/{cart_session_id}/items"
    res = requests.post(API_CART_ADD_ITEM, headers=headers, json={
        "product_id": product_id,
        "quantity": 2
    })
    if res.status_code != 200:
        print(f"âŒ ìƒí’ˆ ë‹´ê¸° ì‹¤íŒ¨: {res.status_code} - {res.text}")
        sys.exit(1)
    print("âœ… ìƒí’ˆ ë‹´ê¸° ì„±ê³µ")

    # 3. [TEST CASE 1] ë¬´ê²Œ ë¶ˆì¼ì¹˜ í…ŒìŠ¤íŠ¸
    print("\nâš–ï¸  [CASE 1] ë¬´ê²Œ ë¶ˆì¼ì¹˜ í…ŒìŠ¤íŠ¸ (ì˜ˆìƒ 200g vs ì¸¡ì • 150g)")
    payload_fail = {
        "cart_session_id": cart_session_id,
        "measured_weight_g": 150,  
        "amount": 3000,
        "use_subscription": False
    }
    res = requests.post(API_PAYMENT_REQUEST, headers=headers, json=payload_fail)
    
    if res.status_code == 409:
        print("âœ… ì„±ê³µ: 409 Conflict ì‘ë‹µ ë°›ìŒ")
        print(f"   ë©”ì‹œì§€: {res.json().get('message')}")
    else:
        print(f"âŒ ì‹¤íŒ¨: {res.status_code} (ì˜ˆìƒ: 409)")
        print(f"   ì‘ë‹µ: {res.text}")

    # 4. [TEST CASE 2] ë¬´ê²Œ ì¼ì¹˜ í…ŒìŠ¤íŠ¸
    print("\nâš–ï¸  [CASE 2] ë¬´ê²Œ ì¼ì¹˜ í…ŒìŠ¤íŠ¸ (ì˜ˆìƒ 200g vs ì¸¡ì • 200g)")
    payload_success = {
        "cart_session_id": cart_session_id,
        "measured_weight_g": 200, 
        "amount": 3000,
        "use_subscription": False
    }
    res = requests.post(API_PAYMENT_REQUEST, headers=headers, json=payload_success)
    
    if res.status_code == 200:
        print("âœ… ì„±ê³µ: 200 OK ì‘ë‹µ ë°›ìŒ")
        print(f"   ê²°ê³¼: {res.json()}")
    else:
        print(f"âŒ ì‹¤íŒ¨: {res.status_code} (ì˜ˆìƒ: 200)")
        print(f"   ì‘ë‹µ: {res.text}")

    print("\nğŸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ")

if __name__ == "__main__":
    main()


==================================================
FILE PATH: .\backend\tests\manual\verify_auth_flow.py
==================================================
import requests

def test_signup_and_login():
    base_url = "http://localhost:8000"
    
    # 1. Signup
    signup_data = {
        "email": "test_user_unique@test.com",
        "password": "Password123!",
        "nickname": "Tester"
    }
    
    print(f"Trying to signup with {signup_data['email']}...")
    try:
        signup_res = requests.post(f"{base_url}/api/auth/signup", json=signup_data)
        if signup_res.status_code == 200:
            print("âœ… Signup success!")
        elif signup_res.status_code == 400:
            print(f"â„¹ï¸ User might already exist: {signup_res.json()}")
        else:
            print(f"âŒ Signup failed: {signup_res.status_code}, {signup_res.text}")
    except Exception as e:
        print(f"âŒ Connection error: {e}")
        return

    # 2. Login
    login_data = {
        "email": "test_user_unique@test.com",
        "password": "Password123!"
    }
    
    print(f"Trying to login with {login_data['email']}...")
    login_res = requests.post(f"{base_url}/api/auth/login", json=login_data)
    
    if login_res.status_code == 200:
        data = login_res.json()
        token = data.get("access_token")
        print(f"âœ… Login success! Token: {token[:10]}...")
        
        # 3. Get Me
        print("Trying to fetch user info with token...")
        me_res = requests.get(
            f"{base_url}/api/users/me",
            headers={"Authorization": f"Bearer {token}"}
        )
        if me_res.status_code == 200:
            print(f"âœ… GetMe success! User: {me_res.json()}")
            return True
        else:
            print(f"âŒ GetMe failed: {me_res.status_code}, {me_res.text}")
    else:
        print(f"âŒ Login failed: {login_res.status_code}, {login_res.text}")
    
    return False

if __name__ == "__main__":
    test_signup_and_login()


==================================================
FILE PATH: .\frontend\cart\README.md
==================================================
# cart

This template should help get you started developing with Vue 3 in Vite.

## Recommended IDE Setup

[VS Code](https://code.visualstudio.com/) + [Vue (Official)](https://marketplace.visualstudio.com/items?itemName=Vue.volar) (and disable Vetur).

## Recommended Browser Setup

- Chromium-based browsers (Chrome, Edge, Brave, etc.):
  - [Vue.js devtools](https://chromewebstore.google.com/detail/vuejs-devtools/nhdogjmejiglipccpnnnanhbledajbpd)
  - [Turn on Custom Object Formatter in Chrome DevTools](http://bit.ly/object-formatters)
- Firefox:
  - [Vue.js devtools](https://addons.mozilla.org/en-US/firefox/addon/vue-js-devtools/)
  - [Turn on Custom Object Formatter in Firefox DevTools](https://fxdx.dev/firefox-devtools-custom-object-formatters/)

## Customize configuration

See [Vite Configuration Reference](https://vite.dev/config/).

## Project Setup

```sh
npm install
```

### Compile and Hot-Reload for Development

```sh
npm run dev
```

### Compile and Minify for Production

```sh
npm run build
```

### Lint with [ESLint](https://eslint.org/)

```sh
npm run lint
```


==================================================
FILE PATH: .\frontend\mobile-app\analysis_options.yaml
==================================================
# This file configures the analyzer, which statically analyzes Dart code to
# check for errors, warnings, and lints.
#
# The issues identified by the analyzer are surfaced in the UI of Dart-enabled
# IDEs (https://dart.dev/tools#ides-and-editors). The analyzer can also be
# invoked from the command line by running `flutter analyze`.

# The following line activates a set of recommended lints for Flutter apps,
# packages, and plugins designed to encourage good coding practices.
include: package:flutter_lints/flutter.yaml

linter:
  # The lint rules applied to this project can be customized in the
  # section below to disable rules from the `package:flutter_lints/flutter.yaml`
  # included above or to enable additional rules. A list of all available lints
  # and their documentation is published at https://dart.dev/lints.
  #
  # Instead of disabling a lint rule for the entire project in the
  # section below, it can also be suppressed for a single line of code
  # or a specific dart file by using the `// ignore: name_of_lint` and
  # `// ignore_for_file: name_of_lint` syntax on the line or in the file
  # producing the lint.
  rules:
    # avoid_print: false  # Uncomment to disable the `avoid_print` rule
    # prefer_single_quotes: true  # Uncomment to enable the `prefer_single_quotes` rule

# Additional information about this file can be found at
# https://dart.dev/guides/language/analysis-options


==================================================
FILE PATH: .\frontend\mobile-app\pubspec.yaml
==================================================
name: pickle
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev

# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1

environment:
  sdk: ^3.10.7

# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter

  flutter_riverpod: ^2.5.1
  go_router: ^14.2.7
  intl: ^0.19.0
  url_launcher: ^6.3.1
  countup: ^0.1.4

  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.8
  mobile_scanner: ^7.1.4
  dio: ^5.9.1
  flutter_secure_storage: ^10.0.0
  flutter_dotenv: ^6.0.0
  webview_flutter: ^4.13.1

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_launcher_icons: ^0.13.1

flutter_launcher_icons:
  android: "launcher_icon"
  ios: true
  image_path: "assets/icon/app_icon.png"
  adaptive_icon_background: "#FFFFFF"
  adaptive_icon_foreground: "assets/icon/app_icon.png"

  # The "flutter_lints" package below contains a set of recommended lints to
  # encourage good coding practices. The lint set provided by the package is
  # activated in the `analysis_options.yaml` file located at the root of your
  # package. See that file for information about deactivating specific lint
  # rules and activating additional ones.
  flutter_lints: ^6.0.0

# For information on the generic Dart part of this file, see the
# following page: https://dart.dev/tools/pub/pubspec

# The following section is specific to Flutter packages.
flutter:

  # The following line ensures that the Material Icons font is
  # included with your application, so that you can use the icons in
  # the material Icons class.
  uses-material-design: true

  # To add assets to your application, add an assets section, like this:
  assets:
    - .env

  # An image asset can refer to one or more resolution-specific "variants", see
  # https://flutter.dev/to/resolution-aware-images

  # For details regarding adding assets from package dependencies, see
  # https://flutter.dev/to/asset-from-package

  # To add custom fonts to your application, add a fonts section here,
  # in this "flutter" section. Each entry in this list should have a
  # "family" key with the font family name, and a "fonts" key with a
  # list giving the asset and other descriptors for the font. For
  # example:
  # fonts:
  #   - family: Schyler
  #     fonts:
  #       - asset: fonts/Schyler-Regular.ttf
  #       - asset: fonts/Schyler-Italic.ttf
  #         style: italic
  #   - family: Trajan Pro
  #     fonts:
  #       - asset: fonts/TrajanPro.ttf
  #       - asset: fonts/TrajanPro_Bold.ttf
  #         weight: 700
  #
  # For details regarding fonts from package dependencies,
  # see https://flutter.dev/to/font-from-package


==================================================
FILE PATH: .\frontend\mobile-app\README.md
==================================================
# pickle

A new Flutter project.

## Getting Started

This project is a starting point for a Flutter application.

A few resources to get you started if this is your first Flutter project:

- [Lab: Write your first Flutter app](https://docs.flutter.dev/get-started/codelab)
- [Cookbook: Useful Flutter samples](https://docs.flutter.dev/cookbook)

For help getting started with Flutter development, view the
[online documentation](https://docs.flutter.dev/), which offers tutorials,
samples, guidance on mobile development, and a full API reference.


==================================================
FILE PATH: .\frontend\mobile-app\lib\app.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'core/router/app_router.dart';
import 'core/theme/app_theme.dart';
import 'core/theme/theme_provider.dart';

class PickleApp extends ConsumerWidget {
  const PickleApp({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final theme_mode = ref.watch(theme_mode_provider);

    return MaterialApp.router(
      title: 'í”¼í´',
      theme: AppTheme.light_theme,
      darkTheme: AppTheme.dark_theme,
      themeMode: theme_mode,
      routerConfig: AppRouter.router,
      debugShowCheckedModeBanner: false,
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\main.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';

import 'app.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await dotenv.load(fileName: ".env");
  runApp(const ProviderScope(child: PickleApp()));
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\network\dio_client.dart
==================================================
import 'package:dio/dio.dart';

class DioClient {
  final Dio _dio;

  DioClient({String? baseUrl})
      : _dio = Dio(
          BaseOptions(
            // ì•ˆë“œë¡œì´ë“œ ì—ë®¬ë ˆì´í„° ì „ìš© ì£¼ì†Œ (10.0.2.2)
            baseUrl: baseUrl ?? 'http://10.0.2.2:8000', 
            connectTimeout: const Duration(seconds: 10),
            receiveTimeout: const Duration(seconds: 10),
            headers: {'Content-Type': 'application/json'},
          ),
        ) {
    _dio.interceptors.add(LogInterceptor(
      requestHeader: true,
      requestBody: true,
      responseBody: true,
      error: true, // ì—ëŸ¬ ë¡œê·¸ ì¼œë‘ê¸°
    ));
  }

  Dio get dio => _dio;

  void setAccessToken(String token) {
    _dio.options.headers['Authorization'] = 'Bearer $token';
  }

  void clearAccessToken() {
    _dio.options.headers.remove('Authorization');
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\core\network\dio_provider.dart
==================================================
import 'dart:io'; // Platform ê°ì§€ë¥¼ ìœ„í•´ ì¶”ê°€
import 'package:flutter/foundation.dart'; // kIsWeb
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'dio_client.dart';

// ì„œë²„ì˜ Base URLì„ ê´€ë¦¬í•˜ëŠ” Provider
final baseUrlProvider = Provider<String>((ref) {
  // 1. .envì— API_URLì´ ê°•ì œë¡œ ì§€ì •ë˜ì–´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìµœìš°ì„  ì‚¬ìš©
  final envUrl = dotenv.env['API_URL'];
  if (envUrl != null && envUrl.isNotEmpty) {
    // ìœˆë„ìš° í™˜ê²½ì´ë©´ì„œ localhostì¸ ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬ ê°€ëŠ¥ (í•„ìš” ì‹œ)
    return envUrl; 
  }

  // 2. ì›¹ ë¸Œë¼ìš°ì €(í¬ë¡¬)ì—ì„œ ì‹¤í–‰ ì‹œ
  if (kIsWeb) {
    // localhost ëŒ€ì‹  127.0.0.1 ì‚¬ìš© (ì¼ë¶€ ìœˆë„ìš° í™˜ê²½ í˜¸í™˜ì„±)
    return 'http://127.0.0.1:8000';
  }

  // 3. ìœˆë„ìš°/ë§¥/ë¦¬ëˆ…ìŠ¤ ë°ìŠ¤í¬í†± ì•±ì—ì„œ ì‹¤í–‰ ì‹œ
  if (Platform.isWindows || Platform.isMacOS || Platform.isLinux) {
    return 'http://127.0.0.1:8000';
  }

  // 4. ì•ˆë“œë¡œì´ë“œ ì—ë®¬ë ˆì´í„° (ê¸°ë³¸ê°’)
  if (Platform.isAndroid) {
    return 'http://10.0.2.2:8000';
  }
  
  // 5. iOS ì‹œë®¬ë ˆì´í„° ë˜ëŠ” ê·¸ ì™¸
  return 'http://127.0.0.1:8000';
});

// DioClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” Provider
final dioClientProvider = Provider<DioClient>((ref) {
  final baseUrl = ref.watch(baseUrlProvider);
  return DioClient(baseUrl: baseUrl);
});


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\router\app_router.dart
==================================================
import 'package:go_router/go_router.dart';
import 'app_routes.dart';

import '../../features/auth/presentation/splash_screen.dart';
import '../../features/auth/presentation/login_screen.dart';
import '../../features/auth/presentation/signup_screen.dart';
import '../../features/home/presentation/home_dashboard_screen.dart';
import '../../features/product/presentation/product_search_screen.dart';
import '../../features/product/presentation/product_detail_screen.dart';
import '../../features/account/presentation/my_page_screen.dart';
import '../../features/account/presentation/spending_overview_screen.dart';
import '../../features/account/presentation/top_items_screen.dart';
import '../../features/account/presentation/spending_breakdown_screen.dart';
import '../../features/account/presentation/change_nickname_screen.dart';
import '../../features/account/presentation/change_password_screen.dart';

import '../../features/cart/presentation/qr_scanner_screen.dart';
import '../../features/cart/presentation/review_and_cook_screen.dart';
import '../../features/cart/presentation/my_recipes_screen.dart';
import '../../features/recipe/presentation/recipe_detail_screen.dart';

import '../../features/payment/presentation/payment_history_screen.dart';
import '../../features/payment/presentation/payment_methods_screen.dart';
import '../../features/payment/presentation/add_new_card_screen.dart';
import '../../features/payment/presentation/card_registration_success_screen.dart';
import '../../features/payment/presentation/kakao_pay_checkout_screen.dart';
import '../../features/payment/presentation/kakao_pay_settings_screen.dart';
import '../../features/payment/presentation/digital_receipt_screen.dart';

class AppRouter {
  static final GoRouter router = GoRouter(
    initialLocation: AppRoutes.login,
    routes: <RouteBase>[
      GoRoute(path: AppRoutes.splash, builder: (c, s) => const SplashScreen()),
      GoRoute(path: AppRoutes.login, builder: (c, s) => const LoginScreen()),
      GoRoute(path: AppRoutes.signup, builder: (c, s) => const SignupScreen()),
      GoRoute(path: AppRoutes.home, builder: (c, s) => const HomeDashboardScreen()),

      GoRoute(path: AppRoutes.product_search, builder: (c, s) => const ProductSearchScreen()),
      GoRoute(
        path: AppRoutes.product_detail,
        builder: (c, s) {
          final String product_id = (s.extra as Map<String, dynamic>?)?['product_id']?.toString() ?? '';
          return ProductDetailScreen(product_id: product_id);
        },
      ),

      GoRoute(path: AppRoutes.my_page, builder: (c, s) => const MyPageScreen()),
      GoRoute(path: AppRoutes.spending_overview, builder: (c, s) => const SpendingOverviewScreen()),
      GoRoute(path: AppRoutes.top_items, builder: (c, s) => const TopItemsScreen()),
      GoRoute(path: AppRoutes.spending_breakdown, builder: (c, s) => const SpendingBreakdownScreen()),
      GoRoute(path: AppRoutes.change_nickname, builder: (c, s) => const ChangeNicknameScreen()),
      GoRoute(path: AppRoutes.change_password, builder: (c, s) => const ChangePasswordScreen()),

      GoRoute(path: AppRoutes.qr_scanner, builder: (c, s) => const QrScannerScreen()),
      GoRoute(path: AppRoutes.review_and_cook, builder: (c, s) => const ReviewAndCookScreen()),
      GoRoute(path: AppRoutes.my_recipes, builder: (c, s) => const MyRecipesScreen()),
      GoRoute(
        path: AppRoutes.recipe_detail,
        builder: (c, s) {
          final String recipe_id = (s.extra as Map<String, dynamic>?)?['recipe_id']?.toString() ?? '';
          return RecipeDetailScreen(recipe_id: recipe_id);
        },
      ),

      GoRoute(path: AppRoutes.payment_history, builder: (c, s) => const PaymentHistoryScreen()),
      GoRoute(path: AppRoutes.payment_methods, builder: (c, s) => const PaymentMethodsScreen()),
      GoRoute(path: AppRoutes.add_new_card, builder: (c, s) => const AddNewCardScreen()),
      GoRoute(path: AppRoutes.card_registration_success, builder: (c, s) => const CardRegistrationSuccessScreen()),
      GoRoute(path: AppRoutes.kakao_pay_checkout, builder: (c, s) => const KakaoPayCheckoutScreen()),
      GoRoute(path: AppRoutes.kakao_pay_settings, builder: (c, s) => const KakaoPaySettingsScreen()),
      GoRoute(
        path: AppRoutes.digital_receipt,
        builder: (c, s) {
          final String receipt_id = (s.extra as Map<String, dynamic>?)?['receipt_id']?.toString() ?? '';
          return DigitalReceiptScreen(receipt_id: receipt_id);
        },
      ),
    ],
  );
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\router\app_routes.dart
==================================================
class AppRoutes {
  static const String splash = '/';
  static const String login = '/login';
  static const String signup = '/signup';
  static const String home = '/home';
  static const String product_search = '/product/search';
  static const String product_detail = '/product/detail';

  static const String my_page = '/account/my';
  static const String spending_overview = '/account/spending';
  static const String top_items = '/account/top-items';
  static const String spending_breakdown = '/account/spending-breakdown';
  static const String change_nickname = '/account/change-nickname';
  static const String change_password = '/account/change-password';

  static const String qr_scanner = '/cart/qr-scanner';
  static const String review_and_cook = '/cart/review-and-cook';
  static const String my_recipes = '/cart/my-recipes';
  static const String recipe_detail = '/recipe/detail';

  static const String payment_history = '/payment/history';
  static const String payment_methods = '/payment/methods';
  static const String add_new_card = '/payment/add-card';
  static const String card_registration_success = '/payment/card-success';
  static const String kakao_pay_checkout = '/payment/kakao-checkout';
  static const String kakao_pay_settings = '/payment/kakao-settings';
  static const String digital_receipt = '/payment/receipt';
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\storage\token_storage.dart
==================================================
import 'package:flutter_secure_storage/flutter_secure_storage.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

class TokenStorage {
  final FlutterSecureStorage _storage;
  static const _keyAccessToken = 'access_token';

  TokenStorage({FlutterSecureStorage? storage})
      : _storage = storage ?? const FlutterSecureStorage();

  Future<void> saveToken(String token) async {
    await _storage.write(key: _keyAccessToken, value: token);
  }

  Future<String?> getToken() async {
    return await _storage.read(key: _keyAccessToken);
  }

  Future<void> deleteToken() async {
    await _storage.delete(key: _keyAccessToken);
  }
}

final tokenStorageProvider = Provider<TokenStorage>((ref) {
  return TokenStorage();
});


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\theme\app_colors.dart
==================================================
import 'package:flutter/material.dart';

class AppColors {
  // Gemini Theme Colors (Updated: Purple focused, No Red)
  static const Color gemini_blue = Color(0xFF3B82F6);
  static const Color gemini_purple = Color(0xFF8B5CF6);

  static const List<Color> gemini_gradient = [
    gemini_blue,
    gemini_purple,
  ];

  static const Color brand_primary = gemini_purple; // Shifted to Purple dominant

  // Light Mode Colors
  static const Color bg = Color(0xFFF6F7F9);
  static const Color text_primary = Color(0xFF111827);
  static const Color text_secondary = Color(0xFF6B7280);
  static const Color card = Colors.white;
  static const Color border = Color(0xFFE5E7EB);

  // Dark Mode Colors
  static const Color bg_dark = Color(0xFF0F172A);
  static const Color text_primary_dark = Color(0xFFF8FAFC);
  static const Color text_secondary_dark = Color(0xFF94A3B8);
  static const Color card_dark = Color(0xFF1E293B);
  static const Color border_dark = Color(0xFF334155);
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\core\theme\app_theme.dart
==================================================
import 'package:flutter/material.dart';
import 'app_colors.dart';

class AppTheme {
  static const String fontFamily = 'Pretendard';

  static ThemeData get light_theme {
    final ColorScheme scheme = ColorScheme.fromSeed(
      seedColor: AppColors.brand_primary,
      brightness: Brightness.light,
    );

    return ThemeData(
      colorScheme: scheme,
      fontFamily: fontFamily,
      scaffoldBackgroundColor: AppColors.bg,
      useMaterial3: true,
      appBarTheme: const AppBarTheme(
        backgroundColor: AppColors.bg,
        elevation: 0,
        centerTitle: true,
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: const Color(0xFFF3F4F6),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: AppColors.border),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: AppColors.border),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 14, vertical: 14),
      ),
      cardTheme: const CardThemeData(
        color: AppColors.card,
        elevation: 0,
        margin: EdgeInsets.zero,
      ),
    );
  }

  static ThemeData get dark_theme {
    final ColorScheme scheme = ColorScheme.fromSeed(
      seedColor: AppColors.brand_primary,
      brightness: Brightness.dark,
      surface: AppColors.card_dark,
    );

    return ThemeData(
      colorScheme: scheme,
      fontFamily: fontFamily,
      scaffoldBackgroundColor: AppColors.bg_dark,
      useMaterial3: true,
      appBarTheme: const AppBarTheme(
        backgroundColor: AppColors.bg_dark,
        elevation: 0,
        centerTitle: true,
      ),
      inputDecorationTheme: InputDecorationTheme(
        filled: true,
        fillColor: const Color(0xFF1E293B),
        border: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: AppColors.border_dark),
        ),
        enabledBorder: OutlineInputBorder(
          borderRadius: BorderRadius.circular(14),
          borderSide: const BorderSide(color: AppColors.border_dark),
        ),
        contentPadding: const EdgeInsets.symmetric(horizontal: 14, vertical: 14),
      ),
      cardTheme: const CardThemeData(
        color: AppColors.card_dark,
        elevation: 0,
        margin: EdgeInsets.zero,
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\theme\colors.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\theme\PickleColors.dart
==================================================
import 'package:flutter/material.dart';

class PickleColors {
  static const Color black = Color(0xFF000000);
  static const Color white = Color(0xFFFFFFFF);
  
  // Theme Color (Updated: Purple focused)
  static const Color pickle = Color(0xFF8B5CF6); 
  static const Color pickleLight = Color(0xFFC4B5FD);
  static const Color pickleDark = Color(0xFF6D28D9);
  
  static const Color grey = Color(0xFF9E9E9E);
  static const Color greyLight = Color(0xFFE0E0E0);
  static const Color greyDark = Color(0xFF616161);
  
  static const Color red = Color(0xFFEF4444);
  static const Color redLight = Color(0xFFFCA5A5);
  static const Color redDark = Color(0xFFB91C1C);
  
  static const Color green = Color(0xFF10B981);
  static const Color greenLight = Color(0xFF6EE7B7);
  static const Color greenDark = Color(0xFF047857);
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\core\theme\text_styles.dart
==================================================
import 'package:flutter/material.dart';
import 'package:pickle/core/theme/PickleColors.dart';

class PickleTextStyles {
  static const TextStyle bigregular = TextStyle(
    fontSize: 24,
    fontWeight: FontWeight.w400,
    color: PickleColors.black,
  );
  static const TextStyle mediumregular = TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w400,
    color: PickleColors.black,
  );
  static const TextStyle smallregular = TextStyle(
    fontSize: 12,
    fontWeight: FontWeight.w400,
    color: PickleColors.black,
  );
  static const TextStyle bigbold = TextStyle(
    fontSize: 24,
    fontWeight: FontWeight.w700,
    color: PickleColors.black,
  );
  static const TextStyle mediumbold = TextStyle(
    fontSize: 16,
    fontWeight: FontWeight.w700,
    color: PickleColors.black,
  );
  static const TextStyle smallbold = TextStyle(
    fontSize: 12,
    fontWeight: FontWeight.w700,
    color: PickleColors.black,
  );
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\theme\theme_provider.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

final theme_mode_provider = StateProvider<ThemeMode>((ref) {
  return ThemeMode.system;
});

final notification_enabled_provider = StateProvider<bool>((ref) {
  return true;
});

==================================================
FILE PATH: .\frontend\mobile-app\lib\core\utils\init.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\core\utils\responsive.dart
==================================================
import 'package:flutter/widgets.dart';

class Responsive {
  static double max_width(BuildContext context) {
    final double w = MediaQuery.sizeOf(context).width;
    if (w >= 600) return 460; // íƒœë¸”ë¦¿/ì›¹ì—ì„œ ê³¼ë„í•˜ê²Œ ë„“ì–´ì§€ì§€ ì•Šê²Œ
    return w;
  }

  static EdgeInsets page_padding(BuildContext context) {
    final double w = MediaQuery.sizeOf(context).width;
    final double h = MediaQuery.sizeOf(context).height;
    final double base = w >= 600 ? 24 : 16;
    return EdgeInsets.fromLTRB(base, base, base, h >= 780 ? 20 : 16);
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\cart.dart
==================================================
class CartItem {
  final String product_id;
  final String name;
  final String option_label; // ì˜ˆ: "1kg Â· ìœ ê¸°ë†"
  final int price;

  const CartItem({
    required this.product_id,
    required this.name,
    required this.option_label,
    required this.price,
  });

  factory CartItem.fromJson(Map<String, dynamic> json) {
    final int weight = json['weight'] ?? 0;
    return CartItem(
      product_id: (json['product_id'] ?? 0).toString(),
      name: json['name'] ?? '',
      option_label: weight > 0 ? '${weight}g' : '',
      price: json['price'] ?? 0,
    );
  }
}

class CartSummary {
  final int cart_session_id;
  final List<CartItem> items;
  final int subtotal;
  final int total;

  const CartSummary({
    required this.cart_session_id,
    required this.items,
    required this.subtotal,
    required this.total,
  });
  
  // CartSummaryëŠ” Repositoryì—ì„œ ì¡°í•©í•´ì„œ ë§Œë“¤ë¯€ë¡œ fromJsonì€ ì„ íƒ ì‚¬í•­ì´ë‚˜,
  // ë°±ì—”ë“œì—ì„œ í†µìœ¼ë¡œ ë‚´ë ¤ì¤„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì¶”ê°€ ê°€ëŠ¥
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\payment.dart
==================================================
class PaymentHistoryItem {
  final String payment_id;
  final DateTime paid_at;
  final String merchant_name;
  final String category_label;
  final int amount;
  final String receipt_id;

  const PaymentHistoryItem({
    required this.payment_id,
    required this.paid_at,
    required this.merchant_name,
    required this.category_label,
    required this.amount,
    required this.receipt_id,
  });
}

class ReceiptItem {
  final String name;
  final String option_label;
  final int qty;
  final int price;

  const ReceiptItem({
    required this.name,
    required this.option_label,
    required this.qty,
    required this.price,
  });
}

class DigitalReceipt {
  final String receipt_id;
  final String store_name;
  final DateTime paid_at;
  final String ref_code;
  final List<ReceiptItem> items;
  final int subtotal;
  final int tax;
  final int total_paid;
  final String paid_method_label;

  const DigitalReceipt({
    required this.receipt_id,
    required this.store_name,
    required this.paid_at,
    required this.ref_code,
    required this.items,
    required this.subtotal,
    required this.tax,
    required this.total_paid,
    required this.paid_method_label,
  });
}

class CardModel {
  final String card_id;
  final String brand_label;
  final String last4;
  final String expires_mm_yy;
  final bool is_primary;

  const CardModel({
    required this.card_id,
    required this.brand_label,
    required this.last4,
    required this.expires_mm_yy,
    required this.is_primary,
  });
}

class WalletModel {
  final String wallet_key; // kakao_pay / pickle_cash ë“±
  final String label;
  final String status_label; // ì—°ê²°ë¨ / ì”ì•¡ ë“±

  const WalletModel({
    required this.wallet_key,
    required this.label,
    required this.status_label,
  });
}

class PaymentReadyResponse {
  final String tid;
  final String next_redirect_app_url;
  final String next_redirect_mobile_url;
  final String next_redirect_pc_url;

  const PaymentReadyResponse({
    required this.tid,
    required this.next_redirect_app_url,
    required this.next_redirect_mobile_url,
    required this.next_redirect_pc_url,
  });

  factory PaymentReadyResponse.fromJson(Map<String, dynamic> json) {
    return PaymentReadyResponse(
      tid: json['tid'] ?? '',
      next_redirect_app_url: json['next_redirect_app_url'] ?? '',
      next_redirect_mobile_url: json['next_redirect_mobile_url'] ?? '',
      next_redirect_pc_url: json['next_redirect_pc_url'] ?? '',
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\product.dart
==================================================
class Product {
  final String product_id;
  final String name;
  final int price;
  final String unit_label; // ì˜ˆ: "kg", "ê°œ", "L"
  final String image_url;
  final bool is_in_stock;
  final String aisle_label; // ì˜ˆ: "Aisle 4" -> UIì—ì„œëŠ” "í†µë¡œ 4"

  const Product({
    required this.product_id,
    required this.name,
    required this.price,
    required this.unit_label,
    required this.image_url,
    required this.is_in_stock,
    required this.aisle_label,
  });

  factory Product.fromJson(Map<String, dynamic> json) {
    return Product(
      product_id: (json['product_id'] ?? 0).toString(),
      name: json['name'] ?? '',
      price: json['price'] ?? 0,
      unit_label: json['unit_weight_g'] != null ? '${json['unit_weight_g']}g' : '1ê°œ',
      image_url: json['image_url'] ?? '',
      is_in_stock: (json['stock_quantity'] ?? 0) > 0,
      // ë°±ì—”ë“œì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì£¼ì§€ ì•Šì„ ê²½ìš° ê¸°ë³¸ê°’ ì²˜ë¦¬
      aisle_label: json['zone_code'] ?? 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ',
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\recipe.dart
==================================================
class RecipeCardModel {
  final String recipe_id;
  final String title;
  final String subtitle;
  final int match_percent;
  final int time_min;
  final String difficulty_label; // ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€
  final bool is_in_progress;
  final bool is_smart_choice;

  const RecipeCardModel({
    required this.recipe_id,
    required this.title,
    required this.subtitle,
    required this.match_percent,
    required this.time_min,
    required this.difficulty_label,
    required this.is_in_progress,
    required this.is_smart_choice,
  });

  factory RecipeCardModel.fromJson(Map<String, dynamic> json) {
    return RecipeCardModel(
      recipe_id: (json['recipe_id'] ?? 0).toString(),
      title: json['title'] ?? '',
      subtitle: json['description'] ?? '',
      // ë°±ì—”ë“œì—ì„œ ì•„ì§ ê³„ì‚° ë¡œì§ì´ ì—†ë‹¤ë©´ ê¸°ë³¸ê°’
      match_percent: json['match_percent'] ?? 0,
      time_min: 30, // ì„ì‹œ ê¸°ë³¸ê°’ (DBì— cooking_time ì»¬ëŸ¼ ì—†ìŒ)
      difficulty_label: 'ë³´í†µ', // ì„ì‹œ ê¸°ë³¸ê°’
      is_in_progress: false,
      is_smart_choice: false,
    );
  }
}

class RecipeIngredient {
  final String name;
  final String status_label; // "ì¹´íŠ¸ì— ìˆìŒ" / "ì—†ìŒ"
  final bool is_available;

  const RecipeIngredient({
    required this.name,
    required this.status_label,
    required this.is_available,
  });
  
  // RecipeIngredientëŠ” DB í…Œì´ë¸”ì´ ë³µí•©ì ì´ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ
  // ìš°ì„  ê¸°ë³¸ ë§¤í•‘ë§Œ ì¶”ê°€
  factory RecipeIngredient.fromJson(Map<String, dynamic> json) {
    return RecipeIngredient(
      name: json['product_name'] ?? json['name'] ?? '',
      status_label: 'í™•ì¸ í•„ìš”',
      is_available: false,
    );
  }
}

class RecipeStep {
  final int order;
  final String title;
  final String description;

  const RecipeStep({
    required this.order,
    required this.title,
    required this.description,
  });

  factory RecipeStep.fromJson(Map<String, dynamic> json) {
    return RecipeStep(
      order: json['order'] ?? 1,
      title: json['title'] ?? '',
      description: json['description'] ?? '',
    );
  }
}

class RecipeDetailModel {
  final String recipe_id;
  final String title;
  final int prep_time_min;
  final String difficulty_label;
  final int calories;
  final List<RecipeIngredient> ingredients;
  final List<RecipeStep> steps;

  const RecipeDetailModel({
    required this.recipe_id,
    required this.title,
    required this.prep_time_min,
    required this.difficulty_label,
    required this.calories,
    required this.ingredients,
    required this.steps,
  });

  factory RecipeDetailModel.fromJson(Map<String, dynamic> json) {
    return RecipeDetailModel(
      recipe_id: (json['recipe_id'] ?? 0).toString(),
      title: json['title'] ?? '',
      prep_time_min: 30, // ê¸°ë³¸ê°’
      difficulty_label: 'ë³´í†µ', // ê¸°ë³¸ê°’
      calories: 500, // ê¸°ë³¸ê°’
      ingredients: [], // ë³„ë„ ë¡œë”© í•„ìš”
      steps: [], // ë³„ë„ ë¡œë”© í•„ìš”
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\spending.dart
==================================================
class SpendingSummary {
  final int total_amount;
  final int diff_percent; // ì§€ë‚œë‹¬ ëŒ€ë¹„ +/-
  final String month_label;

  const SpendingSummary({
    required this.total_amount,
    required this.diff_percent,
    required this.month_label,
  });
}

class SpendingTransaction {
  final String transaction_id;
  final DateTime spent_at;
  final String merchant_name;
  final String category_label;
  final int amount;

  const SpendingTransaction({
    required this.transaction_id,
    required this.spent_at,
    required this.merchant_name,
    required this.category_label,
    required this.amount,
  });
}

class SpendingDay {
  final DateTime date;
  final int amount;

  const SpendingDay({
    required this.date,
    required this.amount,
  });
}

class TopItem {
  final String product_id;
  final String name;
  final String category_label;
  final int purchase_count;
  final int avg_price;

  const TopItem({
    required this.product_id,
    required this.name,
    required this.category_label,
    required this.purchase_count,
    required this.avg_price,
  });
}

class CategorySpend {
  final String category_key;
  final String category_label;
  final double amount;
  final double ratio; // 0~1

  const CategorySpend({
    required this.category_key,
    required this.category_label,
    required this.amount,
    required this.ratio,
  });
}

class MonthSummary {
  final num total_amount;
  final num compared_to_last_month_ratio; // ì˜ˆ: -0.12 ~ 0.35

  const MonthSummary({
    required this.total_amount,
    required this.compared_to_last_month_ratio,
  });
}

class DaySpend {
  final DateTime date;
  final num amount;

  const DaySpend({
    required this.date,
    required this.amount,
  });
}

class TransactionItem {
  final String merchant_name;
  final String category_label;
  final num amount;
  final DateTime spent_at;

  const TransactionItem({
    required this.merchant_name,
    required this.category_label,
    required this.amount,
    required this.spent_at,
  });
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\user.dart
==================================================
class User {
  final int id; // IDëŠ” ë³´í†µ intë¡œ ì˜´ (í•„ìš”ì‹œ Stringìœ¼ë¡œ ë³€ê²½)
  final String name;
  final String email;

  User({
    required this.id,
    required this.name,
    required this.email,
  });

  // ë°±ì—”ë“œ JSON -> Dart ê°ì²´ ë³€í™˜ (Factory Constructor)
  factory User.fromJson(Map<String, dynamic> json) {
    return User(
      // DB ìŠ¤í‚¤ë§ˆì— ë”°ë¥´ë©´ user_idì„
      id: json['user_id'] ?? json['id'] ?? 0,
      name: json['nickname'] ?? '',
      email: json['email'] ?? '',
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\domain\models\user_profile.dart
==================================================
class UserProfile {
  final String user_id;
  final String nickname;
  final String email;
  final bool is_premium;

  const UserProfile({
    required this.user_id,
    required this.nickname,
    required this.email,
    required this.is_premium,
  });
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\account_providers.dart
==================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/network/dio_provider.dart';
import '../repository/account_repository.dart';
import '../repository/http_account_repository.dart';
import '../../../domain/models/user_profile.dart';
import '../../../domain/models/spending.dart';

final Provider<AccountRepository> account_repository_provider =
Provider<AccountRepository>((ProviderRef<AccountRepository> ref) {
  final dioClient = ref.watch(dioClientProvider);
  return HttpAccountRepository(dio: dioClient.dio);
});

final FutureProvider<UserProfile> my_profile_provider =
FutureProvider<UserProfile>(
      (FutureProviderRef<UserProfile> ref) async {
    final AccountRepository repo = ref.read(account_repository_provider);
    return repo.fetch_my_profile();
  },
);

final StateProvider<DateTime> selected_month_provider =
StateProvider<DateTime>((StateProviderRef<DateTime> ref) {
  final DateTime now = DateTime.now();
  return DateTime(now.year, now.month, 1);
});

final FutureProvider<SpendingSummary> month_summary_provider =
FutureProvider<SpendingSummary>(
      (FutureProviderRef<SpendingSummary> ref) async {
    final AccountRepository repo = ref.read(account_repository_provider);
    final DateTime month = ref.watch(selected_month_provider);
    return repo.fetch_month_summary(month: month);
  },
);

final FutureProvider<List<SpendingDay>> month_days_provider =
FutureProvider<List<SpendingDay>>(
      (FutureProviderRef<List<SpendingDay>> ref) async {
    final AccountRepository repo = ref.read(account_repository_provider);
    final DateTime month = ref.watch(selected_month_provider);
    return repo.fetch_month_days(month: month);
  },
);

final FutureProvider<List<SpendingTransaction>> recent_transactions_provider =
FutureProvider<List<SpendingTransaction>>(
      (FutureProviderRef<List<SpendingTransaction>> ref) async {
    final AccountRepository repo = ref.read(account_repository_provider);
    final DateTime month = ref.watch(selected_month_provider);
    return repo.fetch_recent_transactions(month: month);
  },
);

final FutureProvider<List<TopItem>> top_items_provider =
FutureProvider<List<TopItem>>(
      (FutureProviderRef<List<TopItem>> ref) async {
    final AccountRepository repo = ref.read(account_repository_provider);
    final DateTime month = ref.watch(selected_month_provider);
    return repo.fetch_top_items(month: month);
  },
);

final FutureProvider<List<CategorySpend>> category_breakdown_provider =
FutureProvider<List<CategorySpend>>(
      (FutureProviderRef<List<CategorySpend>> ref) async {
    final AccountRepository repo = ref.read(account_repository_provider);
    final DateTime month = ref.watch(selected_month_provider);
    return repo.fetch_category_breakdown(month: month);
  },
);


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\change_nickname_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/app_text_field.dart';
import '../repository/account_repository.dart';
import 'account_providers.dart';

class ChangeNicknameScreen extends ConsumerStatefulWidget {
  const ChangeNicknameScreen({super.key});

  @override
  ConsumerState<ChangeNicknameScreen> createState() => _ChangeNicknameScreenState();
}

class _ChangeNicknameScreenState extends ConsumerState<ChangeNicknameScreen> {
  final TextEditingController nickname_controller = TextEditingController();
  bool is_saving = false;

  @override
  void dispose() {
    nickname_controller.dispose();
    super.dispose();
  }

  Future<void> _save() async {
    final String new_nickname = nickname_controller.text.trim();
    if (new_nickname.isEmpty) return;

    setState(() => is_saving = true);

    try {
      final AccountRepository repo = ref.read(account_repository_provider);
      await repo.update_nickname(new_nickname: new_nickname);
      ref.invalidate(my_profile_provider); // í”„ë¡œí•„ ê°±ì‹ 
      if (mounted) Navigator.of(context).pop();
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('ì €ì¥ ì‹¤íŒ¨: $e')));
    } finally {
      if (mounted) setState(() => is_saving = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final profile_async = ref.watch(my_profile_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ë‹‰ë„¤ì„ ë³€ê²½', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: Padding(
              padding: Responsive.page_padding(context),
              child: profile_async.when(
                loading: () => const Center(child: CircularProgressIndicator()),
                error: (e, _) => Text('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                data: (profile) {
                  return Column(
                    children: <Widget>[
                      SectionCard(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Text('í˜„ì¬ ë‹‰ë„¤ì„', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 8),
                            Container(
                              width: double.infinity,
                              padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 14),
                              decoration: BoxDecoration(
                                color: const Color(0xFFF3F4F6),
                                borderRadius: BorderRadius.circular(14),
                                border: Border.all(color: AppColors.border),
                              ),
                              child: Text(profile.nickname, style: const TextStyle(fontWeight: FontWeight.w900)),
                            ),
                            const SizedBox(height: 14),
                            AppTextField(
                              controller: nickname_controller,
                              label: 'ìƒˆ ë‹‰ë„¤ì„',
                              hint: 'ìƒˆ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”',
                              suffix_icon: IconButton(
                                onPressed: () => nickname_controller.clear(),
                                icon: const Icon(Icons.close),
                              ),
                              helper_text: '2~20ì ì‚¬ìš© ê°€ëŠ¥ (ë¬¸ì/ìˆ«ì/ì´ëª¨ì§€ ê°€ëŠ¥)',
                            ),
                          ],
                        ),
                      ),
                      const Spacer(),
                      PrimaryButton(
                        label: is_saving ? 'ì €ì¥ ì¤‘...' : 'ë³€ê²½ ì €ì¥',
                        on_pressed: is_saving ? null : _save,
                      ),
                    ],
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\change_password_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/app_text_field.dart';
import '../repository/account_repository.dart';
import 'account_providers.dart';

class ChangePasswordScreen extends ConsumerStatefulWidget {
  const ChangePasswordScreen({super.key});

  @override
  ConsumerState<ChangePasswordScreen> createState() => _ChangePasswordScreenState();
}

class _ChangePasswordScreenState extends ConsumerState<ChangePasswordScreen> {
  final TextEditingController current_password_controller = TextEditingController();
  final TextEditingController new_password_controller = TextEditingController();
  final TextEditingController confirm_password_controller = TextEditingController();

  bool is_current_hidden = true;
  bool is_new_hidden = true;
  bool is_confirm_hidden = true;
  bool is_saving = false;

  @override
  void dispose() {
    current_password_controller.dispose();
    new_password_controller.dispose();
    confirm_password_controller.dispose();
    super.dispose();
  }

  bool get has_min_length => new_password_controller.text.length >= 8;
  bool get has_number => RegExp(r'\d').hasMatch(new_password_controller.text);
  bool get has_special => RegExp(r'[!@#$%^&*(),.?":{}|<>]').hasMatch(new_password_controller.text);
  bool get has_upper => RegExp(r'[A-Z]').hasMatch(new_password_controller.text);

  bool get is_confirm_match => new_password_controller.text == confirm_password_controller.text && confirm_password_controller.text.isNotEmpty;

  double get strength {
    int score = 0;
    if (has_min_length) score++;
    if (has_number) score++;
    if (has_special) score++;
    if (has_upper) score++;
    return score / 4;
  }

  String get strength_label {
    final double s = strength;
    if (s >= 0.75) return 'ì¢‹ìŒ';
    if (s >= 0.5) return 'ë³´í†µ';
    if (s > 0) return 'ì•½í•¨';
    return 'ì—†ìŒ';
  }

  Future<void> _save() async {
    final String current_password = current_password_controller.text;
    final String new_password = new_password_controller.text;

    if (!has_min_length || !has_number || !has_special || !is_confirm_match) {
      ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('ë¹„ë°€ë²ˆí˜¸ ì¡°ê±´ì„ í™•ì¸í•´ì£¼ì„¸ìš”.')));
      return;
    }

    setState(() => is_saving = true);
    try {
      final AccountRepository repo = ref.read(account_repository_provider);
      await repo.change_password(current_password: current_password, new_password: new_password);
      if (mounted) Navigator.of(context).pop();
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('ë³€ê²½ ì‹¤íŒ¨: $e')));
    } finally {
      if (mounted) setState(() => is_saving = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                children: <Widget>[
                  SectionCard(
                    child: Column(
                      children: <Widget>[
                        Container(
                          width: 80,
                          height: 80,
                          decoration: BoxDecoration(
                            color: AppColors.brand_primary.withOpacity(0.10),
                            borderRadius: BorderRadius.circular(999),
                          ),
                          child: const Center(child: Icon(Icons.security, color: AppColors.brand_primary, size: 34)),
                        ),
                        const SizedBox(height: 12),
                        Text(
                          'ìˆ«ìì™€ íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•œ ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ ë³´ì•ˆì„ ê°•í™”í•˜ì„¸ìš”.',
                          textAlign: TextAlign.center,
                          style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800),
                        ),
                        const SizedBox(height: 14),

                        AppTextField(
                          controller: current_password_controller,
                          label: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸',
                          hint: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                          obscure_text: is_current_hidden,
                          suffix_icon: IconButton(
                            onPressed: () => setState(() => is_current_hidden = !is_current_hidden),
                            icon: Icon(is_current_hidden ? Icons.visibility_outlined : Icons.visibility_off_outlined),
                          ),
                        ),
                        const SizedBox(height: 14),

                        AppTextField(
                          controller: new_password_controller,
                          label: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸',
                          hint: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                          obscure_text: is_new_hidden,
                          suffix_icon: IconButton(
                            onPressed: () => setState(() => is_new_hidden = !is_new_hidden),
                            icon: Icon(is_new_hidden ? Icons.visibility_outlined : Icons.visibility_off_outlined),
                          ),
                        ),
                        const SizedBox(height: 10),

                        Row(
                          children: <Widget>[
                            Text('ë¹„ë°€ë²ˆí˜¸ ê°•ë„', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                            const Spacer(),
                            Text(strength_label, style: const TextStyle(fontWeight: FontWeight.w900, color: AppColors.brand_primary)),
                          ],
                        ),
                        const SizedBox(height: 8),
                        ClipRRect(
                          borderRadius: BorderRadius.circular(999),
                          child: LinearProgressIndicator(
                            value: strength,
                            minHeight: 10,
                            backgroundColor: AppColors.border.withOpacity(0.35),
                          ),
                        ),
                        const SizedBox(height: 12),

                        _RuleRow(label: 'ìµœì†Œ 8ì ì´ìƒ', is_ok: has_min_length),
                        _RuleRow(label: 'ìˆ«ì í¬í•¨', is_ok: has_number),
                        _RuleRow(label: 'íŠ¹ìˆ˜ë¬¸ì í¬í•¨', is_ok: has_special),
                        _RuleRow(label: 'ëŒ€ë¬¸ì í¬í•¨(ê¶Œì¥)', is_ok: has_upper),

                        const SizedBox(height: 14),
                        AppTextField(
                          controller: confirm_password_controller,
                          label: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸',
                          hint: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”',
                          obscure_text: is_confirm_hidden,
                          suffix_icon: IconButton(
                            onPressed: () => setState(() => is_confirm_hidden = !is_confirm_hidden),
                            icon: Icon(is_confirm_hidden ? Icons.visibility_outlined : Icons.visibility_off_outlined),
                          ),
                          helper_text: is_confirm_match ? 'ì¼ì¹˜í•©ë‹ˆë‹¤' : 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤',
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 14),
                  PrimaryButton(
                    label: is_saving ? 'ë³€ê²½ ì¤‘...' : 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½',
                    on_pressed: is_saving ? null : _save,
                    leading: const Icon(Icons.arrow_forward),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _RuleRow extends StatelessWidget {
  final String label;
  final bool is_ok;

  const _RuleRow({required this.label, required this.is_ok});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        children: <Widget>[
          Icon(is_ok ? Icons.check_circle : Icons.radio_button_unchecked, size: 18, color: is_ok ? AppColors.brand_primary : AppColors.text_secondary),
          const SizedBox(width: 10),
          Expanded(child: Text(label, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800))),
        ],
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\my_page_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/bottom_nav.dart';
import 'account_providers.dart';

class MyPageScreen extends ConsumerStatefulWidget {
  const MyPageScreen({super.key});

  @override
  ConsumerState<MyPageScreen> createState() => _MyPageScreenState();
}

class _MyPageScreenState extends ConsumerState<MyPageScreen> {
  BottomTab current_tab = BottomTab.my_page;

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final profile_async = ref.watch(my_profile_provider);
    final theme_mode = ref.watch(theme_mode_provider);
    final is_dark = theme_mode == ThemeMode.dark || 
                   (theme_mode == ThemeMode.system && MediaQuery.of(context).platformBrightness == Brightness.dark);
    final notifications_enabled = ref.watch(notification_enabled_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ë§ˆì´ í”¼í´', style: TextStyle(fontWeight: FontWeight.w900)),
        actions: <Widget>[
          IconButton(
            onPressed: () {
              ref.read(theme_mode_provider.notifier).state =
                  is_dark ? ThemeMode.light : ThemeMode.dark;
            },
            icon: Icon(
              is_dark ? Icons.nightlight_round : Icons.nightlight_outlined,
              color: is_dark ? Colors.yellow : null,
            ),
          ),
          IconButton(
            onPressed: () {
              ref.read(notification_enabled_provider.notifier).state = !notifications_enabled;
            },
            icon: Icon(notifications_enabled ? Icons.notifications : Icons.notifications_off_outlined),
          ),
        ],
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: profile_async.when(
                loading: () => const Center(child: Padding(padding: EdgeInsets.all(40), child: CircularProgressIndicator())),
                error: (e, _) => _ErrorView(message: 'í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                data: (profile) {
                  return Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: <Widget>[
                      SectionCard(
                        child: Row(
                          children: <Widget>[
                            CircleAvatar(
                              radius: 26,
                              backgroundColor: AppColors.brand_primary.withOpacity(0.15),
                              child: const Icon(Icons.person, color: AppColors.brand_primary),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Row(
                                    children: <Widget>[
                                      Expanded(
                                        child: Text(
                                          profile.nickname,
                                          style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w900),
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                      ),
                                      PopupMenuButton<String>(
                                        icon: const Icon(Icons.settings_outlined),
                                        onSelected: (value) {
                                          if (value == 'nickname') context.push(AppRoutes.change_nickname);
                                          if (value == 'password') context.push(AppRoutes.change_password);
                                        },
                                        itemBuilder: (context) => [
                                          const PopupMenuItem(value: 'nickname', child: Text('ë‹‰ë„¤ì„ ë³€ê²½')),
                                          const PopupMenuItem(value: 'password', child: Text('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½')),
                                        ],
                                      ),
                                    ],
                                  ),
                                  Text(profile.email, style: TextStyle(color: AppColors.text_secondary)),
                                  const SizedBox(height: 6),
                                  if (profile.is_premium)
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                      decoration: BoxDecoration(
                                        color: AppColors.brand_primary.withOpacity(0.12),
                                        borderRadius: BorderRadius.circular(999),
                                      ),
                                      child: const Text(
                                        'í”„ë¦¬ë¯¸ì—„ íšŒì›',
                                        style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w800, fontSize: 12),
                                      ),
                                    ),
                                ],
                              ),
                            ),
                          ],
                        ),
                      ),
                      SectionCard(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Text('ê³„ì • ì„¤ì •', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 10),
                            _MenuTile(
                              icon: Icons.person_outline,
                              title: 'ë‹‰ë„¤ì„ ë³€ê²½',
                              on_tap: () => context.push(AppRoutes.change_nickname),
                            ),
                            _MenuTile(
                              icon: Icons.lock_outline,
                              title: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½',
                              on_tap: () => context.push(AppRoutes.change_password),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 14),
                      SectionCard(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Text('ê²°ì œ ê´€ë¦¬', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 10),
                            _MenuTile(
                              icon: Icons.chat_bubble_outline,
                              title: 'ì¹´ì¹´ì˜¤í˜ì´ ì„¤ì •',
                              on_tap: () => context.push(AppRoutes.kakao_pay_settings),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 14),
                      Center(
                        child: TextButton(
                          onPressed: () {
                            // Implement logout
                            context.go(AppRoutes.login);
                          },
                          child: const Text('ë¡œê·¸ì•„ì›ƒ', style: TextStyle(color: Colors.red, fontWeight: FontWeight.w700)),
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),
          ),
        ),
      ),
      bottomNavigationBar: BottomNav(
        current_tab: current_tab,
        on_tab_selected: (BottomTab next) {
          setState(() => current_tab = next);
          if (next == BottomTab.home) context.go(AppRoutes.home);
          if (next == BottomTab.search) context.go(AppRoutes.product_search);
          if (next == BottomTab.scan) context.push(AppRoutes.qr_scanner);
          if (next == BottomTab.account_book) context.go(AppRoutes.spending_overview);
          if (next == BottomTab.my_page) context.go(AppRoutes.my_page);
        },
      ),
    );
  }
}

class _MenuTile extends StatelessWidget {
  final IconData icon;
  final String title;
  final VoidCallback on_tap;

  const _MenuTile({
    required this.icon,
    required this.title,
    required this.on_tap,
  });

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: on_tap,
      borderRadius: BorderRadius.circular(16),
      child: Padding(
        padding: const EdgeInsets.symmetric(vertical: 10),
        child: Row(
          children: <Widget>[
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: AppColors.border.withOpacity(0.35),
                borderRadius: BorderRadius.circular(14),
              ),
              child: Icon(icon, color: AppColors.brand_primary),
            ),
            const SizedBox(width: 12),
            Expanded(child: Text(title, style: const TextStyle(fontWeight: FontWeight.w900))),
            const Icon(Icons.chevron_right),
          ],
        ),
      ),
    );
  }
}

class _ErrorView extends StatelessWidget {
  final String message;

  const _ErrorView({required this.message});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24),
        child: Text(message, textAlign: TextAlign.center),
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\spending_breakdown_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../domain/models/spending.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import 'account_providers.dart';

class SpendingBreakdownScreen extends ConsumerWidget {
  const SpendingBreakdownScreen({super.key});

  String _format_currency(num amount) {
    final int value = amount.round();
    final String s = value.toString();
    final StringBuffer b = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final int from_end = s.length - i;
      b.write(s[i]);
      if (from_end > 1 && from_end % 3 == 1) b.write(',');
    }
    return 'â‚©${b.toString()}';
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);

    final DateTime month = ref.watch(selected_month_provider);
    final summary_async = ref.watch(month_summary_provider);
    final categories_async = ref.watch(category_breakdown_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ì§€ì¶œ ë¶„ì„', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  SectionCard(
                    child: Column(
                      children: <Widget>[
                        Row(
                          children: <Widget>[
                            IconButton(
                              onPressed: () {
                                final DateTime prev = DateTime(month.year, month.month - 1, 1);
                                ref.read(selected_month_provider.notifier).state = prev;
                              },
                              icon: const Icon(Icons.chevron_left),
                            ),
                            Expanded(
                              child: Text(
                                '${month.year}ë…„ ${month.month}ì›”',
                                textAlign: TextAlign.center,
                                style: const TextStyle(fontWeight: FontWeight.w900),
                              ),
                            ),
                            IconButton(
                              onPressed: () {
                                final DateTime next = DateTime(month.year, month.month + 1, 1);
                                ref.read(selected_month_provider.notifier).state = next;
                              },
                              icon: const Icon(Icons.chevron_right),
                            ),
                          ],
                        ),
                        const SizedBox(height: 10),
                        summary_async.when(
                          loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                          error: (e, _) => Text('ìš”ì•½ ì˜¤ë¥˜: $e'),
                          data: (s) => Column(
                            children: <Widget>[
                              Text('ì´ ì§€ì¶œ', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                              const SizedBox(height: 6),
                              Text(_format_currency(s.total_amount), style: const TextStyle(fontSize: 26, fontWeight: FontWeight.w900)),
                            ],
                          ),
                        ),
                        const SizedBox(height: 14),
                        categories_async.when(
                          loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                          error: (e, _) => Text('ì¹´í…Œê³ ë¦¬ ì˜¤ë¥˜: $e'),
                          data: (categories) {
                            if (categories.isEmpty) {
                              return Text('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ì–´ìš”.', style: TextStyle(color: AppColors.text_secondary));
                            }

                            final CategorySpend top = categories.reduce((a, b) => a.amount >= b.amount ? a : b);
                            final int top_percent = (top.ratio * 100).round();

                            return Column(
                              children: <Widget>[
                                _DonutPlaceholder(
                                  center_label: '$top_percent%\n${top.category_label}',
                                ),
                                const SizedBox(height: 10),
                                Container(
                                  padding: const EdgeInsets.all(12),
                                  decoration: BoxDecoration(
                                    color: AppColors.border.withOpacity(0.25),
                                    borderRadius: BorderRadius.circular(16),
                                  ),
                                  child: Row(
                                    children: <Widget>[
                                      const Icon(Icons.info_outline, color: AppColors.brand_primary),
                                      const SizedBox(width: 10),
                                      Expanded(
                                        child: Text(
                                          'ì´ë²ˆ ë‹¬ ì§€ì¶œì˜ ëŒ€ë¶€ë¶„ì€ "${top.category_label}" í•­ëª©ì´ì—ìš”.',
                                          style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ],
                            );
                          },
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 14),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: <Widget>[
                      const Text('ì¹´í…Œê³ ë¦¬ ìƒì„¸', style: TextStyle(fontWeight: FontWeight.w900)),
                      TextButton.icon(
                        onPressed: () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text('ì •ë ¬ ê¸°ì¤€ì„ ë³€ê²½í•©ë‹ˆë‹¤.')),
                          );
                        },
                        icon: const Icon(Icons.sort, size: 18),
                        label: const Text('ê¸ˆì•¡ìˆœ'),
                      ),
                    ],
                  ),
                  const SizedBox(height: 8),
                  categories_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ì˜¤ë¥˜: $e'),
                    data: (categories) {
                      return SectionCard(
                        child: Column(
                          children: categories.map((c) {
                            final int percent = (c.ratio * 100).round();
                            return Padding(
                              padding: const EdgeInsets.symmetric(vertical: 10),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Row(
                                    children: <Widget>[
                                      Expanded(child: Text(c.category_label, style: const TextStyle(fontWeight: FontWeight.w900))),
                                      Text(_format_currency(c.amount), style: const TextStyle(fontWeight: FontWeight.w900)),
                                      const SizedBox(width: 10),
                                      Text('$percent%', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                                    ],
                                  ),
                                  const SizedBox(height: 8),
                                  Stack(
                                    children: <Widget>[
                                      Container(
                                        height: 10,
                                        decoration: BoxDecoration(
                                          color: AppColors.border.withOpacity(0.35),
                                          borderRadius: BorderRadius.circular(999),
                                        ),
                                      ),
                                      FractionallySizedBox(
                                        widthFactor: c.ratio.clamp(0, 1),
                                        child: Container(
                                          height: 10,
                                          decoration: BoxDecoration(
                                            color: AppColors.brand_primary.withOpacity(0.7),
                                            borderRadius: BorderRadius.circular(999),
                                          ),
                                        ),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            );
                          }).toList(),
                        ),
                      );
                    },
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _DonutPlaceholder extends StatelessWidget {
  final String center_label;

  const _DonutPlaceholder({required this.center_label});

  @override
  Widget build(BuildContext context) {
    return Container(
      width: 180,
      height: 180,
      decoration: BoxDecoration(
        shape: BoxShape.circle,
        color: AppColors.brand_primary.withOpacity(0.10),
        border: Border.all(color: AppColors.border),
      ),
      alignment: Alignment.center,
      child: Text(
        center_label,
        textAlign: TextAlign.center,
        style: const TextStyle(fontWeight: FontWeight.w900),
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\spending_overview_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:countup/countup.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/bottom_nav.dart';
import '../../../domain/models/spending.dart';
import 'account_providers.dart';

class SpendingOverviewScreen extends StatefulWidget {
  const SpendingOverviewScreen({super.key});

  @override
  State<SpendingOverviewScreen> createState() => _SpendingOverviewScreenState();
}

class _SpendingOverviewScreenState extends State<SpendingOverviewScreen> {
  BottomTab current_tab = BottomTab.account_book;

  String _format_currency(num amount) {
    final int value = amount.round();
    final String s = value.toString();
    final StringBuffer b = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final int from_end = s.length - i;
      b.write(s[i]);
      if (from_end > 1 && from_end % 3 == 1) b.write(',');
    }
    return 'â‚©${b.toString()}';
  }

  @override
  Widget build(BuildContext context) {
    return Consumer(
      builder: (context, ref, child) {
        final double max_w = Responsive.max_width(context);

        final DateTime month = ref.watch(selected_month_provider);
        final summary_async = ref.watch(month_summary_provider);
        final days_async = ref.watch(month_days_provider);
        final tx_async = ref.watch(recent_transactions_provider);

        return Scaffold(
          appBar: AppBar(
            title: const Text('ì§€ì¶œ ê°œìš”', style: TextStyle(fontWeight: FontWeight.w900)),
          ),
          body: SafeArea(
            child: Center(
              child: ConstrainedBox(
                constraints: BoxConstraints(maxWidth: max_w),
                child: SingleChildScrollView(
                  padding: Responsive.page_padding(context),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: <Widget>[
                      SectionCard(
                        child: Column(
                          children: <Widget>[
                            _MonthHeader(
                              month: month,
                              on_prev: () {
                                final DateTime prev =
                                    DateTime(month.year, month.month - 1, 1);
                                ref.read(selected_month_provider.notifier).state =
                                    prev;
                              },
                              on_next: () {
                                final DateTime next =
                                    DateTime(month.year, month.month + 1, 1);
                                ref.read(selected_month_provider.notifier).state =
                                    next;
                              },
                            ),
                            const SizedBox(height: 12),
                            summary_async.when(
                              loading: () => const Padding(
                                  padding: EdgeInsets.all(24),
                                  child: CircularProgressIndicator()),
                              error: (e, _) => Text('ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                              data: (summary) {
                                final String diff_label = summary.diff_percent == 0
                                    ? 'ì§€ë‚œë‹¬ê³¼ ë™ì¼'
                                    : summary.diff_percent > 0
                                    ? 'ì§€ë‚œë‹¬ ëŒ€ë¹„ ${summary.diff_percent}% ì¦ê°€'
                                    : 'ì§€ë‚œë‹¬ ëŒ€ë¹„ ${summary.diff_percent.abs()}% ê°ì†Œ';

                                return Column(
                                  children: <Widget>[
                                    Text('ì´ ì§€ì¶œ',
                                        style: TextStyle(
                                            color: AppColors.text_secondary,
                                            fontWeight: FontWeight.w900)),
                                    const SizedBox(height: 6),
                                    Row(
                                      mainAxisAlignment: MainAxisAlignment.center,
                                      children: [
                                        const Text('â‚©', style: TextStyle(fontSize: 28, fontWeight: FontWeight.w900)),
                                        Countup(
                                          begin: 0,
                                          end: summary.total_amount.toDouble(),
                                          duration: const Duration(milliseconds: 1500),
                                          separator: ',',
                                          style: const TextStyle(
                                            fontSize: 28,
                                            fontWeight: FontWeight.w900,
                                          ),
                                        ),
                                      ],
                                    ),
                                    const SizedBox(height: 8),
                                    Container(
                                      padding: const EdgeInsets.symmetric(
                                          horizontal: 10, vertical: 6),
                                      decoration: BoxDecoration(
                                        color: AppColors.brand_primary
                                            .withOpacity(0.12),
                                        borderRadius: BorderRadius.circular(999),
                                      ),
                                      child: Text(diff_label,
                                          style: const TextStyle(
                                              fontWeight: FontWeight.w900,
                                              color: AppColors.brand_primary)),
                                    ),
                                  ],
                                );
                              },
                            ),
                            const SizedBox(height: 14),
                            days_async.when(
                              loading: () => const Padding(
                                  padding: EdgeInsets.all(12),
                                  child: CircularProgressIndicator()),
                              error: (e, _) => Text('ë‹¬ë ¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                              data: (days) =>
                                  _SpendingCalendar(month: month, days: days),
                            ),
                          ],
                        ),
                      ),
                      const SizedBox(height: 14),
                                        Row(
                                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                          children: <Widget>[
                                            const Text('ìµœê·¼ ì§€ì¶œ',
                                                style: TextStyle(
                                                    fontSize: 16, fontWeight: FontWeight.w900)),
                                            TextButton(
                                              onPressed: () => context.push(AppRoutes.payment_history),
                                              child: const Text('ì „ì²´ ë³´ê¸°'),
                                            ),
                                          ],
                                        ),
                                        const SizedBox(height: 8),
                                        tx_async.when(
                                          loading: () => const Padding(
                                              padding: EdgeInsets.all(20),
                                              child: CircularProgressIndicator()),
                                          error: (e, _) => Text('ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                                          data: (list) {
                                            if (list.isEmpty) {
                                              return SectionCard(
                                                child: Text('í‘œì‹œí•  ë‚´ì—­ì´ ì—†ì–´ìš”.',
                                                    style: TextStyle(color: AppColors.text_secondary)),
                                              );
                                            }
                                            return SectionCard(
                                              padding: EdgeInsets.zero,
                                              child: Column(
                                                children: list.map<Widget>((tx) {
                                                  final String amount_label =
                                                      '- ${_format_currency(tx.amount)}';
                                                  final String date_label =
                                                      '${tx.spent_at.month}ì›” ${tx.spent_at.day}ì¼';
                                                  return InkWell(
                                                    onTap: () => context.push(AppRoutes.digital_receipt, extra: {'receipt_id': tx.transaction_id}),
                                                    borderRadius: BorderRadius.circular(16),
                                                    child: Padding(
                                                      padding:
                                                      const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                                                      child: Row(
                                                        children: <Widget>[
                                                          Container(
                                                            width: 40,
                                                            height: 40,
                                                            decoration: BoxDecoration(
                                                              color:
                                                              AppColors.border.withOpacity(0.35),
                                                              borderRadius: BorderRadius.circular(14),
                                                            ),
                                                            child: const Icon(
                                                                Icons.shopping_cart_outlined,
                                                                color: AppColors.brand_primary),
                                                          ),
                                                          const SizedBox(width: 12),
                                                          Expanded(
                                                            child: Column(
                                                              crossAxisAlignment:
                                                              CrossAxisAlignment.start,
                                                              children: <Widget>[
                                                                Text(tx.merchant_name,
                                                                    style: const TextStyle(
                                                                        fontWeight: FontWeight.w900)),
                                                                const SizedBox(height: 4),
                                                                Text('$date_label Â· ${tx.category_label}',
                                                                    style: TextStyle(
                                                                        color: AppColors.text_secondary,
                                                                        fontSize: 12)),
                                                              ],
                                                            ),
                                                          ),
                                                          Row(
                                                            mainAxisSize: MainAxisSize.min,
                                                            children: [
                                                              const Text('- â‚©', style: TextStyle(fontWeight: FontWeight.w900)),
                                                              Countup(
                                                                begin: 0,
                                                                end: tx.amount.toDouble(),
                                                                duration: const Duration(milliseconds: 1000),
                                                                separator: ',',
                                                                style: const TextStyle(
                                                                  fontWeight: FontWeight.w900,
                                                                ),
                                                              ),
                                                            ],
                                                          ),
                                                        ],
                                                      ),
                                                    ),
                                                  );
                                                }).toList(),
                                              ),
                                            );
                                          },
                                        ),
                      
                      const SizedBox(height: 80),
                    ],
                  ),
                ),
              ),
            ),
          ),
          bottomNavigationBar: BottomNav(
            current_tab: current_tab,
            on_tab_selected: (BottomTab next) {
              setState(() => current_tab = next);
              if (next == BottomTab.home) context.go(AppRoutes.home);
              if (next == BottomTab.search) context.go(AppRoutes.product_search);
              if (next == BottomTab.scan) context.push(AppRoutes.qr_scanner);
              if (next == BottomTab.account_book) context.go(AppRoutes.spending_overview);
              if (next == BottomTab.my_page) context.go(AppRoutes.my_page);
            },
          ),
        );
      },
    );
  }
}

class _MonthHeader extends StatelessWidget {
  final DateTime month;
  final VoidCallback on_prev;
  final VoidCallback on_next;

  const _MonthHeader({
    required this.month,
    required this.on_prev,
    required this.on_next,
  });

  @override
  Widget build(BuildContext context) {
    final String label = '${month.year}ë…„ ${month.month}ì›”';
    return Row(
      children: <Widget>[
        IconButton(onPressed: on_prev, icon: const Icon(Icons.chevron_left)),
        Expanded(
          child: Text(label,
              textAlign: TextAlign.center,
              style:
              const TextStyle(fontSize: 16, fontWeight: FontWeight.w900)),
        ),
        IconButton(onPressed: on_next, icon: const Icon(Icons.chevron_right)),
      ],
    );
  }
}

class _SpendingCalendar extends StatelessWidget {
  final DateTime month;
  final List<SpendingDay> days;

  const _SpendingCalendar({
    required this.month,
    required this.days,
  });

  int _days_in_month(DateTime m) {
    final DateTime next = DateTime(m.year, m.month + 1, 1);
    return next.subtract(const Duration(days: 1)).day;
  }

  int _weekday_offset(DateTime m) {
    final int w = DateTime(m.year, m.month, 1).weekday;
    return (w - 1);
  }

  @override
  Widget build(BuildContext context) {
    final int total_days = _days_in_month(month);
    final int offset = _weekday_offset(month);

    final Map<int, int> amount_by_day = <int, int>{};
    for (final SpendingDay d in days) {
      amount_by_day[d.date.day] = d.amount;
    }

    final List<Widget> cells = <Widget>[];
    const List<String> week_labels = <String>['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];

    cells.addAll(week_labels.map((w) {
      return Center(
        child: Text(w,
            style: TextStyle(
                color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
      );
    }));

    for (int i = 0; i < offset; i++) {
      cells.add(const SizedBox.shrink());
    }

    for (int day = 1; day <= total_days; day++) {
      final int amount = amount_by_day[day] ?? 0;
      final bool has_spend = amount > 0;

      cells.add(
        Container(
          decoration: BoxDecoration(
            color:
            has_spend ? AppColors.brand_primary.withOpacity(0.12) : Colors.transparent,
            borderRadius: BorderRadius.circular(14),
          ),
          padding: const EdgeInsets.symmetric(vertical: 8),
          child: Column(
            children: <Widget>[
              Text('$day',
                  style: TextStyle(
                      fontWeight: FontWeight.w900,
                      color: has_spend
                          ? AppColors.brand_primary
                          : AppColors.text_primary)),
              const SizedBox(height: 4),
              Text(
                has_spend ? '-${_short_k(amount)}' : '',
                style: TextStyle(
                    fontSize: 11,
                    color: AppColors.text_secondary,
                    fontWeight: FontWeight.w800),
              ),
            ],
          ),
        ),
      );
    }

    return LayoutBuilder(
      builder: (BuildContext context, BoxConstraints c) {
        final double spacing = 8;
        final double cell_w = (c.maxWidth - spacing * 6) / 7;
        final double cell_h = 46;

        return Wrap(
          spacing: spacing,
          runSpacing: spacing,
          children: cells.map((w) {
            return SizedBox(width: cell_w, height: cell_h, child: w);
          }).toList(),
        );
      },
    );
  }

  String _short_k(int amount) {
    if (amount >= 10000) return '${(amount / 10000).toStringAsFixed(0)}ë§Œ';
    if (amount >= 1000) return '${(amount / 1000).toStringAsFixed(0)}ì²œ';
    return '$amount';
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\presentation\top_items_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/section_card.dart';
import 'account_providers.dart';

class TopItemsScreen extends ConsumerWidget {
  const TopItemsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);
    final DateTime month = ref.watch(selected_month_provider);
    final top_async = ref.watch(top_items_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ìì£¼ ì‚° ìƒí’ˆ'),
        actions: <Widget>[
          IconButton(
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('í•„í„° ì„¤ì • ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
              );
            },
            icon: const Icon(Icons.tune),
          ),
        ],
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  SectionCard(
                    child: Row(
                      children: <Widget>[
                        IconButton(
                          onPressed: () {
                            final DateTime prev = DateTime(month.year, month.month - 1, 1);
                            ref.read(selected_month_provider.notifier).state = prev;
                          },
                          icon: const Icon(Icons.chevron_left),
                        ),
                        Expanded(
                          child: Column(
                            children: <Widget>[
                              Text('${month.year}ë…„ ${month.month}ì›”', style: const TextStyle(fontWeight: FontWeight.w900)),
                              const SizedBox(height: 4),
                              Text('ì›”ê°„ ê¸°ì¤€', style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                            ],
                          ),
                        ),
                        IconButton(
                          onPressed: () {
                            final DateTime next = DateTime(month.year, month.month + 1, 1);
                            ref.read(selected_month_provider.notifier).state = next;
                          },
                          icon: const Icon(Icons.chevron_right),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),
                  top_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(32), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (items) {
                      if (items.isEmpty) {
                        return SectionCard(
                          child: Text('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ì–´ìš”.', style: TextStyle(color: AppColors.text_secondary)),
                        );
                      }

                      final List<TopItemBar> bars = items.take(5).map((it) {
                        return TopItemBar(label: it.name, value: it.purchase_count);
                      }).toList();

                      return Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: <Widget>[
                          SectionCard(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: <Widget>[
                                Row(
                                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                                  children: <Widget>[
                                    const Text('ë¹ˆë„ ë¶„ì„', style: TextStyle(fontWeight: FontWeight.w900)),
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                      decoration: BoxDecoration(
                                        color: AppColors.brand_primary.withOpacity(0.12),
                                        borderRadius: BorderRadius.circular(999),
                                      ),
                                      child: const Text('ì›”ê°„', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                    ),
                                  ],
                                ),
                                const SizedBox(height: 12),
                                _MiniBarChart(items: bars),
                              ],
                            ),
                          ),
                          const SizedBox(height: 12),
                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: <Widget>[
                              const Text('ê°€ì¥ ë§ì´ êµ¬ë§¤', style: TextStyle(fontWeight: FontWeight.w900)),
                              TextButton.icon(
                                onPressed: () {
                                  ScaffoldMessenger.of(context).showSnackBar(
                                    const SnackBar(content: Text('ì •ë ¬ ìˆœì„œë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.')),
                                  );
                                },
                                icon: const Icon(Icons.sort, size: 18),
                                label: const Text('êµ¬ë§¤ íšŸìˆ˜ìˆœ'),
                              ),
                            ],
                          ),
                          const SizedBox(height: 8),
                          SectionCard(
                            child: Column(
                              children: items.asMap().entries.map((entry) {
                                final int idx = entry.key + 1;
                                final item = entry.value;
                                return Padding(
                                  padding: const EdgeInsets.symmetric(vertical: 10),
                                  child: Row(
                                    children: <Widget>[
                                      Container(
                                        width: 28,
                                        height: 28,
                                        decoration: BoxDecoration(
                                          color: idx == 1 ? AppColors.brand_primary : AppColors.border.withOpacity(0.35),
                                          borderRadius: BorderRadius.circular(999),
                                        ),
                                        alignment: Alignment.center,
                                        child: Text(
                                          '$idx',
                                          style: TextStyle(
                                            color: idx == 1 ? Colors.white : AppColors.text_secondary,
                                            fontWeight: FontWeight.w900,
                                          ),
                                        ),
                                      ),
                                      const SizedBox(width: 12),
                                      Container(
                                        width: 40,
                                        height: 40,
                                        decoration: BoxDecoration(
                                          color: AppColors.border.withOpacity(0.35),
                                          borderRadius: BorderRadius.circular(14),
                                        ),
                                        child: const Icon(Icons.shopping_basket_outlined, color: AppColors.brand_primary),
                                      ),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: <Widget>[
                                            Text(item.name, style: const TextStyle(fontWeight: FontWeight.w900)),
                                            const SizedBox(height: 4),
                                            Text(
                                              '${item.category_label} Â· í‰ê·  â‚©${item.avg_price}',
                                              style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800),
                                            ),
                                          ],
                                        ),
                                      ),
                                      Text('${item.purchase_count}íšŒ', style: const TextStyle(fontWeight: FontWeight.w900, color: AppColors.brand_primary)),
                                    ],
                                  ),
                                );
                              }).toList(),
                            ),
                          ),
                        ],
                      );
                    },
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class TopItemBar {
  final String label;
  final int value;

  const TopItemBar({required this.label, required this.value});
}

class _MiniBarChart extends StatelessWidget {
  final List<TopItemBar> items;

  const _MiniBarChart({required this.items});

  @override
  Widget build(BuildContext context) {
    final int max_v = items.map((e) => e.value).fold<int>(0, (p, c) => c > p ? c : p);

    return Column(
      children: items.map((e) {
        final double ratio = max_v == 0 ? 0 : (e.value / max_v);
        return Padding(
          padding: const EdgeInsets.symmetric(vertical: 6),
          child: Row(
            children: <Widget>[
              SizedBox(
                width: 72,
                child: Text(e.label, maxLines: 1, overflow: TextOverflow.ellipsis, style: const TextStyle(fontWeight: FontWeight.w900)),
              ),
              const SizedBox(width: 10),
              Expanded(
                child: Stack(
                  children: <Widget>[
                    Container(height: 10, decoration: BoxDecoration(color: AppColors.border.withOpacity(0.35), borderRadius: BorderRadius.circular(999))),
                    FractionallySizedBox(
                      widthFactor: ratio,
                      child: Container(height: 10, decoration: BoxDecoration(color: AppColors.brand_primary.withOpacity(0.7), borderRadius: BorderRadius.circular(999))),
                    ),
                  ],
                ),
              ),
              const SizedBox(width: 10),
              Text('${e.value}', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
            ],
          ),
        );
      }).toList(),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\repository\account_repository.dart
==================================================
import '../../../domain/models/user_profile.dart';
import '../../../domain/models/spending.dart';

abstract class AccountRepository {
  Future<UserProfile> fetch_my_profile();
  Future<void> update_nickname({required String new_nickname});

  Future<SpendingSummary> fetch_month_summary({required DateTime month});
  Future<List<SpendingDay>> fetch_month_days({required DateTime month});
  Future<List<SpendingTransaction>> fetch_recent_transactions({required DateTime month});

  Future<List<TopItem>> fetch_top_items({required DateTime month});
  Future<List<CategorySpend>> fetch_category_breakdown({required DateTime month});

  Future<void> change_password({
    required String current_password,
    required String new_password,
  });
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\account\repository\http_account_repository.dart
==================================================
import 'package:dio/dio.dart';
import '../../../domain/models/user_profile.dart';
import '../../../domain/models/spending.dart';
import 'account_repository.dart';

class HttpAccountRepository implements AccountRepository {
  final Dio _dio;

  HttpAccountRepository({required Dio dio}) : _dio = dio;

  @override
  Future<UserProfile> fetch_my_profile() async {
    try {
      final response = await _dio.get('/api/users/me');
      final data = response.data;
      return UserProfile(
        user_id: data['user_id'].toString(),
        nickname: data['nickname'],
        email: data['email'],
        is_premium: data['is_premium'] ?? false,
      );
    } catch (e) {
      throw Exception('Failed to load user profile: $e');
    }
  }

  @override
  Future<void> update_nickname({required String new_nickname}) async {
    try {
      await _dio.put('/api/users/me', data: {'nickname': new_nickname});
    } catch (e) {
      throw Exception('Failed to update nickname: $e');
    }
  }

  @override
  Future<void> change_password({required String current_password, required String new_password}) async {
    try {
      await _dio.put('/api/users/me/password', data: {
        'current_password': current_password,
        'new_password': new_password,
      });
    } catch (e) {
      throw Exception('Failed to change password: $e');
    }
  }

  @override
  Future<SpendingSummary> fetch_month_summary({required DateTime month}) async {
    try {
      final response = await _dio.get('/api/ledger/summary/monthly', queryParameters: {
        'year': month.year,
        'month': month.month,
      });

      final data = response.data;
      // ë°±ì—”ë“œì—ì„œ diff_percentë¥¼ ì£¼ì§€ ì•Šìœ¼ë©´ 0ìœ¼ë¡œ ì²˜ë¦¬ (API ë³´ì™„ í•„ìš” ê°€ëŠ¥ì„± ìˆìŒ)
      return SpendingSummary(
        total_amount: data['total_amount'] ?? 0,
        diff_percent: 0, 
        month_label: '${month.month}ì›”',
      );
    } catch (e) {
      print('fetch_month_summary error: $e');
      return SpendingSummary(total_amount: 0, diff_percent: 0, month_label: '${month.month}ì›”');
    }
  }

  @override
  Future<List<SpendingDay>> fetch_month_days({required DateTime month}) async {
    try {
      final response = await _dio.get('/api/ledger/calendar', queryParameters: {
        'year': month.year,
        'month': month.month,
      });

      final Map<String, dynamic> dailyTotal = response.data['daily_total'] ?? {};
      final List<SpendingDay> days = [];

      dailyTotal.forEach((key, value) {
        // key format: "2024-05-01"
        final date = DateTime.parse(key);
        days.add(SpendingDay(date: date, amount: value as int));
      });

      return days;
    } catch (e) {
      print('fetch_month_days error: $e');
      return [];
    }
  }

  @override
  Future<List<SpendingTransaction>> fetch_recent_transactions({required DateTime month}) async {
    // ë°±ì—”ë“œì˜ /recent APIëŠ” month í•„í„°ê°€ ì—†ê³  ìµœê·¼ Nê°œë§Œ ê°€ì ¸ì˜´.
    // ì—¬ê¸°ì„œëŠ” í™”ë©´ ìš”êµ¬ì‚¬í•­ì— ë§ì¶° /recentë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜, /ledger (ëª©ë¡ ì¡°íšŒ)ë¥¼ í˜¸ì¶œí•´ì•¼ í•¨.
    // ì¼ë‹¨ /recent API í™œìš©
    try {
      final response = await _dio.get('/api/ledger/recent', queryParameters: {'limit': 10});
      final List<dynamic> items = response.data['items'] ?? [];

      return items.map((item) {
        return SpendingTransaction(
          transaction_id: item['ledger_entry_id'].toString(),
          spent_at: DateTime.parse(item['spend_date']), // ë°±ì—”ë“œ spend_dateê°€ ë‚ ì§œí˜•ì‹ì´ë©´ ì‹œê°„ì€ 00:00ì¼ìˆ˜ ìˆìŒ
          merchant_name: item['memo'] ?? 'ì•Œ ìˆ˜ ì—†ìŒ', // ê°€ë§¹ì ëª…ì´ ì—†ìœ¼ë©´ ë©”ëª¨ ì‚¬ìš©
          category_label: item['category'] ?? 'ê¸°íƒ€',
          amount: item['amount'],
        );
      }).toList();
    } catch (e) {
      print('fetch_recent_transactions error: $e');
      return [];
    }
  }

  @override
  Future<List<TopItem>> fetch_top_items({required DateTime month}) async {
    try {
      final response = await _dio.get('/api/ledger/top-items', queryParameters: {
        'year': month.year,
        'month': month.month,
        'limit': 5,
      });

      final List<dynamic> items = response.data['items'] ?? [];
      
      return items.map((item) {
        return TopItem(
          product_id: '', // ë°±ì—”ë“œì—ì„œ product_idë¥¼ ì•ˆì£¼ë©´ ë¹ˆê°’
          name: item['item_name'],
          category_label: 'ì‹í’ˆ', // ì„ì‹œ
          purchase_count: item['count'],
          avg_price: (item['total_amount'] / item['count']).round(),
        );
      }).toList();
    } catch (e) {
      print('fetch_top_items error: $e');
      return [];
    }
  }

  @override
  Future<List<CategorySpend>> fetch_category_breakdown({required DateTime month}) async {
    try {
      final response = await _dio.get('/api/ledger/top-categories', queryParameters: {
        'year': month.year,
        'month': month.month,
        'limit': 10,
      });

      final List<dynamic> categories = response.data['categories'] ?? [];
      
      return categories.map((cat) {
        return CategorySpend(
          category_key: cat['category'],
          category_label: cat['category'], // í•œê¸€ ë³€í™˜ í•„ìš” ì‹œ ë§µí•‘ ì¶”ê°€
          amount: (cat['amount'] as num).toDouble(),
          ratio: (cat['ratio'] as num).toDouble() / 100.0, // ë°±ì—”ë“œëŠ” 0~100, í”„ë¡ íŠ¸ëŠ” 0~1
        );
      }).toList();
    } catch (e) {
      print('fetch_category_breakdown error: $e');
      return [];
    }
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\presentation\auth_providers.dart
==================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/network/dio_provider.dart';
import '../../../core/storage/token_storage.dart';
import '../../../domain/models/user.dart';
import '../repository/auth_repository.dart';
import '../repository/auth_repository_impl.dart';

// AuthRepository êµ¬í˜„ì²´ë¥¼ ì œê³µí•˜ëŠ” Provider
final authRepositoryProvider = Provider<AuthRepository>((ref) {
  final dioClient = ref.watch(dioClientProvider);
  final tokenStorage = ref.watch(tokenStorageProvider);
  return AuthRepositoryImpl(dioClient, tokenStorage);
});

// í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê´€ë¦¬í•˜ëŠ” StateProvider (ì˜ˆì‹œ)
final currentUserProvider = StateProvider<User?>((ref) => null);

// ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” Provider
final isAuthenticatedProvider = Provider<bool>((ref) {
  return ref.watch(currentUserProvider) != null;
});


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\presentation\login_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../../../core/router/app_routes.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/primary_button.dart';
import 'auth_providers.dart';

class LoginScreen extends ConsumerStatefulWidget {
  const LoginScreen({super.key});

  @override
  ConsumerState<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends ConsumerState<LoginScreen> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<Offset> _slide_animation;
  
  final _email_controller = TextEditingController();
  final _password_controller = TextEditingController();
  bool _is_loading = false;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    );
    _slide_animation = Tween<Offset>(
      begin: const Offset(0, 0.1),
      end: Offset.zero,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeOutCubic,
    ));
    _controller.forward();
  }

  @override
  void dispose() {
    _controller.dispose();
    _email_controller.dispose();
    _password_controller.dispose();
    super.dispose();
  }

  Future<void> _handle_login() async {
    final email = _email_controller.text.trim();
    final password = _password_controller.text.trim();

    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.')),
      );
      return;
    }

    setState(() {
      _is_loading = true;
    });

    try {
      final authRepo = ref.read(authRepositoryProvider);
      await authRepo.login(email: email, password: password);
      
      if (mounted) {
        context.go(AppRoutes.home);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.toString().replaceAll("Exception: ", "")}')),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _is_loading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 24.0),
          child: SlideTransition(
            position: _slide_animation,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: <Widget>[
                const SizedBox(height: 20),
                Text(
                  'ë°˜ê°€ì›Œìš”!\ní”¼í´ë¡œ ì‡¼í•‘ì„ ì‹œì‘í• ê¹Œìš”?',
                  style: TextStyle(
                    fontSize: 28,
                    fontWeight: FontWeight.w900,
                    color: AppColors.text_primary,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 48),
                TextField(
                  controller: _email_controller,
                  style: const TextStyle(color: Colors.black),
                  textInputAction: TextInputAction.next,
                  decoration: InputDecoration(
                    labelText: 'ì´ë©”ì¼',
                    labelStyle: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700),
                    hintText: 'example@pickle.com',
                    filled: true,
                    fillColor: Colors.grey[100],
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide.none,
                    ),
                    floatingLabelBehavior: FloatingLabelBehavior.never,
                  ),
                ),
                const SizedBox(height: 16),
                TextField(
                  controller: _password_controller,
                  obscureText: true,
                  style: const TextStyle(color: Colors.black),
                  textInputAction: TextInputAction.done,
                  onSubmitted: (_) => _handle_login(),
                  decoration: InputDecoration(
                    labelText: 'ë¹„ë°€ë²ˆí˜¸',
                    labelStyle: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700),
                    hintText: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”',
                    filled: true,
                    fillColor: Colors.grey[100],
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide.none,
                    ),
                    floatingLabelBehavior: FloatingLabelBehavior.never,
                  ),
                ),
                const SizedBox(height: 32),
                PrimaryButton(
                  label: _is_loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸',
                  on_pressed: _is_loading ? () {} : _handle_login,
                ),
                const SizedBox(height: 24),
                Row(
                  children: [
                    const Expanded(child: Divider()),
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 16),
                      child: Text(
                        'ë˜ëŠ”',
                        style: TextStyle(
                          color: AppColors.text_secondary.withOpacity(0.5),
                          fontSize: 14,
                          fontWeight: FontWeight.w600,
                        ),
                      ),
                    ),
                    const Expanded(child: Divider()),
                  ],
                ),
                const SizedBox(height: 24),
                _SocialLoginButton(
                  label: 'ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°',
                  onPressed: () {
                    // TODO: ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì—°ë™
                  },
                  backgroundColor: const Color(0xFFFEE500),
                  textColor: Colors.black.withOpacity(0.85),
                  icon: const Icon(Icons.chat_bubble, color: Colors.black, size: 18),
                ),
                const SizedBox(height: 12),
                _SocialLoginButton(
                  label: 'Googleë¡œ ì‹œì‘í•˜ê¸°',
                  onPressed: () {
                    // TODO: êµ¬ê¸€ ë¡œê·¸ì¸ ì—°ë™
                  },
                  backgroundColor: Colors.white,
                  textColor: Colors.black.withOpacity(0.54),
                  icon: Image.network(
                    'https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png',
                    width: 20,
                    height: 20,
                    errorBuilder: (context, error, stackTrace) => const Text(
                      'G',
                      style: TextStyle(
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                        color: Colors.blue,
                      ),
                    ),
                  ),
                  border: Border.all(color: Colors.grey.shade300),
                ),
                const SizedBox(height: 24),
                Center(
                  child: TextButton(
                    onPressed: () {
                      _email_controller.clear();
                      _password_controller.clear();
                      context.push(AppRoutes.signup);
                    },
                    child: Text(
                      'ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”? íšŒì›ê°€ì…',
                      style: TextStyle(
                        color: AppColors.text_secondary,
                        fontWeight: FontWeight.w700,
                        fontSize: 14,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 24),
                Center(
                  child: Text(
                    'ë¡œê·¸ì¸ì— ë¬¸ì œê°€ ìˆë‚˜ìš”?',
                    style: TextStyle(
                      color: AppColors.text_secondary.withOpacity(0.6),
                      fontWeight: FontWeight.w600,
                      fontSize: 12,
                      decoration: TextDecoration.underline,
                    ),
                  ),
                ),
                const SizedBox(height: 20),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _SocialLoginButton extends StatelessWidget {
  final String label;
  final VoidCallback onPressed;
  final Color backgroundColor;
  final Color textColor;
  final Widget icon;
  final BoxBorder? border;

  const _SocialLoginButton({
    required this.label,
    required this.onPressed,
    required this.backgroundColor,
    required this.textColor,
    required this.icon,
    this.border,
  });

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      width: double.infinity,
      height: 56,
      child: OutlinedButton(
        onPressed: onPressed,
        style: OutlinedButton.styleFrom(
          backgroundColor: backgroundColor,
          side: border != null && border is Border 
              ? BorderSide(color: (border as Border).top.color) 
              : BorderSide.none,
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(16),
          ),
          elevation: 0,
        ),
        child: Stack(
          children: [
            Align(
              alignment: Alignment.centerLeft,
              child: Padding(
                padding: const EdgeInsets.only(left: 8.0),
                child: icon,
              ),
            ),
            Center(
              child: Text(
                label,
                style: TextStyle(
                  color: textColor,
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\presentation\signup_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../../../core/router/app_routes.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/primary_button.dart';
import 'auth_providers.dart';

class SignupScreen extends ConsumerStatefulWidget {
  const SignupScreen({super.key});

  @override
  ConsumerState<SignupScreen> createState() => _SignupScreenState();
}

class _SignupScreenState extends ConsumerState<SignupScreen> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<Offset> _slide_animation;

  final _nickname_controller = TextEditingController();
  final _email_controller = TextEditingController();
  final _password_controller = TextEditingController();
  bool _is_loading = false;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 800),
    );
    _slide_animation = Tween<Offset>(
      begin: const Offset(0, 0.1),
      end: Offset.zero,
    ).animate(CurvedAnimation(
      parent: _controller,
      curve: Curves.easeOutCubic,
    ));
    _controller.forward();
  }

  @override
  void dispose() {
    _controller.dispose();
    _nickname_controller.dispose();
    _email_controller.dispose();
    _password_controller.dispose();
    super.dispose();
  }

  Future<void> _handle_signup() async {
    final nickname = _nickname_controller.text.trim();
    final email = _email_controller.text.trim();
    final password = _password_controller.text.trim();

    if (nickname.isEmpty || email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')),
      );
      return;
    }

    setState(() {
      _is_loading = true;
    });

    try {
      final authRepo = ref.read(authRepositoryProvider);
      await authRepo.signup(
        email: email,
        password: password,
        nickname: nickname,
      );
      
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'))
        );
        // íšŒì›ê°€ì… ì„±ê³µ ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        context.go(AppRoutes.login);
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('íšŒì›ê°€ì… ì‹¤íŒ¨: ${e.toString().replaceAll("Exception: ", "")}')),
        );
      }
    } finally {
      if (mounted) {
        setState(() {
          _is_loading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          onPressed: () {
            _nickname_controller.clear();
            _email_controller.clear();
            _password_controller.clear();
            context.pop();
          },
          icon: Icon(Icons.arrow_back, color: AppColors.text_primary),
        ),
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.symmetric(horizontal: 24.0),
          child: SlideTransition(
            position: _slide_animation,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: <Widget>[
                const SizedBox(height: 20),
                Text(
                  'í™˜ì˜í•©ë‹ˆë‹¤!\nê³„ì •ì„ ë§Œë“¤ì–´ë³¼ê¹Œìš”?',
                  style: TextStyle(
                    fontSize: 28,
                    fontWeight: FontWeight.w900,
                    color: AppColors.text_primary,
                    height: 1.4,
                  ),
                ),
                const SizedBox(height: 48),
                TextField(
                  controller: _nickname_controller,
                  style: const TextStyle(color: Colors.black),
                  textInputAction: TextInputAction.next,
                  decoration: InputDecoration(
                    labelText: 'ë‹‰ë„¤ì„',
                    labelStyle: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700),
                    hintText: 'ì‚¬ìš©í•˜ì‹¤ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”',
                    filled: true,
                    fillColor: Colors.grey[100],
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide.none,
                    ),
                    floatingLabelBehavior: FloatingLabelBehavior.never,
                  ),
                ),
                const SizedBox(height: 16),
                TextField(
                  controller: _email_controller,
                  style: const TextStyle(color: Colors.black),
                  textInputAction: TextInputAction.next,
                  decoration: InputDecoration(
                    labelText: 'ì´ë©”ì¼',
                    labelStyle: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700),
                    hintText: 'example@pickle.com',
                    filled: true,
                    fillColor: Colors.grey[100],
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide.none,
                    ),
                    floatingLabelBehavior: FloatingLabelBehavior.never,
                  ),
                ),
                const SizedBox(height: 16),
                TextField(
                  controller: _password_controller,
                  obscureText: true,
                  style: const TextStyle(color: Colors.black),
                  textInputAction: TextInputAction.done,
                  onSubmitted: (_) => _handle_signup(),
                  decoration: InputDecoration(
                    labelText: 'ë¹„ë°€ë²ˆí˜¸',
                    labelStyle: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700),
                    hintText: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”',
                    filled: true,
                    fillColor: Colors.grey[100],
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(16),
                      borderSide: BorderSide.none,
                    ),
                    floatingLabelBehavior: FloatingLabelBehavior.never,
                  ),
                ),
                const SizedBox(height: 32),
                PrimaryButton(
                  label: _is_loading ? 'ê°€ì… ì¤‘...' : 'íšŒì›ê°€ì… ì™„ë£Œ',
                  on_pressed: _is_loading ? () {} : () async {
                    await _handle_signup();
                    _nickname_controller.clear();
                    _email_controller.clear();
                    _password_controller.clear();
                  },
                ),
                const SizedBox(height: 16),
                Center(
                  child: TextButton(
                    onPressed: () {
                      _nickname_controller.clear();
                      _email_controller.clear();
                      _password_controller.clear();
                      context.pop();
                    },
                    child: Text(
                      'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸',
                      style: TextStyle(
                        color: AppColors.text_secondary,
                        fontWeight: FontWeight.w700,
                        fontSize: 14,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 40),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\presentation\splash_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/storage/token_storage.dart';
import '../../../core/network/dio_provider.dart';
import 'auth_providers.dart';

class SplashScreen extends ConsumerStatefulWidget {
  const SplashScreen({super.key});

  @override
  ConsumerState<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends ConsumerState<SplashScreen> with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _scale_animation;
  late Animation<double> _check_animation;
  late Animation<double> _fade_animation;

  @override
  void initState() {
    super.initState();
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(milliseconds: 2000),
    );

    _scale_animation = Tween<double>(begin: 0.5, end: 1.0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.0, 0.5, curve: Curves.easeOutBack),
      ),
    );

    _check_animation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.4, 0.8, curve: Curves.elasticOut),
      ),
    );

    _fade_animation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.6, 1.0, curve: Curves.easeIn),
      ),
    );

    _controller.forward();

    // Check auth status
    _checkAuthStatus();
  }

  Future<void> _checkAuthStatus() async {
    // ìµœì†Œ 2ì´ˆ ëŒ€ê¸° (ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ í™•ë³´)
    await Future.delayed(const Duration(milliseconds: 2000));

    if (!mounted) return;

    try {
      final tokenStorage = ref.read(tokenStorageProvider);
      final token = await tokenStorage.getToken();

      if (token != null) {
        // í† í°ì´ ìˆìœ¼ë©´ Dioì— ì„¤ì •í•˜ê³  ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
        ref.read(dioClientProvider).setAccessToken(token);
        
        try {
          // ìœ ì € ì •ë³´ ì¡°íšŒ ì„±ê³µ ì‹œ í™ˆìœ¼ë¡œ ì´ë™
          await ref.read(authRepositoryProvider).getUserMe();
          if (mounted) context.go(AppRoutes.home);
          return;
        } catch (e) {
          // í† í° ë§Œë£Œ ë˜ëŠ” ì—ëŸ¬ ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
          // (ì„ íƒ ì‚¬í•­: í† í° ì‚­ì œ)
          await tokenStorage.deleteToken();
        }
      }
      
      // í† í°ì´ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
      if (mounted) context.go(AppRoutes.login);
      
    } catch (e) {
      if (mounted) context.go(AppRoutes.login);
    }
  }

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.white,
      body: Stack(
        children: [
          Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                AnimatedBuilder(
                  animation: _controller,
                  builder: (context, child) {
                    return Transform.scale(
                      scale: _scale_animation.value,
                      child: Stack(
                        alignment: Alignment.center,
                        children: [
                          // Shopping Cart Body (increased size)
                          Icon(
                            Icons.shopping_cart_outlined,
                            size: 120,
                            color: AppColors.brand_primary,
                          ),
                          // Checkmark inside the cart (reduced size and adjusted position)
                          Transform.translate(
                            offset: const Offset(6, -18),
                            child: Transform.scale(
                              scale: _check_animation.value,
                              child: const Icon(
                                Icons.check,
                                size: 36,
                                color: AppColors.brand_primary,
                              ),
                            ),
                          ),
                        ],
                      ),
                    );
                  },
                ),
                const SizedBox(height: 24),
                FadeTransition(
                  opacity: _fade_animation,
                  child: Column(
                    children: [
                      Text(
                        'í”¼í´',
                        style: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w900,
                          color: AppColors.brand_primary,
                          letterSpacing: 2,
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'ë˜‘ë˜‘í•œ ì‡¼í•‘ì˜ ì‹œì‘',
                        style: TextStyle(
                          fontSize: 16,
                          fontWeight: FontWeight.w700,
                          color: AppColors.text_secondary,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          // Subtle Toss-like bottom text
          Positioned(
            bottom: 50,
            left: 0,
            right: 0,
            child: FadeTransition(
              opacity: _fade_animation,
              child: Center(
                child: Text(
                  'Pickle Corp.',
                  style: TextStyle(
                    fontSize: 12,
                    color: AppColors.text_secondary.withOpacity(0.5),
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\repository\auth_repository.dart
==================================================
import '../../../domain/models/user.dart';

abstract class AuthRepository {
  Future<User> login({required String email, required String password});
  Future<void> signup({required String email, required String password, required String nickname});
  Future<User> getUserMe();
  Future<void> logout();
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\repository\auth_repository_impl.dart
==================================================
import 'package:dio/dio.dart';
import '../../../domain/models/user.dart';
import '../../../../core/network/dio_client.dart';
import '../../../../core/storage/token_storage.dart';
import 'auth_repository.dart';

class AuthRepositoryImpl implements AuthRepository {
  final DioClient _dioClient;
  final TokenStorage _tokenStorage;

  AuthRepositoryImpl(this._dioClient, this._tokenStorage);

  @override
  Future<User> login({required String email, required String password}) async {
    try {
      // ë°±ì—”ë“œê°€ JSON í˜•ì‹ì„ ê¸°ëŒ€í•¨ (422 ì—ëŸ¬ í•´ê²°)
      final response = await _dioClient.dio.post(
        '/auth/login',
        data: {
          'email': email, 
          'password': password,
        },
        // Options ì œê±° -> ê¸°ë³¸ê°’ì´ JSON
      );

      final accessToken = response.data['access_token'];
      _dioClient.setAccessToken(accessToken);
      await _tokenStorage.saveToken(accessToken);

      // ë¡œê·¸ì¸ ì„±ê³µ í›„ ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      return await getUserMe();
    } on DioException catch (e) {
      if (e.response?.statusCode == 401) {
        throw Exception('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
      throw Exception('ë¡œê·¸ì¸ ì‹¤íŒ¨: ${e.message}');
    }
  }

  @override
  Future<void> signup({
    required String email,
    required String password,
    required String nickname,
  }) async {
    try {
      // íšŒì›ê°€ì…ì€ ë³´í†µ JSONìœ¼ë¡œ ë³´ëƒ„ (ê¸°ì¡´ ìœ ì§€)
      await _dioClient.dio.post(
        '/auth/signup', // URL ê²½ë¡œ ìˆ˜ì • (/api ì¶”ê°€)
        data: {
          'email': email,
          'password': password,
          'nickname': nickname,
        },
      );
      
      // íšŒì›ê°€ì… ì„±ê³µ í›„ ë°”ë¡œ ë¡œê·¸ì¸ ì‹œë„í•˜ë˜ ë¡œì§ ì œê±°
    } catch (e) {
      throw Exception('íšŒì›ê°€ì… ì‹¤íŒ¨: $e');
    }
  }

  @override
  Future<User> getUserMe() async {
    try {
      final response = await _dioClient.dio.get('/users/me'); // URL ê²½ë¡œ ìˆ˜ì •
      
      // User ëª¨ë¸ì˜ fromJsonì„ ì‚¬ìš©í•˜ì—¬ ê¹”ë”í•˜ê²Œ ë³€í™˜
      return User.fromJson(response.data);
    } catch (e) {
      throw Exception('ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: $e');
    }
  }

  @override
  Future<void> logout() async {
    try {
      // ë¡œê·¸ì•„ì›ƒì€ ë³´í†µ í”„ë¡ íŠ¸ì—ì„œ í† í°ë§Œ ì‚­ì œí•˜ë©´ ë¨ (ì„œë²„ í˜¸ì¶œ ì„ íƒ ì‚¬í•­)
      _dioClient.clearAccessToken();
      await _tokenStorage.deleteToken();
    } catch (e) {
      // ë¬´ì‹œ
    }
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\auth\repository\mock_auth_repository.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\presentation\cart_providers.dart
==================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/network/dio_provider.dart';
import '../repository/cart_repository.dart';
import '../repository/cart_repository_impl.dart';
import '../../../domain/models/cart.dart';

final cart_repository_provider = Provider<CartRepository>((ref) {
  final dioClient = ref.watch(dioClientProvider);
  return CartRepositoryImpl(dioClient);
});

final cart_summary_provider = FutureProvider<CartSummary>((ref) async {
  final CartRepository repo = ref.read(cart_repository_provider);
  return repo.fetch_cart_summary();
});

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\presentation\my_recipes_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../recipe/presentation/recipe_providers.dart';

class MyRecipesScreen extends ConsumerWidget {
  const MyRecipesScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);
    final String filter_key = ref.watch(recipe_filter_provider);
    final recipes_async = ref.watch(recipes_from_cart_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ì¶”ì²œ ë ˆì‹œí”¼', style: TextStyle(fontWeight: FontWeight.w900)),
        actions: <Widget>[
          IconButton(
            onPressed: () {
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('ë ˆì‹œí”¼ ê²€ìƒ‰ ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
              );
            },
            icon: const Icon(Icons.search),
          ),
        ],
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  Row(
                    children: <Widget>[
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                        decoration: BoxDecoration(
                          color: AppColors.brand_primary.withOpacity(0.12),
                          borderRadius: BorderRadius.circular(999),
                        ),
                        child: const Text('ì¹´íŠ¸ ì—°ë™ë¨', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                      ),
                      const SizedBox(width: 10),
                      Text('í”¼í´ ìŠ¤ë§ˆíŠ¸ì¹´íŠ¸ #042', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                    ],
                  ),
                  const SizedBox(height: 12),
                  Wrap(
                    spacing: 8,
                    children: <Widget>[
                      _filter_chip(
                        label: 'ìƒìœ„ ë§¤ì¹­',
                        is_selected: filter_key == 'top_matches',
                        on_tap: () => ref.read(recipe_filter_provider.notifier).state = 'top_matches',
                      ),
                      _filter_chip(
                        label: '15ë¶„ ì´í•˜',
                        is_selected: filter_key == 'under_15',
                        on_tap: () => ref.read(recipe_filter_provider.notifier).state = 'under_15',
                      ),
                      _filter_chip(
                        label: 'ì±„ì‹',
                        is_selected: filter_key == 'vegetarian',
                        on_tap: () => ref.read(recipe_filter_provider.notifier).state = 'vegetarian',
                      ),
                    ],
                  ),
                  const SizedBox(height: 14),

                  Text('í˜„ì¬ ì„ íƒë¨', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                  const SizedBox(height: 8),

                  recipes_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (list) {
                      if (list.isEmpty) {
                        return SectionCard(child: Text('í‘œì‹œí•  ë ˆì‹œí”¼ê°€ ì—†ì–´ìš”.', style: TextStyle(color: AppColors.text_secondary)));
                      }
                      final selected = list.first;

                      return Column(
                        children: <Widget>[
                          SectionCard(
                            child: Row(
                              children: <Widget>[
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: <Widget>[
                                      Row(
                                        children: <Widget>[
                                          Container(
                                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                            decoration: BoxDecoration(
                                              color: AppColors.brand_primary.withOpacity(0.12),
                                              borderRadius: BorderRadius.circular(999),
                                            ),
                                            child: const Text('ì§„í–‰ ì¤‘', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                          ),
                                          const SizedBox(width: 8),
                                          Text('${selected.match_percent}% ë§¤ì¹­', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900, fontSize: 12)),
                                        ],
                                      ),
                                      const SizedBox(height: 8),
                                      Text(selected.title, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 16)),
                                      const SizedBox(height: 6),
                                      Text(selected.subtitle, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12)),
                                      const SizedBox(height: 10),
                                      Row(
                                        children: <Widget>[
                                          ElevatedButton.icon(
                                            onPressed: () {
                                              ScaffoldMessenger.of(context).showSnackBar(
                                                const SnackBar(content: Text('ì¡°ë¦¬ ë‹¨ê³„ë¥¼ ì´ì–´ì„œ ì§„í–‰í•©ë‹ˆë‹¤.')),
                                              );
                                            },
                                            icon: const Icon(Icons.play_arrow),
                                            label: const Text('ë‹¨ê³„ ì´ì–´ê°€ê¸°'),
                                            style: ElevatedButton.styleFrom(
                                              backgroundColor: AppColors.brand_primary,
                                              foregroundColor: Colors.white,
                                              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                                            ),
                                          ),
                                          const SizedBox(width: 10),
                                          IconButton(
                                            onPressed: () {
                                              ScaffoldMessenger.of(context).showSnackBar(
                                                SnackBar(content: Text('${selected.title}ì„(ë¥¼) ì°œí–ˆìŠµë‹ˆë‹¤.')),
                                              );
                                            },
                                            icon: const Icon(Icons.favorite_border),
                                          ),
                                        ],
                                      ),
                                    ],
                                  ),
                                ),
                                const SizedBox(width: 10),
                                Container(
                                  width: 92,
                                  height: 92,
                                  decoration: BoxDecoration(
                                    color: AppColors.border.withOpacity(0.35),
                                    borderRadius: BorderRadius.circular(18),
                                  ),
                                  child: const Icon(Icons.image_outlined),
                                ),
                              ],
                            ),
                          ),
                          const SizedBox(height: 12),

                          Row(
                            mainAxisAlignment: MainAxisAlignment.spaceBetween,
                            children: <Widget>[
                              const Text('ì¹´íŠ¸ì—ì„œ ë™ê¸°í™”ë¨', style: TextStyle(fontWeight: FontWeight.w900)),
                              TextButton(
                                onPressed: () {
                                  ScaffoldMessenger.of(context).showSnackBar(
                                    const SnackBar(content: Text('ë ˆì‹œí”¼ ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.')),
                                  );
                                },
                                child: const Text('ìƒˆë¡œê³ ì¹¨'),
                              ),
                            ],
                          ),
                          const SizedBox(height: 8),

                          ...list.skip(1).map((r) {
                            return Padding(
                              padding: const EdgeInsets.only(bottom: 10),
                              child: SectionCard(
                                child: Row(
                                  children: <Widget>[
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: <Widget>[
                                          Text('${r.match_percent}% ë§¤ì¹­ Â· ${r.time_min}ë¶„', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900, fontSize: 12)),
                                          const SizedBox(height: 6),
                                          Text(r.title, style: const TextStyle(fontWeight: FontWeight.w900)),
                                          const SizedBox(height: 4),
                                          Text(r.subtitle, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12)),
                                          const SizedBox(height: 10),
                                          OutlinedButton(
                                            onPressed: () => context.push(AppRoutes.recipe_detail, extra: <String, dynamic>{'recipe_id': r.recipe_id}),
                                            style: OutlinedButton.styleFrom(shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14))),
                                            child: const Text('ìƒì„¸ ë³´ê¸°'),
                                          ),
                                        ],
                                      ),
                                    ),
                                    const SizedBox(width: 10),
                                    Container(
                                      width: 84,
                                      height: 84,
                                      decoration: BoxDecoration(
                                        color: AppColors.border.withOpacity(0.35),
                                        borderRadius: BorderRadius.circular(18),
                                      ),
                                      child: const Icon(Icons.image_outlined),
                                    ),
                                  ],
                                ),
                              ),
                            );
                          }).toList(),

                          const SizedBox(height: 18),
                          Center(
                            child: Text('ìŠ¤ìº”ìœ¼ë¡œ ë§¤ì¹­ë¥ ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆì–´ìš”.', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12)),
                          ),
                          const SizedBox(height: 80),
                        ],
                      );
                    },
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
      floatingActionButton: Container(
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
        decoration: BoxDecoration(
          color: Colors.black.withOpacity(0.85),
          borderRadius: BorderRadius.circular(999),
        ),
        child: const Row(
          mainAxisSize: MainAxisSize.min,
          children: <Widget>[
            Icon(Icons.shopping_cart_outlined, color: Colors.white),
            SizedBox(width: 10),
            Text('ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° (12)', style: TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
          ],
        ),
      ),
    );
  }

  Widget _filter_chip({required String label, required bool is_selected, required VoidCallback on_tap}) {
    return InkWell(
      onTap: on_tap,
      borderRadius: BorderRadius.circular(999),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
        decoration: BoxDecoration(
          color: is_selected ? AppColors.brand_primary : Colors.white,
          borderRadius: BorderRadius.circular(999),
          border: Border.all(color: is_selected ? AppColors.brand_primary : AppColors.border),
        ),
        child: Text(
          label,
          style: TextStyle(color: is_selected ? Colors.white : AppColors.text_primary, fontWeight: FontWeight.w900, fontSize: 12),
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\presentation\qr_scanner_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:mobile_scanner/mobile_scanner.dart';
import 'package:go_router/go_router.dart';
import 'package:url_launcher/url_launcher.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../core/router/app_routes.dart';

class QrScannerScreen extends ConsumerStatefulWidget {
  const QrScannerScreen({super.key});

  @override
  ConsumerState<QrScannerScreen> createState() => _QrScannerScreenState();
}

class _QrScannerScreenState extends ConsumerState<QrScannerScreen> {
  final MobileScannerController controller = MobileScannerController(
    detectionSpeed: DetectionSpeed.noDuplicates,
    facing: CameraFacing.back,
  );

  bool is_scanned = false;

  @override
  void dispose() {
    controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final theme_mode = ref.watch(theme_mode_provider);
    final scan_window_size = 250.0;
    final scan_window = Rect.fromCenter(
      center: MediaQuery.of(context).size.center(Offset.zero),
      width: scan_window_size,
      height: scan_window_size,
    );

    return Scaffold(
      appBar: AppBar(
        title: const Text('QR ìŠ¤ìº”', style: TextStyle(fontWeight: FontWeight.w900)),
        backgroundColor: Colors.transparent,
        foregroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          onPressed: () => context.pop(),
          icon: const Icon(Icons.close),
        ),
        actions: [
          ValueListenableBuilder(
            valueListenable: controller,
            builder: (context, state, child) {
              if (!state.isInitialized || !state.isRunning) {
                return const SizedBox.shrink();
              }
              return IconButton(
                color: Colors.white,
                icon: state.torchState == TorchState.on
                    ? const Icon(Icons.flash_on)
                    : const Icon(Icons.flash_off),
                onPressed: () => controller.toggleTorch(),
              );
            },
          ),
        ],
      ),
      extendBodyBehindAppBar: true,
      backgroundColor: Colors.black,
      body: Stack(
        children: [
          MobileScanner(
            controller: controller,
            scanWindow: scan_window,
            onDetect: (capture) {
              if (is_scanned) return;
              final List<Barcode> barcodes = capture.barcodes;
              if (barcodes.isNotEmpty) {
                final String? code = barcodes.first.rawValue;
                if (code != null) {
                  setState(() => is_scanned = true);
                  _handleScannedCode(code);
                }
              }
            },
          ),
          // Background Dimming with hole
          ColorFiltered(
            colorFilter: ColorFilter.mode(
              Colors.black.withOpacity(0.5),
              BlendMode.srcOut,
            ),
            child: Stack(
              children: [
                Container(
                  decoration: const BoxDecoration(
                    color: Colors.black,
                    backgroundBlendMode: BlendMode.dstOut,
                  ),
                ),
                Center(
                  child: Container(
                    width: scan_window_size,
                    height: scan_window_size,
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(24),
                    ),
                  ),
                ),
              ],
            ),
          ),
          // Scanner Overlay Border
          Center(
            child: Container(
              width: scan_window_size,
              height: scan_window_size,
              decoration: BoxDecoration(
                border: Border.all(color: AppColors.gemini_purple, width: 4),
                borderRadius: BorderRadius.circular(24),
              ),
            ),
          ),
          // Instructions
          Positioned(
            bottom: 100,
            left: 0,
            right: 0,
            child: Column(
              children: [
                const Text(
                  'QR ì½”ë“œë¥¼ ì‚¬ê°í˜• ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”',
                  style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w700),
                ),
                const SizedBox(height: 8),
                Text(
                  'ì¹´íŠ¸ì˜ QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì‡¼í•‘ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                  style: TextStyle(color: Colors.white.withOpacity(0.7), fontSize: 13),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _handleScannedCode(String code) async {
    // Show success dialog or navigate
    if (!mounted) return;
    
    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => AlertDialog(
        title: const Text('ìŠ¤ìº” ì™„ë£Œ', style: TextStyle(fontWeight: FontWeight.w900)),
        content: Text('ì½”ë“œ: $code\nì—°ê²°ì„ ì§„í–‰í• ê¹Œìš”?'),
        actions: [
          TextButton(
            onPressed: () {
              setState(() => is_scanned = false);
              Navigator.pop(context);
            },
            child: const Text('ì·¨ì†Œ'),
          ),
          ElevatedButton(
            onPressed: () async {
              Navigator.pop(context);
              if (code.startsWith('http')) {
                final Uri url = Uri.parse(code);
                if (await canLaunchUrl(url)) {
                  await launchUrl(url, mode: LaunchMode.externalApplication);
                } else {
                  if (mounted) {
                    ScaffoldMessenger.of(context).showSnackBar(
                      const SnackBar(content: Text('URLì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')),
                    );
                  }
                }
              } else {
                // For other codes, navigate to the cart review screen
                if (mounted) {
                  context.pushReplacement(AppRoutes.review_and_cook);
                }
              }
            },
            style: ElevatedButton.styleFrom(backgroundColor: AppColors.gemini_blue, foregroundColor: Colors.white),
            child: const Text('ì—°ê²°í•˜ê¸°'),
          ),
        ],
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\presentation\review_and_cook_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../recipe/presentation/recipe_providers.dart';
import '../presentation/cart_providers.dart';

class ReviewAndCookScreen extends ConsumerWidget {
  const ReviewAndCookScreen({super.key});

  String _money(int v) {
    final String s = v.toString();
    final StringBuffer b = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final int from_end = s.length - i;
      b.write(s[i]);
      if (from_end > 1 && from_end % 3 == 1) b.write(',');
    }
    return 'â‚©${b.toString()}';
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);

    final cart_async = ref.watch(cart_summary_provider);
    final recipes_async = ref.watch(recipes_you_can_cook_now_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ê²€í†  & ìš”ë¦¬', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  cart_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (cart) {
                      return SectionCard(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Row(
                              children: <Widget>[
                                const Expanded(child: Text('ë‚´ ì¥ë°”êµ¬ë‹ˆ', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900))),
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                  decoration: BoxDecoration(
                                    color: AppColors.border.withOpacity(0.35),
                                    borderRadius: BorderRadius.circular(999),
                                  ),
                                  child: Text('${cart.items.length}ê°œ', style: const TextStyle(fontWeight: FontWeight.w900)),
                                ),
                              ],
                            ),
                            const SizedBox(height: 10),
                            ...cart.items.map((it) {
                              return Padding(
                                padding: const EdgeInsets.symmetric(vertical: 10),
                                child: Row(
                                  children: <Widget>[
                                    Container(
                                      width: 44,
                                      height: 44,
                                      decoration: BoxDecoration(
                                        color: AppColors.border.withOpacity(0.35),
                                        borderRadius: BorderRadius.circular(14),
                                      ),
                                      child: const Icon(Icons.image_outlined),
                                    ),
                                    const SizedBox(width: 12),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: <Widget>[
                                          Text(it.name, style: const TextStyle(fontWeight: FontWeight.w900)),
                                          const SizedBox(height: 4),
                                          Text(it.option_label, style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                        ],
                                      ),
                                    ),
                                    Text(_money(it.price), style: const TextStyle(fontWeight: FontWeight.w900)),
                                  ],
                                ),
                              );
                            }),
                            const Divider(),
                            Row(
                              children: <Widget>[
                                Text('ì†Œê³„', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                                const Spacer(),
                                Text(_money(cart.subtotal), style: const TextStyle(fontWeight: FontWeight.w900)),
                              ],
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                  const SizedBox(height: 14),
                  const Text('ì§€ê¸ˆ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë ˆì‹œí”¼', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
                  Text('í˜„ì¬ ì¥ë°”êµ¬ë‹ˆ ê¸°ë°˜ ì¶”ì²œ', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700)),
                  const SizedBox(height: 10),
                  recipes_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (list) {
                      if (list.isEmpty) {
                        return SectionCard(child: Text('ì¶”ì²œí•  ë ˆì‹œí”¼ê°€ ì—†ì–´ìš”.', style: TextStyle(color: AppColors.text_secondary)));
                      }
                      final r = list.first;
                      return SectionCard(
                        padding: const EdgeInsets.all(12),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Container(
                              height: 160,
                              decoration: BoxDecoration(
                                color: AppColors.border.withOpacity(0.35),
                                borderRadius: BorderRadius.circular(18),
                              ),
                              child: Stack(
                                children: <Widget>[
                                  const Center(child: Icon(Icons.image_outlined, size: 54)),
                                  Positioned(
                                    left: 12,
                                    top: 12,
                                    child: Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                      decoration: BoxDecoration(
                                        color: AppColors.brand_primary.withOpacity(0.12),
                                        borderRadius: BorderRadius.circular(999),
                                      ),
                                      child: Text('${r.match_percent}% ë§¤ì¹­', style: const TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(height: 10),
                            Row(
                              children: <Widget>[
                                Expanded(child: Text(r.title, style: const TextStyle(fontSize: 16, fontWeight: FontWeight.w900))),
                                IconButton(
                                  onPressed: () {
                                    ScaffoldMessenger.of(context).showSnackBar(
                                      SnackBar(content: Text('${r.title} ë ˆì‹œí”¼ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.')),
                                    );
                                  },
                                  icon: const Icon(Icons.bookmark_border),
                                ),
                              ],
                            ),
                            Row(
                              children: <Widget>[
                                Icon(Icons.schedule, size: 16, color: AppColors.text_secondary),
                                const SizedBox(width: 6),
                                Text('${r.time_min}ë¶„', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                                const SizedBox(width: 14),
                                Icon(Icons.emoji_events_outlined, size: 16, color: AppColors.text_secondary),
                                const SizedBox(width: 6),
                                Text(r.difficulty_label, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                              ],
                            ),
                            const SizedBox(height: 10),
                            Row(
                              children: <Widget>[
                                const Icon(Icons.thumb_up_alt_outlined, color: AppColors.brand_primary, size: 18),
                                const SizedBox(width: 8),
                                Text('ì¬ë£Œê°€ ëª¨ë‘ ìˆì–´ìš”!', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900)),
                              ],
                            ),
                            const SizedBox(height: 12),
                            PrimaryButton(
                              label: 'ë ˆì‹œí”¼ ë³´ê¸°',
                              on_pressed: () => context.push(AppRoutes.recipe_detail, extra: <String, dynamic>{'recipe_id': r.recipe_id}),
                            ),
                          ],
                        ),
                      );
                    },
                  ),
                  const SizedBox(height: 90),
                ],
              ),
            ),
          ),
        ),
      ),
      bottomNavigationBar: SafeArea(
        child: Container(
          padding: const EdgeInsets.fromLTRB(16, 10, 16, 12),
          decoration: const BoxDecoration(color: Colors.white),
          child: Row(
            children: <Widget>[
              Expanded(
                child: cart_async.when(
                  loading: () => const Text('í•©ê³„: -', style: TextStyle(fontWeight: FontWeight.w900)),
                  error: (_, __) => const Text('í•©ê³„: -', style: TextStyle(fontWeight: FontWeight.w900)),
                  data: (c) => Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisSize: MainAxisSize.min,
                    children: <Widget>[
                      Text('ì´ì•¡', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900, fontSize: 12)),
                      Text(_money(c.total), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
                    ],
                  ),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: PrimaryButton(
                  label: 'ê²°ì œë¡œ ì´ë™',
                  on_pressed: () => context.push(AppRoutes.kakao_pay_checkout),
                  leading: const Icon(Icons.arrow_forward),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\repository\cart_repository.dart
==================================================
import '../../../domain/models/cart.dart';

abstract class CartRepository {
  Future<CartSummary> fetch_cart_summary();
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\repository\cart_repository_impl.dart
==================================================
import '../../../core/network/dio_client.dart';
import '../../../domain/models/cart.dart';
import 'cart_repository.dart';

class CartRepositoryImpl implements CartRepository {
  final DioClient _dioClient;

  CartRepositoryImpl(this._dioClient);

  @override
  Future<CartSummary> fetch_cart_summary() async {
    try {
      // 1. ë‚´ í˜„ì¬ í™œì„± ì„¸ì…˜ ì¡°íšŒ
      final response = await _dioClient.dio.get('/carts/current');
      final data = response.data;
      
      final int cartSessionId = data['cart_session_id'];
      final List<dynamic> itemsData = data['items'] ?? [];
      final List<CartItem> items = [];
      
      for (var itemJson in itemsData) {
        final product = itemJson['product'];
        final String productId = product['product_id'].toString();
        final String name = product['name'] ?? 'ì•Œ ìˆ˜ ì—†ëŠ” ìƒí’ˆ';
        final int price = product['price'] ?? 0;
        final int quantity = itemJson['quantity'] ?? 1;
        
        // CartItem Response êµ¬ì¡°ì— ë§ê²Œ ìƒì„±
        for (int i = 0; i < quantity; i++) {
          items.add(CartItem(
            product_id: productId,
            name: name,
            option_label: '', // í•„ìš” ì‹œ ì¶”ê°€ íŒŒì‹±
            price: price,
          ));
        }
      }

      final int subtotal = data['total_amount'] ?? 0;
      return CartSummary(
        cart_session_id: cartSessionId,
        items: items, 
        subtotal: subtotal, 
        total: subtotal
      );
      
    } catch (e) {
      print('fetch_cart_summary error: $e');
      throw Exception('ì¥ë°”êµ¬ë‹ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $e');
    }
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\cart\repository\mock_cart_repository.dart
==================================================
import 'dart:async';
import '../../../domain/models/cart.dart';
import 'cart_repository.dart';

class MockCartRepository implements CartRepository {
  @override
  Future<CartSummary> fetch_cart_summary() async {
    await Future<void>.delayed(const Duration(milliseconds: 250));

    final List<CartItem> items = <CartItem>[
      const CartItem(product_id: 'p1', name: 'ë¡œë§ˆ í† ë§ˆí† ', option_label: '1kg Â· ìœ ê¸°ë†', price: 2500),
      const CartItem(product_id: 'p2', name: 'ìŠ¤íŒŒê²Œí‹°ë©´ No.5', option_label: '500g Â· ë°”ë¦´ë¼', price: 1500),
      const CartItem(product_id: 'p3', name: 'ë°”ì§ˆ', option_label: '1ë¬¶ìŒ Â· êµ­ë‚´ì‚°', price: 3000),
    ];

    final int subtotal = items.fold<int>(0, (p, c) => p + c.price);
    return CartSummary(cart_session_id: 0, items: items, subtotal: subtotal, total: subtotal);
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\home\presentation\home_dashboard_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import '../../../core/router/app_routes.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../core/utils/responsive.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/bottom_nav.dart';

class HomeDashboardScreen extends ConsumerStatefulWidget {
  const HomeDashboardScreen({super.key});

  @override
  ConsumerState<HomeDashboardScreen> createState() => _HomeDashboardScreenState();
}

class _HomeDashboardScreenState extends ConsumerState<HomeDashboardScreen> {
  BottomTab current_tab = BottomTab.home;

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('í”¼í´', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  // Cart Sync Banner (Clean version with Logo)
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(24),
                    decoration: BoxDecoration(
                      color: AppColors.brand_primary.withOpacity(0.08),
                      borderRadius: BorderRadius.circular(24),
                      border: Border.all(color: AppColors.brand_primary.withOpacity(0.1)),
                    ),
                    child: Row(
                      children: [
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: <Widget>[
                              Text(
                                'ì‡¼í•‘ ì‹œì‘!',
                                style: TextStyle(color: AppColors.brand_primary, fontSize: 24, fontWeight: FontWeight.w900),
                              ),
                              const SizedBox(height: 12),
                              Wrap(
                                spacing: 8,
                                runSpacing: 8,
                                children: [
                                  ElevatedButton.icon(
                                    onPressed: () => context.push(AppRoutes.qr_scanner),
                                    icon: const Icon(Icons.qr_code_scanner, size: 18),
                                    label: const Text('QR ìŠ¤ìº”', style: TextStyle(fontWeight: FontWeight.w900)),
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: AppColors.brand_primary,
                                      foregroundColor: Colors.white,
                                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                                      elevation: 0,
                                    ),
                                  ),
                                  ElevatedButton.icon(
                                    onPressed: () => context.push(AppRoutes.review_and_cook),
                                    icon: const Icon(Icons.shopping_cart, size: 18),
                                    label: const Text('ì¥ë°”êµ¬ë‹ˆ(Test)', style: TextStyle(fontWeight: FontWeight.w900)),
                                    style: ElevatedButton.styleFrom(
                                      backgroundColor: Colors.grey[700],
                                      foregroundColor: Colors.white,
                                      padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                                      elevation: 0,
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                        // Pickle Logo (Cart + Check)
                        Stack(
                          alignment: Alignment.center,
                          children: [
                            Icon(Icons.shopping_cart_outlined, size: 60, color: AppColors.brand_primary),
                            Transform.translate(
                              offset: const Offset(3, -8),
                              child: const Icon(Icons.check, size: 18, color: AppColors.brand_primary),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Spending Analysis
                  const Text('ì§€ì¶œ ë¶„ì„', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
                  const SizedBox(height: 12),
                  SectionCard(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: <Widget>[
                        const Text('ì´ë²ˆ ë‹¬ ì§€ì¶œ', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                        const SizedBox(height: 4),
                        const Text('â‚©428,500', style: TextStyle(fontSize: 24, fontWeight: FontWeight.w900)),
                        const SizedBox(height: 20),
                        // Bar Chart
                        SizedBox(
                          height: 150,
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                            crossAxisAlignment: CrossAxisAlignment.end,
                            children: <Widget>[
                              _SpendingBar(label: 'ì¼', height: 40),
                              _SpendingBar(label: 'ì›”', height: 80),
                              _SpendingBar(label: 'í™”', height: 60),
                              _SpendingBar(label: 'ìˆ˜', height: 100),
                              _SpendingBar(label: 'ëª©', height: 30),
                              _SpendingBar(label: 'ê¸ˆ', height: 120, is_today: true),
                              _SpendingBar(label: 'í† ', height: 50),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 24),

                  // Recommended Recipes
                  const Text('AI ì¶”ì²œ ë ˆì‹œí”¼', style: TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
                  const SizedBox(height: 12),
                  SingleChildScrollView(
                    scrollDirection: Axis.horizontal,
                    child: Row(
                      children: <Widget>[
                        _RecipeImageCard(
                          title: 'ì—°ì–´ ìŠ¤í…Œì´í¬',
                          imageUrl: 'https://images.unsplash.com/photo-1467003909585-2f8a72700288?w=400',
                          on_tap: () => context.push(AppRoutes.recipe_detail, extra: {'recipe_id': 'r1'}),
                        ),
                        _RecipeImageCard(
                          title: 'ì•„ë³´ì¹´ë„ ìƒëŸ¬ë“œ',
                          imageUrl: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400',
                          on_tap: () => context.push(AppRoutes.recipe_detail, extra: {'recipe_id': 'r2'}),
                        ),
                        _RecipeImageCard(
                          title: 'í† ë§ˆí†  íŒŒìŠ¤íƒ€',
                          imageUrl: 'https://images.unsplash.com/photo-1546548970-71785318a17b?w=400',
                          on_tap: () => context.push(AppRoutes.recipe_detail, extra: {'recipe_id': 'r3'}),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 80),
                ],
              ),
            ),
          ),
        ),
      ),
      bottomNavigationBar: BottomNav(
        current_tab: current_tab,
        on_tab_selected: (BottomTab next) {
          setState(() => current_tab = next);
          if (next == BottomTab.home) context.go(AppRoutes.home);
          if (next == BottomTab.search) context.go(AppRoutes.product_search);
          if (next == BottomTab.scan) context.push(AppRoutes.qr_scanner);
          if (next == BottomTab.account_book) context.go(AppRoutes.spending_overview);
          if (next == BottomTab.my_page) context.go(AppRoutes.my_page);
        },
      ),
    );
  }
}

class _SpendingBar extends StatelessWidget {
  final String label;
  final double height;
  final bool is_today;

  const _SpendingBar({required this.label, required this.height, this.is_today = false});

  @override
  Widget build(BuildContext context) {
    return Column(
      mainAxisAlignment: MainAxisAlignment.end,
      children: <Widget>[
        Container(
          width: 24,
          height: height,
          decoration: BoxDecoration(
            color: is_today ? AppColors.gemini_purple : AppColors.border,
            borderRadius: BorderRadius.circular(6),
          ),
        ),
        const SizedBox(height: 8),
        Text(label, style: TextStyle(fontSize: 12, fontWeight: is_today ? FontWeight.w900 : FontWeight.w700)),
      ],
    );
  }
}

class _RecipeImageCard extends StatelessWidget {
  final String title;
  final String imageUrl;
  final VoidCallback on_tap;

  const _RecipeImageCard({required this.title, required this.imageUrl, required this.on_tap});

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: on_tap,
      borderRadius: BorderRadius.circular(18),
      child: Container(
        width: 160,
        margin: const EdgeInsets.only(right: 12),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: <Widget>[
            ClipRRect(
              borderRadius: BorderRadius.circular(18),
              child: Image.network(
                imageUrl,
                height: 120,
                width: 160,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) => Container(
                  height: 120,
                  color: AppColors.border,
                  child: const Icon(Icons.restaurant, color: Colors.grey),
                ),
              ),
            ),
            const SizedBox(height: 8),
            Text(title, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 14)),
          ],
        ),
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\home\repository\home_repository.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\home\repository\mock_home_repository.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\add_new_card_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../payment/repository/payment_repository.dart';
import 'payment_providers.dart';

class AddNewCardScreen extends ConsumerStatefulWidget {
  const AddNewCardScreen({super.key});

  @override
  ConsumerState<AddNewCardScreen> createState() => _AddNewCardScreenState();
}

class _AddNewCardScreenState extends ConsumerState<AddNewCardScreen> {
  final TextEditingController card_number_controller = TextEditingController();
  final TextEditingController expires_controller = TextEditingController();
  final TextEditingController cvc_controller = TextEditingController();
  final TextEditingController holder_controller = TextEditingController();

  bool save_card = true;
  bool is_submitting = false;

  @override
  void dispose() {
    card_number_controller.dispose();
    expires_controller.dispose();
    cvc_controller.dispose();
    holder_controller.dispose();
    super.dispose();
  }

  Future<void> _submit() async {
    setState(() => is_submitting = true);
    try {
      final PaymentRepository repo = ref.read(payment_repository_provider);
      await repo.register_card(
        card_number: card_number_controller.text.trim(),
        expires_mm_yy: expires_controller.text.trim(),
        cvc: cvc_controller.text.trim(),
        cardholder_name: holder_controller.text.trim(),
        save_card: save_card,
      );

      ref.invalidate(payment_cards_provider);
      if (!mounted) return;
      context.pushReplacement(AppRoutes.card_registration_success);
    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text('ì¹´ë“œ ë“±ë¡ ì‹¤íŒ¨: $e')));
    } finally {
      if (mounted) setState(() => is_submitting = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ì¹´ë“œ ì¶”ê°€', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                children: <Widget>[
                  SectionCard(
                    child: Column(
                      children: <Widget>[
                        Container(
                          width: double.infinity,
                          padding: const EdgeInsets.all(16),
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(18),
                            border: Border.all(color: AppColors.border, style: BorderStyle.solid),
                            color: AppColors.brand_primary.withOpacity(0.06),
                          ),
                          child: Column(
                            children: <Widget>[
                              const Text('ì¹´ë“œë¥¼ ìŠ¤ìº”í•´ ìë™ ì…ë ¥', style: TextStyle(fontWeight: FontWeight.w900)),
                              const SizedBox(height: 6),
                              Text(
                                'ì¹´ë“œë¥¼ í”„ë ˆì„ ì•ˆì— ë§ì¶”ë©´ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì¸ì‹í•´ìš”.',
                                textAlign: TextAlign.center,
                                style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12),
                              ),
                              const SizedBox(height: 12),
                              OutlinedButton.icon(
                                onPressed: () {},
                                icon: const Icon(Icons.photo_camera_outlined),
                                label: const Text('ì¹´ë©”ë¼ ì—´ê¸°'),
                                style: OutlinedButton.styleFrom(
                                  padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
                                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                                ),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 10),
                        Row(
                          children: <Widget>[
                            const Icon(Icons.lock_outline, size: 16, color: AppColors.brand_primary),
                            const SizedBox(width: 8),
                            Expanded(
                              child: Text(
                                'ê²°ì œ ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë¼ìš”.',
                                style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12),
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 12),

                  SectionCard(
                    child: Column(
                      children: <Widget>[
                        _field(label: 'ì¹´ë“œ ë²ˆí˜¸', controller: card_number_controller, hint: '0000 0000 0000 0000', icon: Icons.credit_card),
                        const SizedBox(height: 12),
                        Row(
                          children: <Widget>[
                            Expanded(child: _field(label: 'ë§Œë£Œì¼', controller: expires_controller, hint: 'MM/YY', icon: Icons.calendar_month)),
                            const SizedBox(width: 12),
                            Expanded(child: _field(label: 'CVC', controller: cvc_controller, hint: '123', icon: Icons.shield_outlined)),
                          ],
                        ),
                        const SizedBox(height: 12),
                        _field(label: 'ì¹´ë“œ ì†Œìœ ì£¼', controller: holder_controller, hint: 'ì¹´ë“œì— ì íŒ ì´ë¦„', icon: Icons.person_outline),
                        const SizedBox(height: 10),
                        Row(
                          children: <Widget>[
                            const Icon(Icons.save_outlined, color: AppColors.brand_primary),
                            const SizedBox(width: 10),
                            const Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Text('ì´ ì¹´ë“œë¥¼ ì €ì¥', style: TextStyle(fontWeight: FontWeight.w900)),
                                  SizedBox(height: 2),
                                  Text('ë‹¤ìŒ ê²°ì œë¥¼ ë” ë¹ ë¥´ê²Œ ì§„í–‰í•´ìš”', style: TextStyle(fontSize: 12, color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                                ],
                              ),
                            ),
                            Switch(
                              value: save_card,
                              onChanged: (v) => setState(() => save_card = v),
                              activeColor: AppColors.brand_primary,
                            ),
                          ],
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 14),
                  PrimaryButton(
                    label: is_submitting ? 'ë“±ë¡ ì¤‘...' : 'ì¹´ë“œ ë“±ë¡',
                    on_pressed: is_submitting ? null : _submit,
                    leading: const Icon(Icons.arrow_forward),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _field({
    required String label,
    required TextEditingController controller,
    required String hint,
    required IconData icon,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: <Widget>[
        Text(label, style: const TextStyle(fontWeight: FontWeight.w900)),
        const SizedBox(height: 8),
        TextField(
          controller: controller,
          decoration: InputDecoration(
            hintText: hint,
            prefixIcon: Icon(icon),
          ),
        ),
      ],
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\card_registration_success_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/section_card.dart';

class CardRegistrationSuccessScreen extends StatelessWidget {
  const CardRegistrationSuccessScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);

    return Scaffold(
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: Padding(
              padding: Responsive.page_padding(context),
              child: Column(
                children: <Widget>[
                  const SizedBox(height: 20),
                  Container(
                    width: 120,
                    height: 120,
                    decoration: BoxDecoration(
                      color: AppColors.brand_primary.withOpacity(0.12),
                      borderRadius: BorderRadius.circular(999),
                    ),
                    child: const Icon(Icons.check, color: AppColors.brand_primary, size: 54),
                  ),
                  const SizedBox(height: 18),
                  const Text('ì¹´ë“œ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', style: TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
                  const SizedBox(height: 10),
                  Text(
                    'ìë™ ê²°ì œë¥¼ ìœ„í•´ ì¹´ë“œê°€ ì¤€ë¹„ë˜ì—ˆì–´ìš”.',
                    style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800),
                  ),
                  const SizedBox(height: 16),

                  SectionCard(
                    child: Row(
                      children: <Widget>[
                        Container(
                          width: 74,
                          height: 44,
                          decoration: BoxDecoration(
                            color: AppColors.border.withOpacity(0.35),
                            borderRadius: BorderRadius.circular(14),
                          ),
                          child: const Center(child: Text('VISA', style: TextStyle(fontWeight: FontWeight.w900, color: Colors.blue))),
                        ),
                        const SizedBox(width: 12),
                        const Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: <Widget>[
                              Text('**** 5678', style: TextStyle(fontWeight: FontWeight.w900)),
                              SizedBox(height: 4),
                              Text('ë§Œë£Œ 12/28', style: TextStyle(fontSize: 12, color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                            ],
                          ),
                        ),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                          decoration: BoxDecoration(
                            color: AppColors.brand_primary.withOpacity(0.12),
                            borderRadius: BorderRadius.circular(999),
                          ),
                          child: const Text('ê¸°ë³¸', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                        ),
                      ],
                    ),
                  ),

                  const Spacer(),
                  PrimaryButton(
                    label: 'ê²°ì œ ìˆ˜ë‹¨ìœ¼ë¡œ ëŒì•„ê°€ê¸°',
                    on_pressed: () => context.go(AppRoutes.payment_methods),
                  ),
                  const SizedBox(height: 10),
                  OutlinedButton.icon(
                    onPressed: () => context.push(AppRoutes.add_new_card),
                    icon: const Icon(Icons.add),
                    label: const Text('ì¹´ë“œ ì¶”ê°€ ë“±ë¡'),
                    style: OutlinedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 16),
                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\digital_receipt_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/primary_button.dart';
import 'payment_providers.dart';

class DigitalReceiptScreen extends ConsumerWidget {
  final String receipt_id;

  const DigitalReceiptScreen({super.key, required this.receipt_id});

  String _money(int v) {
    final String s = v.toString();
    final StringBuffer b = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final int from_end = s.length - i;
      b.write(s[i]);
      if (from_end > 1 && from_end % 3 == 1) b.write(',');
    }
    return 'â‚©${b.toString()}';
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);
    final receipt_async = ref.watch(receipt_provider(receipt_id));
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ì˜ìˆ˜ì¦', style: TextStyle(fontWeight: FontWeight.w900)),
        actions: <Widget>[
          IconButton(
            onPressed: () {
              showModalBottomSheet<void>(
                context: context,
                builder: (context) => SafeArea(
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: <Widget>[
                      ListTile(
                        leading: const Icon(Icons.picture_as_pdf_outlined),
                        title: const Text('PDFë¡œ ì €ì¥'),
                        onTap: () => Navigator.pop(context),
                      ),
                      ListTile(
                        leading: const Icon(Icons.print_outlined),
                        title: const Text('ì¸ì‡„í•˜ê¸°'),
                        onTap: () => Navigator.pop(context),
                      ),
                      ListTile(
                        leading: const Icon(Icons.help_outline),
                        title: const Text('ê²°ì œ ê´€ë ¨ ë¬¸ì˜'),
                        onTap: () => Navigator.pop(context),
                      ),
                    ],
                  ),
                ),
              );
            },
            icon: const Icon(Icons.more_horiz),
          ),
        ],
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: receipt_async.when(
                loading: () => const Padding(padding: EdgeInsets.all(24), child: CircularProgressIndicator()),
                error: (e, _) => Text('ì˜ìˆ˜ì¦ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                data: (r) {
                  final String date_label = '${r.paid_at.year}.${r.paid_at.month.toString().padLeft(2, '0')}.${r.paid_at.day.toString().padLeft(2, '0')} ' 
                      '${r.paid_at.hour.toString().padLeft(2, '0')}:${r.paid_at.minute.toString().padLeft(2, '0')}';

                  return Column(
                    children: <Widget>[
                      Container(
                        width: 88,
                        height: 88,
                        decoration: BoxDecoration(
                          color: AppColors.brand_primary.withOpacity(0.12),
                          borderRadius: BorderRadius.circular(999),
                        ),
                        child: const Icon(Icons.check, color: AppColors.brand_primary, size: 40),
                      ),
                      const SizedBox(height: 12),
                      const Text('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', style: TextStyle(fontSize: 20, fontWeight: FontWeight.w900)),
                      const SizedBox(height: 6),
                      Text('ì°¸ì¡°: #${r.ref_code}', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                      const SizedBox(height: 14),

                      SectionCard(
                        child: Column(
                          children: <Widget>[
                            Row(
                              children: <Widget>[
                                CircleAvatar(
                                  radius: 16,
                                  backgroundColor: AppColors.brand_primary.withOpacity(0.12),
                                  child: const Text('P', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900)),
                                ),
                                const SizedBox(width: 10),
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: <Widget>[
                                      Text(r.store_name, style: const TextStyle(fontWeight: FontWeight.w900)),
                                      const SizedBox(height: 2),
                                      Text(date_label, style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                    ],
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 12),
                            ...r.items.map((it) {
                              return Padding(
                                padding: const EdgeInsets.symmetric(vertical: 8),
                                child: Row(
                                  children: <Widget>[
                                    Container(
                                      width: 22,
                                      height: 22,
                                      decoration: BoxDecoration(
                                        color: AppColors.border.withOpacity(0.35),
                                        borderRadius: BorderRadius.circular(8),
                                      ),
                                      alignment: Alignment.center,
                                      child: Text('${it.qty}', style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 12)),
                                    ),
                                    const SizedBox(width: 10),
                                    Expanded(
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: <Widget>[
                                          Text(it.name, style: const TextStyle(fontWeight: FontWeight.w900)),
                                          Text(it.option_label, style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                        ],
                                      ),
                                    ),
                                    Text(_money(it.price), style: const TextStyle(fontWeight: FontWeight.w900)),
                                  ],
                                ),
                              );
                            }),
                            const SizedBox(height: 10),
                            Container(height: 1, color: AppColors.border),
                            const SizedBox(height: 10),
                            _row('ì†Œê³„', _money(r.subtotal)),
                            _row('ì„¸ê¸ˆ', _money(r.tax)),
                            const SizedBox(height: 10),
                            Row(
                              children: <Widget>[
                                const Expanded(child: Text('ê²°ì œ ê¸ˆì•¡', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900))),
                                Text(_money(r.total_paid), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900)),
                              ],
                            ),
                            const SizedBox(height: 10),
                            Row(
                              children: <Widget>[
                                Container(
                                  width: 44,
                                  height: 30,
                                  decoration: BoxDecoration(
                                    color: AppColors.border.withOpacity(0.35),
                                    borderRadius: BorderRadius.circular(10),
                                  ),
                                  child: const Icon(Icons.credit_card, size: 18),
                                ),
                                const SizedBox(width: 10),
                                Expanded(child: Text(r.paid_method_label, style: const TextStyle(fontWeight: FontWeight.w900))),
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                  decoration: BoxDecoration(
                                    color: AppColors.brand_primary.withOpacity(0.12),
                                    borderRadius: BorderRadius.circular(999),
                                  ),
                                  child: const Text('ìë™ ê²°ì œ', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 14),
                      PrimaryButton(
                        label: 'í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°',
                        on_pressed: () => context.go(AppRoutes.home),
                      ),
                      const SizedBox(height: 10),
                      OutlinedButton.icon(
                        onPressed: () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text('ì˜ìˆ˜ì¦ ê³µìœ  ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                          );
                        },
                        icon: const Icon(Icons.ios_share),
                        label: const Text('ì˜ìˆ˜ì¦ ê³µìœ '),
                        style: OutlinedButton.styleFrom(
                          padding: const EdgeInsets.symmetric(vertical: 16),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                        ),
                      ),
                      const SizedBox(height: 10),
                    ],
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _row(String left, String right) {
    return Row(
      children: <Widget>[
        Expanded(child: Text(left, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900))),
        Text(right, style: const TextStyle(fontWeight: FontWeight.w900)),
      ],
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\kakao_pay_checkout_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:webview_flutter/webview_flutter.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../cart/presentation/cart_providers.dart';
import '../repository/payment_repository.dart';
import 'payment_providers.dart';

class KakaoPayCheckoutScreen extends ConsumerStatefulWidget {
  const KakaoPayCheckoutScreen({super.key});

  @override
  ConsumerState<KakaoPayCheckoutScreen> createState() => _KakaoPayCheckoutScreenState();
}

class _KakaoPayCheckoutScreenState extends ConsumerState<KakaoPayCheckoutScreen> {
  final TextEditingController points_controller = TextEditingController(text: '0');
  String? selected_coupon_id;
  bool is_paying = false;

  @override
  void dispose() {
    points_controller.dispose();
    super.dispose();
  }

  int _parse_int(String v) => int.tryParse(v.replaceAll(',', '').trim()) ?? 0;

  String _money(int v) {
    final String s = v.toString();
    final StringBuffer b = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final int from_end = s.length - i;
      b.write(s[i]);
      if (from_end > 1 && from_end % 3 == 1) b.write(',');
    }
    return 'â‚©${b.toString()}';
  }

  // ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
  Future<void> _startKakaoPay(int cart_session_id, int amount, int using_points) async {
    setState(() => is_paying = true);
    try {
      final PaymentRepository repo = ref.read(payment_repository_provider);
      
      // 1. ê²°ì œ ì¤€ë¹„ ìš”ì²­ (Ready)
      final readyResponse = await repo.prepare_kakao_pay(
        cart_session_id: cart_session_id,
        amount: amount,
        using_points: using_points,
        coupon_id: selected_coupon_id,
      );

      if (!mounted) return;

      // 2. ì›¹ë·° ëª¨ë‹¬ ë„ìš°ê¸° (PC URL ì‚¬ìš© - ì•± ì´íƒˆ ë°©ì§€)
      // ëª¨ë°”ì¼ í™˜ê²½ì—ì„œë„ PC URLì„ ë„ìš°ë©´ ì¹´ì¹´ì˜¤í†¡ ì•± ì „í™˜ ì—†ì´ ì›¹ì—ì„œ QR/ë²ˆí˜¸ ê²°ì œ ê°€ëŠ¥
      final String? pgToken = await showDialog<String>(
        context: context,
        barrierDismissible: false, // ì‚¬ìš©ì ì‹¤ìˆ˜ë¡œ ë‹«ê¸° ë°©ì§€
        builder: (context) => _KakaoPayWebViewDialog(
          initialUrl: readyResponse.next_redirect_pc_url,
        ),
      );

      if (pgToken != null) {
        // 3. ê²°ì œ ìŠ¹ì¸ ìš”ì²­ (Approve)
        final String receiptId = await repo.approve_kakao_pay(
          tid: readyResponse.tid,
          pg_token: pgToken,
        );

        if (!mounted) return;
        // 4. ì˜ìˆ˜ì¦ í™”ë©´ìœ¼ë¡œ ì´ë™
        context.go(AppRoutes.digital_receipt, extra: <String, dynamic>{'receipt_id': receiptId});
      } else {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.')),
        );
      }

    } catch (e) {
      if (!mounted) return;
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('ê²°ì œ ì‹¤íŒ¨: ${e.toString().replaceAll("Exception: ", "")}')),
      );
    } finally {
      if (mounted) setState(() => is_paying = false);
    }
  }

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final cart_async = ref.watch(cart_summary_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('í”¼í´', style: TextStyle(fontWeight: FontWeight.w900)),
        leading: IconButton(onPressed: () => context.pop(), icon: const Icon(Icons.close)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: cart_async.when(
                loading: () => const Padding(padding: EdgeInsets.all(24), child: CircularProgressIndicator()),
                error: (e, _) => Text('ì¥ë°”êµ¬ë‹ˆ ì˜¤ë¥˜: $e'),
                data: (cart) {
                  final int amount = cart.total;
                  final int using_points = _parse_int(points_controller.text);
                  final int final_amount = (amount - using_points).clamp(0, amount);

                  return Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: <Widget>[
                      Center(
                        child: Column(
                          children: <Widget>[
                            Text('ê²°ì œ ê¸ˆì•¡', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 8),
                            Text(_money(amount), style: const TextStyle(fontSize: 24, fontWeight: FontWeight.w900)),
                          ],
                        ),
                      ),
                      const SizedBox(height: 14),

                      SectionCard(
                        child: Row(
                          children: <Widget>[
                            Container(
                              width: 44,
                              height: 44,
                              decoration: BoxDecoration(
                                color: const Color(0xFFFFE600).withOpacity(0.9),
                                borderRadius: BorderRadius.circular(14),
                              ),
                              child: const Icon(Icons.chat_bubble_outline, color: Colors.black),
                            ),
                            const SizedBox(width: 12),
                            const Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Text('ì¹´ì¹´ì˜¤í˜ì´', style: TextStyle(fontWeight: FontWeight.w900)),
                                  SizedBox(height: 4),
                                  Text('ê°„í¸ê²°ì œ & í¬ì¸íŠ¸', style: TextStyle(fontSize: 12, color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                                ],
                              ),
                            ),
                            Container(
                              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                              decoration: BoxDecoration(
                                color: AppColors.brand_primary.withOpacity(0.12),
                                borderRadius: BorderRadius.circular(999),
                              ),
                              child: const Text('ì—°ê²°ë¨', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 12),
                      SectionCard(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Row(
                              children: <Widget>[
                                const Expanded(child: Text('í”¼í´ í¬ì¸íŠ¸', style: TextStyle(fontWeight: FontWeight.w900))),
                                Text('ì‚¬ìš© ê°€ëŠ¥ 2,450P', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12)),
                              ],
                            ),
                            const SizedBox(height: 10),
                            TextField(
                              controller: points_controller,
                              keyboardType: TextInputType.number,
                              decoration: InputDecoration(
                                hintText: '0',
                                suffixText: 'P',
                                suffixIcon: IconButton(onPressed: () => points_controller.clear(), icon: const Icon(Icons.close)),
                              ),
                              onChanged: (_) => setState(() {}),
                            ),
                            const SizedBox(height: 10),
                            Wrap(
                              spacing: 8,
                              children: <Widget>[
                                _chip(label: 'ì „ë¶€ ì‚¬ìš©', on_tap: () => setState(() => points_controller.text = '2450')),
                                _chip(label: '100P', on_tap: () => setState(() => points_controller.text = '100')),
                                _chip(label: '1,000P', on_tap: () => setState(() => points_controller.text = '1000')),
                              ],
                            ),
                            const SizedBox(height: 12),
                            InkWell(
                              onTap: () => setState(() => selected_coupon_id = 'cp_1'),
                              borderRadius: BorderRadius.circular(16),
                              child: Container(
                                padding: const EdgeInsets.all(14),
                                decoration: BoxDecoration(
                                  color: AppColors.border.withOpacity(0.25),
                                  borderRadius: BorderRadius.circular(16),
                                ),
                                child: Row(
                                  children: <Widget>[
                                    const Icon(Icons.confirmation_number_outlined, color: AppColors.brand_primary),
                                    const SizedBox(width: 10),
                                    const Expanded(child: Text('ì¿ í° ì„ íƒ', style: TextStyle(fontWeight: FontWeight.w900))),
                                    Text(selected_coupon_id == null ? 'ì„ íƒ ì•ˆ í•¨' : 'ì ìš©ë¨', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                                    const SizedBox(width: 6),
                                    const Icon(Icons.chevron_right),
                                  ],
                                ),
                              ),
                            ),
                            const SizedBox(height: 10),
                            Row(
                              children: <Widget>[
                                const Icon(Icons.lock_outline, size: 16, color: AppColors.text_secondary),
                                const SizedBox(width: 8),
                                Text('ì¹´ì¹´ì˜¤í˜ì´ë¡œ ì•ˆì „í•˜ê²Œ ê²°ì œí•´ìš”.', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800, fontSize: 12)),
                              ],
                            ),
                          ],
                        ),
                      ),

                      const SizedBox(height: 14),
                      Row(
                        children: <Widget>[
                          Checkbox(value: true, onChanged: (_) {}),
                          Expanded(
                            child: Text(
                              'ê²°ì œ ì„œë¹„ìŠ¤ ì•½ê´€ì— ë™ì˜í•˜ë©°, ê²°ì œë¥¼ ìœ„í•´ ì œ3ìì—ê²Œ ê°œì¸ì •ë³´ ì œê³µì„ í—ˆìš©í•©ë‹ˆë‹¤.',
                              style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700, fontSize: 12),
                            ),
                          ),
                        ],
                      ),

                      const SizedBox(height: 12),
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton(
                          onPressed: is_paying
                              ? null
                              : () => _startKakaoPay(cart.cart_session_id, amount, using_points),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFFFFE600),
                            foregroundColor: Colors.black,
                            padding: const EdgeInsets.symmetric(vertical: 16),
                            shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                          ),
                          child: Text(is_paying ? 'ê²°ì œ ì§„í–‰ ì¤‘...' : 'ê²°ì œ ${_money(final_amount)}', style: const TextStyle(fontWeight: FontWeight.w900)),
                        ),
                      ),
                    ],
                  );
                },
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _chip({required String label, required VoidCallback on_tap}) {
    return InkWell(
      onTap: on_tap,
      borderRadius: BorderRadius.circular(999),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
        decoration: BoxDecoration(
          color: Colors.white,
          borderRadius: BorderRadius.circular(999),
          border: Border.all(color: AppColors.border),
        ),
        child: Text(label, style: const TextStyle(fontWeight: FontWeight.w900, fontSize: 12)),
      ),
    );
  }
}

// ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œì°½ì„ ë„ìš°ëŠ” ì›¹ë·° ë‹¤ì´ì–¼ë¡œê·¸
class _KakaoPayWebViewDialog extends StatefulWidget {
  final String initialUrl;

  const _KakaoPayWebViewDialog({required this.initialUrl});

  @override
  State<_KakaoPayWebViewDialog> createState() => _KakaoPayWebViewDialogState();
}

class _KakaoPayWebViewDialogState extends State<_KakaoPayWebViewDialog> {
  late final WebViewController _controller;

  @override
  void initState() {
    super.initState();
    _controller = WebViewController()
      ..setJavaScriptMode(JavaScriptMode.unrestricted)
      ..setNavigationDelegate(
        NavigationDelegate(
          onNavigationRequest: (NavigationRequest request) {
            // ê²°ì œ ì„±ê³µ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ” URL ê°ì§€
            if (request.url.contains('/payments/success')) {
              // URLì—ì„œ pg_token ì¶”ì¶œ
              final Uri uri = Uri.parse(request.url);
              final String? pgToken = uri.queryParameters['pg_token'];
              
              if (pgToken != null) {
                Navigator.of(context).pop(pgToken); // ì„±ê³µ í† í° ë°˜í™˜
              } else {
                Navigator.of(context).pop(null); // í† í° ì—†ìŒ (ì‹¤íŒ¨)
              }
              return NavigationDecision.prevent; // ì›¹ë·° ì´ë™ ë§‰ê¸°
            }
            
            // ê²°ì œ ì·¨ì†Œ/ì‹¤íŒ¨ ê°ì§€
            if (request.url.contains('/payments/cancel') || request.url.contains('/payments/fail')) {
              Navigator.of(context).pop(null);
              return NavigationDecision.prevent;
            }

            return NavigationDecision.navigate;
          },
        ),
      )
      ..loadRequest(Uri.parse(widget.initialUrl));
  }

  @override
  Widget build(BuildContext context) {
    return Dialog(
      insetPadding: const EdgeInsets.all(10),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: SizedBox(
        height: 600,
        child: Column(
          children: [
            // ë‹«ê¸° ë²„íŠ¼ í—¤ë”
            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  const Padding(
                    padding: EdgeInsets.only(left: 12),
                    child: Text('ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ', style: TextStyle(fontWeight: FontWeight.w900)),
                  ),
                  IconButton(
                    icon: const Icon(Icons.close),
                    onPressed: () => Navigator.of(context).pop(null),
                  ),
                ],
              ),
            ),
            const Divider(height: 1),
            // ì›¹ë·° ì˜ì—­
            Expanded(
              child: ClipRRect(
                borderRadius: const BorderRadius.only(
                  bottomLeft: Radius.circular(16),
                  bottomRight: Radius.circular(16),
                ),
                child: WebViewWidget(controller: _controller),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\kakao_pay_settings_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/primary_button.dart';

class KakaoPaySettingsScreen extends ConsumerWidget {
  const KakaoPaySettingsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ì¹´ì¹´ì˜¤í˜ì´ ì„¤ì •', style: TextStyle(fontWeight: FontWeight.w900)),
        leading: IconButton(onPressed: () => context.pop(), icon: const Icon(Icons.arrow_back)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: Padding(
              padding: Responsive.page_padding(context),
              child: Column(
                children: <Widget>[
                  SectionCard(
                    child: Column(
                      children: <Widget>[
                        Container(
                          width: 80,
                          height: 80,
                          decoration: BoxDecoration(
                            color: const Color(0xFFFFE600),
                            borderRadius: BorderRadius.circular(20),
                          ),
                          child: const Icon(Icons.chat_bubble_outline, size: 40, color: Colors.black),
                        ),
                        const SizedBox(height: 16),
                        const Text(
                          'ì¹´ì¹´ì˜¤í˜ì´',
                          style: TextStyle(fontSize: 20, fontWeight: FontWeight.w900),
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'í˜„ì¬ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤',
                          style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 14),
                  SectionCard(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: <Widget>[
                        const Text('ê²°ì œ ì •ë³´', style: TextStyle(fontWeight: FontWeight.w900)),
                        const SizedBox(height: 12),
                        _InfoRow(label: 'ì—°ê²° ê³„ì •', value: 'pick***@kakao.com'),
                        const Divider(height: 24),
                        _InfoRow(label: 'ë“±ë¡ì¼', value: '2026.01.15'),
                        const Divider(height: 24),
                        _InfoRow(label: 'ìë™ ê²°ì œ', value: 'ì‚¬ìš© ì¤‘'),
                      ],
                    ),
                  ),
                  const Spacer(),
                  PrimaryButton(
                    label: 'ì—°ê²° í•´ì œí•˜ê¸°',
                    on_pressed: () {
                      // Implementation for disconnect
                    },
                  ),
                  const SizedBox(height: 12),
                  const Text(
                    'ì—°ê²°ì„ í•´ì œí•˜ë©´ ìŠ¤ë§ˆíŠ¸ì¹´íŠ¸ ìë™ ê²°ì œë¥¼ ì´ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                    style: TextStyle(color: Colors.grey, fontSize: 12),
                    textAlign: TextAlign.center,
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _InfoRow extends StatelessWidget {
  final String label;
  final String value;

  const _InfoRow({required this.label, required this.value});

  @override
  Widget build(BuildContext context) {
    return Row(
      mainAxisAlignment: MainAxisAlignment.spaceBetween,
      children: <Widget>[
        Text(label, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w700)),
        Text(value, style: const TextStyle(fontWeight: FontWeight.w900)),
      ],
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\payment_history_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import 'payment_providers.dart';

class PaymentHistoryScreen extends ConsumerStatefulWidget {
  const PaymentHistoryScreen({super.key});

  @override
  ConsumerState<PaymentHistoryScreen> createState() => _PaymentHistoryScreenState();
}

class _PaymentHistoryScreenState extends ConsumerState<PaymentHistoryScreen> {
  final TextEditingController search_controller = TextEditingController();

  @override
  void dispose() {
    search_controller.dispose();
    super.dispose();
  }

  String _money(int v) {
    final String s = v.toString();
    final StringBuffer b = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final int from_end = s.length - i;
      b.write(s[i]);
      if (from_end > 1 && from_end % 3 == 1) b.write(',');
    }
    return 'â‚©${b.toString()}';
  }

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final DateTime month = ref.watch(payment_month_provider);
    final history_async = ref.watch(payment_history_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ê²°ì œ ë‚´ì—­', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: Padding(
              padding: Responsive.page_padding(context),
              child: Column(
                children: <Widget>[
                  Row(
                    children: <Widget>[
                      Expanded(
                        child: TextField(
                          controller: search_controller,
                          decoration: const InputDecoration(
                            hintText: 'ê±°ë˜ ë‚´ì—­ ê²€ìƒ‰...', 
                            prefixIcon: Icon(Icons.search),
                          ),
                          onChanged: (_) => setState(() {}),
                        ),
                      ),
                      const SizedBox(width: 10),
                      IconButton(
                        onPressed: () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text('í•„í„° ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                          );
                        },
                        icon: const Icon(Icons.tune),
                      ),
                    ],
                  ),
                  const SizedBox(height: 12),

                  history_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(24), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (list) {
                      final String q = search_controller.text.trim();
                      final filtered = q.isEmpty
                          ? list
                          : list.where((x) => x.merchant_name.contains(q) || x.category_label.contains(q)).toList();

                      final int total_amount = filtered.fold<int>(0, (p, c) => p + c.amount);
                      final String month_label = '${month.year}ë…„ ${month.month}ì›”';

                      return Expanded(
                        child: SingleChildScrollView(
                          child: Column(
                            children: <Widget>[
                              SectionCard(
                                child: Container(
                                  width: double.infinity,
                                  padding: const EdgeInsets.all(4),
                                  decoration: BoxDecoration(
                                    gradient: LinearGradient(
                                      colors: <Color>[
                                        AppColors.brand_primary.withOpacity(0.85),
                                        AppColors.brand_primary.withOpacity(0.55),
                                      ],
                                    ),
                                    borderRadius: BorderRadius.circular(20),
                                  ),
                                  child: Padding(
                                    padding: const EdgeInsets.all(14),
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: <Widget>[
                                        Text('$month_label ì´ ì§€ì¶œ', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
                                        const SizedBox(height: 8),
                                        Text(_money(total_amount), style: const TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.w900)),
                                        const SizedBox(height: 10),
                                        Container(
                                          padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                          decoration: BoxDecoration(
                                            color: Colors.white.withOpacity(0.18),
                                            borderRadius: BorderRadius.circular(12),
                                          ),
                                          child: Text('${month.month}ì›” 1ì¼ ~ ${month.month}ì›” 31ì¼', style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w800, fontSize: 12)),
                                        ),
                                      ],
                                    ),
                                  ),
                                ),
                              ),
                              const SizedBox(height: 12),

                              ...filtered.map((it) {
                                final String date_label = '${it.paid_at.month}ì›” ${it.paid_at.day}ì¼ Â· ${it.paid_at.hour.toString().padLeft(2, '0')}:${it.paid_at.minute.toString().padLeft(2, '0')}';
                                return Padding(
                                  padding: const EdgeInsets.only(bottom: 10),
                                  child: SectionCard(
                                    child: Row(
                                      children: <Widget>[
                                        Container(
                                          width: 44,
                                          height: 44,
                                          decoration: BoxDecoration(
                                            color: AppColors.border.withOpacity(0.35),
                                            borderRadius: BorderRadius.circular(14),
                                          ),
                                          child: const Icon(Icons.storefront, color: AppColors.brand_primary),
                                        ),
                                        const SizedBox(width: 12),
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment: CrossAxisAlignment.start,
                                            children: <Widget>[
                                              Text(it.merchant_name, style: const TextStyle(fontWeight: FontWeight.w900)),
                                              const SizedBox(height: 4),
                                              Text('$date_label Â· ${it.category_label}', style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                            ],
                                          ),
                                        ),
                                        Column(
                                          crossAxisAlignment: CrossAxisAlignment.end,
                                          children: <Widget>[
                                            Text(_money(it.amount), style: const TextStyle(fontWeight: FontWeight.w900)),
                                            const SizedBox(height: 8),
                                            OutlinedButton(
                                              onPressed: () => context.push(AppRoutes.digital_receipt, extra: <String, dynamic>{'receipt_id': it.receipt_id}),
                                              style: OutlinedButton.styleFrom(
                                                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                                                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                                              ),
                                              child: const Text('ì˜ìˆ˜ì¦'),
                                            ),
                                          ],
                                        ),
                                      ],
                                    ),
                                  ),
                                );
                              }),

                              if (filtered.isEmpty)
                                Padding(
                                  padding: const EdgeInsets.only(top: 40),
                                  child: Text('í‘œì‹œí•  ê±°ë˜ ë‚´ì—­ì´ ì—†ì–´ìš”.', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                                ),
                            ],
                          ),
                        ),
                      );
                    },
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\payment_methods_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import 'payment_providers.dart';

class PaymentMethodsScreen extends ConsumerWidget {
  const PaymentMethodsScreen({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);

    final cards_async = ref.watch(payment_cards_provider);
    final wallets_async = ref.watch(payment_wallets_provider);
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      appBar: AppBar(
        title: const Text('ê²°ì œ ìˆ˜ë‹¨', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: SingleChildScrollView(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  SectionCard(
                    child: Row(
                      children: <Widget>[
                        const Icon(Icons.verified_user_outlined, color: AppColors.brand_primary),
                        const SizedBox(width: 10),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: <Widget>[
                              const Text('ì•ˆì „í•œ ê²°ì œ í™˜ê²½', style: TextStyle(fontWeight: FontWeight.w900)),
                              const SizedBox(height: 4),
                              Text(
                                'ê²°ì œ ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì²˜ë¦¬ë˜ë©° ì „ì²´ ì¹´ë“œë²ˆí˜¸ë¥¼ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                                style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 14),

                  Text('ì¹´ë“œ', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                  const SizedBox(height: 8),
                  cards_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ì¹´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (cards) {
                      return Column(
                        children: cards.map((c) {
                          return Padding(
                            padding: const EdgeInsets.only(bottom: 10),
                            child: SectionCard(
                              child: Column(
                                children: <Widget>[
                                  Row(
                                    children: <Widget>[
                                      Container(
                                        width: 44,
                                        height: 32,
                                        decoration: BoxDecoration(
                                          color: AppColors.border.withOpacity(0.35),
                                          borderRadius: BorderRadius.circular(12),
                                        ),
                                        child: Center(child: Text(c.brand_label, style: const TextStyle(fontWeight: FontWeight.w900))),
                                      ),
                                      const SizedBox(width: 12),
                                      Expanded(
                                        child: Column(
                                          crossAxisAlignment: CrossAxisAlignment.start,
                                          children: <Widget>[
                                            Row(
                                              children: <Widget>[
                                                Expanded(
                                                  child: Text(
                                                    '${c.brand_label} Â·Â·Â·Â· ${c.last4}',
                                                    style: const TextStyle(fontWeight: FontWeight.w900),
                                                  ),
                                                ),
                                                if (c.is_primary)
                                                  Container(
                                                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                                    decoration: BoxDecoration(
                                                      color: AppColors.brand_primary.withOpacity(0.12),
                                                      borderRadius: BorderRadius.circular(999),
                                                    ),
                                                    child: const Text('ê¸°ë³¸', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                                  ),
                                              ],
                                            ),
                                            const SizedBox(height: 4),
                                            Text('ë§Œë£Œ ${c.expires_mm_yy}', style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                          ],
                                        ),
                                      ),
                                    ],
                                  ),
                                  const SizedBox(height: 10),
                                  Row(
                                    mainAxisAlignment: MainAxisAlignment.end,
                                    children: <Widget>[
                                      TextButton.icon(
                                        onPressed: () {
                                          ScaffoldMessenger.of(context).showSnackBar(
                                            SnackBar(content: Text('${c.brand_label} ì •ë³´ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.')),
                                          );
                                        },
                                        icon: const Icon(Icons.edit, size: 18),
                                        label: const Text('ìˆ˜ì •'),
                                      ),
                                      TextButton.icon(
                                        onPressed: () {
                                          showDialog<void>(
                                            context: context,
                                            builder: (context) => AlertDialog(
                                              title: const Text('ì¹´ë“œ ì‚­ì œ'),
                                              content: Text('${c.brand_label} Â·Â·Â·Â· ${c.last4} ì¹´ë“œë¥¼ ì‚­ì œí• ê¹Œìš”?'),
                                              actions: <Widget>[
                                                TextButton(onPressed: () => Navigator.pop(context), child: const Text('ì·¨ì†Œ')),
                                                TextButton(
                                                  onPressed: () => Navigator.pop(context),
                                                  child: const Text('ì‚­ì œ', style: TextStyle(color: Colors.red)),
                                                ),
                                              ],
                                            ),
                                          );
                                        },
                                        icon: const Icon(Icons.delete_outline, size: 18, color: Colors.red),
                                        label: const Text('ì‚­ì œ'),
                                      ),
                                    ],
                                  ),
                                ],
                              ),
                            ),
                          );
                        }).toList(),
                      );
                    },
                  ),

                  const SizedBox(height: 10),
                  Text('ì „ìì§€ê°‘', style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900)),
                  const SizedBox(height: 8),
                  wallets_async.when(
                    loading: () => const Padding(padding: EdgeInsets.all(20), child: CircularProgressIndicator()),
                    error: (e, _) => Text('ì§€ê°‘ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e'),
                    data: (wallets) {
                      return Column(
                        children: wallets.map((w) {
                          return Padding(
                            padding: const EdgeInsets.only(bottom: 10),
                            child: SectionCard(
                              child: Row(
                                children: <Widget>[
                                  Container(
                                    width: 44,
                                    height: 44,
                                    decoration: BoxDecoration(
                                      color: AppColors.border.withOpacity(0.35),
                                      borderRadius: BorderRadius.circular(14),
                                    ),
                                    child: Icon(
                                      w.wallet_key == 'kakao_pay' ? Icons.chat_bubble_outline : Icons.account_balance_wallet_outlined,
                                      color: AppColors.brand_primary,
                                    ),
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: <Widget>[
                                        Text(w.label, style: const TextStyle(fontWeight: FontWeight.w900)),
                                        const SizedBox(height: 4),
                                        Text(w.status_label, style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                      ],
                                    ),
                                  ),
                                  if (w.wallet_key == 'kakao_pay') ...<Widget>[
                                    TextButton(
                                      onPressed: () => context.push(AppRoutes.kakao_pay_settings),
                                      child: const Text('ê´€ë¦¬'),
                                    ),
                                    TextButton(
                                      onPressed: () {
                                        showDialog<void>(
                                          context: context,
                                          builder: (context) => AlertDialog(
                                            title: const Text('ì—°ê²° í•´ì œ'),
                                            content: const Text('ì¹´ì¹´ì˜¤í˜ì´ ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'),
                                            actions: <Widget>[
                                              TextButton(onPressed: () => Navigator.pop(context), child: const Text('ì·¨ì†Œ')),
                                              TextButton(
                                                onPressed: () => Navigator.pop(context),
                                                child: const Text('í•´ì œ', style: TextStyle(color: Colors.red)),
                                              ),
                                            ],
                                          ),
                                        );
                                      },
                                      child: const Text('ì—°ê²° í•´ì œ'),
                                    ),
                                  ] else ...<Widget>[
                                    TextButton(
                                      onPressed: () {
                                        ScaffoldMessenger.of(context).showSnackBar(
                                          const SnackBar(content: Text('ì§€ê°‘ ë‚´ì—­ ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                                        );
                                      },
                                      child: const Text('ë‚´ì—­'),
                                    ),
                                    TextButton(
                                      onPressed: () {
                                        ScaffoldMessenger.of(context).showSnackBar(
                                          const SnackBar(content: Text('ì¶©ì „ ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                                        );
                                      },
                                      child: const Text('ì¶©ì „'),
                                    ),
                                  ],
                                ],
                              ),
                            ),
                          );
                        }).toList(),
                      );
                    },
                  ),

                  const SizedBox(height: 80),
                ],
              ),
            ),
          ),
        ),
      ),
      bottomNavigationBar: SafeArea(
        child: Padding(
          padding: const EdgeInsets.fromLTRB(16, 10, 16, 12),
          child: ElevatedButton.icon(
            onPressed: () => context.push(AppRoutes.add_new_card),
            icon: const Icon(Icons.add),
            label: const Text('ìƒˆ ê²°ì œ ìˆ˜ë‹¨ ì¶”ê°€', style: TextStyle(fontWeight: FontWeight.w900)),
            style: ElevatedButton.styleFrom(
              backgroundColor: AppColors.brand_primary,
              foregroundColor: Colors.white,
              padding: const EdgeInsets.symmetric(vertical: 16),
              shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
            ),
          ),
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\presentation\payment_providers.dart
==================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/network/dio_provider.dart';
import '../repository/payment_repository.dart';
import '../repository/payment_repository_impl.dart';
import '../../../domain/models/payment.dart';

final payment_repository_provider = Provider<PaymentRepository>((ref) {
  final dioClient = ref.watch(dioClientProvider);
  return PaymentRepositoryImpl(dioClient);
});

final payment_month_provider = StateProvider<DateTime>((ref) {
  final DateTime now = DateTime.now();
  return DateTime(now.year, now.month, 1);
});

final payment_history_provider = FutureProvider<List<PaymentHistoryItem>>((ref) async {
  final PaymentRepository repo = ref.read(payment_repository_provider);
  final DateTime month = ref.watch(payment_month_provider);
  return repo.fetch_payment_history(month: month);
});

final payment_cards_provider = FutureProvider<List<CardModel>>((ref) async {
  final PaymentRepository repo = ref.read(payment_repository_provider);
  return repo.fetch_cards();
});

final payment_wallets_provider = FutureProvider<List<WalletModel>>((ref) async {
  final PaymentRepository repo = ref.read(payment_repository_provider);
  return repo.fetch_wallets();
});

final receipt_provider = FutureProvider.family<DigitalReceipt, String>((ref, receipt_id) async {
  final PaymentRepository repo = ref.read(payment_repository_provider);
  return repo.fetch_receipt(receipt_id: receipt_id);
});


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\repository\mock_payment_repository.dart
==================================================
import 'dart:async';
import '../../../domain/models/payment.dart';
import 'payment_repository.dart';

class MockPaymentRepository implements PaymentRepository {
  @override
  Future<List<PaymentHistoryItem>> fetch_payment_history({required DateTime month}) async {
    await Future<void>.delayed(const Duration(milliseconds: 250));
    return <PaymentHistoryItem>[
      PaymentHistoryItem(
        payment_id: 'pay_1',
        paid_at: DateTime(month.year, month.month, 24, 18, 42),
        merchant_name: 'ë§ˆíŠ¸ ê²°ì œ',
        category_label: 'ì‹ë£Œí’ˆ',
        amount: 84300,
        receipt_id: 'r_1',
      ),
      PaymentHistoryItem(
        payment_id: 'pay_2',
        paid_at: DateTime(month.year, month.month, 24, 8, 15),
        merchant_name: 'ì¹´í˜',
        category_label: 'ì™¸ì‹',
        amount: 12500,
        receipt_id: 'r_2',
      ),
    ];
  }

  @override
  Future<DigitalReceipt> fetch_receipt({required String receipt_id}) async {
    await Future<void>.delayed(const Duration(milliseconds: 250));
    return DigitalReceipt(
      receipt_id: receipt_id,
      store_name: 'í”¼í´ ìŠ¤í† ì–´ #204',
      paid_at: DateTime(2023, 10, 24, 14, 30),
      ref_code: 'P882-9901',
      items: const <ReceiptItem>[
        ReceiptItem(name: 'ì•„ë³´ì¹´ë„', option_label: 'ìœ ê¸°ë†', qty: 2, price: 4000),
        ReceiptItem(name: 'ì˜¤íŠ¸ë°€ ë°”ë¦¬ìŠ¤íƒ€', option_label: '1L', qty: 1, price: 5500),
        ReceiptItem(name: 'ì‚¬ì›Œë„ìš° ë¹µ', option_label: 'ë² ì´ì»¤ë¦¬', qty: 1, price: 6000),
      ],
      subtotal: 15500,
      tax: 1200,
      total_paid: 16700,
      paid_method_label: 'ë§ˆìŠ¤í„°ì¹´ë“œ (ë 8842)',
    );
  }

  @override
  Future<List<CardModel>> fetch_cards() async {
    await Future<void>.delayed(const Duration(milliseconds: 200));
    return const <CardModel>[
      CardModel(card_id: 'c1', brand_label: 'VISA', last4: '1234', expires_mm_yy: '12/25', is_primary: true),
      CardModel(card_id: 'c2', brand_label: 'Mastercard', last4: '5678', expires_mm_yy: '09/24', is_primary: false),
    ];
  }

  @override
  Future<List<WalletModel>> fetch_wallets() async {
    await Future<void>.delayed(const Duration(milliseconds: 200));
    return const <WalletModel>[
      WalletModel(wallet_key: 'kakao_pay', label: 'ì¹´ì¹´ì˜¤í˜ì´', status_label: 'ì—°ê²°ë¨'),
      WalletModel(wallet_key: 'pickle_cash', label: 'í”¼í´ ìºì‹œ', status_label: 'â‚©45,500 ì‚¬ìš© ê°€ëŠ¥'),
    ];
  }

  @override
  Future<String> register_card({
    required String card_number,
    required String expires_mm_yy,
    required String cvc,
    required String cardholder_name,
    required bool save_card,
  }) async {
    await Future<void>.delayed(const Duration(milliseconds: 400));
    return 'c_new';
  }

  @override
  Future<PaymentReadyResponse> prepare_kakao_pay({
    required int amount,
    required int cart_session_id,
    required int using_points,
    required String? coupon_id,
  }) async {
    await Future<void>.delayed(const Duration(milliseconds: 400));
    // Mock response that simulates a ready state
    // Note: The URLs here are fake. In a real mock flow, we can't really open a WebView to these.
    // So this Mock is mainly for unit testing logic around the call, not the actual flow.
    return const PaymentReadyResponse(
      tid: 'mock_tid_123',
      next_redirect_app_url: 'https://mock.kakao.com/app',
      next_redirect_mobile_url: 'https://mock.kakao.com/mobile',
      next_redirect_pc_url: 'https://mock.kakao.com/pc',
    );
  }

  @override
  Future<String> approve_kakao_pay({
    required String tid,
    required String pg_token,
  }) async {
    await Future<void>.delayed(const Duration(milliseconds: 400));
    return 'r_mock_receipt_id';
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\repository\payment_repository.dart
==================================================
import '../../../domain/models/payment.dart';

abstract class PaymentRepository {
  Future<List<PaymentHistoryItem>> fetch_payment_history({required DateTime month});
  Future<DigitalReceipt> fetch_receipt({required String receipt_id});

  Future<List<CardModel>> fetch_cards();
  Future<List<WalletModel>> fetch_wallets();

  Future<String> register_card({
    required String card_number,
    required String expires_mm_yy,
    required String cvc,
    required String cardholder_name,
    required bool save_card,
  });

  // Step 1: ê²°ì œ ì¤€ë¹„ (Returns PaymentReadyResponse with URL & TID)
  Future<PaymentReadyResponse> prepare_kakao_pay({
    required int cart_session_id,
    required int amount,
    required int using_points,
    required String? coupon_id,
  });

  // Step 2: ê²°ì œ ìŠ¹ì¸ (Returns Receipt ID)
  Future<String> approve_kakao_pay({
    required String tid,
    required String pg_token,
  });
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\payment\repository\payment_repository_impl.dart
==================================================
import '../../../core/network/dio_client.dart';
import '../../../domain/models/payment.dart';
import 'payment_repository.dart';

class PaymentRepositoryImpl implements PaymentRepository {
  final DioClient _dioClient;

  PaymentRepositoryImpl(this._dioClient);

  @override
  Future<List<PaymentHistoryItem>> fetch_payment_history({required DateTime month}) async {
    // TODO: Implement fetch_payment_history (ë°±ì—”ë“œ /api/ledger/recent ë“± í™œìš©)
    return [];
  }

  @override
  Future<DigitalReceipt> fetch_receipt({required String receipt_id}) async {
    try {
      // receipt_idëŠ” payment_idì™€ ë™ì¼
      final response = await _dioClient.dio.get('/payments/$receipt_id');
      final data = response.data;
      
      final List<ReceiptItem> items = [];
      if (data['items'] != null) {
        for (var item in data['items']) {
          final product = item['product'];
          items.add(ReceiptItem(
            name: product['name'],
            option_label: '', // í•„ìš”ì‹œ ë¬´ê²Œ ì •ë³´ ë“± íŒŒì‹±
            qty: item['quantity'],
            price: item['unit_price'],
          ));
        }
      }
      
      final int totalAmount = data['total_amount'] ?? 0;
      
      // ì„¸ê¸ˆ ê³„ì‚° (ì„ì˜ë¡œ 10%)
      final int tax = (totalAmount * 0.1).round();
      final int subtotal = totalAmount - tax;
      
      return DigitalReceipt(
        receipt_id: data['payment_id'].toString(),
        store_name: "í”¼í´ ìŠ¤í† ì–´", // ê³ ì •ê°’
        paid_at: DateTime.parse(data['approved_at'] ?? DateTime.now().toIso8601String()),
        ref_code: data['pg_tid'] ?? "REF-UNKNOWN",
        items: items,
        subtotal: subtotal,
        tax: tax,
        total_paid: totalAmount,
        paid_method_label: data['pg_provider'] == 'KAKAO_PAY' ? 'ì¹´ì¹´ì˜¤í˜ì´' : 'ì¹´ë“œ',
      );
      
    } catch (e) {
      throw Exception('ì˜ìˆ˜ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $e');
    }
  }

  @override
  Future<List<CardModel>> fetch_cards() async {
    // TODO: Implement fetch_cards
    return [];
  }

  @override
  Future<List<WalletModel>> fetch_wallets() async {
    // TODO: Implement fetch_wallets
    return [];
  }

  @override
  Future<String> register_card({
    required String card_number,
    required String expires_mm_yy,
    required String cvc,
    required String cardholder_name,
    required bool save_card,
  }) async {
    // TODO: Implement register_card
    return "card_id_123";
  }

  @override
  Future<PaymentReadyResponse> prepare_kakao_pay({
    required int cart_session_id,
    required int amount,
    required int using_points,
    required String? coupon_id,
  }) async {
    try {
      final response = await _dioClient.dio.post(
        '/payments/ready',
        data: {
          "cart_session_id": cart_session_id,
          "total_amount": amount,
          "method_id": null // ì¹´ì¹´ì˜¤í˜ì´ëŠ” method_id null
        },
      );

      return PaymentReadyResponse.fromJson(response.data);
    } catch (e) {
      throw Exception('ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨: $e');
    }
  }

  @override
  Future<String> approve_kakao_pay({
    required String tid,
    required String pg_token,
  }) async {
    try {
      final response = await _dioClient.dio.post(
        '/payments/approve',
        data: {
          "tid": tid,
          "pg_token": pg_token,
        },
      );
      
      // ê²°ì œ ì„±ê³µ ì‹œ Payment ê°ì²´ ë°˜í™˜ë¨ (payment_id í¬í•¨)
      final int paymentId = response.data['payment_id'];
      return paymentId.toString();
    } catch (e) {
      throw Exception('ì¹´ì¹´ì˜¤í˜ì´ ê²°ì œ ìŠ¹ì¸ ì‹¤íŒ¨: $e');
    }
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\product\presentation\product_detail_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

import '../../../core/theme/app_colors.dart';
import '../../../core/utils/responsive.dart';
import '../../../shared/widgets/section_card.dart';

import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/utils/responsive.dart';
import '../../../shared/widgets/section_card.dart';
import 'product_providers.dart';

class ProductDetailScreen extends ConsumerWidget {
  final String product_id;

  const ProductDetailScreen({super.key, required this.product_id});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);
    final product_async = ref.watch(product_repository_provider).fetch_product_detail(product_id: product_id);

    return Scaffold(
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: FutureBuilder(
              future: product_async,
              builder: (context, snapshot) {
                if (snapshot.connectionState == ConnectionState.waiting) {
                  return const Center(child: CircularProgressIndicator());
                }
                if (snapshot.hasError) {
                  return Center(child: Text('ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${snapshot.error}'));
                }
                final product = snapshot.data!;

                return CustomScrollView(
                  slivers: <Widget>[
                    SliverAppBar(
                      pinned: true,
                      leading: IconButton(onPressed: () => context.pop(), icon: const Icon(Icons.arrow_back)),
                      actions: <Widget>[
                        IconButton(
                          onPressed: () {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(content: Text('ìƒí’ˆ ê³µìœ  ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                            );
                          },
                          icon: const Icon(Icons.ios_share),
                        ),
                      ],
                      expandedHeight: 240,
                      flexibleSpace: FlexibleSpaceBar(
                        background: Container(
                          color: Colors.black.withOpacity(0.05),
                          child: const Center(child: Icon(Icons.image_outlined, size: 64)),
                        ),
                      ),
                    ),
                    SliverToBoxAdapter(
                      child: Padding(
                        padding: Responsive.page_padding(context),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            SectionCard(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  Row(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: <Widget>[
                                      Expanded(
                                        child: Text(product.name, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
                                      ),
                                      Text('â‚©${product.price}',
                                          style: const TextStyle(fontSize: 18, fontWeight: FontWeight.w900, color: AppColors.brand_primary)),
                                    ],
                                  ),
                                  const SizedBox(height: 8),
                                  Wrap(
                                    spacing: 8,
                                    runSpacing: 8,
                                    children: <Widget>[
                                      _InfoPill(label: product.is_in_stock ? 'ì¬ê³  ìˆìŒ' : 'í’ˆì ˆ', icon: Icons.check_circle_outline),
                                      _InfoPill(label: product.aisle_label, icon: Icons.location_on_outlined),
                                    ],
                                  ),
                                  const SizedBox(height: 14),
                                  const Text('ë§¤ì¥ ì§€ë„', style: TextStyle(fontWeight: FontWeight.w900)),
                                  const SizedBox(height: 8),
                                  Container(
                                    height: 170,
                                    decoration: BoxDecoration(
                                      color: AppColors.border.withOpacity(0.35),
                                      borderRadius: BorderRadius.circular(18),
                                    ),
                                    child: const Center(child: Text('ì§€ë„ ë°ì´í„°(ì˜ˆ: ì¡´/í†µë¡œ ì¢Œí‘œ)ë¥¼ ë°›ì•„ ë Œë”ë§')),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(height: 14),
                            SectionCard(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: <Widget>[
                                  const Text('ì„¤ëª…', style: TextStyle(fontWeight: FontWeight.w900)),
                                  const SizedBox(height: 8),
                                  Text(
                                    'ì´ ìƒí’ˆì€ ${product.name}ì…ë‹ˆë‹¤. ${product.aisle_label}ì—ì„œ ë§Œë‚˜ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                                    style: TextStyle(color: AppColors.text_secondary),
                                  ),
                                  const SizedBox(height: 12),
                                  InkWell(
                                    onTap: () {
                                      ScaffoldMessenger.of(context).showSnackBar(
                                        const SnackBar(content: Text('ì˜ì–‘ ì„±ë¶„ ì •ë³´ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                                      );
                                    },
                                    borderRadius: BorderRadius.circular(16),
                                    child: Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 14),
                                      decoration: BoxDecoration(
                                        borderRadius: BorderRadius.circular(16),
                                        color: AppColors.brand_primary.withOpacity(0.10),
                                      ),
                                      child: const Row(
                                        children: <Widget>[
                                          Icon(Icons.eco_outlined, color: AppColors.brand_primary),
                                          SizedBox(width: 10),
                                          Expanded(child: Text('ì˜ì–‘ ì •ë³´', style: TextStyle(fontWeight: FontWeight.w700))),
                                          Icon(Icons.keyboard_arrow_down),
                                        ],
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(height: 14),
                            Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: <Widget>[
                                const Text('ê´€ë ¨ ìƒí’ˆ', style: TextStyle(fontWeight: FontWeight.w900)),
                                TextButton(
                                  onPressed: () => context.push(AppRoutes.product_search),
                                  child: const Text('ì „ì²´ ë³´ê¸°'),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8),
                            SizedBox(
                              height: 140,
                              child: FutureBuilder(
                                future: ref.watch(product_repository_provider).fetch_related_products(product_id: product_id),
                                builder: (context, snapshot) {
                                  if (!snapshot.hasData) return const SizedBox();
                                  final related = snapshot.data!;
                                  return ListView.separated(
                                    scrollDirection: Axis.horizontal,
                                    itemBuilder: (BuildContext context, int i) {
                                      final item = related[i];
                                      return _RelatedProductTile(
                                        title: item.name,
                                        price: 'â‚©${item.price}',
                                        on_tap: () => context.push(AppRoutes.product_detail, extra: {'product_id': item.product_id}),
                                      );
                                    },
                                    separatorBuilder: (_, __) => const SizedBox(width: 12),
                                    itemCount: related.length,
                                  );
                                },
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ],
                );
              },
            ),
          ),
        ),
      ),
    );
  }
}

class _InfoPill extends StatelessWidget {
  final String label;
  final IconData icon;

  const _InfoPill({required this.label, required this.icon});

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
      decoration: BoxDecoration(
        color: AppColors.border.withOpacity(0.35),
        borderRadius: BorderRadius.circular(999),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: <Widget>[
          Icon(icon, size: 16, color: AppColors.brand_primary),
          const SizedBox(width: 6),
          Text(label, style: const TextStyle(fontWeight: FontWeight.w800)),
        ],
      ),
    );
  }
}

class _RelatedProductTile extends StatelessWidget {

  final String title;

  final String price;

  final VoidCallback on_tap;



  const _RelatedProductTile({required this.title, required this.price, required this.on_tap});



  @override

  Widget build(BuildContext context) {

    return SizedBox(

      width: 140,

      child: InkWell(

        onTap: on_tap,

        borderRadius: BorderRadius.circular(20),

        child: Card(

          child: Padding(

            padding: const EdgeInsets.all(10),

            child: Column(

              crossAxisAlignment: CrossAxisAlignment.start,

              children: <Widget>[

                Expanded(

                  child: Container(

                    decoration: BoxDecoration(

                      color: AppColors.border.withOpacity(0.35),

                      borderRadius: BorderRadius.circular(14),

                    ),

                    child: const Center(child: Icon(Icons.image_outlined)),

                  ),

                ),

                const SizedBox(height: 8),

                Text(title, maxLines: 1, overflow: TextOverflow.ellipsis, style: const TextStyle(fontWeight: FontWeight.w900)),

                const SizedBox(height: 4),

                Text(price, style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w800, fontSize: 12)),

              ],

            ),

          ),

        ),

      ),

    );

  }

}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\product\presentation\product_providers.dart
==================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../repository/http_product_repository.dart';
import '../repository/product_repository.dart';
import '../../../domain/models/product.dart';
import '../../../core/network/dio_provider.dart';

final product_repository_provider = Provider<ProductRepository>((ref) {
  final dioClient = ref.watch(dioClientProvider);
  return HttpProductRepository(dio: dioClient.dio);
});

final search_query_provider = StateProvider<String>((ref) => '');

final search_results_provider = FutureProvider<List<Product>>((ref) async {
  final query = ref.watch(search_query_provider);
  final repository = ref.watch(product_repository_provider);
  
  // For simplicity, we'll just pass 'on_sale' as default category if we don't have a category provider yet
  return repository.search_products(query: query, category_key: 'on_sale');
});


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\product\presentation\product_search_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';

import '../../../core/router/app_routes.dart';
import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/bottom_nav.dart';

import 'product_providers.dart';

class ProductSearchScreen extends ConsumerStatefulWidget {
  const ProductSearchScreen({super.key});

  @override
  ConsumerState<ProductSearchScreen> createState() => _ProductSearchScreenState();
}

class _ProductSearchScreenState extends ConsumerState<ProductSearchScreen> {
  late final TextEditingController search_controller;
  BottomTab current_tab = BottomTab.search;

  String selected_category_key = 'on_sale'; 

  @override
  void initState() {
    super.initState();
    search_controller = TextEditingController();
  }

  @override
  void dispose() {
    search_controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final double max_w = Responsive.max_width(context);
    final search_results = ref.watch(search_results_provider);

    return Scaffold(
      appBar: AppBar(
        leading: IconButton(onPressed: () => context.go(AppRoutes.home), icon: const Icon(Icons.arrow_back)),
        title: const Text('ìƒí’ˆ ê²€ìƒ‰', style: TextStyle(fontWeight: FontWeight.w900)),
      ),
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: Padding(
              padding: Responsive.page_padding(context),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: <Widget>[
                  TextField(
                    controller: search_controller,
                    textInputAction: TextInputAction.search,
                    decoration: const InputDecoration(
                      hintText: "ì˜ˆ: 'ìœ ê¸°ë† ì•„ë³´ì¹´ë„' ë˜ëŠ” 'ìš°ìœ '",
                      prefixIcon: Icon(Icons.search),
                    ),
                    onSubmitted: (value) {
                      ref.read(search_query_provider.notifier).state = value;
                    },
                  ),
                  const SizedBox(height: 12),
                  SingleChildScrollView(
                    scrollDirection: Axis.horizontal,
                    child: Row(
                      children: <Widget>[
                        _CategoryChip(
                          label: 'í• ì¸',
                          is_selected: selected_category_key == 'on_sale',
                          on_tap: () => setState(() => selected_category_key = 'on_sale'),
                        ),
                        _CategoryChip(
                          label: 'ì±„ì†Œ',
                          is_selected: selected_category_key == 'vegetables',
                          on_tap: () => setState(() => selected_category_key = 'vegetables'),
                        ),
                        _CategoryChip(
                          label: 'ìœ ì œí’ˆ',
                          is_selected: selected_category_key == 'dairy',
                          on_tap: () => setState(() => selected_category_key = 'dairy'),
                        ),
                        _CategoryChip(
                          label: 'ê°„ì‹',
                          is_selected: selected_category_key == 'snacks',
                          on_tap: () => setState(() => selected_category_key = 'snacks'),
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 16),

                  Row(
                    children: <Widget>[
                      const Text('AI ì¶”ì²œ', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900)),
                      const SizedBox(width: 8),
                      Text('ìµœê·¼ êµ¬ë§¤ ê¸°ë°˜', style: TextStyle(color: AppColors.brand_primary, fontSize: 12, fontWeight: FontWeight.w700)),
                    ],
                  ),
                  const SizedBox(height: 10),
                  SectionCard(
                    child: Row(
                      children: <Widget>[
                        Container(
                          width: 44,
                          height: 44,
                          decoration: BoxDecoration(
                            color: AppColors.brand_primary.withOpacity(0.12),
                            borderRadius: BorderRadius.circular(14),
                          ),
                          child: const Icon(Icons.eco_outlined, color: AppColors.brand_primary),
                        ),
                        const SizedBox(width: 12),
                        const Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: <Widget>[
                              Text('ìœ ê¸°ë† í† ë§ˆí† (AI ì¶”ì²œ)', style: TextStyle(fontWeight: FontWeight.w900)),
                              SizedBox(height: 4),
                              Text('ìì£¼ êµ¬ë§¤í•˜ì‹œëŠ” ìƒí’ˆì…ë‹ˆë‹¤.', maxLines: 1, overflow: TextOverflow.ellipsis),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(height: 16),
                  Row(
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: <Widget>[
                      const Text('ê²€ìƒ‰ ê²°ê³¼', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900)),
                      TextButton.icon(
                        onPressed: () {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text('ìƒì„¸ í•„í„° ì„¤ì •ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                          );
                        },
                        icon: const Icon(Icons.tune, size: 18),
                        label: const Text('í•„í„°'),
                      ),
                    ],
                  ),
                  const SizedBox(height: 10),

                  Expanded(
                    child: search_results.when(
                      loading: () => const Center(child: CircularProgressIndicator()),
                      error: (err, stack) => Center(child: Text('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: $err')),
                      data: (items) {
                        if (items.isEmpty) {
                          return const Center(child: Text('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'));
                        }
                        return LayoutBuilder(
                          builder: (BuildContext context, BoxConstraints c) {
                            final double w = c.maxWidth;
                            final int cross_axis_count = w >= 520 ? 3 : 2;
                            const double child_aspect_ratio = 0.85;

                            return GridView.builder(
                              itemCount: items.length,
                              gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                                crossAxisCount: cross_axis_count,
                                crossAxisSpacing: 12,
                                mainAxisSpacing: 12,
                                childAspectRatio: child_aspect_ratio,
                              ),
                              itemBuilder: (BuildContext context, int i) {
                                final item = items[i];
                                return _ProductTile(
                                  name: item.name,
                                  price_label: 'â‚©${item.price}',
                                  on_tap: () => context.push(AppRoutes.product_detail, extra: <String, dynamic>{'product_id': item.product_id}),
                                );
                              },
                            );
                          },
                        );
                      },
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
      bottomNavigationBar: BottomNav(
        current_tab: current_tab,
        on_tab_selected: (BottomTab next) {
          setState(() => current_tab = next);
          if (next == BottomTab.home) context.go(AppRoutes.home);
          if (next == BottomTab.search) context.go(AppRoutes.product_search);
          if (next == BottomTab.scan) context.push(AppRoutes.qr_scanner);
          if (next == BottomTab.account_book) context.go(AppRoutes.spending_overview);
          if (next == BottomTab.my_page) context.go(AppRoutes.my_page);
        },
      ),
    );
  }
}

class _CategoryChip extends StatelessWidget {
  final String label;
  final bool is_selected;
  final VoidCallback on_tap;

  const _CategoryChip({required this.label, required this.is_selected, required this.on_tap});

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(right: 10),
      child: InkWell(
        onTap: on_tap,
        borderRadius: BorderRadius.circular(999),
        child: Container(
          padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
          decoration: BoxDecoration(
            color: is_selected ? AppColors.brand_primary : Colors.white,
            borderRadius: BorderRadius.circular(999),
            border: Border.all(color: is_selected ? AppColors.brand_primary : AppColors.border),
          ),
          child: Text(
            label,
            style: TextStyle(
              color: is_selected ? Colors.white : AppColors.text_primary,
              fontWeight: FontWeight.w800,
              fontSize: 12,
            ),
          ),
        ),
      ),
    );
  }
}

class _ProductTile extends StatelessWidget {
  final String name;
  final String price_label;
  final VoidCallback on_tap;

  const _ProductTile({required this.name, required this.price_label, required this.on_tap});

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: on_tap,
      borderRadius: BorderRadius.circular(20),
      child: Card(
        child: Padding(
          padding: const EdgeInsets.all(12),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: <Widget>[
              Expanded(
                child: Container(
                  decoration: BoxDecoration(
                    color: AppColors.border.withOpacity(0.35),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: const Center(child: Icon(Icons.image_outlined)),
                ),
              ),
              const SizedBox(height: 10),
              Text(name, style: const TextStyle(fontWeight: FontWeight.w900)),
              const SizedBox(height: 6),
              Text(price_label, style: const TextStyle(fontWeight: FontWeight.w900, color: AppColors.brand_primary)),
              // Removed + button from product tile
            ],
          ),
        ),
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\product\repository\http_product_repository.dart
==================================================
import 'package:dio/dio.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import '../../../domain/models/product.dart';
import 'product_repository.dart';

class HttpProductRepository implements ProductRepository {
  final Dio _dio;

  HttpProductRepository({Dio? dio}) : _dio = dio ?? Dio(BaseOptions(
    baseUrl: dotenv.env['API_URL'] ?? 'http://localhost:8000',
    connectTimeout: const Duration(seconds: 5),
    receiveTimeout: const Duration(seconds: 3),
  ));

  @override
  Future<List<Product>> fetch_recommendations() async {
    // TODO: ë°±ì—”ë“œ ì¶”ì²œ API êµ¬í˜„ ì‹œ ì—°ë™ (í˜„ì¬ëŠ” ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)
    return [];
  }

  @override
  Future<List<Product>> search_products({required String query, required String category_key}) async {
    try {
      final response = await _dio.get('/api/products/search', queryParameters: {
        'q': query,
        'category_key': category_key,
      });

      if (response.statusCode == 200) {
        final List<dynamic> data = response.data;
        return data.map((json) => Product.fromJson(json)).toList();
      }
      return [];
    } catch (e) {
      print('Error searching products: $e');
      // ì—ëŸ¬ ë°œìƒ ì‹œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ (ë˜ëŠ” ì˜ˆì™¸ throw)
      return [];
    }
  }

  @override
  Future<Product> fetch_product_detail({required String product_id}) async {
    try {
      final response = await _dio.get('/api/products/$product_id');

      if (response.statusCode == 200) {
        return Product.fromJson(response.data);
      }
      throw Exception('Failed to load product detail');
    } catch (e) {
      print('Error fetching product detail: $e');
      throw e;
    }
  }

  @override
  Future<List<Product>> fetch_related_products({required String product_id}) async {
    // TODO: ë°±ì—”ë“œ ì—°ë™ (í˜„ì¬ëŠ” ë¹ˆ ë¦¬ìŠ¤íŠ¸)
    return [];
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\product\repository\product_repository.dart
==================================================
import '../../../domain/models/product.dart';

abstract class ProductRepository {
  Future<List<Product>> fetch_recommendations();
  Future<List<Product>> search_products({required String query, required String category_key});
  Future<Product> fetch_product_detail({required String product_id});
  Future<List<Product>> fetch_related_products({required String product_id});
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\recipe\presentation\recipe_detail_screen.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import '../../../core/utils/responsive.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/theme/theme_provider.dart';
import '../../../shared/widgets/section_card.dart';
import '../../../shared/widgets/primary_button.dart';
import 'recipe_providers.dart';

class RecipeDetailScreen extends ConsumerWidget {
  final String recipe_id;

  const RecipeDetailScreen({super.key, required this.recipe_id});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final double max_w = Responsive.max_width(context);
    final detail_async = ref.watch(recipe_detail_provider(recipe_id));
    final theme_mode = ref.watch(theme_mode_provider);

    return Scaffold(
      body: SafeArea(
        child: Center(
          child: ConstrainedBox(
            constraints: BoxConstraints(maxWidth: max_w),
            child: detail_async.when(
              loading: () => const Center(child: CircularProgressIndicator()),
              error: (e, _) => Center(child: Text('ë ˆì‹œí”¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.\n$e')),
              data: (d) {
                return CustomScrollView(
                  slivers: <Widget>[
                    SliverAppBar(
                      pinned: true,
                      title: const Text('ë ˆì‹œí”¼ ìƒì„¸', style: TextStyle(fontWeight: FontWeight.w900)),
                      actions: <Widget>[
                        IconButton(
                          onPressed: () {
                            ScaffoldMessenger.of(context).showSnackBar(
                              const SnackBar(content: Text('ë ˆì‹œí”¼ ê³µìœ  ê¸°ëŠ¥ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')),
                            );
                          },
                          icon: const Icon(Icons.share),
                        ),
                      ],
                      expandedHeight: 240,
                      flexibleSpace: FlexibleSpaceBar(
                        background: Container(
                          color: Colors.black.withOpacity(0.06),
                          child: Stack(
                            children: <Widget>[
                              const Center(child: Icon(Icons.image_outlined, size: 70)),
                              Positioned(
                                left: 16,
                                bottom: 18,
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: <Widget>[
                                    Container(
                                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                      decoration: BoxDecoration(
                                        color: AppColors.brand_primary.withOpacity(0.12),
                                        borderRadius: BorderRadius.circular(999),
                                      ),
                                      child: const Text('í”¼í´ ì¶”ì²œ', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                    ),
                                    const SizedBox(height: 8),
                                    Text(d.title, style: const TextStyle(fontSize: 22, fontWeight: FontWeight.w900)),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                    SliverToBoxAdapter(
                      child: Padding(
                        padding: Responsive.page_padding(context),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: <Widget>[
                            Row(
                              children: <Widget>[
                                Expanded(child: _metric(label: 'ì‹œê°„', value: '${d.prep_time_min}ë¶„')),
                                const SizedBox(width: 10),
                                Expanded(child: _metric(label: 'ë‚œì´ë„', value: d.difficulty_label)),
                                const SizedBox(width: 10),
                                Expanded(child: _metric(label: 'ì¹¼ë¡œë¦¬', value: '${d.calories}kcal')),
                              ],
                            ),
                            const SizedBox(height: 14),

                            Row(
                              children: <Widget>[
                                const Expanded(child: Text('ì¬ë£Œ', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900))),
                                Container(
                                  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                  decoration: BoxDecoration(
                                    color: AppColors.brand_primary.withOpacity(0.12),
                                    borderRadius: BorderRadius.circular(999),
                                  ),
                                  child: const Text('ì¹´íŠ¸ ë™ê¸°í™” ì¼¬', style: TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900, fontSize: 12)),
                                ),
                              ],
                            ),
                            const SizedBox(height: 10),
                            SectionCard(
                              child: Column(
                                children: d.ingredients.map((ing) {
                                  return Padding(
                                    padding: const EdgeInsets.symmetric(vertical: 10),
                                    child: Row(
                                      children: <Widget>[
                                        Icon(
                                          ing.is_available ? Icons.check_circle : Icons.radio_button_unchecked,
                                          color: ing.is_available ? AppColors.brand_primary : AppColors.text_secondary,
                                        ),
                                        const SizedBox(width: 10),
                                        Expanded(
                                          child: Column(
                                            crossAxisAlignment: CrossAxisAlignment.start,
                                            children: <Widget>[
                                              Text(ing.name, style: const TextStyle(fontWeight: FontWeight.w900)),
                                              const SizedBox(height: 4),
                                              Text(ing.status_label, style: TextStyle(color: AppColors.text_secondary, fontSize: 12, fontWeight: FontWeight.w800)),
                                            ],
                                          ),
                                        ),
                                        if (!ing.is_available)
                                          InkWell(
                                            onTap: () {
                                              ScaffoldMessenger.of(context).showSnackBar(
                                                SnackBar(content: Text('${ing.name}ì„(ë¥¼) ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤.')),
                                              );
                                            },
                                            borderRadius: BorderRadius.circular(12),
                                            child: Container(
                                              width: 36,
                                              height: 36,
                                              decoration: BoxDecoration(
                                                color: AppColors.brand_primary.withOpacity(0.12),
                                                borderRadius: BorderRadius.circular(12),
                                              ),
                                              child: const Icon(Icons.shopping_cart_outlined, color: AppColors.brand_primary, size: 18),
                                            ),
                                          ),
                                      ],
                                    ),
                                  );
                                }).toList(),
                              ),
                            ),
                            const SizedBox(height: 12),
                            PrimaryButton(
                              label: 'ìš”ë¦¬ ëª¨ë“œ ì‹œì‘',
                              on_pressed: () {
                                ScaffoldMessenger.of(context).showSnackBar(
                                  const SnackBar(content: Text('ìš”ë¦¬ ëª¨ë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.')),
                                );
                              },
                              leading: const Icon(Icons.play_arrow),
                            ),
                            const SizedBox(height: 18),

                            const Text('ì¡°ë¦¬ ë°©ë²•', style: TextStyle(fontSize: 16, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 10),
                            ...d.steps.map((s) {
                              return Padding(
                                padding: const EdgeInsets.only(bottom: 12),
                                child: SectionCard(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: <Widget>[
                                      Row(
                                        children: <Widget>[
                                          Container(
                                            width: 28,
                                            height: 28,
                                            decoration: BoxDecoration(
                                              color: AppColors.brand_primary.withOpacity(0.12),
                                              borderRadius: BorderRadius.circular(10),
                                            ),
                                            alignment: Alignment.center,
                                            child: Text('${s.order}', style: const TextStyle(color: AppColors.brand_primary, fontWeight: FontWeight.w900)),
                                          ),
                                          const SizedBox(width: 10),
                                          Expanded(child: Text(s.title, style: const TextStyle(fontWeight: FontWeight.w900))),
                                        ],
                                      ),
                                      const SizedBox(height: 10),
                                      Container(
                                        height: 140,
                                        decoration: BoxDecoration(
                                          color: AppColors.border.withOpacity(0.35),
                                          borderRadius: BorderRadius.circular(16),
                                        ),
                                        child: const Center(child: Icon(Icons.image_outlined)),
                                      ),
                                      const SizedBox(height: 10),
                                      Text(s.description, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w800)),
                                    ],
                                  ),
                                ),
                              );
                            }).toList(),

                            const SizedBox(height: 30),
                          ],
                        ),
                      ),
                    ),
                  ],
                );
              },
            ),
          ),
        ),
      ),
    );
  }

  Widget _metric({required String label, required String value}) {
    return SectionCard(
      padding: const EdgeInsets.all(12),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: <Widget>[
          Text(label, style: TextStyle(color: AppColors.text_secondary, fontWeight: FontWeight.w900, fontSize: 12)),
          const SizedBox(height: 6),
          Text(value, style: const TextStyle(fontWeight: FontWeight.w900)),
        ],
      ),
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\recipe\presentation\recipe_providers.dart
==================================================
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../../core/network/dio_provider.dart';
import '../../cart/presentation/cart_providers.dart';
import '../repository/recipe_repository.dart';
import '../repository/http_recipe_repository.dart';
import '../../../domain/models/recipe.dart';

final recipe_repository_provider = Provider<RecipeRepository>((ref) {
  final dioClient = ref.watch(dioClientProvider);
  return HttpRecipeRepository(dio: dioClient.dio);
});

final recipe_filter_provider = StateProvider<String>((ref) => 'top_matches');

final recipes_from_cart_provider = FutureProvider<List<RecipeCardModel>>((ref) async {
  final RecipeRepository repo = ref.read(recipe_repository_provider);
  final String filter_key = ref.watch(recipe_filter_provider);
  return repo.fetch_recipes_from_cart(filter_key: filter_key);
});

final recipes_you_can_cook_now_provider = FutureProvider<List<RecipeCardModel>>((ref) async {
  final RecipeRepository repo = ref.read(recipe_repository_provider);
  
  // ì¥ë°”êµ¬ë‹ˆ ìƒíƒœ êµ¬ë…
  final cartAsync = ref.watch(cart_summary_provider);
  
  // ì¥ë°”êµ¬ë‹ˆ ë°ì´í„°ê°€ ë¡œë“œë˜ì—ˆê³  ì•„ì´í…œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¶”ì²œ ë¡œì§ ì‹¤í–‰
  return cartAsync.maybeWhen(
    data: (cart) {
      if (cart.items.isNotEmpty) {
        // ê°€ì¥ ìµœê·¼ì— ë‹´ì€(ë˜ëŠ” ì²«ë²ˆì§¸) ìƒí’ˆ ID ì‚¬ìš©
        // cart.items ìˆœì„œê°€ ì¤‘ìš”í•˜ë‹¤ë©´ ì •ë ¬ í•„ìš”. ì—¬ê¸°ì„œëŠ” ì²«ë²ˆì§¸ ì•„ì´í…œ ì‚¬ìš©
        try {
          final int productId = int.parse(cart.items.first.product_id);
          return repo.fetch_recipes_you_can_cook_now(basedOnProductId: productId);
        } catch (e) {
          return [];
        }
      }
      return [];
    },
    orElse: () => [],
  );
});

final recipe_detail_provider = FutureProvider.family<RecipeDetailModel, String>((ref, recipe_id) async {
  final RecipeRepository repo = ref.read(recipe_repository_provider);
  return repo.fetch_recipe_detail(recipe_id: recipe_id);
});

==================================================
FILE PATH: .\frontend\mobile-app\lib\features\recipe\repository\http_recipe_repository.dart
==================================================
import 'package:dio/dio.dart';
import '../../../domain/models/recipe.dart';
import 'recipe_repository.dart';

class HttpRecipeRepository implements RecipeRepository {
  final Dio _dio;

  HttpRecipeRepository({required Dio dio}) : _dio = dio;

  @override
  Future<List<RecipeCardModel>> fetch_recipes_from_cart({required String filter_key}) async {
    // TODO: í•„í„° í‚¤ì— ë”°ë¥¸ ë¡œì§ (í˜„ì¬ëŠ” ë¯¸êµ¬í˜„, ë¹ˆ ë¦¬ìŠ¤íŠ¸)
    return [];
  }

  @override
  Future<List<RecipeCardModel>> fetch_recipes_you_can_cook_now({int? basedOnProductId}) async {
    if (basedOnProductId == null) {
      return [];
    }
    
    try {
      final response = await _dio.get('/api/recommendations/by-product/$basedOnProductId');
      final List<dynamic> data = response.data;
      
      return data.map((item) {
        // missing_ingredients ì²˜ë¦¬
        // final missingList = (item['missing_ingredients'] as List? ?? []).map((m) => m['name'].toString()).toList();
        
        return RecipeCardModel(
          recipe_id: item['recipe_id'].toString(),
          title: item['title'],
          subtitle: item['description'] ?? 'ì„¤ëª… ì—†ìŒ',
          // image_url: item['image_url'] ?? '', // Modelì— ì—†ìŒ
          time_min: item['cooking_time_min'] ?? 30,
          difficulty_label: item['difficulty'] ?? 'ë³´í†µ',
          match_percent: item['similarity_score'] != null 
              ? (item['similarity_score'] * 100).round() 
              : 80, // ê¸°ë³¸ê°’
          // missing_ingredients_count: missingList.length, // Modelì— ì—†ìŒ
          is_in_progress: false,
          is_smart_choice: false,
        );
      }).toList();
      
    } catch (e) {
      print('fetch_recipes_you_can_cook_now error: $e');
      return [];
    }
  }

  @override
  Future<RecipeDetailModel> fetch_recipe_detail({required String recipe_id}) async {
    try {
      final response = await _dio.get('/api/recipes/$recipe_id');
      final data = response.data;
      
      return RecipeDetailModel(
        recipe_id: data['recipe_id'].toString(),
        title: data['title'],
        // description: data['description'] ?? '', // Modelì— ì—†ìŒ
        // image_url: data['image_url'] ?? '', // Modelì— ì—†ìŒ
        prep_time_min: data['cooking_time_min'] ?? 30,
        difficulty_label: data['difficulty'] ?? 'ë³´í†µ',
        calories: data['calories'] ?? 500,
        ingredients: (data['ingredients'] as List? ?? []).map((i) {
          return RecipeIngredient(
            name: i['name'],
            status_label: i['quantity_info'] ?? '',
            is_available: false, // ìƒì„¸ ì¡°íšŒ ì‹œ ì†Œìœ  ì—¬ë¶€ í™•ì¸ ë¡œì§ í•„ìš” ì‹œ ì¶”ê°€
          );
        }).toList(),
        steps: (data['instructions'] as String? ?? '').split('\n')
          .where((s) => s.trim().isNotEmpty)
          .toList()
          .asMap()
          .entries
          .map((entry) => RecipeStep(
            order: entry.key + 1,
            title: 'Step ${entry.key + 1}',
            description: entry.value,
          ))
          .toList(),
      );
    } catch (e) {
      throw Exception('Failed to load recipe detail: $e');
    }
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\features\recipe\repository\recipe_repository.dart
==================================================
import '../../../domain/models/recipe.dart';

abstract class RecipeRepository {
  Future<List<RecipeCardModel>> fetch_recipes_from_cart({required String filter_key});
  Future<List<RecipeCardModel>> fetch_recipes_you_can_cook_now({int? basedOnProductId});
  Future<RecipeDetailModel> fetch_recipe_detail({required String recipe_id});
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\app_scaffold.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\app_text_field.dart
==================================================
import 'package:flutter/material.dart';

class AppTextField extends StatelessWidget {
  final TextEditingController controller;
  final String label;
  final String hint;
  final bool obscure_text;
  final TextInputType keyboard_type;
  final Widget? prefix_icon;
  final Widget? suffix_icon;
  final String? helper_text;

  const AppTextField({
    super.key,
    required this.controller,
    required this.label,
    required this.hint,
    this.obscure_text = false,
    this.keyboard_type = TextInputType.text,
    this.prefix_icon,
    this.suffix_icon,
    this.helper_text,
  });

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: <Widget>[
        Text(label, style: const TextStyle(fontWeight: FontWeight.w700)),
        const SizedBox(height: 8),
        TextField(
          controller: controller,
          obscureText: obscure_text,
          keyboardType: keyboard_type,
          decoration: InputDecoration(
            hintText: hint,
            prefixIcon: prefix_icon,
            suffixIcon: suffix_icon,
            helperText: helper_text,
          ),
        ),
      ],
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\bottom_nav.dart
==================================================
import 'package:flutter/material.dart';

enum BottomTab {
  home,
  search,
  scan,
  account_book,
  my_page,
}

class BottomNav extends StatelessWidget {
  final BottomTab current_tab;
  final ValueChanged<BottomTab> on_tab_selected;

  const BottomNav({
    super.key,
    required this.current_tab,
    required this.on_tab_selected,
  });

  int _tab_to_index(BottomTab tab) {
    switch (tab) {
      case BottomTab.home:
        return 0;
      case BottomTab.search:
        return 1;
      case BottomTab.scan:
        return 2;
      case BottomTab.account_book:
        return 3;
      case BottomTab.my_page:
        return 4;
    }
  }

  BottomTab _index_to_tab(int index) {
    switch (index) {
      case 0:
        return BottomTab.home;
      case 1:
        return BottomTab.search;
      case 2:
        return BottomTab.scan;
      case 3:
        return BottomTab.account_book;
      case 4:
      default:
        return BottomTab.my_page;
    }
  }

  @override
  Widget build(BuildContext context) {
    final double icon_size = MediaQuery.of(context).size.width < 420 ? 22 : 24;

    return SafeArea(
      top: false,
      child: BottomNavigationBar(
        currentIndex: _tab_to_index(current_tab),
        type: BottomNavigationBarType.fixed,
        onTap: (int index) => on_tab_selected(_index_to_tab(index)),
        selectedFontSize: 12,
        unselectedFontSize: 12,
        items: <BottomNavigationBarItem>[
          BottomNavigationBarItem(
            icon: Icon(Icons.home_outlined, size: icon_size),
            activeIcon: Icon(Icons.home, size: icon_size),
            label: 'í™ˆ',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.search_outlined, size: icon_size),
            activeIcon: Icon(Icons.search, size: icon_size),
            label: 'ê²€ìƒ‰',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.qr_code_scanner_outlined, size: icon_size),
            activeIcon: Icon(Icons.qr_code_scanner, size: icon_size),
            label: 'ìŠ¤ìº”',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.receipt_long_outlined, size: icon_size),
            activeIcon: Icon(Icons.receipt_long, size: icon_size),
            label: 'ê°€ê³„ë¶€',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.person_outline, size: icon_size),
            activeIcon: Icon(Icons.person, size: icon_size),
            label: 'ë§ˆì´',
          ),
        ],
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\buttons.dart
==================================================
import 'package:flutter/material.dart';
import 'package:pickle/core/theme/PickleColors.dart';
import 'package:pickle/shared/widgets/texts.dart';

class PickleButton extends StatelessWidget {
  final String text;
  final VoidCallback? onPressed;
  final Color backgroundColor;
  final Color textColor;

  const PickleButton({
    super.key,
    required this.text,
    this.onPressed,
    this.backgroundColor = PickleColors.pickle,
    this.textColor = PickleColors.white,
  });

  @override
  Widget build(BuildContext context) {
    return ElevatedButton(
      onPressed: onPressed,
      style: ElevatedButton.styleFrom(
        backgroundColor: backgroundColor,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10),
        ),
      ),
      child: PickleText(
        text,
        style: TextStyle(color: textColor),
      ),
    );
  }
}

class PickleOutlinedButton extends StatelessWidget {
  final String text;
  final VoidCallback? onPressed;
  final Color borderColor;
  final Color textColor;

  const PickleOutlinedButton({
    super.key,
    required this.text,
    this.onPressed,
    this.borderColor = PickleColors.pickle,
    this.textColor = PickleColors.pickle,
  });

  @override
  Widget build(BuildContext context) {
    return OutlinedButton(
      onPressed: onPressed,
      style: OutlinedButton.styleFrom(
        side: BorderSide(color: borderColor),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(10),
        ),
      ),
      child: PickleText(
        text,
        style: TextStyle(color: textColor),
      ),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\button_nav.dart
==================================================
import 'package:flutter/material.dart';
import '../../core/theme/app_colors.dart';

enum BottomTab { home, search, scan, history, my }

class BottomNav extends StatelessWidget {
  final BottomTab current_tab;
  final ValueChanged<BottomTab> on_changed;

  const BottomNav({
    super.key,
    required this.current_tab,
    required this.on_changed,
  });

  int _index(BottomTab tab) => BottomTab.values.indexOf(tab);

  @override
  Widget build(BuildContext context) {
    return NavigationBar(
      backgroundColor: Colors.white,
      indicatorColor: AppColors.brand_primary.withOpacity(0.18),
      selectedIndex: _index(current_tab),
      onDestinationSelected: (int i) => on_changed(BottomTab.values[i]),
      destinations: const <NavigationDestination>[
        NavigationDestination(icon: Icon(Icons.home_outlined), label: 'í™ˆ'),
        NavigationDestination(icon: Icon(Icons.search), label: 'ê²€ìƒ‰'),
        NavigationDestination(icon: Icon(Icons.qr_code_scanner), label: 'ìŠ¤ìº”'),
        NavigationDestination(icon: Icon(Icons.receipt_long), label: 'ë‚´ì—­'),
        NavigationDestination(icon: Icon(Icons.person_outline), label: 'ë§ˆì´'),
      ],
    );
  }
}

==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\empty_state_card.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\pill_chip.dart
==================================================


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\primary_button.dart
==================================================
ï»¿import 'package:flutter/material.dart';
import '../../core/theme/app_colors.dart';

class PrimaryButton extends StatelessWidget {
  final String label;
  final VoidCallback? on_pressed;
  final Widget? leading;
  final bool is_expanded;

  const PrimaryButton({
    super.key,
    required this.label,
    required this.on_pressed,
    this.leading,
    this.is_expanded = true,
  });

  @override
  Widget build(BuildContext context) {
    final Widget child = Row(
      mainAxisSize: MainAxisSize.min,
      mainAxisAlignment: MainAxisAlignment.center,
      children: <Widget>[
        if (leading != null) ...<Widget>[leading!, const SizedBox(width: 8)],
        Text(label, style: const TextStyle(fontWeight: FontWeight.w700)),
      ],
    );

    final Widget button = FilledButton(
      onPressed: on_pressed,
      style: FilledButton.styleFrom(
        backgroundColor: AppColors.brand_primary,
        foregroundColor: Colors.white,
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 16),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      ),
      child: child,
    );

    if (!is_expanded) return button;
    return SizedBox(width: double.infinity, child: button);
  }
}



==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\section_card.dart
==================================================
import 'package:flutter/material.dart';

class SectionCard extends StatelessWidget {
  final Widget child;
  final EdgeInsets padding;

  const SectionCard({
    super.key,
    required this.child,
    this.padding = const EdgeInsets.all(16),
  });

  @override
  Widget build(BuildContext context) {
    return Card(
      child: Padding(padding: padding, child: child),
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\lib\shared\widgets\texts.dart
==================================================
import 'package:flutter/material.dart';
import 'package:pickle/core/theme/text_styles.dart';

class PickleText extends StatelessWidget {
  final String text;
  final TextStyle style;

  const PickleText(this.text, {super.key, this.style = PickleTextStyles.mediumregular});

  @override
  Widget build(BuildContext context) {
    return Text(
      text,
      style: style,
    );
  }
}


==================================================
FILE PATH: .\frontend\mobile-app\test\login_screen_test.dart
==================================================
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:pickle/features/auth/presentation/login_screen.dart';

void main() {
  testWidgets('Login screen should show Google and Kakao login buttons', (WidgetTester tester) async {
    // Build our app and trigger a frame.
    await tester.pumpWidget(
      const ProviderScope(
        child: MaterialApp(
          home: LoginScreen(),
        ),
      ),
    );

    // Verify that the 'ë˜ëŠ”' text is present
    expect(find.text('ë˜ëŠ”'), findsOneWidget);

    // Verify that social login buttons are present by their labels
    expect(find.text('ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°'), findsOneWidget);
    expect(find.text('Googleë¡œ ì‹œì‘í•˜ê¸°'), findsOneWidget);

    // Verify presence of login fields
    expect(find.widgetWithText(TextField, 'ì´ë©”ì¼'), findsOneWidget);
    expect(find.widgetWithText(TextField, 'ë¹„ë°€ë²ˆí˜¸'), findsOneWidget);
  });
}


==================================================
FILE PATH: .\frontend\mobile-app\test\widget_test.dart
==================================================
// // This is a basic Flutter widget test.
// //
// // To perform an interaction with a widget in your test, use the WidgetTester
// // utility in the flutter_test package. For example, you can send tap and scroll
// // gestures. You can also use WidgetTester to find child widgets in the widget
// // tree, read text, and verify that the values of widget properties are correct.
//
// import 'package:flutter/material.dart';
// import 'package:flutter_test/flutter_test.dart';
//
// import 'package:pickle/main.dart';
//
// void main() {
//   testWidgets('Counter increments smoke test', (WidgetTester tester) async {
//     // Build our app and trigger a frame.
//     await tester.pumpWidget(const MyApp());
//
//     // Verify that our counter starts at 0.
//     expect(find.text('0'), findsOneWidget);
//     expect(find.text('1'), findsNothing);
//
//     // Tap the '+' icon and trigger a frame.
//     await tester.tap(find.byIcon(Icons.add));
//     await tester.pump();
//
//     // Verify that our counter has incremented.
//     expect(find.text('0'), findsNothing);
//     expect(find.text('1'), findsOneWidget);
//   });
// }


==================================================
FILE PATH: .\mlops\environment.yaml
==================================================
name: pickle_mlops
channels:
  - conda-forge
  - defaults
dependencies:
  - python=3.10
  - pip
  - pip:
    - apache-airflow==2.10.4
    - mlflow>=3.0.0
    - boto3
    - psycopg2-binary
    - pandas
    - scikit-learn

==================================================
FILE PATH: .\mlops\README.md
==================================================
# MLOps (Data Pipeline & Model Ops)

ì´ ë””ë ‰í† ë¦¬ëŠ” ì§€ì†ì ì¸ AI ëª¨ë¸ í•™ìŠµ ë° ë°°í¬ë¥¼ ìœ„í•œ **MLOps í”Œë«í¼**ì„ êµ¬ì„±í•©ë‹ˆë‹¤.



## 1. ë””ë ‰í† ë¦¬ êµ¬ì¡°

- **`airflow/`**: ì›Œí¬í”Œë¡œìš° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë„êµ¬.
  - **`dags/`**: ë°ì´í„° ìˆ˜ì§‘, ì „ì²˜ë¦¬, ì¬í•™ìŠµ íŒŒì´í”„ë¼ì¸ ì •ì˜ (Python).
  - **`logs/`**: íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œê·¸.
- **`mlflow/`** (ì˜ˆì •): ì‹¤í—˜ ì¶”ì  ë° ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ê´€ë¦¬.



## 2. ì£¼ìš” ê¸°ëŠ¥

### ì´ˆê¸° í•™ìŠµ

1. **ë°ì´í„°ì…‹ ì¤€ë¹„**: ìˆ˜ë™ìœ¼ë¡œ ë¼ë²¨ë§ëœ ê³ í’ˆì§ˆ ìƒí’ˆ ì´ë¯¸ì§€ ë°ì´í„°ì…‹ì„ ë¡œì»¬ í™˜ê²½ì—ì„œ ì •ì œ.
2. **ëª¨ë¸ ì„ ì •**: `ai/training/` ë‚´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©, YOLOv8/v11 ì‚¬ì „ í•™ìŠµ ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ ì „ì´ í•™ìŠµ(Transfer Learning) ìˆ˜í–‰.
3. **ì‹¤í—˜ ê¸°ë¡**: í•™ìŠµ ê³¼ì •ì˜ ëª¨ë“  í•˜ì´í¼íŒŒë¼ë¯¸í„° ë° í‰ê°€ì§€í‘œ(mAP, Loss)ë¥¼ **MLflow**ì— ê¸°ë¡í•˜ì—¬ ê´€ë¦¬.
4. **ë² ì´ìŠ¤ë¼ì¸ í™•ì •**: í•™ìŠµ ì™„ë£Œ í›„ ìµœì ì˜ ì„±ëŠ¥ì„ ë‚¸ `best.pt` íŒŒì¼ì„ MLflow Model Registryì— **`v1.0.0 (Production)`**ìœ¼ë¡œ ë“±ë¡í•˜ì—¬ ì„œë¹„ìŠ¤ ì´ˆê¸° ëª¨ë¸ë¡œ ë°°í¬.
5. **ë°ì´í„° ì•„ì¹´ì´ë¹™**: ì´ˆê¸° í•™ìŠµì— ì‚¬ìš©ëœ ë°ì´í„°ì…‹ ì›ë³¸ì„ **MinIO**(`datasets/initial-v1/`)ì— ì €ì¥í•˜ì—¬ í–¥í›„ ì„±ëŠ¥ ë¹„êµì˜ ëŒ€ì¡°êµ°ìœ¼ë¡œ í™œìš©.



### í•™ìŠµ ìë™í™”

1. **ë°ì´í„° ìˆ˜ì§‘**: Jetsonì—ì„œ ì—…ë¡œë“œëœ 'ì˜¤ë‹µ ì´ë¯¸ì§€'ë¥¼ MinIOì—ì„œ ê°€ì ¸ì˜´.
2. **ìë™ ì¬í•™ìŠµ**: ë°ì´í„°ê°€ ì¼ì •ëŸ‰ ìŒ“ì´ë©´ Airflowê°€ GPU ì„œë²„ì—ì„œ YOLO í•™ìŠµ íŠ¸ë¦¬ê±°.
3. **ëª¨ë¸ í‰ê°€**: í•™ìŠµëœ ëª¨ë¸ì˜ ì„±ëŠ¥(mAP)ì„ MLflowì— ê¸°ë¡í•˜ê³ , ì´ì „ ëª¨ë¸ê³¼ ë¹„êµ.
4. **ë°°í¬**: ì„±ëŠ¥ì´ í–¥ìƒë˜ë©´ Jetsonì´ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆë„ë¡ ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ë“±ë¡.



## 3. ì ‘ì† ì •ë³´ (ë¡œì»¬ ì‹¤í–‰ ì‹œ)

- **Airflow UI**: `http://localhost:8080`
- **MLflow UI**: `http://localhost:5000`


==================================================
FILE PATH: .\mlops\airflow\dags\pipeline_test.py
==================================================
from airflow import DAG
from airflow.operators.bash import BashOperator
from airflow.utils.dates import days_ago
from datetime import timedelta

# ê¸°ë³¸ ì„¤ì •
default_args = {
    'owner': 'airflow',
    'depends_on_past': False,
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': 1,
    'retry_delay': timedelta(minutes=5),
}

# DAG ì •ì˜
with DAG(
    '01_pipeline_integration_test',
    default_args=default_args,
    description='A dummy pipeline to test MLflow and MinIO integration',
    schedule_interval=None, # ìˆ˜ë™ ì‹¤í–‰ (Manual Trigger)
    start_date=days_ago(1),
    tags=['mlops', 'test'],
    catchup=False,
) as dag:

    # Task 1: í™˜ê²½ ë³€ìˆ˜ ë° ì˜ì¡´ì„± í™•ì¸ (Optional)
    check_env = BashOperator(
        task_id='check_environment',
        bash_command='echo "Checking MLflow connection..." && python --version && pip list | grep mlflow'
    )

    # Task 2: Mock Training Script ì‹¤í–‰
    # Airflow Docker Container ë‚´ë¶€ ê²½ë¡œ ê¸°ì¤€: /opt/airflow/dags/scripts/mock_train.py
    run_mock_train = BashOperator(
        task_id='run_mock_training',
        bash_command='python /opt/airflow/dags/scripts/mock_train.py',
        env={
            # docker-compose network ë‚´ì—ì„œ MLflow ì»¨í…Œì´ë„ˆ ì£¼ì†Œ
            'MLFLOW_TRACKING_URI': 'http://mlflow_server:5000',
            # í•„ìš”í•œ ê²½ìš° AWS Credential ë“±ì„ ì—¬ê¸°ì„œ ì£¼ì… ê°€ëŠ¥í•˜ì§€ë§Œ,
            # Docker Compose ë ˆë²¨ì—ì„œ ì´ë¯¸ ì£¼ì…ë˜ì–´ ìˆìœ¼ë©´ ìƒëµ ê°€ëŠ¥
            'AWS_ACCESS_KEY_ID': 'admin',
            'AWS_SECRET_ACCESS_KEY': 'password123',
            'MLFLOW_S3_ENDPOINT_URL': 'http://minio:9000'
        }
    )

    check_env >> run_mock_train


==================================================
FILE PATH: .\mlops\airflow\dags\scripts\mock_train.py
==================================================
import mlflow
import os
import random
import time
import sys

# Airflow ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë  ë•Œ MLflow ì„œë²„ ì£¼ì†Œ
# docker-compose.ymlì˜ service name ë˜ëŠ” container_nameì„ ì‚¬ìš©
MLFLOW_TRACKING_URI = os.getenv("MLFLOW_TRACKING_URI", "http://mlflow_server:5000")

def train_mock_yolo():
    print(f"Connecting to MLflow at: {MLFLOW_TRACKING_URI}")
    mlflow.set_tracking_uri(MLFLOW_TRACKING_URI)
    
    # Experiment ì„¤ì • (ì—†ìœ¼ë©´ ìƒì„±)
    experiment_name = "YOLO_Mock_Training"
    mlflow.set_experiment(experiment_name)

    with mlflow.start_run(run_name=f"mock_run_{int(time.time())}"):
        print("Starting Mock Training...")
        
        # 1. í•˜ì´í¼íŒŒë¼ë¯¸í„° ë¡œê¹… (Pre-defined params)
        params = {
            "model_type": "yolov8s",
            "epochs": 50,
            "batch_size": 16,
            "img_size": 640,
            "optimizer": "SGD"
        }
        mlflow.log_params(params)
        print("Logged parameters.")

        # 2. í•™ìŠµ ë£¨í”„ ì‹œë®¬ë ˆì´ì…˜ (Metrics logging)
        for epoch in range(1, 11):
            # í•™ìŠµ ì§„í–‰ ì²™ í•˜ê¸°
            time.sleep(0.5) 
            
            # ì§€í‘œ ìƒì„± (ì ì  ì¢‹ì•„ì§€ëŠ” ì²™)
            loss = 1.0 / (0.1 * epoch + 1) + random.uniform(-0.05, 0.05)
            map50 = 0.5 + (0.04 * epoch) + random.uniform(-0.01, 0.01)
            if map50 > 0.95: map50 = 0.95
            
            mlflow.log_metric("train_loss", loss, step=epoch)
            mlflow.log_metric("val_mAP50", map50, step=epoch)
            
            print(f"Epoch {epoch}/10 - loss: {loss:.4f} - mAP50: {map50:.4f}")

        # 3. ì•„í‹°íŒ©íŠ¸(ëª¨ë¸ íŒŒì¼) ì €ì¥ ì‹œë®¬ë ˆì´ì…˜
        # ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ best.pt íŒŒì¼ì´ ìƒì„±ë¨
        os.makedirs("weights", exist_ok=True)
        dummy_weight_path = "weights/best.pt"
        with open(dummy_weight_path, "w") as f:
            f.write(f"This is a dummy YOLO weight file created at {time.ctime()}")
        
        # MLflow Artifact Store(MinIO)ì— ì—…ë¡œë“œ
        mlflow.log_artifact(dummy_weight_path, artifact_path="models")
        print(f"Uploaded artifact: {dummy_weight_path}")

        print("Mock Training Complete.")

if __name__ == "__main__":
    try:
        train_mock_yolo()
    except Exception as e:
        print(f"Error during mock training: {e}")
        sys.exit(1)

